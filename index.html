<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Seiren OS</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#ff69b4">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/3461/3461877.png">

    <style>
        /* --- 2004 MOE AESTHETIC --- */
        :root {
            --pink: #ff69b4;
            --light-pink: #fff0f5;
            --blue: #4fc3f7;
            --text: #555;
            --glass: rgba(255, 255, 255, 0.95);
        }

        body {
            font-family: 'Verdana', sans-serif;
            background-color: #ffe4e1;
            margin: 0;
            display: flex;
            justify-content: center;
            height: 100vh;
            overflow: hidden;
            color: var(--text);
        }

        /* SNOWFALL ANIMATION */
        .snow-container {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; z-index: 0; overflow: hidden;
        }
        .snowflake {
            position: absolute; top: -10px; color: white; font-size: 1em; opacity: 0.8;
            animation: fall linear infinite; text-shadow: 0 0 5px rgba(255,255,255,0.8);
        }
        @keyframes fall {
            to { transform: translateY(110vh) rotate(360deg); }
        }

        /* SCANLINES */
        .scanlines {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.03) 50%);
            background-size: 100% 3px; pointer-events: none; z-index: 999;
        }

        .app-shell {
            width: 100%; max-width: 480px;
            background: var(--glass);
            display: flex; flex-direction: column;
            position: relative; height: 100%;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
            z-index: 10;
        }

        /* HEADER */
        .marquee-container {
            background: linear-gradient(180deg, var(--pink), #ff1493);
            color: white; padding: 6px 0;
            white-space: nowrap; overflow: hidden; border-bottom: 3px solid #fff;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            flex-shrink: 0; z-index: 10;
        }
        .marquee-text {
            display: inline-block; padding-left: 100%;
            animation: marquee 15s linear infinite; font-weight: bold; font-size: 0.8rem;
            text-transform: uppercase; letter-spacing: 1px;
        }
        @keyframes marquee { 0% { transform: translate(0, 0); } 100% { transform: translate(-100%, 0); } }

        /* CONTENT */
        .content {
            flex: 1; overflow-y: auto; overflow-x: hidden;
            padding: 20px; padding-bottom: 100px; scroll-behavior: smooth;
        }

        .page { display: none; animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .page.active { display: block; }
        @keyframes popIn { from {opacity:0; transform:scale(0.95);} to {opacity:1; transform:scale(1);} }

        /* === 1. HOME: ID CARD & XP === */
        .xp-bar-container {
            background: white; padding: 10px; border-radius: 10px; margin-bottom: 15px;
            border: 2px solid var(--blue); text-align: center;
        }
        .xp-track { background: #eee; height: 10px; border-radius: 5px; overflow: hidden; margin-top: 5px; }
        .xp-fill { height: 100%; background: linear-gradient(90deg, var(--blue), #87cefa); width: 0%; transition: width 0.5s; }

        .id-card {
            background: #fff;
            border: 3px solid var(--pink); border-radius: 15px; padding: 15px;
            box-shadow: 5px 5px 0px rgba(255, 105, 180, 0.4);
            position: relative; overflow: hidden; margin-bottom: 25px;
        }
        .id-card::after {
            content: ""; position: absolute; top: -50%; left: -50%; width: 200%; height: 200%;
            background: linear-gradient(45deg, transparent 40%, rgba(255,255,255,0.4) 50%, transparent 60%);
            animation: shine 3s infinite; pointer-events: none;
        }
        @keyframes shine { 0% {top:-150%;} 100% {top:150%;} }

        .id-layout { display: flex; gap: 15px; }
        .avatar-box {
            width: 80px; height: 80px; background: var(--light-pink);
            border: 2px solid var(--pink); border-radius: 10px;
            overflow: hidden; padding: 0;
        }
        .avatar-box img { width: 100%; height: 100%; object-fit: cover; }
        
        .id-info h2 { margin: 0; color: var(--pink); font-size: 1.3rem; text-transform: uppercase; border-bottom: 1px dashed #ccc; }
        .id-stats { font-size: 0.75rem; color: #666; margin-top: 5px; line-height: 1.5; }

        /* === 2. WISHLIST CORKBOARD === */
        .corkboard {
            background-color: #eaddcf;
            background-image: radial-gradient(#d4c5b0 2px, transparent 2px);
            background-size: 20px 20px;
            padding: 15px; border-radius: 10px;
            border: 4px solid #8b4513;
            min-height: 300px;
        }
        .wish-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 15px; }
        .polaroid {
            background: white; padding: 8px 8px 25px 8px;
            box-shadow: 2px 2px 5px rgba(0,0,0,0.2);
            transform: rotate(-2deg); transition: transform 0.2s;
            text-align: center; position: relative;
        }
        .polaroid:nth-child(even) { transform: rotate(2deg); }
        .polaroid img { width: 100%; aspect-ratio: 1/1; object-fit: cover; background: #eee; border: 1px solid #ddd; }
        .polaroid-caption {
            font-family: 'Courier New', monospace; font-size: 0.7rem; color: #333;
            margin-top: 8px; font-weight: bold; overflow: hidden; white-space: nowrap; text-overflow: ellipsis;
        }
        .pin {
            width: 12px; height: 12px; border-radius: 50%; background: red;
            position: absolute; top: -5px; left: 50%; transform: translateX(-50%);
            box-shadow: 1px 1px 2px rgba(0,0,0,0.3);
        }

        /* === 3. EBI (PET) === */
        .pet-container {
            background: white; border: 3px solid var(--pink); border-radius: 20px;
            padding: 20px; text-align: center; margin-bottom: 20px;
        }
        .pet-img { 
            width: 120px; height: 120px; 
            object-fit: contain; 
            animation: bounce 2s infinite; 
            filter: drop-shadow(0 4px 0 rgba(0,0,0,0.1));
        }
        @keyframes bounce { 0%, 100% {transform:translateY(0);} 50% {transform:translateY(-10px) rotate(5deg);} }
        
        .hunger-track { background: #eee; height: 12px; border-radius: 10px; margin: 10px 0; overflow: hidden; border: 1px solid #ccc; }
        .hunger-fill { height: 100%; background: linear-gradient(90deg, #ff9a9e, #ff69b4); width: 50%; transition: width 0.3s; }

        .task-item {
            background: white; padding: 10px; margin-bottom: 5px; border-radius: 8px;
            display: flex; justify-content: space-between; align-items: center;
            border-bottom: 2px solid #eee;
        }

        /* === 4. DIARY === */
        .diary-paper {
            background: #fff; padding: 15px; border-radius: 10px; margin-bottom: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        .mood-grid { display: flex; justify-content: space-between; margin-bottom: 10px; }
        .mood-btn {
            font-size: 1.5rem; background: none; border: 2px solid transparent; border-radius: 50%;
            cursor: pointer; transition: 0.2s; width: 40px; height: 40px;
        }
        .mood-btn.selected { background: var(--light-pink); border-color: var(--pink); transform: scale(1.1); }
        .entry-bubble {
            background: white; padding: 10px; border-radius: 10px; margin-bottom: 8px;
            border: 1px solid #eee; border-left: 4px solid var(--blue);
            font-size: 0.9rem;
        }

        /* UI */
        input { width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 8px; box-sizing: border-box; font-family:inherit; }
        button { cursor: pointer; }
        .btn-pink {
            background: var(--pink); color: white; border: none; padding: 10px 20px;
            border-radius: 20px; font-weight: bold; box-shadow: 0 3px 0 #d12e87;
            width: 100%; margin-top: 5px;
        }
        .btn-pink:active { transform: translateY(3px); box-shadow: none; }
        .btn-small { width: auto; font-size: 1.2rem; padding: 5px 15px; }

        /* NAV */
        nav {
            position: fixed; bottom: 0; left: 0; right: 0;
            background: white; border-top: 3px solid var(--pink);
            display: flex; justify-content: space-around; padding: 10px 0;
            padding-bottom: max(10px, env(safe-area-inset-bottom));
            z-index: 100;
        }
        .nav-btn {
            background: none; border: none; color: #aaa;
            display: flex; flex-direction: column; align-items: center; font-size: 0.7rem;
        }
        .nav-btn span { font-size: 1.5rem; margin-bottom: 2px; }
        .nav-btn.active { color: var(--pink); transform: scale(1.1); font-weight: bold; }

    </style>
</head>
<body>

<div class="snow-container" id="snow-container"></div>
<div class="scanlines"></div>

<div class="app-shell">
    <div class="marquee-container">
        <div class="marquee-text">
            ‚òÖ SEIREN OS v9.0 ‚òÖ EBI'S HOUSE ONLINE ‚òÖ LEVEL UP YOUR ID ‚òÖ WISH FOR ITEMS ‚òÖ GIRLS BRAVO ‚òÖ
        </div>
    </div>

    <div class="content">

        <div id="tab-home" class="page active">
            
            <div id="setup-screen" style="text-align:center; padding:20px; display:none;">
                <h2 style="color:var(--pink);">Create Profile</h2>
                <input type="text" id="setup-name" placeholder="Your Name" style="margin-bottom:10px;">
                <input type="number" id="setup-age" placeholder="Age" style="margin-bottom:10px;">
                <button class="btn-pink" onclick="createProfile()">ENTER WORLD</button>
            </div>

            <div id="id-display" style="display:none;">
                
                <div class="xp-bar-container">
                    <div style="display:flex; justify-content:space-between; font-size:0.8rem; font-weight:bold;">
                        <span>Level <span id="lvl-num">1</span></span>
                        <span><span id="xp-val">0</span> / 100 XP</span>
                    </div>
                    <div class="xp-track"><div id="xp-bar" class="xp-fill"></div></div>
                </div>

                <div class="id-card">
                    <div style="text-align:right; font-size:0.6rem; letter-spacing:1px; color:#aaa; margin-bottom:5px;">SEIREN RESIDENT CARD</div>
                    <div class="id-layout">
                        <div class="avatar-box" onclick="changeAvatar()">
                            <img id="my-avatar" src="" alt="Avatar">
                        </div>
                        <div class="id-info">
                            <h2 id="my-name">Snow</h2>
                            <div class="id-stats">
                                <strong>Type:</strong> <span id="my-type">Tsundere</span><br>
                                <strong>Power:</strong> <span id="my-pow">80%</span><br>
                                <strong>ID:</strong> #<span id="my-id">2004</span>
                            </div>
                            <div style="font-size:0.6rem; color:var(--blue); margin-top:5px; cursor:pointer;" onclick="changeAvatar()">[TAP TO CHANGE]</div>
                        </div>
                    </div>
                </div>

                <div style="text-align:center; margin-top:20px;">
                    <h3 style="color:var(--blue); margin-bottom:5px;">Daily Fortune</h3>
                    <div style="perspective:600px; height:200px; width:150px; margin:0 auto;" onclick="flipFortune()">
                        <div id="card-inner" style="position:relative; width:100%; height:100%; transition:transform 0.6s; transform-style:preserve-3d;">
                            <div style="position:absolute; width:100%; height:100%; backface-visibility:hidden; background:repeating-linear-gradient(45deg, var(--pink), var(--pink) 10px, #ffb7b2 10px, #ffb7b2 20px); border:4px solid white; border-radius:10px; display:flex; align-items:center; justify-content:center; box-shadow:0 4px 10px rgba(0,0,0,0.1);">
                                <span style="font-size:3rem; color:white;">?</span>
                            </div>
                            <div style="position:absolute; width:100%; height:100%; backface-visibility:hidden; background:white; transform:rotateY(180deg); border:4px solid var(--blue); border-radius:10px; display:flex; flex-direction:column; align-items:center; justify-content:center; padding:10px;">
                                <div id="fortune-icon" style="font-size:3rem;"></div>
                                <strong id="fortune-title" style="color:var(--pink); margin-top:10px; font-size:0.9rem;"></strong>
                                <p id="fortune-desc" style="font-size:0.75rem; color:#666; margin-top:5px; line-height:1.2;"></p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="tab-wish" class="page">
            <h2 style="color:var(--blue);">My Wishlist</h2>
            <div style="background:white; padding:10px; border-radius:10px; margin-bottom:15px; box-shadow:0 2px 5px rgba(0,0,0,0.1);">
                <input type="text" id="wish-name" placeholder="Item Name..." style="margin-bottom:5px;">
                <input type="text" id="wish-img" placeholder="Image Link...">
                <button class="btn-pink" onclick="addWish()">Pin to Board</button>
            </div>
            <div class="corkboard"><div id="wish-grid" class="wish-grid"></div></div>
        </div>

        <div id="tab-pet" class="page">
            <div class="pet-container">
                <img src="https://cdn-icons-png.flaticon.com/512/3069/3069172.png" class="pet-img" id="ebi-img">
                <h3 style="color:var(--pink); margin:5px 0;">Ebi</h3>
                <div class="hunger-track">
                    <div id="hunger-bar" class="hunger-fill"></div>
                </div>
                <p id="pet-msg" style="font-size:0.8rem; color:#888;">Ebi wants space snacks!</p>
            </div>
            
            <h3>Tasks (Fills Happy Meter)</h3>
            <div style="display:flex; gap:5px; margin-bottom:15px;">
                <input type="text" id="task-input" placeholder="New Task...">
                <button class="btn-pink btn-small" onclick="addTask()">+</button>
            </div>
            <div id="task-list"></div>
        </div>

        <div id="tab-diary" class="page">
            <h2 style="color:var(--pink);">Secret Diary</h2>
            <div class="diary-paper">
                <div class="mood-grid">
                    <button class="mood-btn selected" onclick="setMood('üòä', this)">üòä</button>
                    <button class="mood-btn" onclick="setMood('üò¢', this)">üò¢</button>
                    <button class="mood-btn" onclick="setMood('üò°', this)">üò°</button>
                    <button class="mood-btn" onclick="setMood('üíñ', this)">üíñ</button>
                </div>
                <textarea id="diary-text" style="width:100%; height:80px; padding:10px; border:2px solid #eee; border-radius:8px; resize:none;" placeholder="Today I..."></textarea>
                <button class="btn-pink" onclick="saveDiary()">Save Entry</button>
            </div>
            <div id="diary-history"></div>
        </div>

    </div>

    <nav>
        <button class="nav-btn active" onclick="nav('home', this)"><span>üè†</span>Home</button>
        <button class="nav-btn" onclick="nav('wish', this)"><span>üìå</span>Wishlist</button>
        <button class="nav-btn" onclick="nav('pet', this)"><span>üç§</span>Ebi</button>
        <button class="nav-btn" onclick="nav('diary', this)"><span>üìì</span>Diary</button>
    </nav>
</div>

<script>
    // === AVATAR POOL ===
    const MOE_ICONS = [
        "https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcRzYjS4GrT6U0nmcao3A-UnuzLyeh-2UR3jloaiM4z7_A&s=10",
        "https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcT-z6WQN33PPEubdeVEbA1tGIvqoi3-J8-8wReOIZikgQ&s=10",
        "https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcRJVhcDbDaFqB74aaGolFdS64y-mZ-MFhlhYcurhWdC_g&s=10",
        "https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcTklVuzM99qRKzhmBO5tNcbgRNsRyEVv7a4xjoHGC-ttshIszV1lN-VRNw&s=10",
        "https://upload.wikimedia.org/wikipedia/commons/4/43/Chara04.png",
        "https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcTDNRg8thRPLTkTTKHsN1GxIk8WWQuawgwJcJalTTxhbNf339y17tzoxbmI&s=10",
        "https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcTt4mFfq8-QLLwjpTjWrloE8-LH67ZIuDDv_5pqzFDKeC5CbaNQn60p9j8&s=10",
        "https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcRrlK8lLQ6EYZMbc8lqQ5ZCX_kThxUo6XFKizYzXR91YNT5feH1etfRF-s&s=10",
        "https://static.wikia.nocookie.net/aesthetics/images/0/04/Luckystarmoe.png/revision/latest?cb=20230827221913"
    ];

    // === AUDIO ENGINE ===
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    function playBloop() {
        if(audioCtx.state === 'suspended') audioCtx.resume();
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.type = 'sine';
        osc.frequency.setValueAtTime(800, audioCtx.currentTime);
        osc.frequency.exponentialRampToValueAtTime(400, audioCtx.currentTime + 0.1);
        gain.gain.setValueAtTime(0.3, audioCtx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.1);
        osc.connect(gain); gain.connect(audioCtx.destination);
        osc.start(); osc.stop(audioCtx.currentTime + 0.1);
    }
    function playSparkle() {
        if(audioCtx.state === 'suspended') audioCtx.resume();
        for(let i=0; i<3; i++) {
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.type = 'triangle';
            osc.frequency.setValueAtTime(1000 + (i*200), audioCtx.currentTime + (i*0.05));
            gain.gain.setValueAtTime(0.1, audioCtx.currentTime + (i*0.05));
            gain.gain.linearRampToValueAtTime(0, audioCtx.currentTime + (i*0.05) + 0.1);
            osc.connect(gain); gain.connect(audioCtx.destination);
            osc.start(audioCtx.currentTime + (i*0.05)); osc.stop(audioCtx.currentTime + (i*0.05) + 0.1);
        }
    }

    // === STATE ===
    const DB = {
        user: JSON.parse(localStorage.getItem('seiren_v9_user')) || null,
        wishlist: JSON.parse(localStorage.getItem('seiren_v9_wish')) || [],
        pet: JSON.parse(localStorage.getItem('seiren_v9_pet')) || { hunger: 50, tasks: ['Drink Water'] },
        diary: JSON.parse(localStorage.getItem('seiren_v9_diary')) || [],
        fortune: JSON.parse(localStorage.getItem('seiren_v9_fortune')) || { date: '', icon: '', title: '', desc: '' },
        xp: parseInt(localStorage.getItem('seiren_v9_xp')) || 0,
        level: parseInt(localStorage.getItem('seiren_v9_lvl')) || 1
    };
    let currentMood = 'üòä';

    function init() {
        createSnow();
        if(DB.user) { renderID(); checkFortune(); updateXPBar(); } 
        else { document.getElementById('setup-screen').style.display = 'block'; }
        renderWishlist(); renderPet(); renderDiary();
    }

    function createSnow() {
        const container = document.getElementById('snow-container');
        for(let i=0; i<15; i++) {
            const flake = document.createElement('div');
            flake.className = 'snowflake';
            flake.innerText = '‚ùÑ';
            flake.style.left = Math.random() * 100 + 'vw';
            flake.style.animationDuration = Math.random() * 3 + 5 + 's';
            flake.style.animationDelay = Math.random() * 5 + 's';
            container.appendChild(flake);
        }
    }

    function addXP(amount) {
        DB.xp += amount;
        if(DB.xp >= 100) {
            DB.xp -= 100; DB.level++; playSparkle(); alert("LEVEL UP! New Avatar Available!");
        }
        localStorage.setItem('seiren_v9_xp', DB.xp);
        localStorage.setItem('seiren_v9_lvl', DB.level);
        updateXPBar();
    }
    function updateXPBar() {
        document.getElementById('lvl-num').innerText = DB.level;
        document.getElementById('xp-val').innerText = DB.xp;
        document.getElementById('xp-bar').style.width = DB.xp + "%";
    }

    // PROFILE
    function createProfile() {
        playBloop();
        const name = document.getElementById('setup-name').value;
        const age = document.getElementById('setup-age').value;
        if(!name) return;

        const seed = name.length + parseInt(age||0);
        const pres = ["Mi", "Lu", "Fa", "Ko", "Ri", "Yu"];
        const sufs = ["-chan", "-pyon", "ren", "la"];
        const sName = pres[seed % pres.length] + sufs[(seed*3) % sufs.length];

        DB.user = {
            realName: name, seirenName: sName, avatarIdx: 0,
            type: ["Tsundere", "Dojikko", "Alien", "Idol"][seed % 4],
            pow: Math.floor(Math.random()*100), id: Math.floor(Math.random()*9000)+1000
        };
        localStorage.setItem('seiren_v9_user', JSON.stringify(DB.user));
        document.getElementById('setup-screen').style.display = 'none';
        renderID();
    }
    function renderID() {
        document.getElementById('id-display').style.display = 'block';
        document.getElementById('my-name').innerText = DB.user.seirenName;
        document.getElementById('my-type').innerText = DB.user.type;
        document.getElementById('my-pow').innerText = DB.user.pow + "%";
        document.getElementById('my-id').innerText = DB.user.id;
        document.getElementById('my-avatar').src = MOE_ICONS[DB.user.avatarIdx % MOE_ICONS.length];
    }
    function changeAvatar() {
        if(DB.level < 2 && DB.user.avatarIdx === 0) { alert("Level up to unlock more avatars!"); return; }
        playBloop();
        const unlockedCount = Math.min(DB.level + 1, MOE_ICONS.length);
        DB.user.avatarIdx = (DB.user.avatarIdx + 1) % unlockedCount;
        localStorage.setItem('seiren_v9_user', JSON.stringify(DB.user));
        renderID();
    }

    // WISHLIST
    function addWish() {
        playBloop();
        const name = document.getElementById('wish-name').value;
        const img = document.getElementById('wish-img').value;
        if(!name) return;
        DB.wishlist.push({ name: name, img: img || "https://cdn-icons-png.flaticon.com/512/3209/3209955.png" });
        localStorage.setItem('seiren_v9_wish', JSON.stringify(DB.wishlist));
        document.getElementById('wish-name').value = ""; document.getElementById('wish-img').value = "";
        renderWishlist();
    }
    function renderWishlist() {
        const grid = document.getElementById('wish-grid');
        grid.innerHTML = "";
        DB.wishlist.forEach(w => {
            grid.innerHTML += `<div class="polaroid"><div class="pin"></div><img src="${w.img}"><div class="polaroid-caption">${w.name}</div></div>`;
        });
    }

    // FORTUNE (UPDATED CHAOS)
    function checkFortune() {
        const today = new Date().toDateString();
        if(DB.fortune.date === today) {
            renderFortuneData(DB.fortune);
            const card = document.getElementById('card-inner');
            card.style.transition = 'none'; card.style.transform = 'rotateY(180deg)';
        }
    }
    function flipFortune() {
        playSparkle();
        const today = new Date().toDateString();
        if(DB.fortune.date === today) return;

        const opts = [
            {i:"üçû", t:"Toast Run", d:"You will be late for school and bump into your soulmate."},
            {i:"üõÅ", t:"Bath Portal", d:"Avoid bathtubs. High risk of teleportation to a men's bath."},
            {i:"ü§ß", t:"Sneeze Warning", d:"If you sneeze, you might turn into a boy. Careful."},
            {i:"üçÆ", t:"Pudding Theft", d:"Someone will eat your dessert from the fridge."},
            {i:"üëΩ", t:"Space Signal", d:"Your phone will receive a text from another galaxy."},
            {i:"üíñ", t:"Childhood Friend", d:"Someone has a crush on you but is too tsundere to say it."}
        ];
        const res = opts[Math.floor(Math.random()*opts.length)];
        
        DB.fortune = { date: today, icon: res.i, title: res.t, desc: res.d };
        localStorage.setItem('seiren_v9_fortune', JSON.stringify(DB.fortune));
        addXP(10);
        renderFortuneData(res);
        document.getElementById('card-inner').style.transition = 'transform 0.6s';
        document.getElementById('card-inner').style.transform = 'rotateY(180deg)';
    }
    function renderFortuneData(res) {
        document.getElementById('fortune-icon').innerText = res.icon;
        document.getElementById('fortune-title').innerText = res.title;
        document.getElementById('fortune-desc').innerText = res.desc;
    }

    // EBI & DIARY
    function renderPet() {
        const bar = document.getElementById('hunger-bar');
        bar.style.width = DB.pet.hunger + "%";
        document.getElementById('pet-msg').innerText = DB.pet.hunger > 50 ? "Ebi is happy! Squeak!" : "Ebi wants food...";
        const list = document.getElementById('task-list');
        list.innerHTML = "";
        DB.pet.tasks.forEach(t => {
            list.innerHTML += `<div class="task-item"><span>${t}</span><input type="checkbox" onclick="feed()"></div>`;
        });
    }
    function feed() {
        playBloop();
        DB.pet.hunger = Math.min(100, DB.pet.hunger + 20);
        addXP(5);
        localStorage.setItem('seiren_v9_pet', JSON.stringify(DB.pet));
        renderPet();
    }
    function addTask() {
        const val = document.getElementById('task-input').value;
        if(val) {
            playBloop(); DB.pet.tasks.push(val);
            localStorage.setItem('seiren_v9_pet', JSON.stringify(DB.pet));
            document.getElementById('task-input').value = ""; renderPet();
        }
    }
    function setMood(m, btn) {
        playBloop(); currentMood = m;
        document.querySelectorAll('.mood-btn').forEach(b => b.classList.remove('selected'));
        btn.classList.add('selected');
    }
    function saveDiary() {
        const txt = document.getElementById('diary-text').value;
        if(!txt) return;
        playSparkle();
        DB.diary.unshift({ date: new Date().toLocaleDateString(), mood: currentMood, text: txt });
        addXP(15);
        localStorage.setItem('seiren_v9_diary', JSON.stringify(DB.diary));
        document.getElementById('diary-text').value = ""; renderDiary();
    }
    function renderDiary() {
        const div = document.getElementById('diary-history');
        div.innerHTML = "";
        DB.diary.forEach(e => {
            div.innerHTML += `<div class="entry-bubble"><span style="font-size:1.2rem;">${e.mood}</span> <span style="color:#aaa; font-size:0.7rem;">${e.date}</span><br>${e.text}</div>`;
        });
    }

    function nav(id, btn) {
        playBloop();
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        document.getElementById('tab-'+id).classList.add('active');
        document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
    }

    init();

    if('serviceWorker' in navigator) {
        window.addEventListener('load', ()=>navigator.serviceWorker.register('./sw.js'));
    }
</script>

</body>
</html>
