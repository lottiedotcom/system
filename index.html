<!DOCTYPE html>  
<html lang="en">  
<head>  
    <meta charset="UTF-8">  
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">  
    <meta name="apple-mobile-web-app-capable" content="yes">  
    <meta name="theme-color" content="#ff69b4">  
    <title>Seiren OS</title>  
    <link rel="manifest" href="manifest.json">  
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/2919/2919573.png">  
    <link rel="icon" type="image/png" href="https://cdn-icons-png.flaticon.com/512/2919/2919573.png">  

<style>  
    /* --- CORE VARIABLES --- */  
    :root {  
        --main: #ff69b4;   
        --font-main: 'Verdana', sans-serif;  
        --font-mono: 'Courier New', monospace;  
    }  

    * { box-sizing: border-box; user-select: none; -webkit-tap-highlight-color: transparent; }  

    body {  
        font-family: var(--font-main);  
        background-color: #ffe4e1;   
        background-image: radial-gradient(#ffb7b2 15%, transparent 16%), radial-gradient(#ffb7b2 15%, transparent 16%);  
        background-size: 20px 20px; background-position: 0 0, 10px 10px;  
        background-repeat: repeat;  
        background-attachment: fixed; 
        transition: all 0.8s ease;  
        margin: 0; display: flex; justify-content: center; height: 100vh; overflow: hidden;  
        color: #444;   
    }  

    /* --- NIGHT MODE (LIMINAL DREAM JOURNAL) --- */
    body.night-mode {
        background-color: #050510 !important;
        /* Remove default patterns */
        background-image: none !important;
        color: #b0c4de !important;
    }
    
    /* NEW DREAMY BACKGROUND */
    body.night-mode::before {
        content: "";
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: url('https://i.postimg.cc/Zn1jB8Lc/Untitled86-20260119120235.jpg');
        background-size: cover;
        background-position: center;
        filter: blur(4px) brightness(0.7) contrast(1.1); /* The "Dreamy" Effect */
        z-index: -1;
        pointer-events: none;
        animation: breathe 10s infinite alternate;
    }
    @keyframes breathe { from { transform: scale(1); } to { transform: scale(1.05); } }

    body.night-mode .app-shell { backdrop-filter: none; }
    body.night-mode .dock { background: rgba(10, 10, 30, 0.8); border-color: #333; }
    body.night-mode .dock-btn { filter: grayscale(100%) brightness(200%); }
    body.night-mode .btn-action { background: #483d8b; color: #e6e6fa; box-shadow: 0 4px 0 #282250; }
    
    body.night-mode input, body.night-mode textarea, body.night-mode .id-card-wrap { 
        background: rgba(10,10,20,0.6) !important; 
        color: #e6e6fa !important; 
        border: 1px solid #483d8b !important; 
        font-family: var(--font-mono) !important;
    }
    body.night-mode h2 { 
        background: transparent !important; 
        color: #e6e6fa !important; 
        text-shadow: 0 0 10px rgba(230, 230, 250, 0.5);
        font-family: var(--font-mono) !important;
        border: 1px solid #483d8b;
    }
    
    body.night-mode .bio-container {
        background: rgba(15, 15, 30, 0.9) !important;
        border: 1px solid rgba(126, 87, 194, 0.3);
        box-shadow: 0 0 20px rgba(0,0,0,0.5);
    }

    /* --- WALLPAPERS --- */
    .bg-apple { background-image: url('https://i.postimg.cc/jSy15jN8/254dfc0d0652f67805de02ae1113f60a.jpg') !important; background-size: cover !important; background-attachment: fixed !important; }
    .bg-polka-brown { background-image: url('https://i.postimg.cc/yNBbSzXn/53f33a2e730b5174988e4d58c7e6fbb7.jpg') !important; background-size: cover !important; background-attachment: fixed !important; }
    .bg-clover { background-image: url('https://i.postimg.cc/Xv3zy0cw/684495e309f1e7a6b1d1609f033f905c.jpg') !important; background-size: cover !important; background-attachment: fixed !important; }
    .bg-stars-blue { background-image: url('https://i.postimg.cc/Jhm2BWcq/7cf07749dc2fcf775ffc407e42a0a53e.jpg') !important; background-size: cover !important; background-attachment: fixed !important; }
    .bg-bow-y2k { background-image: url('https://i.postimg.cc/YSksmwfs/86c8380a6558035b88292bba20ec14c1.jpg') !important; background-size: cover !important; background-attachment: fixed !important; }
    .bg-stars-bw { background-image: url('https://i.postimg.cc/TPG4WXqj/8da7b8d48d6823657b54988755d60dd9.jpg') !important; background-size: cover !important; background-attachment: fixed !important; }
    .bg-music-pink { background-image: url('https://i.postimg.cc/Xv3zy0ck/bd4efa7fd2209b10fc4725c471ece520.jpg') !important; background-size: cover !important; background-attachment: fixed !important; }
    .bg-stars-classic { background-image: url('https://i.postimg.cc/6QwmGNLL/d0d6e91da0105b958697e57a47a0d4ca.jpg') !important; background-size: cover !important; background-attachment: fixed !important; }
    .bg-bow-classic { background-image: url('https://i.postimg.cc/DzFMbKd6/f17eaffa8a2d53f205b6e7b2718ff2ae.jpg') !important; background-size: cover !important; background-attachment: fixed !important; }
    .bg-strawberry { background-image: url('https://i.postimg.cc/43ZShTb6/f9fc99a5267ad98f2760ee5846f21607.jpg') !important; background-size: cover !important; background-attachment: fixed !important; }
    .bg-heart-bp { background-image: url('https://i.postimg.cc/KYFHgyDX/Untitled83_20260118063949.jpg') !important; background-size: cover !important; background-attachment: fixed !important; }
    .bg-polka-classic { background-image: url('https://i.postimg.cc/6QwmGNfB/Untitled84_20260118064140.jpg') !important; background-size: cover !important; background-attachment: fixed !important; }
    
    /* --- VISUAL FX --- */  
    .scanlines {  
        position: fixed; top: 0; left: 0; right: 0; bottom: 0; pointer-events: none; z-index: 9999; display: none;  
        background: linear-gradient(to bottom, rgba(255,255,255,0) 50%, rgba(0,0,0,0.1) 50%); background-size: 100% 4px;  
        animation: scan 60s linear infinite; opacity: 0.6;  
    }  
    .dream-overlay {  
        position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 9998; display: none;  
        background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.65' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)' opacity='0.05'/%3E%3C/svg%3E");  
        opacity: 0.5; mix-blend-mode: overlay;  
    }  
    body.fx-active .scanlines, body.fx-active .dream-overlay { display: block; }  
    @keyframes scan { 0% { background-position: 0 0; } 100% { background-position: 0 100%; } }  

    /* --- APP SHELL --- */  
    .app-shell {  
        width: 100%; max-width: 480px; 
        background: transparent; 
        display: none; flex-direction: column; position: relative; height: 100%;  
        z-index: 10; 
    }  
    
    body.fx-active .app-shell {
        backdrop-filter: blur(10px); 
        -webkit-backdrop-filter: blur(10px);
    }

    /* SCROLL CONTAINER */
    .content { 
        flex: 1; 
        overflow-y: auto; 
        overflow-x: hidden;
        padding: 20px; 
        padding-bottom: 120px;
        scroll-behavior: smooth; 
        -webkit-overflow-scrolling: touch; 
    }  
    
    .page { display: none; animation: popIn 0.3s; }  
    .page.active { display: block; }  
    @keyframes popIn { from {opacity:0; transform:scale(0.98);} to {opacity:1; transform:scale(1);} }  

    /* --- ALERT BANNER --- */
    .sys-alert {
        background: #ff4444; color: white; padding: 12px;
        font-weight: bold; display: none; justify-content: space-between;
        align-items: center; box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        z-index: 200; animation: slideDown 0.3s;
        border-bottom: 2px solid white;
        text-transform: uppercase; font-size: 0.9rem;
    }
    @keyframes slideDown { from {transform:translateY(-100%)} to {transform:translateY(0)} }

    /* --- ID CARD --- */  
    .id-card-wrap {  
        background: #fff; border-radius: 15px; padding: 0;  
        box-shadow: 0 10px 20px rgba(0,0,0,0.15); margin-bottom: 20px;   
        position: relative; overflow: hidden; border: 1px solid #ccc;  
        min-height: 270px;
        transform: translate3d(0,0,0); 
    }  
    .id-card-wrap::before {  
        content: ""; position: absolute; top: -50%; left: -50%; width: 200%; height: 200%;  
        background: linear-gradient(115deg, transparent 40%, rgba(255,0,150,0.2) 45%, rgba(0,255,255,0.3) 50%, rgba(255,255,0,0.2) 55%, transparent 60%);  
        mix-blend-mode: multiply; pointer-events: none; z-index: 10;  
        animation: foil 5s linear infinite; opacity: 0.6;  
        will-change: transform;
    }  
    @keyframes foil { 
        0% { transform: translate3d(0,0,0); } 
        100% { transform: translate3d(50%,50%,0); } 
    }  

    .id-inner { padding: 15px; height: 100%; display: flex; flex-direction: column; position: relative; z-index: 2; }  
    .id-header { border-bottom: 2px solid var(--main); padding-bottom: 5px; margin-bottom: 10px; display: flex; justify-content: space-between; font-weight: 900; letter-spacing: 1px; font-size: 0.7rem; color: #555; }  
    .id-main { display: flex; gap: 15px; margin-bottom: 10px; }  
    .id-photo { width: 90px; height: 110px; background: #eee; border: 1px solid #999; object-fit: cover; display: block; box-shadow: 2px 2px 5px rgba(0,0,0,0.1); }  
    .id-details { flex: 1; display: flex; flex-direction: column; justify-content: flex-start; gap: 5px; font-size: 0.7rem; }  
    .id-label { color: var(--main); font-weight: bold; font-size: 0.6rem; text-transform: uppercase; display:block; }  
    .id-val { color: #222; font-weight: bold; display: block; border-bottom: 1px dotted #ccc; width: 100%; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }  
    .bio-section { background: rgba(255,255,255,0.8); border: 1px solid #ddd; border-radius: 8px; padding: 8px; font-size: 0.75rem; color: #333; flex: 1; overflow-y: auto; max-height: 80px; margin-top: 5px; white-space: pre-wrap; }  

    /* --- DASHBOARD --- */  
    .dash-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 20px; }  
    .dash-btn { background: white; border: 2px solid #eee; border-radius: 18px; padding: 15px; text-align: center; font-weight: bold; cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }  
    .dash-btn:active { transform: scale(0.96); background: #f9f9f9; border-color: var(--main); }  

    /* --- BIO/ABOUT TAB --- */
    .bio-container { background: white; padding: 20px; border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
    .bio-list-box { 
        border: 2px dashed #eee; padding: 10px; border-radius: 10px; min-height: 60px; 
        display: flex; flex-wrap: wrap; gap: 5px; margin-bottom: 10px;
    }
    .bio-tag { 
        background: var(--main); color: white; padding: 4px 10px; border-radius: 15px; 
        font-size: 0.8rem; font-weight: bold; display: flex; align-items: center; gap: 5px;
    }
    .bio-tag span { cursor: pointer; opacity: 0.7; font-size: 0.7rem; }
    .bio-input-group { display: flex; gap: 5px; margin-bottom: 15px; }

    /* --- LOG TABLE --- */
    .log-table { width: 100%; border-collapse: collapse; font-size: 0.8rem; }
    .log-table th { text-align: left; border-bottom: 2px solid var(--main); padding: 5px; color: var(--main); }
    .log-table td { border-bottom: 1px solid #eee; padding: 8px 5px; color: #555; }
    .log-table tr:nth-child(even) { background: #f9f9f9; }

    /* --- CHAT --- */  
    .chat-shell { display: flex; height: 100%; border: 2px solid var(--main); border-radius: 15px; background: white; overflow: hidden; position:relative; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }  
    .channel-sidebar { width: 75px; background: #f0f0f0; border-right: 1px solid #e0e0e0; padding-top: 40px; display: flex; flex-direction: column; align-items: center; gap: 12px; overflow-y: auto; transition: margin-left 0.3s ease; }  
    .channel-sidebar.hidden { margin-left: -75px; }  
    .sidebar-toggle { position: absolute; top: 10px; left: 10px; z-index: 100; background: var(--main); color: white; border: none; border-radius: 50%; width: 25px; height: 25px; font-weight: bold; cursor: pointer; }  
    .chan-btn { width: 48px; height: 48px; border-radius: 50%; background: #ddd; display: flex; align-items: center; justify-content: center; font-weight: bold; color: #666; cursor: pointer; border: 2px solid white; position: relative; flex-shrink: 0; }  
    .chan-btn.active { background: var(--main); color: white; border-radius: 14px; }  
    .del-chan { position: absolute; top: -5px; right: -5px; background: red; color: white; width: 18px; height: 18px; border-radius: 50%; font-size: 10px; display: none; align-items: center; justify-content: center; }  
    .chan-btn:hover .del-chan { display: flex; }  
    .chat-view { flex: 1; display: flex; flex-direction: column; min-width: 0; }  
    .chat-feed { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 15px; background-image: radial-gradient(#f0f0f0 1px, transparent 1px); background-size: 20px 20px; }  
    .pk-msg { display: flex; gap: 10px; align-items: flex-start; cursor: pointer; }  
    .pk-msg:active { background: rgba(0,0,0,0.05); border-radius: 10px; }
    .pk-av { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; flex-shrink: 0; }  
    .pk-img { max-width: 150px; border-radius: 10px; margin-top: 5px; display: block; border: 2px solid #eee;}  
    .chat-input-area { padding: 10px; border-top: 1px solid #eee; display: flex; gap: 8px; align-items: center; background: #fafafa; }  

    /* --- PET --- */  
    .pet-stage { 
        height: 350px; position: relative; 
        border: 4px ridge var(--main); border-radius: 20px; 
        background: rgba(255,255,255,0.1); 
        box-shadow: 0 5px 15px rgba(0,0,0,0.1); 
        overflow: hidden; display: flex; align-items: center; justify-content: center; 
    }  
    .ebi-img { width: 160px; pointer-events: none; z-index: 5; margin-top: 60px; filter: drop-shadow(0 5px 5px rgba(0,0,0,0.1)); }  
    .sticker { position: absolute; cursor: grab; z-index: 10; user-select: none; width: 80px; height: auto; }
    .sticker img { width: 100%; pointer-events: none; display: block; }
    .speech-bubble {  
        position: absolute; top: 40px; left: 50%; transform: translateX(-50%) scale(0);  
        background: white; padding: 10px 15px; border-radius: 20px; border: 2px solid var(--main);  
        font-size: 0.8rem; font-weight: bold; z-index: 20; text-align: center;  
        transition: transform 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);  
        pointer-events: none; white-space: nowrap;  
    }  
    .speech-bubble.show { transform: translateX(-50%) scale(1); }  

    /* --- SYSTEM LOG CONSOLE --- */
    .console-box {
        background: rgba(40, 40, 40, 0.85); 
        border: 2px solid var(--main); border-radius: 10px; margin-top: 15px; padding: 10px; 
        font-family: var(--font-mono); color: #ffb7b2; font-size: 0.75rem; 
        box-shadow: 0 4px 10px rgba(0,0,0,0.1); position: relative; backdrop-filter: blur(4px); 
    }
    .console-header { border-bottom: 1px solid rgba(255,255,255,0.2); padding-bottom: 5px; margin-bottom: 5px; display: flex; justify-content: space-between; font-weight: bold; letter-spacing: 1px; }
    .console-log { height: 80px; overflow-y: auto; display: flex; flex-direction: column-reverse; }
    .log-line { margin-bottom: 2px; }
    .log-line::before { content: "> "; opacity: 0.6; }
    .ebi-chat-btn { position: absolute; bottom: 10px; right: 10px; background: var(--main); border: 2px solid white; border-radius: 50%; width: 35px; height: 35px; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; box-shadow: 0 2px 5px rgba(0,0,0,0.2); z-index: 20; }
    .ebi-chat-btn:active { transform: scale(0.9); }

    /* --- PHARMACY LOYALTY CARD --- */
    .loyalty-card {
        background-image: url('https://i.postimg.cc/9fr6qn0r/152f88be4a1ea59ecb8283bd71e01aa5.jpg');
        background-size: cover;
        padding: 15px; border-radius: 10px; border: 1px solid #ccc;
        box-shadow: 0 5px 15px rgba(0,0,0,0.1); margin-bottom: 15px; position: relative;
    }
    .loyalty-header { text-align: center; font-weight: bold; color: #555; font-size: 0.8rem; margin-bottom: 10px; border-bottom: 1px dashed #999; padding-bottom: 5px; text-transform: uppercase; letter-spacing: 1px; }
    .stamp-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; }
    .stamp-slot { 
        aspect-ratio: 1/1; border: 2px dashed #bbb; border-radius: 50%; 
        display: flex; align-items: center; justify-content: center; 
        background: rgba(255,255,255,0.5); position: relative;
    }
    .stamp-mark { width: 100%; height: 100%; object-fit: contain; transform: rotate(-15deg); opacity: 0.8; animation: stomp 0.2s; }
    @keyframes stomp { 0% { transform: scale(2) rotate(0deg); opacity: 0; } 100% { transform: scale(1) rotate(-15deg); opacity: 0.8; } }
    .reward-btn { 
        display: none; width: 100%; margin-top: 10px; background: #81c784; 
        color: white; border: none; padding: 10px; border-radius: 8px; 
        font-weight: bold; cursor: pointer; animation: pulse 1s infinite; 
    }
    @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.02); } 100% { transform: scale(1); } }

    /* --- NEW: REWARD OVERLAY (CONFETTI EXPLOSION) --- */
    #reward-overlay {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.8); z-index: 5000;
        display: none; flex-direction: column; align-items: center; justify-content: center;
        animation: fadeIn 0.5s;
    }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    
    .reward-card-big {
        width: 80%; max-width: 300px; height: 180px;
        background-image: url('https://i.postimg.cc/9fr6qn0r/152f88be4a1ea59ecb8283bd71e01aa5.jpg');
        background-size: cover;
        border-radius: 15px; border: 4px solid white;
        display: flex; align-items: center; justify-content: center;
        box-shadow: 0 0 50px rgba(255, 105, 180, 0.8);
        animation: bigPop 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }
    @keyframes bigPop { 0% { transform: scale(0) rotate(0deg); } 80% { transform: scale(1.1) rotate(5deg); } 100% { transform: scale(1) rotate(0deg); } }

    .reward-items {
        display: flex; gap: 10px; margin-top: 20px;
    }
    .reward-item {
        width: 60px; height: 60px; background: white; border-radius: 50%;
        border: 3px solid var(--main); display: flex; align-items: center; justify-content: center;
        font-size: 2rem; box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        opacity: 0; transform: translateY(20px);
        animation: slideUp 0.5s forwards;
    }
    .reward-item img { width: 80%; height: 80%; object-fit: contain; }
    @keyframes slideUp { to { opacity: 1; transform: translateY(0); } }

    .confetti {
        position: absolute; width: 10px; height: 10px; background: #ffd700;
        animation: fall 2s linear forwards;
    }
    @keyframes fall { to { transform: translateY(100vh) rotate(720deg); } }

    /* --- DREAM JOURNAL (NIGHT MODE) --- */
    .dream-entry { 
        background: rgba(255,255,255,0.1); padding: 10px; border-left: 3px solid #81c784; 
        margin-bottom: 10px; border-radius: 5px; color: inherit; 
    }
    .dream-blur { filter: blur(3px); transition: filter 0.3s; cursor: pointer; }
    .dream-blur:hover { filter: blur(0); }

    /* --- PHARMACY --- */  
    .receipt-paper { 
        background: #fff; padding: 15px; 
        font-family: 'Courier New', monospace; font-size: 0.8rem; 
        box-shadow: 0 5px 15px rgba(0,0,0,0.1); margin-bottom: 10px; position: relative; 
        border-top: 5px solid #333;
        background-image: linear-gradient(135deg, transparent 50%, #fff 50%), linear-gradient(45deg, #fff 50%, transparent 50%);
        background-size: 20px 20px;
        background-repeat: repeat-x;
        background-position: bottom;
        padding-bottom: 30px; 
    }  
    
    .mood-grid { 
        display: grid; 
        grid-template-columns: repeat(4, 1fr); 
        gap: 10px; 
        padding: 10px 0;
    }  
    .mood-btn { 
        background: white; 
        border: 2px solid #eee; 
        border-radius: 12px; 
        height: 55px; 
        font-size: 1.8rem; 
        cursor: pointer; 
        transition: transform 0.1s;
    }  
    .mood-btn:active { transform: scale(0.95); background: var(--main); border-color: var(--main); }

    /* --- UI COMPONENTS --- */  
    .btn-action { background: var(--main); color: white; padding: 12px; width: 100%; border: none; border-radius: 12px; font-weight: bold; cursor: pointer; margin-bottom: 5px; box-shadow: 0 4px 0 rgba(0,0,0,0.1); }  
    .btn-action:active { transform: translateY(3px); box-shadow: none; }  
      
    .dock { position: fixed; bottom: 25px; left: 20px; right: 20px; background: rgba(255,255,255,0.95); border-radius: 25px; padding: 12px 25px; display: flex; justify-content: space-between; box-shadow: 0 5px 25px rgba(0,0,0,0.15); z-index: 100; border: 2px solid white; }  
    .dock-btn { background: none; border: none; font-size: 1.6rem; cursor: pointer; opacity: 0.5; transition: 0.2s; }  
    .dock-btn.active { opacity: 1; transform: translateY(-8px); }  

    .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 2000; display: none; align-items: center; justify-content: center; padding: 20px; }  
    .modal-card { 
        background: white; width: 90%; max-width: 380px; border-radius: 25px; padding: 25px; 
        border: 4px ridge var(--main); 
        max-height: 80vh; 
        overflow-y: auto; 
        padding-bottom: 40px; 
    }  
    input, textarea { width: 100%; padding: 10px; margin-bottom: 8px; border: 2px inset #eee; border-radius: 10px; font-family: inherit;}  

    /* --- LOCK SCREEN --- */  
    #lock-screen { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: var(--main); z-index: 20000; display: none; flex-direction: column; align-items: center; justify-content: center; color: white; }  
    .pin-pad { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-top: 30px; }  
    .pin-btn { width: 70px; height: 70px; border-radius: 50%; border: 2px solid white; background: rgba(255,255,255,0.15); color: white; font-size: 1.8rem; display: flex; align-items: center; justify-content: center; cursor: pointer; }  

    /* --- DIARY --- */  
    .diary-entry { background: white; padding: 15px; border-radius: 12px; margin-bottom: 12px; border-left: 5px solid var(--main); position: relative; box-shadow: 2px 2px 5px rgba(0,0,0,0.05); color: #444; }  
    .del-diary { position: absolute; top: 8px; right: 8px; color: #ff4444; cursor: pointer; font-weight: bold; font-size: 0.9rem; padding: 5px; }  
    
    .file-upload-btn {
        display: block; width: 100%; padding: 10px; text-align: center; background: #eee;
        border-radius: 10px; margin-bottom: 10px; cursor: pointer; font-weight: bold; color: #555;
    }
</style>

</head>  
<body class="fx-active">  
<div class="scanlines"></div>  
<div class="dream-overlay"></div>  

<div id="reward-overlay" onclick="this.style.display='none'">
    <div class="reward-card-big">
        <h2 style="background:white; padding:5px; border-radius:5px;">REFILLED!</h2>
    </div>
    <div class="reward-items" id="reward-items-container"></div>
</div>

<div id="welcome-screen" style="position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.9); z-index:3000; display:flex; flex-direction:column; align-items:center; justify-content:center;">  
    <div style="font-size:4rem; margin-bottom:10px;">üíæ</div>  
    <h1 style="color:var(--main); margin:0 0 10px 0;">SEIREN OS</h1>  
    <p style="font-size:0.8rem; color:#666; margin-bottom:30px;">Guest Mode Active</p>  
    <button class="btn-action" style="width:220px;" onclick="enterSystem()">Enter System</button>  
    
    <label class="btn-action" style="width:220px; background:#4fc3f7; text-align:center; display:block; cursor:pointer;">  
        üìÇ Load Backup  
        <input type="file" id="backup-input" style="display:none;" onchange="importData(this)">  
    </label>

    <label class="btn-action" style="width:220px; background:#7e57c2; text-align:center; display:block; cursor:pointer; margin-top:10px;">  
        üëæ Import PluralKit  
        <input type="file" id="pk-input" style="display:none;" onchange="importPluralKit(this)">  
    </label>
</div>  

<div id="lock-screen">  
    <div style="font-size:4rem; margin-bottom:10px;">üîí</div>  
    <h3>SYSTEM LOCKED</h3>  
    <div id="pin-dots" style="font-size:3rem; letter-spacing:15px; height:60px; font-family:monospace;"></div>  
    <div class="pin-pad">  
        <div class="pin-btn" onclick="enterPin(1)">1</div><div class="pin-btn" onclick="enterPin(2)">2</div><div class="pin-btn" onclick="enterPin(3)">3</div>  
        <div class="pin-btn" onclick="enterPin(4)">4</div><div class="pin-btn" onclick="enterPin(5)">5</div><div class="pin-btn" onclick="enterPin(6)">6</div>  
        <div class="pin-btn" onclick="enterPin(7)">7</div><div class="pin-btn" onclick="enterPin(8)">8</div><div class="pin-btn" onclick="enterPin(9)">9</div>  
        <div class="pin-btn" style="opacity:0"></div><div class="pin-btn" onclick="enterPin(0)">0</div><div class="pin-btn" style="background:rgba(255,200,200,0.3)" onclick="clearPin()">C</div>  
    </div>  
</div>  

<div class="app-shell" id="app">  
    <div id="sys-alert" class="sys-alert">
        <span id="sys-alert-msg"></span>
        <button onclick="dismissAlert()" style="background:transparent; border:none; color:white; font-weight:bold; cursor:pointer;">X</button>
    </div>

    <div class="content">
        <div id="page-dash" class="page active" style="padding-top:20px;">  
            <div class="id-card-wrap">  
                <div class="id-inner">  
                    <div class="id-header">  
                        <span id="sys-name-display">SEIREN OS</span>  
                        <span>GLIMMER ID</span>  
                    </div>  
                    <div class="id-main">  
                        <img id="dash-av" class="id-photo" src="">  
                        <div class="id-details">  
                            <div><span class="id-label">NAME</span><span class="id-val" id="dash-name">Guest</span></div>  
                            <div style="display:flex; gap:10px;">  
                                <div style="flex:1;"><span class="id-label">AGE</span><span class="id-val" id="dash-age">--</span></div>  
                                <div style="flex:1;"><span class="id-label">HEIGHT</span><span class="id-val" id="dash-height">--</span></div>  
                            </div>  
                            <div style="display:flex; gap:10px;">  
                                <div style="flex:1;"><span class="id-label">SIGN</span><span class="id-val" id="dash-sign">--</span></div>  
                                <div style="flex:1;"><span class="id-label">SPECIES</span><span class="id-val" id="dash-species">--</span></div>  
                            </div>  
                            <div id="cofront-row" style="display:none; margin-top:5px;">
                                <span class="id-label">CO-CON</span>
                                <span class="id-val" id="dash-co"></span>
                            </div>
                        </div>  
                    </div>  
                    <span class="id-label">PERSONNEL NOTES</span>  
                    <div class="bio-section" id="dash-bio">  
                        Official System Member  
                    </div>  
                </div>  
            </div>  

            <div style="background:white; padding:12px; border-radius:15px; text-align:center; margin-bottom:20px; border:2px inset #eee; color:#666;">  
                <b>XP Points:</b> <span id="cp-display" style="color:var(--main); font-weight:bold; font-size:1.2rem;">0</span>  
            </div>  

            <div class="dash-grid">  
                <div class="dash-btn" onclick="openProfileModal()"><span>üë•</span><br>Switch/Edit</div>  
                <div class="dash-btn" onclick="openSettingsModal()"><span>‚öôÔ∏è</span><br>Settings</div>  
                <div class="dash-btn" onclick="openBackpack()"><span>üéí</span><br>Items</div>  
                <div class="dash-btn" onclick="nav('about')"><span>üë§</span><br>About Me</div>  
            </div>  
            
            <button class="btn-action" style="background:#607d8b; margin-top:25px; width:auto; font-size:0.8rem;" onclick="exportData()">üíæ Save Backup</button>  
        </div>  

        <div id="page-about" class="page" style="padding-top:20px;">
            <h2 style="color:var(--main); text-align:center; background:white; border-radius:10px; display:inline-block; padding:5px 15px; margin:0 auto 15px auto; display:table;">About Me</h2>
            
            <div class="bio-container">
                <h4 style="color:#555; margin:0 0 5px 0;">üíñ Likes</h4>
                <div id="likes-list" class="bio-list-box"></div>
                <div class="bio-input-group">
                    <input type="text" id="like-in" placeholder="Add like..." style="margin:0;">
                    <button class="btn-action" style="width:auto; margin:0;" onclick="addBioItem('likes')">+</button>
                </div>

                <h4 style="color:#555; margin:15px 0 5px 0;">üö´ Dislikes</h4>
                <div id="dislikes-list" class="bio-list-box"></div>
                <div class="bio-input-group">
                    <input type="text" id="dislike-in" placeholder="Add dislike..." style="margin:0;">
                    <button class="btn-action" style="width:auto; margin:0;" onclick="addBioItem('dislikes')">+</button>
                </div>

                <h4 style="color:#555; margin:15px 0 5px 0;">üìù Notes / Triggers</h4>
                <textarea id="notes-in" style="height:100px;" placeholder="Extra details here..." onblur="saveBioNotes()"></textarea>
            </div>
        </div>

        <div id="page-chat" class="page" style="height:100%; padding-bottom:80px;">  
            <div class="chat-shell">  
                <button class="sidebar-toggle" onclick="toggleSidebar()">&lt;</button>  
                <div class="channel-sidebar" id="chan-list"></div>  
                <div class="chat-view">  
                    <div class="chat-header">  
                        <span id="chan-title">#general</span>  
                        <button class="btn-action" style="width:auto; padding:2px 8px; font-size:0.7rem; margin:0; background:#ff4444;" onclick="sendAlert()">‚ö†Ô∏è Broadcast</button>
                    </div>  
                    <div class="chat-feed" id="chat-feed"></div>  
                    <div class="chat-input-area">  
                        <label style="cursor:pointer; font-size:1.5rem; color:#888;">üìé<input type="file" accept="image/*" style="display:none;" onchange="handleChatImage(this)"></label>  
                        <input type="text" id="msg-in" style="width:100%; margin:0;" placeholder="Message...">  
                        <button class="btn-action" style="width:auto; margin:0;" onclick="sendMsg()">Send</button>  
                    </div>  
                </div>  
            </div>  
        </div>  

        <div id="page-pharmacy" class="page">  
            <h2 style="color:var(--main); text-align:center; margin-bottom:15px; background:white; border-radius:10px; display:inline-block; padding:5px 15px;">Pharmacy & Care</h2>  
            
            <div class="loyalty-card">
                <div class="loyalty-header">Seiren Clinic ‚Ä¢ Patient Card</div>
                <div class="stamp-grid" id="stamp-grid"></div>
                <button id="reward-btn" class="reward-btn" onclick="claimRewardAnimation()">
                    <img src="https://i.postimg.cc/8C9qdmfN/a3f6c6b70ab5af6f58240dba296b7556.png" style="width:30px; vertical-align:middle; margin-right:5px;">
                    CLAIM REFILL
                </button>
            </div>

            <div style="background:white; padding:15px; border-radius:15px; border:2px solid var(--main);">  
                <div id="receipt-list" class="receipt-paper"></div>  
                
                <div style="text-align:center; margin-bottom:5px; font-size:0.7rem; color:#888;">LOG SYMPTOMS:</div>  
                <div class="mood-grid">  
                    <button class="mood-btn" onclick="logMood('üòä Happy', 5)">üòä</button>  
                    <button class="mood-btn" onclick="logMood('üò¢ Sad', 10)">üò¢</button>  
                    <button class="mood-btn" onclick="logMood('üò° Angry', 10)">üò°</button>  
                    <button class="mood-btn" onclick="logMood('üåÄ Anxious', 15)">üåÄ</button>  
                    <button class="mood-btn" onclick="logMood('üí§ Tired', 5)">üí§</button>  
                    <button class="mood-btn" onclick="logMood('‚ú® Hyper', 5)">‚ú®</button>  
                    <button class="mood-btn" onclick="logMood('üíÄ Dead', 15)">üíÄ</button>  
                    <button class="mood-btn" onclick="logMood('üíñ Loved', 5)">üíñ</button>  
                    <button class="mood-btn" onclick="logMood('üò∞ Panic', 15)">üò∞</button>  
                    <button class="mood-btn" onclick="logMood('üå´Ô∏è Numb', 10)">üå´Ô∏è</button>  
                    <button class="mood-btn" onclick="logMood('‚ö° Manic', 15)">‚ö°</button>  
                    <button class="mood-btn" onclick="logMood('ü•Ä Lonely', 10)">ü•Ä</button>  
                    <button class="mood-btn" onclick="logMood('üé™ Silly', 5)">üé™</button>  
                    <button class="mood-btn" onclick="logMood('ü©π Hurt', 10)">ü©π</button>  
                    <button class="mood-btn" onclick="logMood('üéÆ Bored', 5)">üéÆ</button>  
                    <button class="mood-btn" onclick="logMood('üß∏ Soft', 5)">üß∏</button>  
                    <button class="mood-btn" onclick="logMood('ü§¢ Sick', 15)">ü§¢</button>  
                    <button class="mood-btn" onclick="logMood('ü§Ø Overwhelmed', 15)">ü§Ø</button>  
                    <button class="mood-btn" onclick="logMood('ü•∫ Sensitive', 10)">ü•∫</button>  
                    <button class="mood-btn" onclick="logMood('üò§ Frustrated', 10)">üò§</button>
                    <button class="mood-btn" onclick="logMood('üçº Little', 10)">üçº</button>
                    <button class="mood-btn" onclick="logMood('üò∂ Non-verbal', 10)">üò∂</button>
                    <button class="mood-btn" onclick="logMood('üå´Ô∏è Dissociated', 15)">üå´Ô∏è</button>
                    <button class="mood-btn" onclick="logMood('üí• Overstimulated', 15)">üí•</button>
                </div>  

                <button class="btn-action" style="margin-top:10px; background:#78909c;" onclick="processReceipt()">Print Receipt (+Self Care)</button>  
                <button class="btn-action" style="margin-top:10px; background:#4db6ac;" onclick="fillPrescription()">üíä Fill Rx (50 XP)</button>  
            </div>  
        </div>  

        <div id="page-pet" class="page">  
            <h2 style="color:var(--main); text-align:center; background:white; border-radius:10px; display:inline-block; padding:5px 15px;">Patient Room</h2>  
            <div class="pet-stage" id="pet-stage">  
                <div id="decor-layer"></div>  
                <div id="pet-speech" class="speech-bubble">Hello!</div>  
                <img src="https://i.postimg.cc/13FQckct/Untitled-Artwork-20260110072840-20260110074706.png" class="ebi-img">  
            </div>  
            
            <div class="console-box">
                <div class="console-header">
                    <span>SYSTEM LOG</span>
                    <span>v1.0</span>
                </div>
                <div class="console-log" id="console-log-feed"></div>
                <button class="ebi-chat-btn" onclick="triggerEbiChat()">üí¨</button>
            </div>
        </div>  

        <div id="page-dream" class="page">
            <h2 style="text-align:center;">Dream Journal</h2>
            <div class="bio-container">
                <label>Location (In Between):</label>
                <input type="text" id="dream-loc" placeholder="e.g. The Pool Rooms">
                
                <label>Clarity (Fuzzy -> Hyper-Real):</label>
                <input type="range" id="dream-clear" min="1" max="10" style="width:100%;">
                
                <label>Visitors:</label>
                <input type="text" id="dream-ent" placeholder="Who was there?">
                
                <label>Residue (Feeling):</label>
                <input type="text" id="dream-feel" placeholder="e.g. Cold, Nostalgic">
                
                <label>Memory Dump:</label>
                <textarea id="dream-text" style="height:80px;"></textarea>
                
                <button class="btn-action" style="background:#7e57c2;" onclick="saveDream()">Log Dream</button>
            </div>
            <div id="dream-feed" style="margin-top:20px;"></div>
        </div>

        <div id="page-diary" class="page">  
            <h2 style="color:var(--main); text-align:center; background:white; border-radius:10px; display:inline-block; padding:5px 15px;">Diary</h2>  
            <textarea id="diary-in" style="width:100%; height:100px;" placeholder="Entry..."></textarea>  
            <button class="btn-action" onclick="postDiary()">Save</button>  
            <div id="diary-feed" style="margin-top:20px;"></div>  
        </div> 
    </div> 

    <div class="dock">  
        <button class="dock-btn active" onclick="nav('dash')">üè†</button>  
        <button class="dock-btn" onclick="nav('pharmacy')">üè•</button>  
        <button class="dock-btn" onclick="nav('pet')">üç§</button>  
        <button class="dock-btn" onclick="nav('chat')">üí¨</button>  
        <button class="dock-btn" onclick="nav('diary')">üìì</button>  
        <button class="dock-btn" onclick="toggleNightMode()">üåô</button>
    </div>
</div>  

<script>  
    // ... (STATE & LOOT_ITEMS are the same) ...
    let DB = {  
        sysName: "SEIREN OS",  
        profiles: [], active: 0, xp: 0, 
        inventory: [], decor: [], cofront: [], frontHistory: [], consoleHistory: ["System Initialized..."], 
        dreamLog: [], stamps: 0, 
        currentFrontStart: 0, activeAlert: null, lock: null, channels: { 'gen': {name:'general', msgs:[]} }, curChan: 'gen',  
        diary: [], settings: { crt: true }  
    };  
    let pendingXP = 0; let tempPin = ""; let uploadedAv = ""; let chatImg = "";  
    let isSelling = false; let selectedMsgIndex = -1; 

    const LOOT_ITEMS = [
        "bg-apple", "bg-polka-brown", "bg-clover", "bg-stars-blue", "bg-bow-y2k", "bg-stars-bw", "bg-music-pink", "bg-stars-classic", "bg-bow-classic", "bg-strawberry", "bg-heart-bp", "bg-polka-classic",
        "https://i.postimg.cc/4dFyJtrX/12d9131d2320519e1e23f5f678427396.png",
        "https://i.postimg.cc/zBPvJW46/3e4f2fa5b124701b5f17089d9ab9b737.png",
        "https://i.postimg.cc/hjGhWMZ5/62695aafc7da6361407abf3a87ecafb6.png",
        "https://i.postimg.cc/1tYX96bb/65794fc54d21b0cdd7b3db4e813c6b11.png",
        "https://i.postimg.cc/4dFyJtrR/9add2a23fa78c0e9fcc21c3a394b02cd.png",
        "https://i.postimg.cc/bJFrzbKc/ed8d7acf0f1516a1b3de4b9df6a3b048.png",
        "https://i.postimg.cc/DyG0TS6t/2f0f42dbd7882d400c9e4f651c9d438d.png",
        "https://i.postimg.cc/P5kxrdFT/363a54d905dfd329fb095af572d6d580.png",
        "https://i.postimg.cc/8k9c9RR9/42616c918cd958cc301cb745852ff27e.png",
        "https://i.postimg.cc/tC6JjsD4/45ca3463cef73aa5c917b57ac0cfd971.png",
        "https://i.postimg.cc/FF8z8yb5/56e20c61dbf4feb80179606c2699d5f1.png",
        "https://i.postimg.cc/CL85gR7v/607d0537e36c5788fe96007288ae5ccc.png",
        "https://i.postimg.cc/05FjFYYL/69e61b8d6420f427e4ac42a32f49eddf.png",
        "https://i.postimg.cc/66gqgrr1/6b1bb26664a8aafcd16a6d4436bcf54a.png",
        "https://i.postimg.cc/PrDJjCKh/7e91ebbf0419972863f456a8aa7c904b.png",
        "https://i.postimg.cc/28WyD1Gs/93e86c6d6b567ece1a03b6c04d04892c.png",
        "https://i.postimg.cc/nhtzcnwr/a09248b8a40f6c9f22285635b90be653.png",
        "https://i.postimg.cc/Mp8TKzrp/abb690b3250b998f75bbc788f7154c55.png",
        "https://i.postimg.cc/fRhLTMgT/af7f389e3f9e09024197d9e164ad33e2.png",
        "https://i.postimg.cc/qMKqTNQt/d1b701f32c7e48282f4a20be48a7fd3f.png",
        "https://i.postimg.cc/vHnTs4Xm/d3092ebc83ae4814d0e75e1af83646e1.png",
        "https://i.postimg.cc/WpCzCGGx/d754b77bd5a2ef644d29367b5ca3a51b.png",
        "https://i.postimg.cc/ncmrJXT8/da7d72fedbce39a1f0d35f89c184c29f.png",
        "https://i.postimg.cc/DyG0TS5f/da828bc90e8f772100995a682a906233.png",
        "https://i.postimg.cc/x1SCT9Fj/deb771ba2ff74c9af0871e8af7bb4cc0.png",
        "https://i.postimg.cc/pXjrHmC1/eb31aaf8301282152f43f7050b39a5fd.png",
        "https://i.postimg.cc/SN9RhnVJ/ee455254fdc48289bf096e1eb048e089.png",
        "https://i.postimg.cc/KvTj21fw/f91a9c969269fdedf2e437391eda83e8.png"
    ];
    const EBI_TALK = ["Thank you!", "I feel better!", "Yummy!", "So cozy!", "Yay!", "Take care!", "Hydrate!", "Rest up!"];
    const SELF_CARE = ["Drink a glass of water", "Stretch for 2 mins", "Fix your posture", "Take a deep breath"];
    const DEFAULT_AV = "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Crect width='100' height='100' fill='%23f0f0f0'/%3E%3Ccircle cx='50' cy='40' r='20' fill='%23ccc'/%3E%3Cpath d='M20,90 Q50,60 80,90' fill='%23ccc'/%3E%3C/svg%3E";
    const BG_ICONS = { 'bg-apple': 'üçé', 'bg-polka-brown': 'üü§', 'bg-clover': 'üçÄ', 'bg-stars-blue': '‚≠ê' }; // (Shortened for brevity)

    window.onload = () => {  
        const saved = localStorage.getItem('seiren_fixed_v87'); 
        if(saved) { try { DB = JSON.parse(saved); } catch(e) {} }  
        if(DB.profiles.length === 0) DB.profiles.push({ name: "Guest", av: DEFAULT_AV, color: "#ff69b4", id: "GUEST" });
        
        // Init missing fields
        if(!DB.cofront) DB.cofront = [];
        if(!DB.frontHistory) DB.frontHistory = [];
        if(!DB.consoleHistory) DB.consoleHistory = ["System Initialized..."];
        if(!DB.dreamLog) DB.dreamLog = [];
        if(!DB.stamps) DB.stamps = 0;
        
        loadUI(); renderStamps(); renderConsole(); // FORCE RENDER STAMPS
    };  

    // ... (Navigation, Diary, Decor, Chat functions same as previous) ...

    // --- PHARMACY ---  
    function logMood(i,p) { document.getElementById('receipt-list').innerHTML += `<div style="border-bottom:1px dotted #ccc; margin-bottom:5px;">${i} ... ${p} XP</div>`; pendingXP+=p; }  
    
    function processReceipt() { 
        if(pendingXP>0){ 
            DB.xp+=pendingXP; 
            DB.stamps = (DB.stamps || 0) + 1; 
            if(DB.stamps > 10) DB.stamps = 10; 
            
            const task = SELF_CARE[Math.floor(Math.random()*SELF_CARE.length)]; 
            alert(`‚úÖ Receipt Processed\n+${pendingXP} XP\nTask: "${task}"\n\nüíä STAMP ADDED`); 
            
            logToConsole(`Processed: +${pendingXP} XP`); 
            pendingXP=0; 
            document.getElementById('receipt-list').innerHTML=""; 
            save(); loadUI(); renderStamps(); // UPDATE UI
        } 
    }  
    
    function renderStamps() {
        const grid = document.getElementById('stamp-grid');
        if(!grid) return;
        grid.innerHTML = "";
        for(let i=0; i<10; i++) {
            const slot = document.createElement('div');
            slot.className = 'stamp-slot';
            if(i < DB.stamps) {
                slot.innerHTML = '<img src="https://i.postimg.cc/q7zPC5qM/ec9635acf11fbbb9c3b0bbfec3b6eb30.png" class="stamp-mark">';
            }
            grid.appendChild(slot);
        }
        
        const btn = document.getElementById('reward-btn');
        if(DB.stamps >= 10) {
            btn.style.display = 'block';
        } else {
            btn.style.display = 'none';
        }
    }

    // --- NEW REWARD ANIMATION ---
    function claimRewardAnimation() {
        const overlay = document.getElementById('reward-overlay');
        const container = document.getElementById('reward-items-container');
        container.innerHTML = ""; // Clear old
        
        // 1. Generate Rewards
        let rewards = [];
        for(let i=0; i<3; i++) {
            let item = LOOT_ITEMS[Math.floor(Math.random()*LOOT_ITEMS.length)];
            rewards.push(item);
            DB.inventory.push(item); // Add to inventory immediately
        }
        DB.stamps = 0; // Reset stamps
        save(); renderStamps(); loadUI();

        // 2. Show Overlay
        overlay.style.display = 'flex';
        
        // 3. Spawn Confetti
        for(let i=0; i<30; i++) {
            let conf = document.createElement('div');
            conf.className = 'confetti';
            conf.style.left = Math.random() * 100 + 'vw';
            conf.style.backgroundColor = ['#ff69b4', '#87ceeb', '#ffd700', '#98fb98'][Math.floor(Math.random()*4)];
            conf.style.animationDuration = (Math.random() * 2 + 1) + 's';
            overlay.appendChild(conf);
            setTimeout(() => conf.remove(), 3000);
        }

        // 4. Show Items with Delay
        setTimeout(() => {
            rewards.forEach((item, idx) => {
                let div = document.createElement('div');
                div.className = 'reward-item';
                div.style.animationDelay = (idx * 0.2) + 's';
                
                if(item.startsWith('http')) {
                    div.innerHTML = `<img src="${item}">`;
                } else if(item.startsWith('bg-')) {
                    div.innerText = "üñºÔ∏è";
                } else {
                    div.innerText = item;
                }
                container.appendChild(div);
            });
        }, 600);
    }

    // ... (Rest of functions: fillPrescription, console logic, dream journal, misc) ...
    // Note: Use previous code for nav, postDiary, etc. they are unchanged.
    
    function logToConsole(msg) {
        if(!DB.consoleHistory) DB.consoleHistory = [];
        const time = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        DB.consoleHistory.push(`${time} - ${msg}`);
        if(DB.consoleHistory.length > 50) DB.consoleHistory.shift(); 
        save(); renderConsole();
    }
    function renderConsole() {
        const feed = document.getElementById('console-log-feed');
        if(!feed) return;
        feed.innerHTML = "";
        if(DB.consoleHistory) { [...DB.consoleHistory].reverse().forEach(line => { feed.innerHTML += `<div class="log-line">${line}</div>`; }); }
    }
    function triggerEbiChat() {
        const quote = EBI_TALK[Math.floor(Math.random()*EBI_TALK.length)];
        logToConsole(`Ebi says: "${quote}"`);
        const bub = document.getElementById('pet-speech'); bub.innerText = quote; bub.classList.add('show'); setTimeout(()=>bub.classList.remove('show'), 2000); 
    }
    function toggleNightMode() { document.body.classList.toggle('night-mode'); if(document.body.classList.contains('night-mode')) nav('dream'); else nav('dash'); }
    function saveDream() {
        const loc=document.getElementById('dream-loc').value, clr=document.getElementById('dream-clear').value, ent=document.getElementById('dream-ent').value, feel=document.getElementById('dream-feel').value, txt=document.getElementById('dream-text').value;
        if(txt||loc){ DB.dreamLog.unshift({d:new Date().toLocaleDateString(), loc, clr, ent, feel, txt}); 
        document.getElementById('dream-loc').value=""; document.getElementById('dream-ent').value=""; document.getElementById('dream-feel').value=""; document.getElementById('dream-text').value=""; save(); renderDreamLog(); }
    }
    function renderDreamLog() {
        const f=document.getElementById('dream-feed'); f.innerHTML="";
        DB.dreamLog.forEach((d,i)=>{ f.innerHTML+=`<div class="dream-entry"><div class="dream-blur" onclick="this.classList.remove('dream-blur')"><small style="opacity:0.7;">${d.d} ‚Ä¢ ${d.loc||'Unknown'} ‚Ä¢ Clarity: ${d.clr}/10</small><br>${d.ent?`<strong>Visitors:</strong> ${d.ent}<br>`:''}${d.feel?`<strong>Residue:</strong> ${d.feel}<br>`:''}<p style="margin-top:5px;">${d.txt}</p></div><button style="color:red; background:none; border:none; float:right; cursor:pointer;" onclick="if(confirm('Forget this dream?')){DB.dreamLog.splice(${i},1); save(); renderDreamLog();}">x</button></div>`; });
    }
    function nav(id) { document.querySelectorAll('.page').forEach(p=>p.classList.remove('active')); document.getElementById('page-'+id).classList.add('active'); document.querySelectorAll('.dock-btn').forEach(b=>b.classList.remove('active')); if(id==='pet')renderDecor(); if(id==='chat')renderChat(); if(id==='diary')renderDiary(); if(id==='about')renderBio(); if(id==='dream')renderDreamLog(); }  
    function postDiary() { const t=document.getElementById('diary-in'); if(t.value){ DB.diary.unshift({d:new Date().toLocaleDateString(), n:DB.profiles[DB.active].name, uid: DB.profiles[DB.active].id, t:t.value}); t.value=""; save(); renderDiary(); } }  
    function renderDiary() { const f=document.getElementById('diary-feed'); f.innerHTML=""; const currentID = DB.profiles[DB.active].id; const myEntries = DB.diary.filter(e => e.uid === currentID || !e.uid); myEntries.forEach((e,i)=>{ f.innerHTML+=`<div class="diary-entry"><div class="del-diary" onclick="if(confirm('Del?')){DB.diary.splice(${DB.diary.indexOf(e)},1);save();renderDiary();}">x</div><small>${e.d} ‚Ä¢ ${e.n}</small><div style="white-space:pre-wrap;">${e.t}</div></div>`; }); }
    function closeModals() { document.querySelectorAll('.modal').forEach(m=>m.style.display='none'); }  
    function openSettingsModal() { document.getElementById('modal-settings').style.display='flex'; } 
    function toggleCRT() { DB.settings.crt = document.getElementById('toggle-crt').checked; loadUI(); save(); }  
    function enterPin(n) { tempPin+=n; document.getElementById('pin-dots').innerText="*".repeat(tempPin.length); if(tempPin.length===4){ if(tempPin===DB.lock){ document.getElementById('lock-screen').style.display='none'; document.querySelector('.app-shell').style.display='flex'; refreshAll(); } else { tempPin=""; document.getElementById('pin-dots').innerText="ERR"; }}}  
    function clearPin(){ tempPin=""; document.getElementById('pin-dots').innerText=""; }  
    function setLock(){ const p=document.getElementById('pin-set').value; if(p.length===4){ DB.lock=p; save(); alert("Locked!"); closeModals(); }}  
    function disableLock(){ if(confirm("Remove?")){ DB.lock=null; save(); alert("Removed"); closeModals(); }}  
    function exportData() { const a=document.createElement('a'); a.href="data:text/json;charset=utf-8,"+encodeURIComponent(JSON.stringify(DB)); a.download="seiren_bk.json"; document.body.appendChild(a); a.click(); a.remove(); }  
    function importData(input) { const file = input.files[0]; if(!file) return; const reader = new FileReader(); reader.onload=(e)=>{ try { const json = JSON.parse(e.target.result); DB = json; save(); alert("Backup Loaded Successfully!"); location.reload(); } catch(x) { alert("Error: Invalid Backup File."); console.error(x); } }; reader.readAsText(file); input.value = ""; }  
    
    // --- REGISTER SERVICE WORKER ---
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('sw.js')
                .then(reg => console.log('Seiren OS: Service Worker Registered!', reg))
                .catch(err => console.log('Seiren OS: SW Registration Failed', err));
        });
    }
</script>  
</body>  
</html>
