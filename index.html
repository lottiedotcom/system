<!DOCTYPE html>  
<html lang="en">  
<head>  
    <meta charset="UTF-8">  
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">  
    <meta name="apple-mobile-web-app-capable" content="yes">  
    <meta name="theme-color" content="#ff69b4">  
    <title>Seiren OS</title>  
    <link rel="manifest" href="manifest.json">  
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/2919/2919573.png">  
    <link rel="icon" type="image/png" href="https://cdn-icons-png.flaticon.com/512/2919/2919573.png">  

<style>  
    /* --- CORE VARIABLES --- */  
    :root {  
        --main: #ff69b4;   
        --font-main: 'Verdana', sans-serif;  
        --font-mono: 'Courier New', monospace;  
    }  

    * { box-sizing: border-box; user-select: none; -webkit-tap-highlight-color: transparent; }  

    body {  
        font-family: var(--font-main);  
        background-color: #ffe4e1;   
        background-image: radial-gradient(#ffb7b2 15%, transparent 16%), radial-gradient(#ffb7b2 15%, transparent 16%);  
        background-size: 20px 20px; background-position: 0 0, 10px 10px;  
        background-repeat: repeat;  
        background-attachment: fixed; 
        transition: all 0.8s ease;  
        margin: 0; display: flex; justify-content: center; height: 100vh; overflow: hidden;  
        color: #444;   
    }  

    /* --- NIGHT MODE (LIMINAL DREAM JOURNAL) --- */
    body.night-mode {
        background-color: #000 !important;
        background-image: none !important; 
        color: #b0c4de !important;
    }
    
    body.night-mode::before {
        content: "";
        position: fixed; top: 0; left: 0; right: 0; bottom: 0;
        background-image: url('https://i.postimg.cc/Zn1jB8Lc/Untitled86-20260119120235.jpg');
        background-size: cover; background-position: center; background-repeat: no-repeat;
        filter: blur(4px) brightness(0.8) contrast(1.1);
        transform: scale(1.1); z-index: -1;
        animation: dream-breathe 20s infinite alternate ease-in-out;
    }
    @keyframes dream-breathe { from { transform: scale(1.1); } to { transform: scale(1.2); } }

    body.night-mode .app-shell { backdrop-filter: none; }
    body.night-mode .dock { background: rgba(10, 10, 30, 0.8); border-color: #333; }
    body.night-mode .dock-btn { filter: grayscale(100%) brightness(200%); }
    body.night-mode .btn-action { background: #483d8b; color: #e6e6fa; box-shadow: 0 4px 0 #282250; }
    
    body.night-mode input, body.night-mode textarea, body.night-mode select, body.night-mode .id-card-wrap { 
        background: rgba(10,10,20,0.6) !important; 
        color: #e6e6fa !important; 
        border: 1px solid #483d8b !important; 
        font-family: var(--font-mono) !important;
    }
    
    body.night-mode .bio-container {
        background: rgba(15, 15, 30, 0.9) !important;
        border: 1px solid rgba(126, 87, 194, 0.3);
        box-shadow: 0 0 20px rgba(0,0,0,0.5);
    }

    /* --- WALLPAPERS --- */
    .bg-apple { background-image: url('https://i.postimg.cc/jSy15jN8/254dfc0d0652f67805de02ae1113f60a.jpg') !important; background-size: cover !important; background-attachment: fixed !important; }
    .bg-polka-brown { background-image: url('https://i.postimg.cc/yNBbSzXn/53f33a2e730b5174988e4d58c7e6fbb7.jpg') !important; background-size: cover !important; background-attachment: fixed !important; }
    .bg-clover { background-image: url('https://i.postimg.cc/Xv3zy0cw/684495e309f1e7a6b1d1609f033f905c.jpg') !important; background-size: cover !important; background-attachment: fixed !important; }
    .bg-stars-blue { background-image: url('https://i.postimg.cc/Jhm2BWcq/7cf07749dc2fcf775ffc407e42a0a53e.jpg') !important; background-size: cover !important; background-attachment: fixed !important; }
    .bg-bow-y2k { background-image: url('https://i.postimg.cc/YSksmwfs/86c8380a6558035b88292bba20ec14c1.jpg') !important; background-size: cover !important; background-attachment: fixed !important; }
    .bg-stars-bw { background-image: url('https://i.postimg.cc/TPG4WXqj/8da7b8d48d6823657b54988755d60dd9.jpg') !important; background-size: cover !important; background-attachment: fixed !important; }
    .bg-music-pink { background-image: url('https://i.postimg.cc/Xv3zy0ck/bd4efa7fd2209b10fc4725c471ece520.jpg') !important; background-size: cover !important; background-attachment: fixed !important; }
    .bg-stars-classic { background-image: url('https://i.postimg.cc/6QwmGNLL/d0d6e91da0105b958697e57a47a0d4ca.jpg') !important; background-size: cover !important; background-attachment: fixed !important; }
    .bg-bow-classic { background-image: url('https://i.postimg.cc/DzFMbKd6/f17eaffa8a2d53f205b6e7b2718ff2ae.jpg') !important; background-size: cover !important; background-attachment: fixed !important; }
    .bg-strawberry { background-image: url('https://i.postimg.cc/43ZShTb6/f9fc99a5267ad98f2760ee5846f21607.jpg') !important; background-size: cover !important; background-attachment: fixed !important; }
    .bg-heart-bp { background-image: url('https://i.postimg.cc/KYFHgyDX/Untitled83_20260118063949.jpg') !important; background-size: cover !important; background-attachment: fixed !important; }
    .bg-polka-classic { background-image: url('https://i.postimg.cc/6QwmGNfB/Untitled84_20260118064140.jpg') !important; background-size: cover !important; background-attachment: fixed !important; }
    
    /* NEW WALLPAPERS */
    .bg-stars-2 { background-image: url('https://i.postimg.cc/XYfPyYDs/Untitled86_20260119115349.jpg') !important; background-size: cover !important; background-attachment: fixed !important; }
    .bg-heart-pink { background-image: url('https://i.postimg.cc/dV2fTVS4/Untitled86_20260119115047.jpg') !important; background-size: cover !important; background-attachment: fixed !important; }
    .bg-stars-y2k { background-image: url('https://i.postimg.cc/nrX5sK67/Untitled86_20260119115537.jpg') !important; background-size: cover !important; background-attachment: fixed !important; }
    .bg-stars-pink { background-image: url('https://i.postimg.cc/wM1Pt5Sc/Untitled86_20260119115338.jpg') !important; background-size: cover !important; background-attachment: fixed !important; }
    .bg-heart-by { background-image: url('https://i.postimg.cc/NFKVy8Wx/Untitled86_20260119115121.jpg') !important; background-size: cover !important; background-attachment: fixed !important; }
    .bg-polka-pink { background-image: url('https://i.postimg.cc/WzdKDmQw/Untitled85_20260119113009.jpg') !important; background-size: cover !important; background-attachment: fixed !important; }

    /* --- VISUAL FX --- */  
    .scanlines {  
        position: fixed; top: 0; left: 0; right: 0; bottom: 0; pointer-events: none; z-index: 9999; display: none;  
        background: linear-gradient(to bottom, rgba(255,255,255,0) 50%, rgba(0,0,0,0.1) 50%); background-size: 100% 4px;  
        animation: scan 60s linear infinite; opacity: 0.6;  
    }  
    .dream-overlay {  
        position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 9998; display: none;  
        background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.65' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)' opacity='0.05'/%3E%3C/svg%3E");  
        opacity: 0.5; mix-blend-mode: overlay;  
    }  
    body.fx-active .scanlines, body.fx-active .dream-overlay { display: block; }  
    @keyframes scan { 0% { background-position: 0 0; } 100% { background-position: 0 100%; } }  

    /* --- APP SHELL & SCROLLING FIX --- */  
    .app-shell {  
        width: 100%; max-width: 480px; 
        background: transparent; 
        display: none; flex-direction: column; position: relative; height: 100%;  
        z-index: 10; 
    }  
    body.fx-active .app-shell { backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); }
    
    /* SCROLL CONTROLS */
    .content { flex: 1; overflow-y: auto; overflow-x: hidden; padding: 20px; padding-bottom: 120px; scroll-behavior: smooth; -webkit-overflow-scrolling: touch; }  
    .content.no-scroll { overflow: hidden; } /* LOCK SCROLL FOR PET ROOM */

    /* UPDATED: REMOVE HEIGHT 100% SO OTHER PAGES SCROLL */
    .page { display: none; animation: popIn 0.3s; }  
    
    /* ONLY PET PAGE IS LOCKED */
    #page-pet { height: 100%; overflow: hidden; }
    
    .page.active { display: block; }  
    @keyframes popIn { from {opacity:0; transform:scale(0.98);} to {opacity:1; transform:scale(1);} }  

    /* --- ALERT BANNER --- */
    .sys-alert {
        background: #ff4444; color: white; padding: 12px;
        font-weight: bold; display: none; justify-content: space-between;
        align-items: center; box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        z-index: 200; animation: slideDown 0.3s; border-bottom: 2px solid white;
        text-transform: uppercase; font-size: 0.9rem;
    }
    @keyframes slideDown { from {transform:translateY(-100%)} to {transform:translateY(0)} }

    /* --- ID CARD --- */  
    .id-card-wrap {  
        background: #fff; border-radius: 15px; padding: 0;  
        box-shadow: 0 10px 20px rgba(0,0,0,0.15); margin-bottom: 20px;   
        position: relative; overflow: hidden; border: 1px solid #ccc;  
        min-height: 270px; transform: translate3d(0,0,0); 
    }  
    .id-card-wrap::before {  
        content: ""; position: absolute; top: -50%; left: -50%; width: 200%; height: 200%;  
        background: linear-gradient(115deg, transparent 40%, rgba(255,0,150,0.2) 45%, rgba(0,255,255,0.3) 50%, rgba(255,255,0,0.2) 55%, transparent 60%);  
        mix-blend-mode: multiply; pointer-events: none; z-index: 10;  
        animation: foil 5s linear infinite; opacity: 0.6; will-change: transform;
    }  
    @keyframes foil { 0% { transform: translate3d(0,0,0); } 100% { transform: translate3d(50%,50%,0); } }  
    .id-inner { padding: 15px; height: 100%; display: flex; flex-direction: column; position: relative; z-index: 2; }  
    .id-header { border-bottom: 2px solid var(--main); padding-bottom: 5px; margin-bottom: 10px; display: flex; justify-content: space-between; font-weight: 900; letter-spacing: 1px; font-size: 0.7rem; color: #555; }  
    .id-main { display: flex; gap: 15px; margin-bottom: 10px; }  
    .id-photo { width: 90px; height: 110px; background: #eee; border: 1px solid #999; object-fit: cover; display: block; box-shadow: 2px 2px 5px rgba(0,0,0,0.1); }  
    .id-details { flex: 1; display: flex; flex-direction: column; justify-content: flex-start; gap: 5px; font-size: 0.7rem; }  
    .id-label { color: var(--main); font-weight: bold; font-size: 0.6rem; text-transform: uppercase; display:block; }  
    .id-val { color: #222; font-weight: bold; display: block; border-bottom: 1px dotted #ccc; width: 100%; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }  
    .bio-section { background: rgba(255,255,255,0.8); border: 1px solid #ddd; border-radius: 8px; padding: 8px; font-size: 0.75rem; color: #333; flex: 1; overflow-y: auto; max-height: 80px; margin-top: 5px; white-space: pre-wrap; }  

    /* --- DASHBOARD --- */  
    .dash-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 20px; }  
    .dash-btn { background: white; border: 2px solid #eee; border-radius: 18px; padding: 15px; text-align: center; font-weight: bold; cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }  
    .dash-btn:active { transform: scale(0.96); background: #f9f9f9; border-color: var(--main); }  

    /* --- BIO/ABOUT TAB --- */
    .bio-container { background: white; padding: 20px; border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
    .bio-list-box { border: 2px dashed #eee; padding: 10px; border-radius: 10px; min-height: 60px; display: flex; flex-wrap: wrap; gap: 5px; margin-bottom: 10px; }
    .bio-tag { background: var(--main); color: white; padding: 4px 10px; border-radius: 15px; font-size: 0.8rem; font-weight: bold; display: flex; align-items: center; gap: 5px; }
    .bio-tag span { cursor: pointer; opacity: 0.7; font-size: 0.7rem; }
    .bio-input-group { display: flex; gap: 5px; margin-bottom: 15px; }

    /* --- LOG TABLE --- */
    .log-table { width: 100%; border-collapse: collapse; font-size: 0.8rem; }
    .log-table th { text-align: left; border-bottom: 2px solid var(--main); padding: 5px; color: var(--main); }
    .log-table td { border-bottom: 1px solid #eee; padding: 8px 5px; color: #555; }
    .log-table tr:nth-child(even) { background: #f9f9f9; }

    /* --- CHAT --- */  
    .chat-shell { display: flex; height: 100%; border: 2px solid var(--main); border-radius: 15px; background: white; overflow: hidden; position:relative; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }  
    .channel-sidebar { width: 75px; background: #f0f0f0; border-right: 1px solid #e0e0e0; padding-top: 40px; display: flex; flex-direction: column; align-items: center; gap: 12px; overflow-y: auto; transition: margin-left 0.3s ease; }  
    .channel-sidebar.hidden { margin-left: -75px; }  
    .sidebar-toggle { position: absolute; top: 10px; left: 10px; z-index: 100; background: var(--main); color: white; border: none; border-radius: 50%; width: 25px; height: 25px; font-weight: bold; cursor: pointer; }  
    .chan-btn { width: 48px; height: 48px; border-radius: 50%; background: #ddd; display: flex; align-items: center; justify-content: center; font-weight: bold; color: #666; cursor: pointer; border: 2px solid white; position: relative; flex-shrink: 0; }  
    .chan-btn.active { background: var(--main); color: white; border-radius: 14px; }  
    .del-chan { position: absolute; top: -5px; right: -5px; background: red; color: white; width: 18px; height: 18px; border-radius: 50%; font-size: 10px; display: none; align-items: center; justify-content: center; }  
    .chan-btn:hover .del-chan { display: flex; }  
    .chat-view { flex: 1; display: flex; flex-direction: column; min-width: 0; }  
    .chat-feed { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 15px; background-image: radial-gradient(#f0f0f0 1px, transparent 1px); background-size: 20px 20px; }  
    .pk-msg { display: flex; gap: 10px; align-items: flex-start; cursor: pointer; }  
    .pk-msg:active { background: rgba(0,0,0,0.05); border-radius: 10px; }
    .pk-av { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; flex-shrink: 0; }  
    .pk-img { max-width: 150px; border-radius: 10px; margin-top: 5px; display: block; border: 2px solid #eee;}  
    .chat-input-area { padding: 10px; border-top: 1px solid #eee; display: flex; gap: 8px; align-items: center; background: #fafafa; }  

    /* --- PET --- */  
    .pet-stage { 
        height: 100%; width: 100%; position: relative; 
        border: 4px ridge var(--main); border-radius: 20px; 
        background-color: rgba(255,255,255,0.1); 
        background-size: cover; background-position: center; /* FOR BEDROOM WALLPAPERS */
        box-shadow: 0 5px 15px rgba(0,0,0,0.1); 
        overflow: hidden; display: flex; align-items: center; justify-content: center; 
    }  
    
    /* SCALABLE EBI */
    .ebi-img { 
        width: 160px; pointer-events: auto; z-index: 5; 
        filter: drop-shadow(0 5px 5px rgba(0,0,0,0.1)); cursor: pointer; 
        transition: transform 0.1s;
    }  
    .ebi-img:active { filter: brightness(1.2); }
    .ebi-img.selected { filter: drop-shadow(0 0 10px var(--main)); }

    /* UPDATED STICKER CLASS */
    .sticker { 
        position: absolute; cursor: grab; z-index: 10; user-select: none; width: 80px; height: auto; 
        transition: transform 0.1s; 
    }
    .sticker.selected {
        filter: drop-shadow(0 0 5px var(--main));
        border: 1px dashed white;
    }
    .sticker img { width: 100%; pointer-events: none; display: block; }
    
    .speech-bubble {  
        position: absolute; top: 30%; left: 50%; transform: translateX(-50%) scale(0);  
        background: white; padding: 10px 15px; border-radius: 20px; border: 2px solid var(--main);  
        font-size: 0.8rem; font-weight: bold; z-index: 20; text-align: center;  
        transition: transform 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);  
        pointer-events: none; white-space: nowrap;  
    }  
    .speech-bubble.show { transform: translateX(-50%) scale(1); } 

    /* STICKER CONTROLS */
    #decor-controls {
        position: absolute; bottom: 80px; left: 50%; transform: translateX(-50%);
        background: white; padding: 8px 15px; border-radius: 20px;
        display: none; align-items: center; gap: 10px; z-index: 100;
        box-shadow: 0 5px 15px rgba(0,0,0,0.2);
    }
    #decor-controls input[type="range"] { width: 100px; margin: 0; }
    #decor-controls button { background: #ff4444; color: white; border: none; border-radius: 5px; padding: 5px 8px; cursor: pointer; font-size: 0.8rem; }

    /* --- SYSTEM LOG CONSOLE --- */
    .console-box {
        position: absolute; bottom: 20px; left: 20px; right: 20px;
        background: rgba(40, 40, 40, 0.85); 
        border: 2px solid var(--main); border-radius: 10px; padding: 10px; 
        font-family: var(--font-mono); color: #ffb7b2; font-size: 0.75rem; 
        box-shadow: 0 4px 10px rgba(0,0,0,0.1); backdrop-filter: blur(4px); 
        z-index: 50;
    }
    .console-header { border-bottom: 1px solid rgba(255,255,255,0.2); padding-bottom: 5px; margin-bottom: 5px; display: flex; justify-content: space-between; font-weight: bold; letter-spacing: 1px; }
    .console-log { height: 60px; overflow-y: auto; display: flex; flex-direction: column-reverse; }
    .log-line { margin-bottom: 2px; }
    .log-line::before { content: "> "; opacity: 0.6; }
    .ebi-chat-btn { 
        position: absolute; bottom: 5px; right: 5px; /* Inside Console Box */
        background: var(--main); border: 2px solid white; border-radius: 50%; width: 30px; height: 30px; 
        cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 1rem; 
        box-shadow: 0 2px 5px rgba(0,0,0,0.2); z-index: 60; 
    }
    .ebi-chat-btn:active { transform: scale(0.9); }

    /* --- PHARMACY LOYALTY CARD --- */
    .loyalty-card {
        background-image: url('https://i.postimg.cc/9fr6qn0r/152f88be4a1ea59ecb8283bd71e01aa5.jpg'); /* NEW PAPER TEXTURE */
        background-size: cover;
        padding: 15px; border-radius: 10px; border: 1px solid #ccc;
        box-shadow: 0 5px 15px rgba(0,0,0,0.1); margin-bottom: 15px; position: relative;
    }
    .loyalty-header { text-align: center; font-weight: bold; color: #555; font-size: 0.8rem; margin-bottom: 10px; border-bottom: 1px dashed #999; padding-bottom: 5px; text-transform: uppercase; letter-spacing: 1px; }
    .stamp-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; }
    .stamp-slot { 
        aspect-ratio: 1/1; border: 2px dashed #bbb; border-radius: 50%; 
        display: flex; align-items: center; justify-content: center; 
        background: rgba(255,255,255,0.5); position: relative;
    }
    .stamp-mark { width: 100%; height: 100%; object-fit: contain; transform: rotate(-15deg); opacity: 0.8; animation: stomp 0.2s; }
    @keyframes stomp { 0% { transform: scale(2) rotate(0deg); opacity: 0; } 100% { transform: scale(1) rotate(-15deg); opacity: 0.8; } }
    .reward-btn { 
        display: none; width: 100%; margin-top: 10px; background: #81c784; 
        color: white; border: none; padding: 10px; border-radius: 8px; 
        font-weight: bold; cursor: pointer; animation: pulse 1s infinite; 
    }
    @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.02); } 100% { transform: scale(1); } }

    /* --- DREAM JOURNAL UI (RESIDUE & SLIDERS) --- */
    .dream-entry { 
        background: rgba(255,255,255,0.1); padding: 10px; border-left: 3px solid #81c784; 
        margin-bottom: 10px; border-radius: 5px; color: inherit; position: relative;
    }
    .dream-blur { filter: blur(3px); transition: filter 0.3s; cursor: pointer; }
    .dream-blur:hover { filter: blur(0); }
    
    /* NEW CUSTOM SLIDERS */
    .sensory-slider { margin-bottom: 15px; }
    .sensory-label {
        display: flex; justify-content: space-between; font-size: 0.7rem; color: #888; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 3px;
    }
    .sensory-range {
        width: 100%; -webkit-appearance: none; height: 10px; background: transparent; cursor: pointer;
    }
    .sensory-range::-webkit-slider-runnable-track {
        width: 100%; height: 8px; background: repeating-linear-gradient(90deg, #333 0, #333 2px, transparent 2px, transparent 4px);
        border: 1px solid #555;
    }
    .sensory-range::-webkit-slider-thumb {
        -webkit-appearance: none; height: 16px; width: 16px; background: #e6e6fa; margin-top: -5px; border: 2px solid #483d8b; box-shadow: 0 0 5px #e6e6fa;
    }
    
    /* FIXED RESIDUE SCANNER STYLING */
    .residue-scanner {
        display: block; width: 100%; box-sizing: border-box;
        border: 2px dashed #483d8b; background: rgba(0,0,0,0.2); 
        padding: 15px; text-align: center; border-radius: 10px; margin-top: 10px; margin-bottom: 15px; 
        cursor: pointer;
    }
    .residue-preview {
        width: 100%; height: 100px; object-fit: cover; margin-top: 10px; filter: grayscale(100%) contrast(150%); border: 1px solid #555; display: none;
    }

    /* --- PHARMACY --- */  
    .receipt-paper { 
        background: #fff; padding: 15px; 
        font-family: 'Courier New', monospace; font-size: 0.8rem; 
        box-shadow: 0 5px 15px rgba(0,0,0,0.1); margin-bottom: 10px; position: relative; 
        border-top: 5px solid #333;
        background-image: linear-gradient(135deg, transparent 50%, #fff 50%), linear-gradient(45deg, #fff 50%, transparent 50%);
        background-size: 20px 20px;
        background-repeat: repeat-x;
        background-position: bottom;
        padding-bottom: 30px; 
    }  
    .mood-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; padding: 10px 0; }  
    .mood-btn { background: white; border: 2px solid #eee; border-radius: 12px; height: 55px; font-size: 1.8rem; cursor: pointer; transition: transform 0.1s; }  
    .mood-btn:active { transform: scale(0.95); background: var(--main); border-color: var(--main); }

    /* --- UI COMPONENTS --- */  
    .btn-action { background: var(--main); color: white; padding: 12px; width: 100%; border: none; border-radius: 12px; font-weight: bold; cursor: pointer; margin-bottom: 5px; box-shadow: 0 4px 0 rgba(0,0,0,0.1); }  
    .btn-action:active { transform: translateY(3px); box-shadow: none; }  
      
    .dock { position: fixed; bottom: 25px; left: 20px; right: 20px; background: rgba(255,255,255,0.95); border-radius: 25px; padding: 12px 25px; display: flex; justify-content: space-between; box-shadow: 0 5px 25px rgba(0,0,0,0.15); z-index: 100; border: 2px solid white; }  
    .dock-btn { background: none; border: none; font-size: 1.6rem; cursor: pointer; opacity: 0.5; transition: 0.2s; }  
    .dock-btn.active { opacity: 1; transform: translateY(-8px); }  

    .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 2000; display: none; align-items: center; justify-content: center; padding: 20px; }  
    .modal-card { 
        background: white; width: 90%; max-width: 380px; border-radius: 25px; padding: 25px; 
        border: 4px ridge var(--main); 
        max-height: 80vh; 
        overflow-y: auto; 
        padding-bottom: 40px; 
    }  
    input, textarea, select { width: 100%; padding: 10px; margin-bottom: 8px; border: 2px inset #eee; border-radius: 10px; font-family: inherit;}  

    /* --- LOCK SCREEN --- */  
    #lock-screen { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: var(--main); z-index: 20000; display: none; flex-direction: column; align-items: center; justify-content: center; color: white; }  
    .pin-pad { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-top: 30px; }  
    .pin-btn { width: 70px; height: 70px; border-radius: 50%; border: 2px solid white; background: rgba(255,255,255,0.15); color: white; font-size: 1.8rem; display: flex; align-items: center; justify-content: center; cursor: pointer; }  

    /* --- DIARY --- */  
    .diary-entry { background: white; padding: 15px; border-radius: 12px; margin-bottom: 12px; border-left: 5px solid var(--main); position: relative; box-shadow: 2px 2px 5px rgba(0,0,0,0.05); color: #444; }  
    .del-diary { position: absolute; top: 8px; right: 8px; color: #ff4444; cursor: pointer; font-weight: bold; font-size: 0.9rem; padding: 5px; }  
    
    .file-upload-btn {
        display: block; width: 100%; padding: 10px; text-align: center; background: #eee;
        border-radius: 10px; margin-bottom: 10px; cursor: pointer; font-weight: bold; color: #555;
    }

    /* --- REWARD OVERLAY (NEW) --- */
    #reward-screen {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(255,182,193, 0.95);
        z-index: 10000; display: none;
        flex-direction: column; align-items: center; justify-content: center;
        text-align: center;
    }
    .confetti {
        position: absolute; width: 10px; height: 10px; background: #fff;
        animation: fall linear forwards;
    }
    @keyframes fall { to { transform: translateY(100vh) rotate(720deg); } }
    
    .reward-box {
        background: white; padding: 20px; border-radius: 20px;
        box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        animation: popUp 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        max-width: 90%;
        z-index: 2;
        border: 5px solid #fff;
        outline: 5px dashed var(--main);
    }
    @keyframes popUp { from{transform:scale(0);} to{transform:scale(1);} }
    
    .reward-items-container {
        display: flex; gap: 15px; justify-content: center; margin: 20px 0;
    }
    .reward-item-display {
        width: 70px; height: 70px; 
        background: #f9f9f9; border-radius: 10px;
        display: flex; align-items: center; justify-content: center;
        font-size: 2rem; border: 2px solid #eee;
        box-shadow: 0 5px 10px rgba(0,0,0,0.1);
    }
    .reward-item-display img { width: 90%; height: 90%; object-fit: contain; }
</style>

</head>  
<body class="fx-active">  
<div class="scanlines"></div>  
<div class="dream-overlay"></div>  

<div id="reward-screen">
    <div class="reward-box">
        <h1 style="color:var(--main); margin:0;">CONGRATS!</h1>
        <p style="color:#666; margin:5px 0;">Prescription Refilled Successfully</p>
        <div class="reward-items-container" id="reward-showcase">
            </div>
        <button class="btn-action" onclick="closeRewardScreen()">Collect Items</button>
    </div>
</div>

<div id="welcome-screen" style="position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.9); z-index:3000; display:flex; flex-direction:column; align-items:center; justify-content:center;">  
    <div style="font-size:4rem; margin-bottom:10px;">üíæ</div>  
    <h1 style="color:var(--main); margin:0 0 10px 0;">SEIREN OS</h1>  
    <p style="font-size:0.8rem; color:#666; margin-bottom:30px;">Guest Mode Active</p>  
    <button class="btn-action" style="width:220px;" onclick="enterSystem()">Enter System</button>  
    
    <label class="btn-action" style="width:220px; background:#4fc3f7; text-align:center; display:block; cursor:pointer;">  
        üìÇ Load Backup  
        <input type="file" id="backup-input" style="display:none;" onchange="importData(this)">  
    </label>

    <label class="btn-action" style="width:220px; background:#7e57c2; text-align:center; display:block; cursor:pointer; margin-top:10px;">  
        üëæ Import PluralKit  
        <input type="file" id="pk-input" style="display:none;" onchange="importPluralKit(this)">  
    </label>
</div>  

<div id="lock-screen">  
    <div style="font-size:4rem; margin-bottom:10px;">üîí</div>  
    <h3>SYSTEM LOCKED</h3>  
    <div id="pin-dots" style="font-size:3rem; letter-spacing:15px; height:60px; font-family:monospace;"></div>  
    <div class="pin-pad">  
        <div class="pin-btn" onclick="enterPin(1)">1</div><div class="pin-btn" onclick="enterPin(2)">2</div><div class="pin-btn" onclick="enterPin(3)">3</div>  
        <div class="pin-btn" onclick="enterPin(4)">4</div><div class="pin-btn" onclick="enterPin(5)">5</div><div class="pin-btn" onclick="enterPin(6)">6</div>  
        <div class="pin-btn" onclick="enterPin(7)">7</div><div class="pin-btn" onclick="enterPin(8)">8</div><div class="pin-btn" onclick="enterPin(9)">9</div>  
        <div class="pin-btn" style="opacity:0"></div><div class="pin-btn" onclick="enterPin(0)">0</div><div class="pin-btn" style="background:rgba(255,200,200,0.3)" onclick="clearPin()">C</div>  
    </div>  
</div>  

<div class="app-shell" id="app">  
    <div id="sys-alert" class="sys-alert">
        <span id="sys-alert-msg"></span>
        <button onclick="dismissAlert()" style="background:transparent; border:none; color:white; font-weight:bold; cursor:pointer;">X</button>
    </div>

    <div class="content">
        <div id="page-dash" class="page active" style="padding-top:20px;">  
            <div class="id-card-wrap">  
                <div class="id-inner">  
                    <div class="id-header">  
                        <span id="sys-name-display">SEIREN OS</span>  
                        <span>GLIMMER ID</span>  
                    </div>  
                    <div class="id-main">  
                        <img id="dash-av" class="id-photo" src="">  
                        <div class="id-details">  
                            <div><span class="id-label">NAME</span><span class="id-val" id="dash-name">Guest</span></div>  
                            <div style="display:flex; gap:10px;">  
                                <div style="flex:1;"><span class="id-label">AGE</span><span class="id-val" id="dash-age">--</span></div>  
                                <div style="flex:1;"><span class="id-label">HEIGHT</span><span class="id-val" id="dash-height">--</span></div>  
                            </div>  
                            <div style="display:flex; gap:10px;">  
                                <div style="flex:1;"><span class="id-label">SIGN</span><span class="id-val" id="dash-sign">--</span></div>  
                                <div style="flex:1;"><span class="id-label">SPECIES</span><span class="id-val" id="dash-species">--</span></div>  
                            </div>  
                            <div id="cofront-row" style="display:none; margin-top:5px;">
                                <span class="id-label">CO-CON</span>
                                <span class="id-val" id="dash-co"></span>
                            </div>
                        </div>  
                    </div>  
                    <span class="id-label">PERSONNEL NOTES</span>  
                    <div class="bio-section" id="dash-bio">  
                        Official System Member  
                    </div>  
                </div>  
            </div>  

            <div style="background:white; padding:12px; border-radius:15px; text-align:center; margin-bottom:20px; border:2px inset #eee; color:#666;">  
                <b>XP Points:</b> <span id="cp-display" style="color:var(--main); font-weight:bold; font-size:1.2rem;">0</span>  
            </div>  

            <div class="dash-grid">  
                <div class="dash-btn" onclick="openProfileModal()"><span>üë•</span><br>Switch/Edit</div>  
                <div class="dash-btn" onclick="openSettingsModal()"><span>‚öôÔ∏è</span><br>Settings</div>  
                <div class="dash-btn" onclick="openBackpack()"><span>üéí</span><br>Items</div>  
                <div class="dash-btn" onclick="nav('about')"><span>üë§</span><br>About Me</div>  
            </div>  
            
            <button class="btn-action" style="background:#607d8b; margin-top:25px; width:auto; font-size:0.8rem;" onclick="exportData()">üíæ Save Backup</button>  
        </div>  

        <div id="page-about" class="page" style="padding-top:20px;">
            <h2 style="color:var(--main); text-align:center; background:white; border-radius:10px; display:inline-block; padding:5px 15px; margin:0 auto 15px auto; display:table;">About Me</h2>
            
            <div class="bio-container">
                <h4 style="color:#555; margin:0 0 5px 0;">üíñ Likes</h4>
                <div id="likes-list" class="bio-list-box"></div>
                <div class="bio-input-group">
                    <input type="text" id="like-in" placeholder="Add like..." style="margin:0;">
                    <button class="btn-action" style="width:auto; margin:0;" onclick="addBioItem('likes')">+</button>
                </div>

                <h4 style="color:#555; margin:15px 0 5px 0;">üö´ Dislikes</h4>
                <div id="dislikes-list" class="bio-list-box"></div>
                <div class="bio-input-group">
                    <input type="text" id="dislike-in" placeholder="Add dislike..." style="margin:0;">
                    <button class="btn-action" style="width:auto; margin:0;" onclick="addBioItem('dislikes')">+</button>
                </div>

                <h4 style="color:#555; margin:15px 0 5px 0;">üìù Notes / Triggers</h4>
                <textarea id="notes-in" style="height:100px;" placeholder="Extra details here..." onblur="saveBioNotes()"></textarea>
            </div>
        </div>

        <div id="page-chat" class="page" style="height:100%; padding-bottom:80px;">  
            <div class="chat-shell">  
                <button class="sidebar-toggle" onclick="toggleSidebar()">&lt;</button>  
                <div class="channel-sidebar" id="chan-list"></div>  
                <div class="chat-view">  
                    <div class="chat-header">  
                        <span id="chan-title">#general</span>  
                        <button class="btn-action" style="width:auto; padding:2px 8px; font-size:0.7rem; margin:0; background:#ff4444;" onclick="sendAlert()">‚ö†Ô∏è Broadcast</button>
                    </div>  
                    <div class="chat-feed" id="chat-feed"></div>  
                    <div class="chat-input-area">  
                        <label style="cursor:pointer; font-size:1.5rem; color:#888;">üìé<input type="file" accept="image/*" style="display:none;" onchange="handleChatImage(this)"></label>  
                        <input type="text" id="msg-in" style="width:100%; margin:0;" placeholder="Message...">  
                        <button class="btn-action" style="width:auto; margin:0;" onclick="sendMsg()">Send</button>  
                    </div>  
                </div>  
            </div>  
        </div>  

        <div id="page-pharmacy" class="page">  
            <h2 style="color:var(--main); text-align:center; margin-bottom:15px; background:white; border-radius:10px; display:inline-block; padding:5px 15px;">Pharmacy & Care</h2>  
            
            <div class="loyalty-card">
                <div class="loyalty-header">Seiren Clinic ‚Ä¢ Patient Card</div>
                <div class="stamp-grid" id="stamp-grid"></div>
                <button id="reward-btn" class="reward-btn" onclick="claimReward()">
                    <img src="https://i.postimg.cc/8C9qdmfN/a3f6c6b70ab5af6f58240dba296b7556.png" style="width:30px; vertical-align:middle; margin-right:5px;">
                    CLAIM REFILL
                </button>
            </div>

            <div style="background:white; padding:15px; border-radius:15px; border:2px solid var(--main);">  
                <div id="receipt-list" class="receipt-paper"></div>  
                
                <div style="text-align:center; margin-bottom:5px; font-size:0.7rem; color:#888;">LOG SYMPTOMS:</div>  
                <div class="mood-grid">  
                    <button class="mood-btn" onclick="logMood('üòä Happy', 5)">üòä</button>  
                    <button class="mood-btn" onclick="logMood('üò¢ Sad', 10)">üò¢</button>  
                    <button class="mood-btn" onclick="logMood('üò° Angry', 10)">üò°</button>  
                    <button class="mood-btn" onclick="logMood('üåÄ Anxious', 15)">üåÄ</button>  
                    <button class="mood-btn" onclick="logMood('üí§ Tired', 5)">üí§</button>  
                    <button class="mood-btn" onclick="logMood('‚ú® Hyper', 5)">‚ú®</button>  
                    <button class="mood-btn" onclick="logMood('üíÄ Dead', 15)">üíÄ</button>  
                    <button class="mood-btn" onclick="logMood('üíñ Loved', 5)">üíñ</button>  
                    <button class="mood-btn" onclick="logMood('üò∞ Panic', 15)">üò∞</button>  
                    <button class="mood-btn" onclick="logMood('üå´Ô∏è Numb', 10)">üå´Ô∏è</button>  
                    <button class="mood-btn" onclick="logMood('‚ö° Manic', 15)">‚ö°</button>  
                    <button class="mood-btn" onclick="logMood('ü•Ä Lonely', 10)">ü•Ä</button>  
                    <button class="mood-btn" onclick="logMood('üé™ Silly', 5)">üé™</button>  
                    <button class="mood-btn" onclick="logMood('ü©π Hurt', 10)">ü©π</button>  
                    <button class="mood-btn" onclick="logMood('üéÆ Bored', 5)">üéÆ</button>  
                    <button class="mood-btn" onclick="logMood('üß∏ Soft', 5)">üß∏</button>  
                    <button class="mood-btn" onclick="logMood('ü§¢ Sick', 15)">ü§¢</button>  
                    <button class="mood-btn" onclick="logMood('ü§Ø Overwhelmed', 15)">ü§Ø</button>  
                    <button class="mood-btn" onclick="logMood('ü•∫ Sensitive', 10)">ü•∫</button>  
                    <button class="mood-btn" onclick="logMood('üò§ Frustrated', 10)">üò§</button>
                    <button class="mood-btn" onclick="logMood('üçº Little', 10)">üçº</button>
                    <button class="mood-btn" onclick="logMood('üò∂ Non-verbal', 10)">üò∂</button>
                    <button class="mood-btn" onclick="logMood('üå´Ô∏è Dissociated', 15)">üå´Ô∏è</button>
                    <button class="mood-btn" onclick="logMood('üí• Overstimulated', 15)">üí•</button>
                </div>  

                <button class="btn-action" style="margin-top:10px; background:#78909c;" onclick="processReceipt()">Print Receipt (+Self Care)</button>  
                <button class="btn-action" style="margin-top:10px; background:#4db6ac;" onclick="fillPrescription()">üíä Fill Rx (50 XP)</button>  
            </div>  
        </div>  

        <div id="page-pet" class="page">  
            <div class="pet-stage" id="pet-stage">  
                <div id="decor-layer"></div>  
                <div id="pet-speech" class="speech-bubble">Hello!</div>  
                
                <img src="https://i.postimg.cc/13FQckct/Untitled-Artwork-20260110072840-20260110074706.png" class="ebi-img" onclick="clickEbi(event)">  
                
                <div id="decor-controls">
                    <span>Size:</span>
                    <input type="range" id="scale-slider" min="0.5" max="2.5" step="0.1" oninput="updateDecorScale(this.value)">
                    <button onclick="deleteSelectedDecor()">üóëÔ∏è</button>
                </div>

                <div class="console-box">
                    <div class="console-header">
                        <span>SYSTEM LOG</span>
                        <span>v1.0</span>
                    </div>
                    <div class="console-log" id="console-log-feed"></div>
                    <button class="ebi-chat-btn" onclick="triggerEbiChat()">üí¨</button>
                </div>
            </div>  
        </div>  

        <div id="page-dream" class="page">
            <h2 style="text-align:center;">Dream Journal</h2>
            <div class="bio-container">
                <label>Location / Level:</label>
                <input list="dream-levels" id="dream-loc" placeholder="Select or type location...">
                <datalist id="dream-levels">
                    <option value="The In Between"></option>
                    <option value="The Pool Rooms"></option>
                    <option value="The Mall (Empty)"></option>
                    <option value="The Infinite Hotel"></option>
                    <option value="The Waiting Room"></option>
                    <option value="The Garden"></option>
                </datalist>

                <div class="sensory-slider">
                    <div class="sensory-label"><span>Nostalgia</span><span>Anemoia</span></div>
                    <input type="range" id="dream-nostalgia" min="0" max="100" class="sensory-range">
                </div>
                
                <div class="sensory-slider">
                    <div class="sensory-label"><span>Presence</span><span>Watched</span></div>
                    <input type="range" id="dream-presence" min="0" max="100" class="sensory-range">
                </div>

                <div class="sensory-slider">
                    <div class="sensory-label"><span>Reality</span><span>Glitched</span></div>
                    <input type="range" id="dream-reality" min="0" max="100" class="sensory-range">
                </div>

                <label>Entities / Visitors:</label>
                <input type="text" id="dream-ent" placeholder="Who was there?">
                
                <label>Memory Dump:</label>
                <textarea id="dream-text" style="height:80px;"></textarea>

                <label class="residue-scanner">
                    <div style="font-weight:bold; color:#e6e6fa; font-family:var(--font-mono);">[ SCAN RESIDUE ]</div>
                    <div style="font-size:0.7rem; color:#888;">Upload Evidence</div>
                    <input type="file" accept="image/*" style="display:none;" onchange="handleDreamImage(this)">
                    <img id="dream-preview" class="residue-preview">
                </label>
                
                <button class="btn-action" style="background:#7e57c2; margin-top:10px;" onclick="saveDream()">Log Dream</button>
                <button class="btn-action" style="background:#555; margin-top:5px;" onclick="openDreamArchive()">üìñ Open Dream Diary</button>
            </div>
        </div>

        <div id="page-diary" class="page">  
            <h2 style="color:var(--main); text-align:center; background:white; border-radius:10px; display:inline-block; padding:5px 15px;">Diary</h2>  
            <textarea id="diary-in" style="width:100%; height:100px;" placeholder="Entry..."></textarea>  
            <button class="btn-action" onclick="postDiary()">Save</button>  
            <div id="diary-feed" style="margin-top:20px;"></div>  
        </div> 
    </div> 

    <div class="dock">  
        <button class="dock-btn active" onclick="nav('dash')">üè†</button>  
        <button class="dock-btn" onclick="nav('pharmacy')">üè•</button>  
        <button class="dock-btn" onclick="nav('pet')">üç§</button>  
        <button class="dock-btn" onclick="nav('chat')">üí¨</button>  
        <button class="dock-btn" onclick="nav('diary')">üìì</button>  
        <button class="dock-btn" onclick="toggleNightMode()">üåô</button>
    </div>
</div>  

<div id="modal-chat-actions" class="modal">
    <div class="modal-card" style="text-align:center;">
        <h3>Message Options</h3>
        <p id="chat-action-text" style="font-size:0.8rem; color:#666; margin-bottom:15px;">...</p>
        <button class="btn-action" style="background:#64b5f6;" onclick="replyToMsg()">‚Ü©Ô∏è Reply</button>
        <button class="btn-action" style="background:#ffb74d;" onclick="editMsg()">‚úèÔ∏è Edit</button>
        <button class="btn-action" style="background:#ff4444;" onclick="deleteMsg()">üóëÔ∏è Delete</button>
        <button class="btn-action" style="background:#ccc;" onclick="closeModals()">Cancel</button>
    </div>
</div>

<div id="modal-settings" class="modal">  
    <div class="modal-card">  
        <h3>Settings</h3>  
        <label>System Name:</label>  
        <input type="text" id="sys-name-input" placeholder="Seiren OS">  
        <button class="btn-action" style="margin-top:5px; margin-bottom:15px;" onclick="saveSystemName()">Update Name</button>  
        <label style="display:flex; justify-content:space-between; align-items:center; background:#f9f9f9; padding:10px; border-radius:10px;">  
            <span>üì∫ CRT Effects</span>  
            <input type="checkbox" id="toggle-crt" onchange="toggleCRT()" checked style="width:auto; margin:0;">  
        </label>  
        <hr>  
        <h4>Security</h4>  
        <input type="number" id="pin-set" placeholder="New PIN (4 digits)" maxlength="4" style="text-align:center;">  
        <button class="btn-action" style="margin-top:5px;" onclick="setLock()">Enable Lock</button>  
        <button class="btn-action" style="margin-top:5px; background:#ff4444;" onclick="disableLock()">Disable Lock</button>  
        <button class="btn-action" style="margin-top:15px; background:#ccc;" onclick="closeModals()">Close</button>  
    </div>
</div>  

<div id="modal-profile" class="modal">  
    <div class="modal-card">  
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
            <h3>Identity Card</h3>
            <button class="btn-action" style="width:auto; padding:5px 10px; font-size:0.7rem;" onclick="openLogModal()">üìú History</button>
        </div>
        <div id="prof-list" style="margin-bottom:15px; max-height:150px; overflow-y:auto; border:1px solid #eee;"></div>  
        <hr>  
        <h4>Profile Editor</h4>  
        <p style="font-size:0.7rem; color:#666;">Leave fields blank to keep current data.</p>
        <input type="text" id="new-name" placeholder="Name">  
        <div style="display:flex; gap:10px;">  
            <input type="text" id="new-age" placeholder="Age" style="width:30%;">  
            <input type="text" id="new-sign" placeholder="Sign" style="width:70%;">  
        </div>  
        <div style="display:flex; gap:10px;">  
            <input type="text" id="new-species" placeholder="Species" style="width:70%;">  
            <input type="text" id="new-height" placeholder="Height" style="width:30%;">  
        </div>  
        <textarea id="new-bio" placeholder="Profile Info / Notes..." style="height:60px; font-family:inherit;"></textarea>  
        <label class="file-upload-btn">  
            üìÇ Upload Photo  
            <input type="file" accept="image/*" style="display:none;" onchange="handleFile(this, 'av-preview')">  
        </label>  
        <img id="av-preview" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Crect width='100' height='100' fill='%23eee'/%3E%3Ccircle cx='50' cy='40' r='20' fill='%23ccc'/%3E%3Cpath d='M20,90 Q50,60 80,90' fill='%23ccc'/%3E%3C/svg%3E" style="width:60px; height:60px; margin:0 auto; display:block; object-fit:cover; border-radius:50%; background:#eee;">  
        <input type="color" id="new-color" value="#ff69b4" style="width:100%; border:none; height:30px; margin-top:5px;">  
        <div style="display:flex; gap:5px; margin-top:10px; flex-wrap:wrap;">
            <button class="btn-action" style="background:#81c784; flex:1;" onclick="updateCurrentProfile()">Save Changes</button>
            <button class="btn-action" style="flex:1;" onclick="createProfile()">Create New</button>
        </div>
        <button class="btn-action" style="margin-top:5px; background:#ccc;" onclick="closeModals()">Close</button>  
    </div>
</div>  

<div id="modal-log" class="modal">
    <div class="modal-card">
        <h3>Front Log</h3>
        <div style="max-height:300px; overflow-y:auto; margin-bottom:10px;">
            <table class="log-table">
                <thead><tr><th>Who</th><th>Date</th><th>Start</th><th>Duration</th></tr></thead>
                <tbody id="front-log-body"></tbody>
            </table>
        </div>
        <button class="btn-action" style="background:#ccc;" onclick="closeModals()">Close</button>
    </div>
</div>

<div id="modal-dream-archive" class="modal">
    <div class="modal-card">
        <h3>Dream Archives</h3>
        <div id="dream-feed" style="max-height:60vh; overflow-y:auto; margin-bottom:10px;"></div>
        <button class="btn-action" style="background:#ccc;" onclick="closeModals()">Close</button>
    </div>
</div>

<div id="modal-backpack" class="modal">  
    <div class="modal-card">  
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <h3>Inventory</h3>
            <button id="sell-btn" class="btn-action" style="width:auto; padding:5px 10px; font-size:0.8rem; background:#4db6ac;" onclick="toggleSell()">üí∞ Sell Mode</button>
        </div>
        <p style="font-size:0.7rem; color:#666;">Items placed in Room. Backgrounds apply to SYSTEM.</p>  
        <div id="inventory-grid" style="display:flex; flex-wrap:wrap; gap:10px; justify-content:center; padding:10px; background:#f9f9f9; border-radius:10px; margin-bottom:10px;"></div>  
        <div id="empty-msg" style="text-align:center; color:#999; display:none;">Backpack is empty.<br>Visit Pharmacy.</div>
        <button class="btn-action" style="background:#ff6b6b;" onclick="clearDecor()">üóëÔ∏è Clear Room</button>  
        <button class="btn-action" style="margin-top:5px; background:#ccc;" onclick="closeModals()">Close</button>  
    </div>  
</div>  

<script>  
    // --- STATE ---  
    let DEFAULT_DB = {  
        sysName: "SEIREN OS",  
        profiles: [{ name: "Guest", av: "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Crect width='100' height='100' fill='%23f0f0f0'/%3E%3Ccircle cx='50' cy='40' r='20' fill='%23ccc'/%3E%3Cpath d='M20,90 Q50,60 80,90' fill='%23ccc'/%3E%3C/svg%3E", color: "#ff69b4", id: "GUEST", sign: "-", species: "Visitor", age: "-", height: "-", bio: "Guest Access", likes: [], dislikes: [], notes: "" }], 
        active: 0, xp: 0, 
        inventory: [], 
        decor: [],   
        cofront: [], 
        frontHistory: [], 
        consoleHistory: ["System Initialized..."], 
        dreamLog: [], 
        stamps: 0, 
        currentFrontStart: Date.now(), 
        activeAlert: null,
        lock: null, channels: { 'gen': {name:'general', msgs:[]} }, curChan: 'gen',  
        diary: [], settings: { crt: true },
        roomWallpaper: "", 
        ebiScale: 1 
    };
    
    let DB = JSON.parse(JSON.stringify(DEFAULT_DB));

    let pendingXP = 0; let tempPin = ""; let uploadedAv = ""; let chatImg = "";  
    let isSelling = false;
    let selectedMsgIndex = -1;
    let tempDreamImg = ""; 
    let selectedDecorIndex = -2; 

    // LOOT TABLE
    const LOOT_ITEMS = [
        "bg-apple", "bg-polka-brown", "bg-clover", "bg-stars-blue", "bg-bow-y2k",
        "bg-stars-bw", "bg-music-pink", "bg-stars-classic", "bg-bow-classic",
        "bg-strawberry", "bg-heart-bp", "bg-polka-classic",
        "bg-stars-2", "bg-heart-pink", "bg-stars-y2k", "bg-stars-pink", "bg-heart-by", "bg-polka-pink",
        
        // BEDROOM WALLPAPERS
        "https://i.postimg.cc/DZ5qstqb/10b51003f5fc0df41075f24861363d7d.jpg",
        "https://i.postimg.cc/qRQ8n983/327b16e3d5893b32482b5642782105d5.jpg",
        "https://i.postimg.cc/wvFhJSht/7de5e7ad4933d616d390e74c5405ebc8.jpg",
        "https://i.postimg.cc/mDTYPbFM/891e1ee9f917421887230a1f93c50e74.jpg",
        "https://i.postimg.cc/pTkD8gD5/fdfddf6e776fd0428aa1e486741fe780.jpg",

        // STICKERS
        "https://i.postimg.cc/4dFyJtrX/12d9131d2320519e1e23f5f678427396.png",
        "https://i.postimg.cc/zBPvJW46/3e4f2fa5b124701b5f17089d9ab9b737.png",
        "https://i.postimg.cc/hjGhWMZ5/62695aafc7da6361407abf3a87ecafb6.png",
        "https://i.postimg.cc/1tYX96bb/65794fc54d21b0cdd7b3db4e813c6b11.png",
        "https://i.postimg.cc/4dFyJtrR/9add2a23fa78c0e9fcc21c3a394b02cd.png",
        "https://i.postimg.cc/bJFrzbKc/ed8d7acf0f1516a1b3de4b9df6a3b048.png",
        "https://i.postimg.cc/DyG0TS6t/2f0f42dbd7882d400c9e4f651c9d438d.png",
        "https://i.postimg.cc/P5kxrdFT/363a54d905dfd329fb095af572d6d580.png",
        "https://i.postimg.cc/8k9c9RR9/42616c918cd958cc301cb745852ff27e.png",
        "https://i.postimg.cc/tC6JjsD4/45ca3463cef73aa5c917b57ac0cfd971.png",
        "https://i.postimg.cc/FF8z8yb5/56e20c61dbf4feb80179606c2699d5f1.png",
        "https://i.postimg.cc/CL85gR7v/607d0537e36c5788fe96007288ae5ccc.png",
        "https://i.postimg.cc/05FjFYYL/69e61b8d6420f427e4ac42a32f49eddf.png",
        "https://i.postimg.cc/66gqgrr1/6b1bb26664a8aafcd16a6d4436bcf54a.png",
        "https://i.postimg.cc/PrDJjCKh/7e91ebbf0419972863f456a8aa7c904b.png",
        "https://i.postimg.cc/28WyD1Gs/93e86c6d6b567ece1a03b6c04d04892c.png",
        "https://i.postimg.cc/nhtzcnwr/a09248b8a40f6c9f22285635b90be653.png",
        "https://i.postimg.cc/Mp8TKzrp/abb690b3250b998f75bbc788f7154c55.png",
        "https://i.postimg.cc/fRhLTMgT/af7f389e3f9e09024197d9e164ad33e2.png",
        "https://i.postimg.cc/qMKqTNQt/d1b701f32c7e48282f4a20be48a7fd3f.png",
        "https://i.postimg.cc/vHnTs4Xm/d3092ebc83ae4814d0e75e1af83646e1.png",
        "https://i.postimg.cc/WpCzCGGx/d754b77bd5a2ef644d29367b5ca3a51b.png",
        "https://i.postimg.cc/ncmrJXT8/da7d72fedbce39a1f0d35f89c184c29f.png",
        "https://i.postimg.cc/DyG0TS5f/da828bc90e8f772100995a682a906233.png",
        "https://i.postimg.cc/x1SCT9Fj/deb771ba2ff74c9af0871e8af7bb4cc0.png",
        "https://i.postimg.cc/pXjrHmC1/eb31aaf8301282152f43f7050b39a5fd.png",
        "https://i.postimg.cc/SN9RhnVJ/ee455254fdc48289bf096e1eb048e089.png",
        "https://i.postimg.cc/KvTj21fw/f91a9c969269fdedf2e437391eda83e8.png"
    ];  
    
    const BG_ICONS = {
        'bg-apple': 'üçé', 'bg-polka-brown': 'üü§', 'bg-clover': 'üçÄ', 'bg-stars-blue': '‚≠ê',
        'bg-bow-y2k': 'üéÄ', 'bg-stars-bw': '‚ú®', 'bg-music-pink': 'üéµ', 'bg-stars-classic': 'üåü',
        'bg-bow-classic': 'üéóÔ∏è', 'bg-strawberry': 'üçì', 'bg-heart-bp': 'üíô',
        'bg-polka-classic': '‚ö™',
        'bg-stars-2': 'üåü', 'bg-heart-pink': 'üíñ', 'bg-stars-y2k': 'üí´', 
        'bg-stars-pink': 'üå∏', 'bg-heart-by': 'üíô', 'bg-polka-pink': 'üü£'
    };

    window.onload = () => {  
        const saved = localStorage.getItem('seiren_fixed_v87'); 
        if(saved) { 
            try { 
                const parsed = JSON.parse(saved); 
                // MERGE SAVED DATA WITH DEFAULT STRUCTURE TO PREVENT CRASHES ON OLD BACKUPS
                DB = { ...DEFAULT_DB, ...parsed };
                
                // Ensure arrays exist
                if(!DB.profiles) DB.profiles = DEFAULT_DB.profiles;
                if(!DB.inventory) DB.inventory = [];
                if(!DB.decor) DB.decor = [];
            } catch(e) { 
                console.error("Save corrupted, resetting.");
            } 
        }  

        document.getElementById('sys-name-input').value = DB.sysName || "SEIREN OS";  
        document.getElementById('toggle-crt').checked = DB.settings.crt;  
        toggleCRT();  
        renderAlert();
        renderConsole();
        renderStamps();
    };  
  
    function enterSystem() {  
        document.getElementById('welcome-screen').style.display = 'none';  
        if(DB.lock) document.getElementById('lock-screen').style.display='flex';  
        else { document.querySelector('.app-shell').style.display='flex'; refreshAll(); }  
    }  
  
    function refreshAll() { loadUI(); renderChat(); renderDecor(); renderDiary(); renderBio(); renderAlert(); renderConsole(); renderDreamLog(); renderStamps(); }  
    function save() { localStorage.setItem('seiren_fixed_v87', JSON.stringify(DB)); }  
  
    function saveSystemName() { DB.sysName = document.getElementById('sys-name-input').value; save(); loadUI(); closeModals(); }  
    
    function handleFile(inpt, id) {   
        const file = inpt.files[0]; if(!file) return;  
        const reader = new FileReader();  
        reader.onload = (e) => {  
            const img = new Image();
            img.onload = () => {
                const canvas = document.createElement('canvas'); const ctx = canvas.getContext('2d');
                const maxSize = 250; let w = img.width; let h = img.height;
                if (w > h) { if (w > maxSize) { h *= maxSize / w; w = maxSize; } } else { if (h > maxSize) { w *= maxSize / h; h = maxSize; } }
                canvas.width = w; canvas.height = h; ctx.drawImage(img, 0, 0, w, h);
                uploadedAv = canvas.toDataURL('image/jpeg', 0.8);
                document.getElementById(id).src = uploadedAv; 
            };
            img.src = e.target.result;
        };  
        reader.readAsDataURL(file); inpt.value = ""; 
    }  
    function handleChatImage(inpt) {   
        const file = inpt.files[0]; if(!file) return;  
        const reader = new FileReader(); reader.onload = (e) => { chatImg = e.target.result; alert("Image attached!"); }; reader.readAsDataURL(file); inpt.value = ""; 
    }  
  
    function loadUI() {  
        const p = DB.profiles[DB.active];  
        document.documentElement.style.setProperty('--main', p.color);  
        document.getElementById('sys-name-display').innerText = DB.sysName;  
        document.getElementById('dash-name').innerText = p.name;  
        document.getElementById('dash-sign').innerText = p.sign||"?";  
        document.getElementById('dash-species').innerText = p.species||"?";  
        document.getElementById('dash-age').innerText = p.age||"?";  
        document.getElementById('dash-height').innerText = p.height||"?";  
        document.getElementById('dash-bio').innerText = p.bio || "No info provided.";  
        document.getElementById('dash-av').src = p.av || DEFAULT_AV;  
        document.getElementById('cp-display').innerText = DB.xp;  
        
        const coDiv = document.getElementById('cofront-row');
        if (DB.cofront && DB.cofront.length > 0) {
            const names = DB.cofront.map(idx => DB.profiles[idx].name).join(", ");
            document.getElementById('dash-co').innerText = names;
            coDiv.style.display = 'block';
        } else {
            coDiv.style.display = 'none';
        }

        let classes = "";
        if(DB.settings.crt) classes += "fx-active ";
        if(p.wallpaper) classes += p.wallpaper;
        document.body.className = classes;
    }  
  
    function createProfile() {  
        const n = document.getElementById('new-name').value;  
        if(n) {  
            if(DB.profiles[0].id === "GUEST") DB.profiles = [];  
            DB.profiles.push({  
                name:n, color:document.getElementById('new-color').value,   
                av: uploadedAv || DEFAULT_AV,  
                sign:document.getElementById('new-sign').value,   
                species:document.getElementById('new-species').value,   
                age:document.getElementById('new-age').value,  
                height:document.getElementById('new-height').value,  
                bio:document.getElementById('new-bio').value,
                likes: [], dislikes: [], notes: "",  
                id: Math.floor(Math.random()*900000)  
            });  
            uploadedAv = ""; DB.active = DB.profiles.length - 1;  
            save(); closeModals(); refreshAll();  
        }  
    }

    // --- FIXED UPDATE FUNCTION (NO MORE GHOST WRITING) ---
    function updateCurrentProfile() {
        if(DB.active < 0 || DB.active >= DB.profiles.length) return;
        const p = DB.profiles[DB.active];
        
        // Directly grab values since they are pre-filled now
        p.name = document.getElementById('new-name').value;
        p.age = document.getElementById('new-age').value;
        p.sign = document.getElementById('new-sign').value;
        p.species = document.getElementById('new-species').value;
        p.height = document.getElementById('new-height').value;
        p.bio = document.getElementById('new-bio').value;
        p.color = document.getElementById('new-color').value;
        
        if(uploadedAv) { p.av = uploadedAv; uploadedAv = ""; }
        save(); closeModals(); refreshAll(); alert("ID Updated!");
    }
  
    function openProfileModal() {  
        document.getElementById('modal-profile').style.display='flex';  
        const p = DB.profiles[DB.active];
        
        // --- PRE-FILL INPUTS (FIXES EDITING) ---
        document.getElementById('new-name').value = p.name;
        document.getElementById('new-age').value = p.age !== "-" ? p.age : "";
        document.getElementById('new-sign').value = p.sign !== "-" ? p.sign : "";
        document.getElementById('new-species').value = p.species !== "Visitor" ? p.species : "";
        document.getElementById('new-height').value = p.height !== "-" ? p.height : "";
        document.getElementById('new-bio').value = p.bio !== "Guest Access" ? p.bio : "";
        
        document.getElementById('new-color').value = p.color;
        document.getElementById('av-preview').src = p.av || DEFAULT_AV;

        const list = document.getElementById('prof-list'); list.innerHTML="";  
        DB.profiles.forEach((p,i)=>{  
            list.innerHTML += `<div style="padding:10px; border-bottom:1px solid #eee; display:flex; justify-content:space-between; align-items:center;">  
                <b>${p.name}</b>  
                <div>  
                    <button style="margin-right:5px; font-size:0.8rem;" onclick="addToCofront(${i})">+ Co-Con</button>
                    <button onclick="switchProfile(${i})">Switch</button>  
                    ${i!==0 ? `<button style="color:red; margin-left:5px;" onclick="if(confirm('Delete?')){DB.profiles.splice(${i},1); DB.active=0; save(); openProfileModal();}">x</button>` : ''}  
                </div>  
            </div>`;  
        });  
    }  

    function switchProfile(index) { logSwitch(DB.active); DB.active = index; DB.cofront = []; save(); refreshAll(); closeModals(); }
    function addToCofront(index) {
        if (!DB.cofront) DB.cofront = [];
        if (index === DB.active) { alert("Already fronting!"); return; }
        if (DB.cofront.includes(index)) { alert("Already co-fronting!"); return; }
        DB.cofront.push(index); save(); refreshAll(); alert(DB.profiles[index].name + " added to Co-Con!");
    }
    function logSwitch(oldIndex) {
        if (!DB.currentFrontStart) { DB.currentFrontStart = Date.now(); return; }
        const now = Date.now(); const diff = now - DB.currentFrontStart;
        const minutes = Math.floor(diff / 60000); const hours = Math.floor(minutes / 60);
        const displayTime = (hours > 0 ? hours + "h " : "") + (minutes % 60) + "m";
        const p = DB.profiles[oldIndex];
        DB.frontHistory.unshift({ n: p.name, d: new Date(DB.currentFrontStart).toLocaleDateString(), t: new Date(DB.currentFrontStart).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}), dur: displayTime || "<1m" });
        if (DB.frontHistory.length > 50) DB.frontHistory.pop();
        DB.currentFrontStart = now;
    }
    function openLogModal() {
        document.getElementById('modal-log').style.display = 'flex';
        const tbody = document.getElementById('front-log-body');
        tbody.innerHTML = "";
        DB.frontHistory.forEach(entry => { tbody.innerHTML += `<tr><td><b>${entry.n}</b></td><td>${entry.d}</td><td>${entry.t}</td><td>${entry.dur}</td></tr>`; });
    }

    function renderBio() {
        const p = DB.profiles[DB.active];
        if(!p.likes) p.likes=[]; if(!p.dislikes) p.dislikes=[]; if(!p.notes) p.notes="";
        const likesList = document.getElementById('likes-list'); likesList.innerHTML = "";
        p.likes.forEach((l, i) => { likesList.innerHTML += `<div class="bio-tag">${l} <span onclick="removeBioItem('likes',${i})">x</span></div>`; });
        const dislikesList = document.getElementById('dislikes-list'); dislikesList.innerHTML = "";
        p.dislikes.forEach((l, i) => { dislikesList.innerHTML += `<div class="bio-tag" style="background:#555;">${l} <span onclick="removeBioItem('dislikes',${i})">x</span></div>`; });
        document.getElementById('notes-in').value = p.notes;
    }
    function addBioItem(type) {
        const inputId = type === 'likes' ? 'like-in' : 'dislike-in'; const val = document.getElementById(inputId).value;
        if(val) { DB.profiles[DB.active][type].push(val); document.getElementById(inputId).value = ""; save(); renderBio(); }
    }
    function removeBioItem(type, index) { DB.profiles[DB.active][type].splice(index, 1); save(); renderBio(); }
    function saveBioNotes() { DB.profiles[DB.active].notes = document.getElementById('notes-in').value; save(); }
  
    function toggleSidebar() { document.getElementById('chan-list').classList.toggle('hidden'); const btn = document.querySelector('.sidebar-toggle'); btn.innerText = btn.innerText === '<' ? '>' : '<'; }  
    function renderChat() {  
        const list = document.getElementById('chan-list'); list.innerHTML="";  
        Object.keys(DB.channels).forEach(k => {  
            const div = document.createElement('div'); div.className = `chan-btn ${DB.curChan===k?'active':''}`;  
            div.innerText = DB.channels[k].name.substring(0,2).toUpperCase(); div.onclick = () => { DB.curChan=k; renderChat(); };  
            if(k!=='gen') { const del = document.createElement('div'); del.className='del-chan'; del.innerText='x'; div.appendChild(del); del.onclick=(e)=>{e.stopPropagation(); if(confirm("Delete?")){ delete DB.channels[k]; DB.curChan='gen'; save(); renderChat(); }}; }  
            list.appendChild(div);  
        });  
        const add = document.createElement('div'); add.className='chan-btn'; add.style.background='#4fc3f7'; add.style.color='white'; add.innerText='+';  
        add.onclick = () => { const n=prompt("Name:"); if(n){ const id=n.toLowerCase().replace(/\s/g,''); DB.channels[id]={name:n, msgs:[]}; save(); renderChat(); }};  
        list.appendChild(add);  
        const c = DB.channels[DB.curChan]; document.getElementById('chan-title').innerText = "#" + c.name;  
        const feed = document.getElementById('chat-feed'); feed.innerHTML="";  
        c.msgs.forEach((m, idx) => { 
            const imgHTML = m.img ? `<img src="${m.img}" class="pk-img">` : ''; 
            feed.innerHTML += `
            <div class="pk-msg" onclick="openChatOptions(${idx})">
                <img src="${m.av}" class="pk-av" style="background:${m.color}">
                <div>
                    <div class="pk-name" style="color:${m.color}">${m.name} <span style="color:#aaa; font-size:0.7em;">${m.time||''}</span></div>
                    <div class="pk-txt">${m.txt}${imgHTML}</div>
                </div>
            </div>`; 
        });  
        feed.scrollTop = feed.scrollHeight;  
    }  
    function sendMsg() {  
        const i = document.getElementById('msg-in'); 
        let txt = i.value;
        if(!txt && !chatImg) return;  
        const p = DB.profiles[DB.active];  
        const time = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        
        if(txt.startsWith("> Quoting:")) { }
        
        DB.channels[DB.curChan].msgs.push({ name:p.name, av:p.av, color:p.color, txt:txt, img:chatImg, time:time });  
        i.value=""; chatImg=""; save(); renderChat();  
    } 
    function sendAlert() {
        const msg = prompt("Broadcast Message:");
        if(msg) {
            DB.activeAlert = msg.toUpperCase(); save(); renderAlert();
        }
    }
    function renderAlert() {
        const el = document.getElementById('sys-alert');
        if(DB.activeAlert) {
            document.getElementById('sys-alert-msg').innerText = "‚ö†Ô∏è " + DB.activeAlert;
            el.style.display = 'flex';
        } else {
            el.style.display = 'none';
        }
    }
    function dismissAlert() { DB.activeAlert = null; save(); renderAlert(); }

    // --- CHAT ACTIONS ---
    function openChatOptions(index) {
        selectedMsgIndex = index;
        const msg = DB.channels[DB.curChan].msgs[index];
        document.getElementById('chat-action-text').innerText = msg.txt.substring(0, 30) + "...";
        document.getElementById('modal-chat-actions').style.display = 'flex';
    }
    function deleteMsg() {
        if(selectedMsgIndex > -1) {
            DB.channels[DB.curChan].msgs.splice(selectedMsgIndex, 1);
            save(); renderChat(); closeModals();
        }
    }
    function replyToMsg() {
        if(selectedMsgIndex > -1) {
            const msg = DB.channels[DB.curChan].msgs[selectedMsgIndex];
            const input = document.getElementById('msg-in');
            input.value = `> Quoting ${msg.name}: "${msg.txt}"\n` + input.value;
            closeModals();
            input.focus();
        }
    }
    function editMsg() {
        if(selectedMsgIndex > -1) {
            const msg = DB.channels[DB.curChan].msgs[selectedMsgIndex];
            const newTxt = prompt("Edit message:", msg.txt);
            if(newTxt !== null) {
                msg.txt = newTxt + " (edited)";
                save(); renderChat(); closeModals();
            }
        }
    }
  
    // --- DECOR ---  
    function renderDecor() {  
        const l = document.getElementById('decor-layer'); l.innerHTML="";   
        
        // APPLY ROOM BG IF EXISTS
        const stage = document.getElementById('pet-stage');
        if (DB.roomWallpaper) {
            stage.style.backgroundImage = `url('${DB.roomWallpaper}')`;
        } else {
            stage.style.backgroundImage = "none";
        }

        // RENDER EBI
        const ebi = document.querySelector('.ebi-img');
        const eScale = DB.ebiScale || 1;
        ebi.style.transform = `scale(${eScale})`;

        // RENDER STICKERS
        DB.decor.forEach((d, index) => {  
            const el = document.createElement('div'); el.className='sticker'; 
            // APPLY SCALE
            const scale = d.s || 1;
            el.style.transform = `scale(${scale})`;
            
            if (d.i.startsWith('http')) {
                const img = document.createElement('img');
                img.src = d.i;
                el.appendChild(img);
            } else {
                el.innerText = d.i;
            }
            el.style.left=d.x+"%"; el.style.top=d.y+"%";  
            
            // Interaction: Select & Drag
            let isDrag=false;  
            const move = (e) => { 
                if(!isDrag) return; 
                const b = document.getElementById('pet-stage').getBoundingClientRect(); 
                const cx = e.touches ? e.touches[0].clientX : e.clientX; 
                const cy = e.touches ? e.touches[0].clientY : e.clientY; 
                d.x = ((cx - b.left) / b.width) * 100; 
                d.y = ((cy - b.top) / b.height) * 100; 
                el.style.left = d.x+"%"; el.style.top = d.y+"%"; 
            };  
            const end = () => { if(isDrag){ isDrag=false; save(); } };  
            
            el.onmousedown = (e) => { 
                e.stopPropagation(); 
                isDrag=true; 
                selectSticker(index); // SELECT STICKER
            }; 
            el.ontouchstart = (e) => { 
                e.stopPropagation(); 
                isDrag=true; 
                selectSticker(index); // SELECT STICKER
            };  
            
            window.addEventListener('mousemove', move); window.addEventListener('touchmove', move, {passive:false}); window.addEventListener('mouseup', end); window.addEventListener('touchend', end);  
            l.appendChild(el);  
        });
        
        // Hide controls if clicked outside
        document.getElementById('pet-stage').onclick = (e) => {
            if(e.target.id === 'pet-stage' || e.target.id === 'decor-layer') {
                deselectSticker();
            }
        };
    }  
    
    // --- CLICKER & SELECTION FUNCTIONALITY ---
    function clickEbi(e) {
        e.stopPropagation(); 
        
        // 1. SELECT EBI FOR SCALING
        selectedDecorIndex = -1; // -1 represents Ebi
        const ctrls = document.getElementById('decor-controls');
        const slider = document.getElementById('scale-slider');
        const delBtn = ctrls.querySelector('button');
        
        // Highlight logic
        document.querySelector('.ebi-img').classList.add('selected');
        document.querySelectorAll('.sticker').forEach(s => s.classList.remove('selected'));

        slider.value = DB.ebiScale || 1;
        delBtn.style.display = 'none'; // Cannot delete Ebi
        ctrls.style.display = 'flex';

        // 2. ADD XP LOGIC
        DB.xp += 1;
        document.getElementById('cp-display').innerText = DB.xp;
        
        const rng = Math.random();
        if(rng < 0.2) {
            triggerEbiChat();
        } else if(rng > 0.95) {
            logToConsole("‚ö†Ô∏è GLITCH DETECTED: +5 XP");
            DB.xp += 5;
        }
        save();
    }

    function selectSticker(index) {
        selectedDecorIndex = index; // 0+ represents stickers
        const ctrls = document.getElementById('decor-controls');
        const slider = document.getElementById('scale-slider');
        const delBtn = ctrls.querySelector('button');
        const d = DB.decor[index];
        
        document.querySelector('.ebi-img').classList.remove('selected');
        document.querySelectorAll('.sticker').forEach((s, i) => {
            if(i === index) s.classList.add('selected');
            else s.classList.remove('selected');
        });

        slider.value = d.s || 1;
        delBtn.style.display = 'block'; // Can delete stickers
        ctrls.style.display = 'flex';
    }

    function deselectSticker() {
        selectedDecorIndex = -2; // None selected
        document.getElementById('decor-controls').style.display = 'none';
        document.querySelectorAll('.sticker').forEach(s => s.classList.remove('selected'));
        document.querySelector('.ebi-img').classList.remove('selected');
    }

    function updateDecorScale(val) {
        if(selectedDecorIndex === -1) {
            // Scale Ebi
            DB.ebiScale = val;
            document.querySelector('.ebi-img').style.transform = `scale(${val})`;
        } else if (selectedDecorIndex >= 0) {
            // Scale Sticker
            DB.decor[selectedDecorIndex].s = val;
            const stickers = document.querySelectorAll('.sticker');
            if(stickers[selectedDecorIndex]) {
                stickers[selectedDecorIndex].style.transform = `scale(${val})`;
            }
        }
        save();
    }

    function deleteSelectedDecor() {
        if(selectedDecorIndex >= 0) {
            DB.inventory.push(DB.decor[selectedDecorIndex].i);
            DB.decor.splice(selectedDecorIndex, 1);
            save();
            deselectSticker();
            renderDecor();
            alert("Item returned to backpack.");
        }
    }

    // --- FIXED BACKPACK ---
    function toggleSell() {
        isSelling = !isSelling;
        const btn = document.getElementById('sell-btn');
        const grid = document.getElementById('inventory-grid');
        if(isSelling) {
            btn.style.background = "#ff4444"; btn.innerText = "üõë Stop Selling"; grid.style.background = "#ffebee"; 
        } else {
            btn.style.background = "#4db6ac"; btn.innerText = "üí∞ Sell Mode"; grid.style.background = "#f9f9f9";
        }
        openBackpack(); 
    }

    function openBackpack() {  
        document.getElementById('modal-backpack').style.display='flex';  
        const g = document.getElementById('inventory-grid'); g.innerHTML="";  
        if(DB.inventory.length === 0) document.getElementById('empty-msg').style.display='block'; else document.getElementById('empty-msg').style.display='none';

        const clearBtn = document.createElement('div'); 
        clearBtn.style.fontSize="1.5rem"; clearBtn.innerText="üö´"; 
        clearBtn.style.border="2px dashed red"; clearBtn.style.padding="10px"; clearBtn.style.borderRadius="10px"; clearBtn.style.cursor="pointer";
        clearBtn.onclick = () => { DB.profiles[DB.active].wallpaper = ""; save(); refreshAll(); alert("Wallpaper Removed"); };
        g.appendChild(clearBtn);

        const counts = {};
        DB.inventory.forEach(x => { counts[x] = (counts[x] || 0) + 1; });

        const uniqueItems = Object.keys(counts).sort((a,b) => { 
            const aBg = a.startsWith('bg-'); const bBg = b.startsWith('bg-'); 
            return aBg === bBg ? 0 : aBg ? 1 : -1; 
        });

        uniqueItems.forEach(item => {  
            const b = document.createElement('div'); 
            b.style.fontSize="2.5rem"; b.style.cursor="pointer"; b.style.position="relative"; 
            
            let badge = "";
            if(counts[item] > 1 && !item.startsWith('bg-')) {
                badge = `<span style="position:absolute; bottom:0; right:0; background:red; color:white; font-size:0.6rem; padding:2px 5px; border-radius:10px;">x${counts[item]}</span>`;
            }
            
            // LOGIC FOR BEDROOM vs OS WALLPAPERS
            if(ROOM_WALLPAPERS.includes(item)) {
                // IT IS A BEDROOM WALLPAPER
                b.innerHTML = `<img src="${item}" style="width:50px; height:50px; object-fit:cover; border:2px solid #7e57c2; border-radius:5px;">` + badge;
                b.onclick = () => {
                    if(isSelling) {
                        const realIndex = DB.inventory.indexOf(item); 
                        if(realIndex > -1) { DB.inventory.splice(realIndex, 1); DB.xp += 30; } 
                        save(); openBackpack();
                    } else {
                        DB.roomWallpaper = item; save(); refreshAll(); closeModals(); nav('pet');
                    }
                };
            } else if(item.startsWith('bg-')) {  
                let icon = BG_ICONS[item] || "üñºÔ∏è"; b.style.fontSize="1.5rem"; b.innerHTML=icon; 
                b.style.border="2px solid pink"; b.style.padding="10px"; b.style.borderRadius="10px";
                
                b.onclick = () => { 
                    if(isSelling) {
                        const realIndex = DB.inventory.indexOf(item); 
                        if(realIndex > -1) { DB.inventory.splice(realIndex, 1); DB.xp += 30; } 
                        save(); openBackpack(); 
                    } else {
                        DB.profiles[DB.active].wallpaper = item; save(); refreshAll(); alert("Wallpaper Applied!"); 
                    }
                };  
            } else if (item.startsWith('http')) {
                b.innerHTML = `<img src="${item}" style="width:50px; height:50px; object-fit:contain;">` + badge;
                b.onclick = () => { 
                    if(isSelling) {
                        const realIndex = DB.inventory.indexOf(item); 
                        if(realIndex > -1) { DB.inventory.splice(realIndex, 1); DB.xp += 10; }
                        save(); openBackpack(); 
                    } else {
                        DB.decor.push({i:item, x:50, y:50, s:1}); 
                        const realIndex = DB.inventory.indexOf(item); 
                        if(realIndex > -1) DB.inventory.splice(realIndex, 1); 
                        save(); closeModals(); nav('pet'); 
                    }
                };
            }
            g.appendChild(b);  
        });  
    }  

    function clearDecor(){ 
        DB.decor.forEach(d => { DB.inventory.push(d.i); });
        DB.decor=[]; save(); renderDecor(); closeModals(); alert("Items returned to Backpack!");
    }  
  
    // --- PHARMACY ---  
    function logMood(i,p) { document.getElementById('receipt-list').innerHTML += `<div style="border-bottom:1px dotted #ccc; margin-bottom:5px;">${i} ... ${p} XP</div>`; pendingXP+=p; }  
    function processReceipt() { 
        if(pendingXP>0){ 
            DB.xp+=pendingXP; 
            DB.stamps = (DB.stamps || 0) + 1; // ADD STAMP
            if(DB.stamps > 10) DB.stamps = 10; // Cap at 10 until redeemed
            
            // NEW EXPANDED PRESCRIPTION LOGIC
            const task = CLINICAL_ORDERS[Math.floor(Math.random()*CLINICAL_ORDERS.length)]; 
            
            alert(`‚úÖ Receipt Processed\n\n+${pendingXP} XP\n\nüìã CLINICAL ORDER:\n"${task}"\n\nüíä STAMP ADDED TO CARD`); 
            logToConsole(`Processed: +${pendingXP} XP`); 
            pendingXP=0; 
            document.getElementById('receipt-list').innerHTML=""; 
            save(); refreshAll();
        } 
    }  
    
    function renderStamps() {
        const grid = document.getElementById('stamp-grid');
        if(!grid) return;
        grid.innerHTML = "";
        for(let i=0; i<10; i++) {
            const slot = document.createElement('div');
            slot.className = 'stamp-slot';
            if(i < DB.stamps) {
                // Use the user provided stamp URL
                slot.innerHTML = '<img src="https://i.postimg.cc/q7zPC5qM/ec9635acf11fbbb9c3b0bbfec3b6eb30.png" class="stamp-mark">';
            }
            grid.appendChild(slot);
        }
        
        const btn = document.getElementById('reward-btn');
        if(DB.stamps >= 10) {
            btn.style.display = 'block';
        } else {
            btn.style.display = 'none';
        }
    }

    // --- NEW REWARD ANIMATION FUNCTION ---
    function claimReward() {
        if(DB.stamps >= 10) {
            // Reward: 3 Random Items
            let rewards = [];
            for(let i=0; i<3; i++) rewards.push(LOOT_ITEMS[Math.floor(Math.random()*LOOT_ITEMS.length)]);
            
            // Add to inventory immediately
            DB.inventory.push(...rewards);
            
            // Show Overlay
            const screen = document.getElementById('reward-screen');
            const showcase = document.getElementById('reward-showcase');
            showcase.innerHTML = "";
            
            rewards.forEach(r => {
                let inner = "";
                if(r.startsWith('bg-')) inner = BG_ICONS[r] || "üñºÔ∏è";
                else if (ROOM_WALLPAPERS.includes(r)) inner = `<img src="${r}" style="border:2px solid #7e57c2">`;
                else inner = `<img src="${r}">`;
                showcase.innerHTML += `<div class="reward-item-display">${inner}</div>`;
            });

            // Create Confetti
            for(let i=0; i<50; i++) {
                const c = document.createElement('div');
                c.className = 'confetti';
                c.style.left = Math.random() * 100 + "%";
                c.style.top = -10 + "px";
                c.style.backgroundColor = `hsl(${Math.random()*360}, 100%, 50%)`;
                c.style.animationDuration = (Math.random() * 3 + 2) + "s";
                screen.appendChild(c);
            }
            
            screen.style.display = 'flex';
        }
    }

    function closeRewardScreen() {
        DB.stamps = 0;
        save();
        refreshAll();
        document.getElementById('reward-screen').style.display = 'none';
        // Remove confetti
        const conf = document.querySelectorAll('.confetti');
        conf.forEach(c => c.remove());
    }

    function fillPrescription() {   
        if(DB.xp>=50){   
            DB.xp-=50; let item = ""; let attempts = 0;
            do { item = LOOT_ITEMS[Math.floor(Math.random()*LOOT_ITEMS.length)]; attempts++; if (item.startsWith('bg-') && DB.inventory.includes(item)) { item = "DUPE"; } } while (item === "DUPE" && attempts < 10);
            if (item === "DUPE") { const consumables = LOOT_ITEMS.filter(i => !i.startsWith('bg-')); item = consumables[Math.floor(Math.random()*consumables.length)]; }
            DB.inventory.push(item);  
            
            const speech = EBI_TALK[Math.floor(Math.random()*EBI_TALK.length)]; 
            const bub = document.getElementById('pet-speech'); bub.innerText = speech; bub.classList.add('show'); setTimeout(()=>bub.classList.remove('show'), 2000);  
            
            logToConsole(`Rx Filled. -50 XP`); 
            
            let msg = `Rx Filled!\n\nReceived: Item`; 
            if(item.startsWith('bg-')) { 
                const icon = BG_ICONS[item] || "üñºÔ∏è"; 
                msg = `Rx Filled!\n\nReceived: ${icon} Wallpaper`; 
            } else if (ROOM_WALLPAPERS.includes(item)) {
                msg = `Rx Filled!\n\nReceived: New Room Wallpaper`;
            } else if(item.startsWith('http')) {
                msg = `Rx Filled!\n\nReceived: New Sticker!`;
            }
            alert(msg); save(); loadUI();   
        } else alert("Need 50 XP");   
    }  

    // --- CONSOLE LOGIC ---
    function logToConsole(msg) {
        if(!DB.consoleHistory) DB.consoleHistory = [];
        const time = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        DB.consoleHistory.push(`${time} - ${msg}`);
        if(DB.consoleHistory.length > 50) DB.consoleHistory.shift(); 
        save();
        renderConsole();
    }

    function renderConsole() {
        const feed = document.getElementById('console-log-feed');
        if(!feed) return;
        feed.innerHTML = "";
        if(DB.consoleHistory) {
            [...DB.consoleHistory].reverse().forEach(line => {
                feed.innerHTML += `<div class="log-line">${line}</div>`;
            });
        }
    }

    function triggerEbiChat() {
        const quote = EBI_TALK[Math.floor(Math.random()*EBI_TALK.length)];
        logToConsole(`Ebi says: "${quote}"`);
        const bub = document.getElementById('pet-speech'); 
        bub.innerText = quote; 
        bub.classList.add('show'); 
        setTimeout(()=>bub.classList.remove('show'), 2000); 
    }

    // --- DREAM JOURNAL ---
    function toggleNightMode() {
        document.body.classList.toggle('night-mode');
        // Auto navigate to dream journal if opening night mode
        if(document.body.classList.contains('night-mode')) {
            nav('dream');
        } else {
            nav('dash');
        }
    }
    
    function handleDreamImage(inpt) {
        const file = inpt.files[0]; if(!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
            tempDreamImg = e.target.result;
            const prev = document.getElementById('dream-preview');
            prev.src = tempDreamImg;
            prev.style.display = 'block';
        };
        reader.readAsDataURL(file);
    }

    function saveDream() {
        const loc = document.getElementById('dream-loc').value;
        const ent = document.getElementById('dream-ent').value;
        const txt = document.getElementById('dream-text').value;
        
        const nostalgia = document.getElementById('dream-nostalgia').value;
        const presence = document.getElementById('dream-presence').value;
        const reality = document.getElementById('dream-reality').value;
        
        if(txt || loc || tempDreamImg) {
            DB.dreamLog.unshift({
                d: new Date().toLocaleDateString(),
                loc: loc, 
                nostalgia: nostalgia, presence: presence, reality: reality,
                ent: ent, txt: txt,
                img: tempDreamImg 
            });
            // Reset form
            document.getElementById('dream-loc').value="";
            document.getElementById('dream-ent').value="";
            document.getElementById('dream-text').value="";
            document.getElementById('dream-preview').style.display='none';
            tempDreamImg = "";
            save(); 
            
            // INSTANT CONFIRMATION
            alert("Archive Logged.");
            renderDreamLog(); // Updates the hidden feed
        }
    }

    function renderDreamLog() {
        const f = document.getElementById('dream-feed');
        f.innerHTML = "";
        DB.dreamLog.forEach((d, i) => {
            const nos = d.nostalgia || 0;
            const pre = d.presence || 0;
            const rea = d.reality || 0;
            
            f.innerHTML += `
            <div class="dream-entry">
                <div class="dream-blur" onclick="this.classList.remove('dream-blur')">
                    <small style="opacity:0.7;">${d.d} ‚Ä¢ ${d.loc || 'Unknown'}</small><br>
                    ${d.ent ? `<strong>Visitors:</strong> ${d.ent}<br>` : ''}
                    
                    <div style="display:flex; gap:5px; margin:5px 0;">
                        <span style="font-size:0.6rem; border:1px solid #ccc; padding:2px 5px; border-radius:4px;">N: ${nos}%</span>
                        <span style="font-size:0.6rem; border:1px solid #ccc; padding:2px 5px; border-radius:4px;">P: ${pre}%</span>
                        <span style="font-size:0.6rem; border:1px solid #ccc; padding:2px 5px; border-radius:4px;">R: ${rea}%</span>
                    </div>

                    ${d.img ? `<img src="${d.img}" style="width:100%; height:auto; border-radius:5px; margin:5px 0; filter:grayscale(100%) contrast(150%); border:1px solid #7e57c2;">` : ''}

                    <p style="margin-top:5px; white-space:pre-wrap;">${d.txt}</p>
                </div>
                <button style="color:red; background:none; border:none; float:right; cursor:pointer;" onclick="if(confirm('Forget this dream?')){DB.dreamLog.splice(${i},1); save(); renderDreamLog();}">x</button>
            </div>`;
        });
    }
    
    function openDreamArchive() {
        renderDreamLog();
        document.getElementById('modal-dream-archive').style.display = 'flex';
    }
  
    // --- MISC & PRIVATE DIARY ---  
    function toggleCRT() { DB.settings.crt = document.getElementById('toggle-crt').checked; loadUI(); save(); }  
    function enterPin(n) { tempPin+=n; document.getElementById('pin-dots').innerText="*".repeat(tempPin.length); if(tempPin.length===4){ if(tempPin===DB.lock){ document.getElementById('lock-screen').style.display='none'; document.querySelector('.app-shell').style.display='flex'; refreshAll(); } else { tempPin=""; document.getElementById('pin-dots').innerText="ERR"; }}}  
    function clearPin(){ tempPin=""; document.getElementById('pin-dots').innerText=""; }  
    function setLock(){ const p=document.getElementById('pin-set').value; if(p.length===4){ DB.lock=p; save(); alert("Locked!"); closeModals(); }}  
    function disableLock(){ if(confirm("Remove?")){ DB.lock=null; save(); alert("Removed"); closeModals(); }}  
    function exportData() { const a=document.createElement('a'); a.href="data:text/json;charset=utf-8,"+encodeURIComponent(JSON.stringify(DB)); a.download="seiren_bk.json"; document.body.appendChild(a); a.click(); a.remove(); }  
    function importData(input) { 
        const file = input.files[0]; 
        if(!file) return; 
        
        const reader = new FileReader(); 
        reader.onload=(e)=>{ 
            try { 
                const json = JSON.parse(e.target.result); 
                
                // CHECK IF THIS IS A SYSTEM BACKUP (LOOK FOR sysName)
                if(!json.sysName && !json.profiles) {
                    alert("‚ö†Ô∏è WARNING: This does not look like a System Backup file.\n\nIf this is a PluralKit file, please use the PURPLE 'Import PluralKit' button below.");
                    input.value = "";
                    return;
                }

                // SMART MERGE (Fixes old backups breaking new features)
                // We keep current DB structure (DEFAULT_DB) and overwrite with loaded data
                // This ensures new fields like 'ebiScale' or 'roomWallpaper' are not lost/undefined
                DB = { ...DEFAULT_DB, ...json };
                
                // Sanity check for critical arrays
                if(!DB.profiles) DB.profiles = DEFAULT_DB.profiles;
                if(!DB.inventory) DB.inventory = [];
                if(!DB.decor) DB.decor = [];

                save(); 
                alert("Backup Loaded Successfully!"); 
                location.reload(); 
            } catch(x) { 
                alert("Error: Invalid Backup File. It might be corrupted."); 
                console.error(x); 
            } 
        }; 
        reader.readAsText(file); 
        input.value = ""; 
    }  
    
    // --- BULLETPROOF PLURALKIT IMPORT ---
    function importPluralKit(input) {
        const file = input.files[0];
        if(!file) return;
        const reader = new FileReader();
        
        reader.onload = (e) => {
            try {
                const json = JSON.parse(e.target.result);
                let members = [];
                
                // 1. Detect format (Pk, Tupperbox, or raw array)
                if (json.members && Array.isArray(json.members)) members = json.members;
                else if (json.tuppers && Array.isArray(json.tuppers)) members = json.tuppers;
                else if (Array.isArray(json)) members = json;
                else if (json.name) members = [json]; // Single file

                if (members.length === 0) throw new Error("No members found. Check file format.");

                let count = 0;
                members.forEach(m => {
                    // Simple check to avoid duplicates
                    if (!DB.profiles.some(p => p.name === m.name)) {
                        DB.profiles.push({
                            name: m.name || "Unknown",
                            av: m.avatar_url || DEFAULT_AV,
                            sign: m.pronouns || "?",
                            age: m.birthday || "--",
                            species: "System Member",
                            height: "--",
                            // JUST DUMP THE DESCRIPTION. No parsing.
                            bio: m.description || "Imported Member",
                            color: m.color ? "#"+m.color : "#ff69b4",
                            id: m.id || Math.floor(Math.random()*900000),
                            // Initialize empty arrays so the UI doesn't break
                            likes: [],
                            dislikes: [],
                            notes: ""
                        });
                        count++;
                    }
                });

                save();
                alert(`Success! Imported ${count} members.`);
                refreshAll();
            } catch(err) {
                alert("Import Failed: " + err.message);
                console.error(err);
            }
        };
        reader.readAsText(file);
        input.value = ""; 
    }

    function nav(id) { 
        document.querySelectorAll('.page').forEach(p=>p.classList.remove('active')); 
        const page = document.getElementById('page-'+id);
        page.classList.add('active'); 
        
        // --- LOCK SCROLL ON PET PAGE ---
        const content = document.querySelector('.content');
        if(id === 'pet') {
            content.classList.add('no-scroll');
        } else {
            content.classList.remove('no-scroll');
        }

        document.querySelectorAll('.dock-btn').forEach(b=>b.classList.remove('active')); 
        if(id==='pet')renderDecor(); 
        if(id==='chat')renderChat(); 
        if(id==='diary')renderDiary(); 
        if(id==='about')renderBio(); 
        if(id==='dream')renderDreamLog(); 
    }  
    
    function postDiary() { const t=document.getElementById('diary-in'); if(t.value){ DB.diary.unshift({d:new Date().toLocaleDateString(), n:DB.profiles[DB.active].name, uid: DB.profiles[DB.active].id, t:t.value}); t.value=""; save(); renderDiary(); } }  
    function renderDiary() { const f=document.getElementById('diary-feed'); f.innerHTML=""; const currentID = DB.profiles[DB.active].id; const myEntries = DB.diary.filter(e => e.uid === currentID || !e.uid); myEntries.forEach((e,i)=>{ f.innerHTML+=`<div class="diary-entry"><div class="del-diary" onclick="if(confirm('Del?')){DB.diary.splice(${DB.diary.indexOf(e)},1);save();renderDiary();}">x</div><small>${e.d} ‚Ä¢ ${e.n}</small><div style="white-space:pre-wrap;">${e.t}</div></div>`; }); }  
    
    function closeModals() { document.querySelectorAll('.modal').forEach(m=>m.style.display='none'); }  
    function openSettingsModal() { document.getElementById('modal-settings').style.display='flex'; }  
  
    // --- SERVICE WORKER REGISTRATION ---
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('sw.js')
                .then(reg => console.log('SW registered!', reg.scope))
                .catch(err => console.log('SW failed:', err));
        });
    }
</script>  
</body>  
        </html>
