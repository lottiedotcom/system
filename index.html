<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#ff69b4">
    <title>Seiren OS 2.0</title>
    
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/2919/2919573.png">
    <link rel="icon" type="image/png" href="https://cdn-icons-png.flaticon.com/512/2919/2919573.png">

    <style>
        /* --- THEME VARIABLES --- */
        :root {
            --main: #ff69b4;
            --bg-light: #ffe4e1;
            --bg-dark: #ffb7b2;
            --dark: #d12e87;
            --glass: rgba(255, 255, 255, 0.95);
            --text: #555;
            --blue: #4fc3f7;
            --banana: #ffe135;
        }

        /* 2004 SCROLLBAR */
        ::-webkit-scrollbar { width: 12px; }
        ::-webkit-scrollbar-track { background: #e0e0e0; border-left: 1px solid #ccc; }
        ::-webkit-scrollbar-thumb { background: #ff69b4; border: 2px outset #ff9eb5; }

        body {
            font-family: 'Verdana', 'Tahoma', sans-serif;
            background-color: var(--bg-light);
            background-image: 
                radial-gradient(var(--bg-dark) 15%, transparent 16%),
                radial-gradient(var(--bg-dark) 15%, transparent 16%);
            background-size: 20px 20px;
            background-position: 0 0, 10px 10px;
            margin: 0; display: flex; justify-content: center; height: 100vh; overflow: hidden;
            color: var(--text); overscroll-behavior: none;
            user-select: none;
            -webkit-user-select: none;
        }

        /* --- CRT & DREAM OVERLAYS --- */
        .dream-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; z-index: 9998;
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.65' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)' opacity='0.05'/%3E%3C/svg%3E");
            opacity: 0.5;
            backdrop-filter: blur(0.5px);
            mix-blend-mode: overlay;
        }
        
        .scanlines {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: linear-gradient(
                to bottom,
                rgba(255,255,255,0),
                rgba(255,255,255,0) 50%,
                rgba(0,0,0,0.1) 50%,
                rgba(0,0,0,0.1)
            );
            background-size: 100% 4px;
            pointer-events: none; z-index: 9999;
            opacity: 0.6;
            animation: scanMove 60s linear infinite;
        }
        @keyframes scanMove { 0% { background-position: 0 0; } 100% { background-position: 0 100%; } }

        /* --- APP SHELL --- */
        #welcome-layer {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: linear-gradient(135deg, var(--bg-light) 0%, #ffffff 100%);
            z-index: 10000; display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            transition: opacity 0.5s ease-out;
        }
        .welcome-card {
            background: rgba(255,255,255,0.9); padding: 40px; border-radius: 40px;
            box-shadow: 0 10px 40px rgba(255, 105, 180, 0.3);
            text-align: center; backdrop-filter: blur(5px);
            width: 80%; max-width: 320px; border: 4px ridge white;
        }
        .enter-btn {
            background: #ff69b4; color: white; border: 3px outset #ffb7b2; padding: 15px 0; width: 100%;
            border-radius: 50px; font-size: 1.2rem; font-weight: bold; cursor: pointer; 
            box-shadow: 2px 2px 5px rgba(0,0,0,0.1); 
            transition: transform 0.1s; letter-spacing: 1px;
        }
        .enter-btn:active { transform: scale(0.98); border-style: inset; }

        .app-shell {
            width: 100%; max-width: 480px; background: var(--glass);
            display: none; flex-direction: column; position: relative; height: 100%;
            box-shadow: 0 0 50px rgba(0,0,0,0.1); z-index: 10;
        }

        .status-bar {
            display: flex; justify-content: space-between; padding: 10px 15px;
            font-size: 0.7rem; font-weight: bold; color: var(--dark);
            background: rgba(255,255,255,0.8); border-bottom: 2px solid white;
        }
        
        .lvl-badge {
            position: fixed; top: 50px; left: 10px; z-index: 50;
            background: white; border: 2px outset #ff69b4;
            border-radius: 50%; width: 40px; height: 40px;
            display: flex; align-items: center; justify-content: center;
            font-size: 1.5rem; box-shadow: 2px 2px 5px rgba(0,0,0,0.1);
            animation: popIn 0.5s;
        }

        .marquee-container {
            background: var(--main);
            color: white; padding: 6px 0; white-space: nowrap; overflow: hidden;
            border-bottom: 2px solid white; border-top: 2px solid white;
        }
        .marquee-text {
            display: inline-block; padding-left: 100%;
            animation: marquee 15s linear infinite; font-size: 0.7rem; letter-spacing: 1px; font-weight:bold;
        }
        @keyframes marquee { 0% { transform: translate(0, 0); } 100% { transform: translate(-100%, 0); } }

        .content {
            flex: 1; overflow-y: auto; overflow-x: hidden;
            padding: 20px; padding-bottom: 120px; scroll-behavior: smooth;
        }
        .page { display: none; animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .page.active { display: block; }
        @keyframes popIn { from {opacity:0; transform:scale(0.98);} to {opacity:1; transform:scale(1);} }

        /* DASHBOARD */
        .dash-header { text-align: center; margin-bottom: 20px; }
        .xp-box { background: white; padding: 10px; border-radius: 12px; margin-bottom: 15px; border: 2px inset var(--blue); text-align: center; }
        .xp-track { height: 8px; background: #eee; border-radius: 4px; margin-top: 5px; overflow: hidden; border: 1px inset #ccc; }
        .xp-fill { height: 100%; background: repeating-linear-gradient(45deg, var(--blue), var(--blue) 5px, #87cefa 5px, #87cefa 10px); width: 0%; transition: width 0.5s; }

        /* ID CARD */
        .id-card-wrap {
            background: white; border: 4px ridge var(--main); border-radius: 20px;
            padding: 5px; box-shadow: 3px 3px 0 #ffb7b2;
            margin-bottom: 20px; position: relative; overflow: hidden;
        }
        .id-card-wrap::after {
            content: ''; position: absolute; top: 0; left: -100%; width: 50%; height: 100%;
            background: linear-gradient(to right, rgba(255,255,255,0) 0%, rgba(255,255,255,0.8) 50%, rgba(255,255,255,0) 100%);
            transform: skewX(-25deg); animation: shine 3s infinite; pointer-events: none;
        }
        @keyframes shine { 0% {left: -100%;} 20% {left: 200%;} 100% {left: 200%;} }

        .id-inner {
            background: var(--bg-light);
            background-image: radial-gradient(var(--bg-dark) 2px, transparent 2px); background-size: 15px 15px;
            border: 2px dashed var(--dark); border-radius: 15px; padding: 15px; position: relative;
        }
        .deco-bow { position: absolute; top: -5px; right: -5px; font-size: 2rem; transform: rotate(15deg); z-index: 5; }
        .id-top { display: flex; justify-content: space-between; border-bottom: 2px solid var(--main); padding-bottom: 5px; margin-bottom: 10px; }
        .id-body { display: flex; gap: 10px; align-items: center; }
        .id-photo { 
            width: 80px; height: 80px; border-radius: 50%; border: 3px outset white; 
            outline: 3px solid var(--main); object-fit: cover; background: white;
            animation: float 4s ease-in-out infinite; cursor: pointer;
        }
        .id-data { flex: 1; }
        .id-stats-grid {
            display: grid; grid-template-columns: 1fr; gap: 4px; font-size: 0.65rem;
            background: rgba(255,255,255,0.8); padding: 5px; border-radius: 5px; margin-top:5px; border: 1px inset white;
        }
        .signature { font-family: 'Brush Script MT', cursive; font-size: 1.2rem; color: var(--blue); transform: rotate(-5deg); display: inline-block; margin-right: 10px; }

        /* DASH BUTTONS */
        .dash-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-bottom: 20px; }
        .dash-btn {
            background: white; border-radius: 15px; padding: 10px 5px; text-align: center;
            box-shadow: 2px 2px 5px rgba(0,0,0,0.05); cursor: pointer; transition: 0.1s;
            border: 2px outset #eee;
        }
        .dash-btn:active { transform: scale(0.95); border-style: inset; }
        .dash-icon { font-size: 1.5rem; display: block; margin-bottom: 3px; }
        .dash-label { font-size: 0.7rem; font-weight: bold; color: var(--text); }

        /* PET ROOM & DRAG SYSTEM */
        .pet-box { background: white; border: 3px ridge var(--main); border-radius: 20px; padding: 20px; text-align: center; margin-bottom: 20px; position:relative; transition: background 0.3s; min-height: 250px; overflow: hidden; touch-action: none; }
        
        .ebi-img { width: 140px; transition: transform 0.2s; margin-top:30px; position:relative; z-index:2; pointer-events: none;}
        .ebi-img.bounce { animation: bigBounce 0.5s ease; }
        @keyframes bigBounce { 0% {transform:scale(1);} 50% {transform:scale(1.2) translateY(-15px);} 100% {transform:scale(1);} }

        /* Draggable Items */
        .pet-sticker {
            position: absolute;
            font-size: 3rem;
            cursor: grab;
            user-select: none;
            transition: transform 0.1s;
        }
        .pet-sticker.wear { z-index: 20; } /* Wearables on top of Ebi */
        .pet-sticker.decor { z-index: 1; } /* Decor behind Ebi */
        .pet-sticker:active { cursor: grabbing; transform: scale(1.1); z-index: 30; }

        /* WALLPAPERS */
        .bg-hearts { background-color: #ffe4e1 !important; background-image: radial-gradient(#ff69b4 2px, transparent 2px), radial-gradient(#ff69b4 2px, transparent 2px) !important; background-size: 20px 20px !important; background-position: 0 0, 10px 10px !important; }
        .bg-dots-blue { background-color: #e0f7fa !important; background-image: radial-gradient(#4fc3f7 2px, transparent 2px) !important; background-size: 15px 15px !important; }
        .bg-check-green { background-color: #f1f8e9 !important; background-image: repeating-linear-gradient(45deg, #c5e1a5 25%, transparent 25%, transparent 75%, #c5e1a5 75%, #c5e1a5), repeating-linear-gradient(45deg, #c5e1a5 25%, #f1f8e9 25%, #f1f8e9 75%, #c5e1a5 75%, #c5e1a5) !important; background-size: 20px 20px !important; }
        .bg-clouds { background-color: #e3f2fd !important; background-image: radial-gradient(white 8px, transparent 9px), radial-gradient(white 8px, transparent 9px) !important; background-size: 40px 40px !important; background-position: 0 0, 20px 20px !important; }
        
        /* NEW WALLPAPERS */
        .bg-seiren {
            background: linear-gradient(135deg, #ffb3d9 25%, transparent 25%),
                        linear-gradient(225deg, #ffb3d9 25%, transparent 25%),
                        linear-gradient(45deg, #ffb3d9 25%, transparent 25%),
                        linear-gradient(315deg, #ffb3d9 25%, #ffe4f0 25%) !important;
            background-size: 30px 30px !important;
            background-position: 15px 0, 15px 0, 0 0, 0 0 !important;
        }
        .bg-bath {
            background: linear-gradient(to bottom, #e1f5fe 0%, #b3e5fc 100%) !important;
            background-image: 
                radial-gradient(circle, #81d4fa 2px, transparent 2px),
                radial-gradient(circle, #4fc3f7 1px, transparent 1px) !important;
            background-size: 40px 40px, 20px 20px !important;
            background-position: 0 0, 10px 10px !important;
        }
        .bg-bubblegum {
            background: #ffccdd !important;
            background-image: repeating-radial-gradient(circle at 0 0, transparent 0, #ffccdd 10px),
                              repeating-linear-gradient(#ff99bb55, #ff99bb) !important;
        }
        .bg-nature {
            background: #c8e6c9 !important;
            background-image: 
                linear-gradient(45deg, #a5d6a7 25%, transparent 25%),
                linear-gradient(-45deg, #a5d6a7 25%, transparent 25%),
                linear-gradient(45deg, transparent 75%, #a5d6a7 75%),
                linear-gradient(-45deg, transparent 75%, #a5d6a7 75%) !important;
            background-size: 20px 20px !important;
        }

        /* INVENTORY & GACHA */
        .gacha-pool-btn { width: 45%; margin: 2px; padding: 15px; border-radius: 12px; font-weight: bold; font-size: 0.9rem; }
        
        .inv-section-title { width: 100%; border-bottom: 2px solid #ddd; margin: 10px 0 5px 0; font-size: 0.7rem; color: #888; text-transform: uppercase; letter-spacing: 1px; }
        .inventory-grid { display: flex; flex-wrap: wrap; gap: 5px; justify-content: flex-start; }
        .inv-item { font-size: 1.5rem; cursor: pointer; padding: 5px; border: 1px solid #ddd; background: white; border-radius: 5px; width: 40px; height: 40px; display:flex; align-items:center; justify-content:center;}
        .inv-item:hover { background: #e0f7fa; border-color: var(--blue); }

        /* RECEIPT SYSTEM */
        .receipt-container {
            font-family: 'Courier New', monospace;
            background: #fff;
            padding: 15px;
            border: 1px dashed #aaa;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            position: relative;
            margin-top: 15px;
        }
        .receipt-header { text-align: center; border-bottom: 2px dashed #000; padding-bottom: 10px; margin-bottom: 10px; font-weight: bold; font-size: 0.9rem; }
        .receipt-lines { min-height: 80px; font-size: 0.75rem; line-height: 1.4; color: #333; }
        .receipt-footer { border-top: 2px dashed #000; padding-top: 10px; margin-top: 10px; font-size: 0.8rem; font-weight: bold; display: flex; justify-content: space-between; }
        .print-btn {
            background: var(--dark); color: white; border: none; padding: 10px; width: 100%;
            font-family: 'Courier New', monospace; font-weight: bold; margin-top: 10px;
            cursor: pointer; text-transform: uppercase; letter-spacing: 1px;
        }
        .print-btn:active { opacity: 0.8; }
        .print-btn:disabled { background: #ccc; cursor: not-allowed; }

        /* UI GENERAL */
        .btn-main { background: var(--main); color: white; border: 2px outset #ff9eb5; padding: 12px; width: 100%; border-radius: 25px; font-weight: bold; cursor: pointer; box-shadow: 2px 2px 0 rgba(0,0,0,0.1); }
        .btn-main:active { transform: translateY(2px); box-shadow: none; border-style: inset; }
        
        .modal-overlay { position: fixed; top:0; left:0; right:0; bottom:0; background: rgba(0,0,0,0.6); z-index: 2000; display: none; align-items: center; justify-content: center; backdrop-filter: blur(2px); }
        .modal-box { background: white; width: 85%; max-width: 400px; border-radius: 25px; border: 4px ridge var(--main); padding: 20px; max-height: 80vh; overflow-y: auto; box-shadow: 0 10px 30px rgba(0,0,0,0.3); animation: popIn 0.3s; }

        /* BBS & OTHERS */
        .bbs-container { background: white; border: 2px ridge var(--main); border-radius: 15px; height: 100%; min-height: 400px; display: flex; flex-direction: column; overflow: hidden; }
        .bbs-messages { flex: 1; overflow-y: auto; padding: 10px; background: #f9f9f9; }
        .bbs-msg { background: white; padding: 8px 12px; border-radius: 10px; margin-bottom: 8px; box-shadow: 1px 1px 3px rgba(0,0,0,0.05); font-size: 0.8rem; border-left: 4px solid #ddd; }
        input { width: 100%; padding: 12px; border: 2px inset #ddd; border-radius: 15px; box-sizing: border-box; font-family:inherit; margin-bottom: 10px; outline:none; background: #fffdfd; }
        
        nav { position: fixed; bottom: 35px; left: 20px; right: 20px; background: rgba(255,255,255,0.95); border-radius: 40px; display: flex; justify-content: space-around; padding: 15px 0; box-shadow: 0 5px 20px rgba(0,0,0,0.1); z-index: 100; border: 2px solid white; }
        .nav-btn { background: none; border: none; color: #ccc; font-size: 1.4rem; transition: 0.2s; display: flex; flex-direction:column; align-items: center; }
        .nav-label { font-size: 0.55rem; margin-top:2px; font-weight:bold; }
        .nav-btn.active { color: var(--main); transform: scale(1.1); }

        .save-ribbon {
            position: fixed; bottom: 0; left: 0; right: 0; height: 25px;
            background: #d12e87; color: white;
            font-size: 0.7rem; display: flex; align-items: center; justify-content: center;
            z-index: 200; border-top: 2px solid white; font-weight: bold;
            letter-spacing: 1px;
        }
        
        .toast { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background: rgba(255, 105, 180, 0.9); color: white; padding: 10px 20px; border-radius: 20px; font-size: 0.8rem; opacity: 0; transition: 0.3s; z-index: 10001; font-weight:bold; }
        .toast.show { opacity: 1; top: 30px; }

        .corkboard { background: #e6d7c3; border: 5px ridge #8b5a2b; border-radius: 10px; padding: 15px; min-height: 400px; position: relative; }
        .polaroid { background: white; padding: 6px; text-align: center; margin-bottom:15px; transform: rotate(-2deg); box-shadow: 3px 3px 6px rgba(0,0,0,0.1); position:relative; transition: transform 0.2s; display: inline-block; width: 45%; margin: 2%; vertical-align: top; }
        .fab-btn { position: fixed; bottom: 100px; right: 25px; width: 60px; height: 60px; background: var(--main); color: white; border-radius: 50%; border: 3px outset white; font-size: 2rem; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 10px rgba(0,0,0,0.3); cursor: pointer; z-index: 100; transition: transform 0.2s; }
        
        .badges-container { display: flex; gap: 5px; justify-content: center; flex-wrap: wrap; margin-top: 20px; opacity: 0.9; }
        .web-badge { width: 88px; height: 31px; border: 1px solid #fff; background: #e0e0e0; display: flex; align-items: center; justify-content: center; font-size: 9px; font-weight: bold; color: #555; text-decoration: none; }
        
        /* TASK LIST */
        .task-item { background: white; padding: 10px; margin-bottom: 5px; border-radius: 10px; display: flex; justify-content: space-between; border-bottom: 1px solid #eee; }
        
        /* DIARY */
        .diary-box { background: white; border-radius: 15px; padding: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        .mood-bar { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-bottom: 15px; }
        .mood-btn { font-size: 1.5rem; background: #f0f0f0; border-radius: 15px; height: 40px; border: 2px outset #eee; cursor: pointer; display:flex; align-items:center; justify-content:center; }
        .mood-btn.selected { border-color: var(--main); background: var(--bg-light); border-style: inset; }

        .fortune-stage { perspective: 1000px; width: 140px; height: 200px; margin: 0 auto; cursor: pointer; }
        .card-wrapper { width: 100%; height: 100%; position: relative; transform-style: preserve-3d; transition: transform 0.8s; }
        .card-wrapper.flipped { transform: rotateY(180deg); }
        .card-face { position: absolute; width: 100%; height: 100%; backface-visibility: hidden; border-radius: 12px; display: flex; flex-direction: column; align-items: center; justify-content: center; box-shadow: 0 5px 15px rgba(0,0,0,0.15); border: 4px solid white; }
        .card-front { background: repeating-linear-gradient(45deg, var(--main), var(--main) 10px, #ffb7b2 10px, #ffb7b2 20px); }
        .card-back { background: white; transform: rotateY(180deg); padding: 10px; text-align: center; border: 2px solid var(--main); }
        .new-day-btn { background: #4fc3f7; color: white; border: 2px outset #81d4fa; padding: 8px 15px; border-radius: 20px; font-size: 0.8rem; margin-top: 15px; cursor: pointer; box-shadow: 2px 2px 0 #29b6f6; font-weight: bold; }

    </style>
</head>
<body>

<div class="dream-overlay"></div>
<div class="scanlines"></div>
<div id="toast" class="toast">üíæ Saved!</div>

<div id="welcome-layer">
    <div class="welcome-card">
        <div style="font-size:4rem; margin-bottom:10px;">üéÄ</div>
        <h1 class="welcome-title">SEIREN OS</h1>
        <button class="enter-btn" onclick="enterApp()">
            ENTER WORLD<br>
            <span style="font-size:1rem;">‚ô°</span>
        </button>
    </div>
</div>

<div class="app-shell" id="main-app">
    
    <div id="lvl-badge" class="lvl-badge">üå±</div>

    <div class="status-bar">
        <span id="clock">12:00</span>
        <span>üîã 100%</span>
    </div>
    
    <div class="marquee-container">
        <div class="marquee-text">
            ‚òÖ SYSTEM ONLINE ‚òÖ WELCOME HOME ‚òÖ EBI IS HUNGRY ‚òÖ MAKE A WISH ‚òÖ GIRLS BRAVO FOREVER ‚òÖ
        </div>
    </div>

    <div class="content">

        <div id="tab-dash" class="page active">
            
            <div id="setup-view" style="text-align:center; padding:30px; display:none;">
                <h2 style="color:var(--main);">New System?</h2>
                <input type="text" id="setup-name" placeholder="Name">
                <input type="number" id="setup-age" placeholder="Age">
                <button class="btn-main" onclick="initFirstProfile()">Create ID</button>
            </div>

            <div id="dash-view" style="display:none; position:relative;">
                
                <div class="dash-header">
                    <h2 style="margin:0; color:var(--dark);" id="dash-greet">Hello!</h2>
                    <span style="font-size:0.8rem; color:#888;">System Dashboard</span>
                </div>

                <div class="xp-box">
                    <div style="display:flex; justify-content:space-between; font-size:0.8rem; font-weight:bold; color:var(--blue);">
                        <span>Level <span id="lvl-num">1</span></span>
                        <span><span id="xp-val">0</span>/<span id="xp-req">100</span> XP</span>
                    </div>
                    <div class="xp-track"><div id="xp-bar" class="xp-fill"></div></div>
                    <div style="margin-top:5px; font-size:0.7rem; color:var(--dark); font-weight:bold;">Bananas: <span id="credit-val">0</span> üçå</div>
                </div>

                <div class="id-card-wrap">
                    <div class="id-inner">
                        <div class="deco-bow">üéÄ</div>
                        <div class="id-top">
                            <span style="font-size:0.7rem; font-weight:bold; color:var(--dark);">SEIREN GOV</span>
                            <span style="font-size:0.6rem; color:#aaa; font-weight:bold;">ID CARD</span>
                        </div>
                        <div class="id-body">
                            <img id="id-pic" class="id-photo" src="" referrerpolicy="no-referrer" onclick="rotateAvatar()" onerror="this.src='https://cdn-icons-png.flaticon.com/512/3233/3233508.png'">
                            <div class="id-data">
                                <div id="id-name" style="font-size:1.3rem; font-weight:bold; color:var(--dark); line-height:1;">User</div>
                                <div id="id-real" style="font-size:0.7rem; font-style:italic; color:#888; margin-bottom:8px;">aka ???</div>
                                <div class="id-stats-grid">
                                    <span><b>ID:</b> <span id="id-num">000</span></span>
                                    <span><b>Sign:</b> <span id="id-sign">?</span></span>
                                    <div style="grid-column: span 2; font-style: italic; color:#666;" id="id-traits"></div>
                                </div>
                            </div>
                        </div>
                        <div class="id-footer">
                            AUTHORIZED SIGNATURE: <span class="signature" id="my-sig">User</span>
                        </div>
                    </div>
                </div>

                <div class="dash-grid">
                    <div class="dash-btn" onclick="openProfileManager()">
                        <span class="dash-icon">üë•</span>
                        <span class="dash-label">Switch</span>
                    </div>
                    <div class="dash-btn" onclick="openPortal()">
                        <span class="dash-icon">üåÄ</span>
                        <span class="dash-label">Portal</span>
                    </div>
                    <div class="dash-btn" onclick="openBackpack()">
                        <span class="dash-icon">üéí</span>
                        <span class="dash-label">Backpack</span>
                    </div>
                </div>

                <div style="text-align:center; padding-bottom:20px;">
                    <h3 style="color:var(--main); margin-bottom:5px;">Daily Fortune</h3>
                    <div class="fortune-stage" onclick="flipFortune()">
                        <div class="card-wrapper" id="fortune-card">
                            <div class="card-face card-front"><span style="font-size:3rem; color:white; font-weight:bold;">?</span></div>
                            <div class="card-face card-back">
                                <div id="fortune-icon" style="font-size:3rem; margin-bottom:5px;">‚≠ê</div>
                                <strong id="fortune-title" style="color:var(--main); font-size:0.9rem;"></strong>
                                <p id="fortune-desc" style="font-size:0.65rem; color:#666; margin-top:2px; line-height:1.2;"></p>
                            </div>
                        </div>
                    </div>
                    <button class="new-day-btn" onclick="resetFortune()">‚Üª New Day</button>
                </div>

                <div class="badges-container">
                    <a href="#" class="web-badge" style="background:#ff9eb5; color:white;">HTML VALID</a>
                    <a href="#" class="web-badge" style="background:#4fc3f7; color:white;">NOTEPAD</a>
                    <a href="#" class="web-badge" style="background:#d12e87; color:white;">GIRLS BRAVO</a>
                    <a href="#" class="web-badge" style="background:#b39ddb; color:white;">IE 6.0</a>
                </div>

            </div>
        </div>

        <div id="tab-pet" class="page">
            
            <div id="pet-container" class="pet-box">
                <div id="room-decor-layer"></div>
                <div id="room-wear-layer"></div>
                
                <img id="ebi-pet" src="https://i.postimg.cc/13FQckct/Untitled-Artwork-20260110072840-20260110074706.png" class="ebi-img">
                
                <h3 style="color:var(--main);">Ebi</h3>
                <div style="background:#eee; height:12px; border-radius:10px; overflow:hidden; margin:10px 0;">
                    <div id="pet-bar" style="width:50%; height:100%; background:var(--main); transition:width 0.5s;"></div>
                </div>
                <div id="ebi-msg" style="height:20px; font-size:0.7rem; color:#888; margin-bottom:10px;">Do tasks to feed me!</div>
            </div>

            <div style="margin-bottom:10px; text-align:center;">
                <button class="btn-main" style="background:#e1f5fe; color:#0277bd; border-color:#81d4fa;" onclick="takeBath()">üõÅ Take a Bath (Daily Event)</button>
            </div>

            <div style="margin-bottom:10px;">
                <strong>To Do List</strong>
                <div style="display:flex; gap:5px;">
                    <input type="text" id="task-in" placeholder="Task...">
                    <button class="btn-main" style="width:auto;" onclick="addTask()">+</button>
                </div>
                <div id="task-list"></div>
            </div>
            
            <div style="margin-top:20px;">
                <strong style="color:var(--dark);">Quick Mood Log</strong>
                <div class="quick-mood-board" style="display:grid; grid-template-columns: repeat(4, 1fr); gap:8px; margin-top:5px;">
                    <button class="mood-btn" onclick="logMoodQuick('üòä','Good')">üòä</button>
                    <button class="mood-btn" onclick="logMoodQuick('üò¢','Sad')">üò¢</button>
                    <button class="mood-btn" onclick="logMoodQuick('üò°','Mad')">üò°</button>
                    <button class="mood-btn" onclick="logMoodQuick('üíñ','Love')">üíñ</button>
                    <button class="mood-btn" onclick="logMoodQuick('‚ú®','Sparkle')">‚ú®</button>
                    <button class="mood-btn" onclick="logMoodQuick('üíÄ','Dead')">üíÄ</button>
                    <button class="mood-btn" onclick="logMoodQuick('üí§','Sleepy')">üí§</button>
                    <button class="mood-btn" onclick="logMoodQuick('‚òÅÔ∏è','Numb')">‚òÅÔ∏è</button>
                </div>
                
                <div class="receipt-container">
                    <div class="receipt-header">
                        ‚ïî‚ïê‚ïê‚ïê‚ïê SEIREN OS ‚ïê‚ïê‚ïê‚ïê‚ïó<br>
                        ‚ïë   MOOD RECEIPT    ‚ïë<br>
                        ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
                    </div>
                    <div id="receipt-lines" class="receipt-lines">
                        Waiting for input...
                    </div>
                    <div class="receipt-footer">
                        <span>ENTRIES: <span id="r-count">0</span></span>
                        <span>PENDING: +<span id="r-xp">0</span> XP</span>
                    </div>
                    <button id="print-btn" class="print-btn" onclick="cashOutReceipt()" disabled>üñ®Ô∏è PRINT & COLLECT</button>
                </div>
            </div>
        </div>

        <div id="tab-bbs" class="page">
            <h2 style="color:var(--main);">System Chat</h2>
            <div class="bbs-container">
                <div class="bbs-messages" id="bbs-feed"></div>
                <div class="bbs-input-area" style="padding:10px; border-top:1px solid #eee; display:flex; gap:5px;">
                    <input type="text" id="bbs-input" placeholder="Message..." style="margin:0;">
                    <button class="btn-main" style="width:auto; padding:10px;" onclick="postBBS()">Send</button>
                </div>
            </div>
        </div>

        <div id="tab-wish" class="page">
            <h2 style="color:var(--blue);">Wishlist</h2>
            <div class="corkboard">
                <div id="wish-list" class="wish-grid"></div>
            </div>
            <button class="fab-btn" onclick="openWishModal()">+</button>
        </div>

        <div id="tab-diary" class="page">
            <h2 style="color:var(--main);">Secret Diary</h2>
            <div class="diary-box">
                <div class="mood-bar">
                    <button class="mood-btn selected" onclick="setMood('üòä', this)">üòä</button>
                    <button class="mood-btn" onclick="setMood('üò¢', this)">üò¢</button>
                    <button class="mood-btn" onclick="setMood('üò°', this)">üò°</button>
                    <button class="mood-btn" onclick="setMood('üíñ', this)">üíñ</button>
                </div>
                <textarea id="diary-in" style="width:100%; height:80px; padding:10px; border:2px inset #eee; border-radius:10px; resize:none;" placeholder="Write something..."></textarea>
                <button class="btn-main" onclick="postDiary()">Save Entry</button>
            </div>
            <div id="diary-feed" style="margin-top:20px;"></div>
        </div>

    </div> <div class="save-ribbon">‚ô° REMEMBER TO SAVE BEFORE LEAVING ‚ô°</div>

    <div id="modal-backpack" class="modal-overlay">
        <div class="modal-box">
            <h3 style="margin-top:0; color:var(--main);">üéí Ebi's Backpack</h3>
            
            <div style="background:#f9f9f9; border:2px inset #eee; padding:10px; border-radius:10px; margin-bottom:15px;">
                <div style="font-size:0.8rem; font-weight:bold; color:var(--dark);">Gacha Shop (50 üçå)</div>
                <div style="display:flex; flex-wrap:wrap; justify-content:center;">
                    <button class="btn-main gacha-pool-btn" style="background:#ffb7b2;" onclick="playGacha('cute')">üéÄ Cute</button>
                    <button class="btn-main gacha-pool-btn" style="background:#333;" onclick="playGacha('dark')">üï∏Ô∏è Dark</button>
                    <button class="btn-main gacha-pool-btn" style="background:#ff69b4;" onclick="playGacha('seiren')">üëô Seiren</button>
                    <button class="btn-main gacha-pool-btn" style="background:#81c784;" onclick="playGacha('fun')">üê∏ Fun</button>
                </div>
            </div>

            <div style="font-size:0.8rem; font-weight:bold;">Inventory (Click to use):</div>
            <div style="max-height:200px; overflow-y:auto; background:#fff; border:1px solid #eee; padding:5px;">
                <div class="inv-section-title">üëí Wearables (Drag on Ebi)</div>
                <div class="inventory-grid" id="inv-wear"></div>
                
                <div class="inv-section-title">üè† Room Decor (Drag in Room)</div>
                <div class="inventory-grid" id="inv-decor"></div>
                
                <div class="inv-section-title">üé® Wallpapers</div>
                <div class="inventory-grid" id="inv-wall"></div>
            </div>
            
            <div style="margin-top:15px; border-top:1px dashed #ccc; padding-top:10px;">
                 <button class="btn-main" style="background:#ff8a80;" onclick="clearRoomDecor()">üóëÔ∏è Clear Room</button>
            </div>

            <button class="btn-main" style="background:#ccc; margin-top:15px;" onclick="closeModals()">Close</button>
        </div>
    </div>

    <div id="modal-profiles" class="modal-overlay">
        <div class="modal-box">
            <h3 style="margin-top:0; color:var(--main);">Select Fronter</h3>
            <div id="profile-list" style="max-height:200px; overflow-y:auto; margin-bottom:15px;"></div>
            <div style="border-top:2px dashed #eee; padding-top:10px;">
                <h4 style="margin:0 0 10px 0;">New Identity</h4>
                <input type="text" id="new-p-name" placeholder="Name">
                <input type="number" id="new-p-age" placeholder="Age">
                <label style="font-size:0.8rem; font-weight:bold;">Theme Color:</label>
                <input type="color" id="new-p-color" value="#ff69b4" style="height:40px; padding:0; border:none; width:100%; border-radius:10px; margin-bottom:10px;">
                <button class="btn-main" onclick="addProfile()">Create</button>
            </div>
            <button class="btn-main" style="background:#ccc; margin-top:10px;" onclick="closeModals()">Close</button>
        </div>
    </div>

    <div id="modal-portal" class="modal-overlay">
        <div class="modal-box">
            <h3 style="margin-top:0; color:var(--main);">üåÄ Web Portal</h3>
            <div id="link-list" style="margin-bottom:15px;"></div>
            <a href="https://www.quotev.com/quiz/17122879/who-am-I-pt-2" target="_blank" style="display:block; background:var(--main); color:white; padding:10px; border-radius:10px; text-decoration:none; text-align:center; font-weight:bold; margin-bottom:10px;">‚ú® Take "Who Am I?" Quiz</a>
            <div style="background:#f0f8ff; padding:10px; border-radius:10px; margin-bottom:10px;">
                <input type="text" id="link-name" placeholder="Title" style="margin-bottom:5px;">
                <input type="text" id="link-url" placeholder="URL (https://...)">
                <button class="btn-main" style="background:var(--blue); padding:5px;" onclick="addLink()">Add Link</button>
            </div>
            <div style="border-top:1px dashed #ccc; padding-top:10px; text-align:center;">
                <button class="btn-main" style="background:#555; font-size:0.8rem;" onclick="exportData()">üíæ Copy Save Data</button>
                <button class="btn-main" style="background:#999; font-size:0.8rem; margin-top:5px;" onclick="importData()">üìÇ Import Save Data</button>
            </div>
            <button class="btn-main" style="background:#ccc; margin-top:15px;" onclick="closeModals()">Close</button>
        </div>
    </div>

    <div id="modal-wish" class="modal-overlay">
        <div class="modal-box">
            <h3>New Wish</h3>
            <input type="text" id="w-name" placeholder="Item Name">
            <input type="text" id="w-img" placeholder="Image Link">
            <button class="btn-main" onclick="submitWish()">Pin It</button>
            <button class="btn-main" style="background:#ccc; margin-top:10px;" onclick="closeModals()">Close</button>
        </div>
    </div>

    <nav>
        <button class="nav-btn active" onclick="go('home', this)"><span>üè†</span><span class="nav-label">Home</span></button>
        <button class="nav-btn" onclick="go('bbs', this)"><span>üí¨</span><span class="nav-label">Chat</span></button>
        <button class="nav-btn" onclick="go('wish', this)"><span>üìå</span><span class="nav-label">Wish</span></button>
        <button class="nav-btn" onclick="go('pet', this)"><span>üç§</span><span class="nav-label">Tools</span></button>
        <button class="nav-btn" onclick="go('diary', this)"><span>üìì</span><span class="nav-label">Diary</span></button>
    </nav>

</div>

<script>
    // --- CONSTANTS ---
    const AVATARS = [
        "https://i.postimg.cc/Wb1dxKCd/Images_D2FB0W0F.webp",
        "https://i.postimg.cc/QxdFvPwK/girlsbravo_tomoka_manga.jpg",
        "https://i.postimg.cc/bNwZ4MWn/girlsbravo_maharu_manga.jpg",
        "https://i.postimg.cc/28S1gJMq/girlsbravo_koyomi_manga.jpg",
        "https://i.postimg.cc/YqCvTVZR/Girls_Bravo_Koyomi_Hare_Nanaka.webp",
        "https://i.postimg.cc/5N2XDGTw/Girls_Bravo_Kosame.webp",
        "https://i.postimg.cc/J7qy6m6H/ee755c95_ea8f_4a26_bdfd_fbaff3669802.jpg",
        "https://i.postimg.cc/wTj1nPZQ/Cd480afa91.webp",
        "https://i.postimg.cc/rFwD7b39/Cc8a9456a3.webp",
        "https://i.postimg.cc/X7YrthmQ/Ac83513f62.webp",
        "https://i.postimg.cc/5N2XDGTP/9180_710547588.jpg"
    ];

    const GB_ARCHETYPES = [
        {name: "Miharu Type", traits: "Sweet, Innocent, Hungry", emoji: "üå∏"},
        {name: "Tomoka Type", traits: "Energetic, Cat-like, Playful", emoji: "üê±"},
        {name: "Koyomi Type", traits: "Tsundere, Strong-willed, Loyal", emoji: "‚ö°"},
        {name: "Kosame Type", traits: "Shy, Bookish, Thoughtful", emoji: "üìö"},
        {name: "Kirie Type", traits: "Responsible, Mature, Leader", emoji: "üëë"},
        {name: "Yukina Type", traits: "Performer, Charismatic, Shining", emoji: "‚≠ê"},
        {name: "Mamoru Type", traits: "Flirty, Social, Charming", emoji: "üíï"},
        {name: "Lisa Type", traits: "Powerful, Mysterious, Magical", emoji: "üîÆ"},
        {name: "Ebi Type", traits: "Quirky, Unique, Independent", emoji: "üç§"},
        {name: "Maharu Type", traits: "Tomboyish, Athletic, Competitive", emoji: "üèÉ‚Äç‚ôÄÔ∏è"}
    ];

    const GACHA = {
        cute: {
            wear: ["üéÄ","üëë","üßÅ","üçì","üç≠","üê∞","üíñ","üå∏","üíÆ"],
            decor: ["üß∏","üç∞","üëõ","üíí","üé†"],
            wall: ["bg-hearts", "bg-bubblegum"]
        },
        seiren: {
            wear: ["üçå","üõÅ","üå∫","üíß","‚≠ê","üå∏"],
            decor: ["ü™¥","üå¥","üíê","üïØÔ∏è","ü™û"],
            wall: ["bg-seiren", "bg-bath", "bg-nature"]
        },
        dark: {
            wear: ["üï∑Ô∏è","üíÄ","ü•Ä","üñ§","ü¶á","‚õìÔ∏è"],
            decor: ["üïØÔ∏è","‚ö∞Ô∏è","üï∏Ô∏è","üó°Ô∏è"],
            wall: ["bg-void", "bg-gothic"]
        },
        fun: {
            wear: ["üçÑ","üå±","üê∏","ü¶ã","üêå","üçè"],
            decor: ["üåµ","ü™µ","‚õ∫","üçØ"],
            wall: ["bg-check-green", "bg-clouds"]
        }
    };

    const FORTUNES = [
        {i:"üçû",t:"Toast Dash",d:"Running late but looking cute!"},
        {i:"üåü",t:"Super Star",d:"You are the main character today."},
        {i:"üåßÔ∏è",t:"Melancholy",d:"A good day for reading inside."},
        {i:"üíñ",t:"Doki Doki",d:"Love is in the air!"},
        {i:"üçå",t:"Banana Power",d:"Potassium levels critical."},
        {i:"üç§",t:"Ebi Blessing",d:"A good meal awaits you."}
    ];

    const BADGES = ["üå±","üê£","üéÄ","‚≠ê","üå∏","üçÑ","üíé","üëë","üßö‚Äç‚ôÄÔ∏è","üè∞","ü™ê"];

    // --- STATE ---
    let DB = {
        profiles: [], activeIdx: 0, xp: 0, credits: 0, lvl: 1,
        wish: [], pet: {
            hunger:50, tasks:[], lastTask: Date.now(), 
            placed: [] // Combined array for all placed items {id, type, x, y}
        }, 
        inventory: [], // Strings like "üéÄ" or "bg-hearts"
        bbs: [], frontLog: [], diary: [], links: [],
        fortune: {date:'', i:'', t:'', d:''},
        wallpaper: "",
        lastBath: ""
    };
    
    // Runtime vars
    let mood = 'üòä';
    let receiptBuffer = [];
    let pendingXP = 0;
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

    // --- INIT ---
    window.addEventListener('load', () => {
        const saved = localStorage.getItem('seiren_v50');
        if(saved) DB = JSON.parse(saved);
        
        // Data Migration
        if(!DB.pet.placed) DB.pet.placed = [];
        if(DB.pet.decor) { // Migrate old decor to new placed system
             DB.pet.decor.forEach(d => DB.pet.placed.push({id: d.item, type: 'decor', x: d.x, y: d.y}));
             delete DB.pet.decor;
        }

        setInterval(() => {
            const d = new Date();
            document.getElementById('clock').innerText = d.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
        }, 1000);
    });

    function enterApp() {
        if(audioCtx.state === 'suspended') audioCtx.resume();
        document.getElementById('welcome-layer').style.opacity = '0';
        setTimeout(() => {
            document.getElementById('welcome-layer').style.display = 'none';
            document.getElementById('main-app').style.display = 'flex';
            setTimeout(() => {
                document.getElementById('main-app').style.opacity = '1';
                if(DB.profiles.length > 0) {
                    applyTheme(DB.profiles[DB.activeIdx]);
                    document.getElementById('dash-view').style.display = 'block';
                    refreshUI(); renderPlacedItems();
                } else {
                    document.getElementById('setup-view').style.display = 'block';
                    document.getElementById('dash-view').style.display = 'none';
                }
            }, 50);
        }, 500);
    }

    function save() {
        localStorage.setItem('seiren_v50', JSON.stringify(DB));
        const t = document.getElementById('toast');
        t.classList.add('show');
        setTimeout(() => t.classList.remove('show'), 1000);
    }

    // --- HELPER: GET ITEM TYPE ---
    function getItemType(item) {
        if(item.startsWith('bg-')) return 'wall';
        // Scan all pools
        for(let pool in GACHA) {
            if(GACHA[pool].wear.includes(item)) return 'wear';
            if(GACHA[pool].decor.includes(item)) return 'decor';
        }
        return 'decor'; // Default
    }

    // --- GENERATOR & THEME ---
    function genID(name, age, color) {
        const seed = name.length + parseInt(age||0) + Math.floor(Math.random()*100);
        const syllables = ["Mih","aru","Tom","oka","Koy","omi","Kir","ie","Yuk","ina","Lis","a","Eb","i","Mah","aru","Bra","vo"];
        const generatedName = syllables[seed%syllables.length] + syllables[(seed+1)%syllables.length];
        
        const archetype = GB_ARCHETYPES[seed % GB_ARCHETYPES.length];

        return {
            name: generatedName,
            realName: name, age: age,
            color: color || "#ff69b4",
            id: Math.floor(Math.random()*9000)+1000,
            sign: archetype.name,
            traits: archetype.traits,
            av: Math.min(DB.lvl, AVATARS.length-1)
        };
    }

    function applyTheme(user) {
        const color = user ? (user.color || "#ff69b4") : "#ff69b4";
        const r = document.documentElement;
        r.style.setProperty('--main', color);
        r.style.setProperty('--dark', adjustColor(color, -40));
        r.style.setProperty('--bg-light', adjustColor(color, 160));
        r.style.setProperty('--bg-dark', adjustColor(color, 120));
    }
    
    function adjustColor(col, amt) {
        var usePound = false; if (col[0] == "#") { col = col.slice(1); usePound = true; }
        var num = parseInt(col,16);
        var r = (num >> 16) + amt; var b = ((num >> 8) & 0x00FF) + amt; var g = (num & 0x0000FF) + amt;
        if (r > 255) r = 255; else if (r < 0) r = 0; if (b > 255) b = 255; else if (b < 0) b = 0; if (g > 255) g = 255; else if (g < 0) g = 0;
        return (usePound?"#":"") + (g | (b << 8) | (r << 16)).toString(16);
    }

    // --- UI RENDER ---
    function refreshUI() {
        const u = DB.profiles[DB.activeIdx];
        if(u) {
            document.getElementById('dash-greet').innerText = `Hello, ${u.realName}`;
            document.getElementById('id-name').innerText = u.name;
            document.getElementById('id-real').innerText = `aka ${u.realName}`;
            document.getElementById('id-num').innerText = u.id;
            document.getElementById('id-sign').innerText = u.sign;
            document.getElementById('id-traits').innerText = u.traits;
            
            const avIndex = (u.av || 0) % AVATARS.length;
            document.getElementById('id-pic').src = AVATARS[avIndex];
            document.getElementById('my-sig').innerText = u.name;
        }
        
        document.getElementById('pet-container').className = `pet-box ${DB.wallpaper || ''}`;

        // Level & Bananas
        const badgeIdx = Math.min(DB.lvl-1, BADGES.length-1);
        document.getElementById('lvl-badge').innerText = BADGES[Math.max(0, badgeIdx)];
        const reqXP = 100 + (DB.lvl * 20);
        document.getElementById('lvl-num').innerText = DB.lvl;
        document.getElementById('xp-req').innerText = reqXP;
        document.getElementById('xp-val').innerText = DB.xp;
        const pct = Math.min(100, (DB.xp / reqXP) * 100);
        document.getElementById('xp-bar').style.width = pct + "%";
        document.getElementById('credit-val').innerText = DB.credits;

        // Inventory
        const wearGrid = document.getElementById('inv-wear'); wearGrid.innerHTML = "";
        const decorGrid = document.getElementById('inv-decor'); decorGrid.innerHTML = "";
        const wallGrid = document.getElementById('inv-wall'); wallGrid.innerHTML = "";

        DB.inventory.forEach(item => {
            const type = getItemType(item);
            const span = document.createElement('span');
            span.className = 'inv-item';
            
            if(type === 'wall') {
                span.innerText = "üñºÔ∏è";
                span.onclick = () => { DB.wallpaper = item; save(); refreshUI(); playSnd('bloop'); alert("Wallpaper Applied!"); };
                wallGrid.appendChild(span);
            } else {
                span.innerText = item;
                span.onclick = () => spawnItem(item, type);
                if(type === 'wear') wearGrid.appendChild(span);
                else decorGrid.appendChild(span);
            }
        });

        // Logs & Lists
        const tList = document.getElementById('task-list'); tList.innerHTML="";
        DB.pet.tasks.forEach((t,i)=> tList.innerHTML+=`<div class="task-item"><span>${t}</span><input type="checkbox" onclick="doTask(${i})"></div>`);

        const bbs = document.getElementById('bbs-feed'); bbs.innerHTML="";
        DB.bbs.slice().reverse().forEach(m => {
            bbs.innerHTML += `<div class="bbs-msg" style="border-left-color:${m.color}"><div class="bbs-meta"><span style="color:${m.color};font-weight:bold;">${m.sender}</span><span>${m.time}</span></div>${m.text}</div>`;
        });
        
        const wList = document.getElementById('wish-list'); wList.innerHTML="";
        DB.wish.forEach((w,i)=> wList.innerHTML+=`<div class="polaroid"><div class="delete-wish-btn" style="position:absolute;top:-5px;right:-5px;background:red;color:white;border-radius:50%;width:20px;height:20px;cursor:pointer;" onclick="delWish(${i})">x</div><img src="${w.img}"><div style="font-size:0.7rem;margin-top:5px;font-weight:bold;">${w.name}</div></div>`);
    }

    // --- RECEIPT SYSTEM ---
    function logMoodQuick(emoji, label) {
        playSnd('print');
        const now = new Date();
        const time = now.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
        
        const line = `<div style="display:flex; justify-content:space-between;"><span>${time} ${emoji} ${label}</span><span>......+5 XP</span></div>`;
        
        receiptBuffer.push(line);
        pendingXP += 5;
        
        const rLines = document.getElementById('receipt-lines');
        if(receiptBuffer.length === 1) rLines.innerHTML = ""; // Clear waiting text
        rLines.innerHTML += line;
        
        document.getElementById('r-count').innerText = receiptBuffer.length;
        document.getElementById('r-xp').innerText = pendingXP;
        document.getElementById('print-btn').disabled = false;
        rLines.scrollTop = rLines.scrollHeight;
    }

    function cashOutReceipt() {
        if(pendingXP <= 0) return;
        playSnd('print');
        addXP(pendingXP);
        DB.credits += pendingXP; // Convert XP to Bananas 1:1
        alert(`Receipt Printed! Gained ${pendingXP} XP & Bananas üçå`);
        
        // Reset
        pendingXP = 0;
        receiptBuffer = [];
        document.getElementById('receipt-lines').innerHTML = "Waiting for input...";
        document.getElementById('r-count').innerText = "0";
        document.getElementById('r-xp').innerText = "0";
        document.getElementById('print-btn').disabled = true;
        save(); refreshUI();
    }

    // --- PLACEMENT & DRAGGING ---
    function spawnItem(id, type) {
        DB.pet.placed.push({
            id: id, type: type,
            x: 50, y: 50 // Center default
        });
        save(); renderPlacedItems(); closeModals();
        alert(`${type === 'wear' ? 'Accessory' : 'Decor'} placed! Drag to move.`);
    }

    function renderPlacedItems() {
        const wearLayer = document.getElementById('room-wear-layer');
        const decorLayer = document.getElementById('room-decor-layer');
        wearLayer.innerHTML = ""; decorLayer.innerHTML = "";

        DB.pet.placed.forEach((item, index) => {
            const el = document.createElement('div');
            el.className = `pet-sticker ${item.type}`;
            el.innerText = item.id;
            el.style.left = item.x + "%";
            el.style.top = item.y + "%";

            // Drag Logic
            let isDragging = false;
            const startDrag = (e) => { isDragging = true; e.preventDefault(); };
            const doDrag = (e) => {
                if(!isDragging) return;
                const box = document.getElementById('pet-container').getBoundingClientRect();
                const clientX = e.touches ? e.touches[0].clientX : e.clientX;
                const clientY = e.touches ? e.touches[0].clientY : e.clientY;
                item.x = ((clientX - box.left) / box.width) * 100;
                item.y = ((clientY - box.top) / box.height) * 100;
                el.style.left = item.x + "%";
                el.style.top = item.y + "%";
            };
            const endDrag = () => { if(isDragging) { isDragging = false; save(); } };

            el.addEventListener('mousedown', startDrag);
            el.addEventListener('touchstart', startDrag);
            window.addEventListener('mousemove', doDrag);
            window.addEventListener('touchmove', doDrag);
            window.addEventListener('mouseup', endDrag);
            window.addEventListener('touchend', endDrag);

            if(item.type === 'wear') wearLayer.appendChild(el);
            else decorLayer.appendChild(el);
        });
    }

    function clearRoomDecor() {
        if(confirm("Clear all items from the room?")) {
            DB.pet.placed = [];
            save(); renderPlacedItems();
        }
    }

    // --- GACHA ---
    function playGacha(theme) {
        if(DB.credits < 50) { alert("Need 50 Bananas! üçå"); return; }
        
        DB.credits -= 50;
        playSnd('chime');
        
        const pool = GACHA[theme];
        // 40% wear, 40% decor, 20% wall
        const rand = Math.random();
        let type = 'wear';
        if(rand > 0.4) type = 'decor';
        if(rand > 0.8) type = 'wall';
        
        const items = pool[type];
        const item = items[Math.floor(Math.random() * items.length)];
        
        DB.inventory.push(item);
        save(); refreshUI();
        alert(`GACHA RESULT:\nType: ${type.toUpperCase()}\nItem: ${item}`);
    }

    // --- EVENTS & BATH ---
    function takeBath() {
        const today = new Date().toDateString();
        if(DB.lastBath === today) {
            alert("Already bathed today! Ebi is clean. üíß");
            return;
        }
        
        playSnd('chime');
        DB.lastBath = today;
        addXP(30);
        DB.credits += 20;
        alert("Ahh~ So refreshing! üõÅ\n+30 XP, +20 Bananas");
        save(); refreshUI();
    }

    function initFirstProfile() {
        const n = document.getElementById('setup-name').value;
        const a = document.getElementById('setup-age').value;
        if(!n) return;
        DB.profiles.push(genID(n, a, "#ff69b4"));
        DB.activeIdx = 0;
        save(); enterApp();
    }

    function addProfile() {
        const n = document.getElementById('new-p-name').value;
        const a = document.getElementById('new-p-age').value;
        const c = document.getElementById('new-p-color').value;
        if(!n) return;
        DB.profiles.push(genID(n, a, c));
        swap(DB.profiles.length - 1);
        closeModals();
    }

    function swap(i) {
        DB.activeIdx = i;
        const user = DB.profiles[i];
        applyTheme(user); save(); refreshUI();
    }

    function addXP(amount) {
        DB.xp += amount;
        const reqXP = 100 + (DB.lvl * 20);
        if(DB.xp >= reqXP) {
            DB.xp -= reqXP; DB.lvl++; playSnd('chime');
            alert(`LEVEL UP! You are now Level ${DB.lvl}! üçå`);
        }
        save(); refreshUI();
    }

    function playSnd(type) {
        if(audioCtx.state === 'suspended') audioCtx.resume();
        const gain = audioCtx.createGain();
        
        if (type === 'print') {
            // Thermal printer effect
            const now = audioCtx.currentTime;
            const whir = audioCtx.createOscillator();
            whir.type = 'sawtooth';
            whir.frequency.setValueAtTime(80, now);
            whir.frequency.linearRampToValueAtTime(120, now + 0.3);
            whir.connect(gain);
            
            const clicks = 8; 
            for(let i = 0; i < clicks; i++) {
                const clickTime = now + (i * 0.05);
                const osc = audioCtx.createOscillator();
                const clickGain = audioCtx.createGain();
                osc.type = 'square';
                osc.frequency.setValueAtTime(800 + Math.random() * 400, clickTime);
                osc.connect(clickGain);
                clickGain.connect(gain);
                clickGain.gain.setValueAtTime(0.15, clickTime);
                clickGain.gain.exponentialRampToValueAtTime(0.01, clickTime + 0.02);
                osc.start(clickTime);
                osc.stop(clickTime + 0.02);
            }
            gain.connect(audioCtx.destination);
            gain.gain.setValueAtTime(0.3, now);
            gain.gain.exponentialRampToValueAtTime(0.01, now + 0.4);
            whir.start(now); whir.stop(now + 0.4);
        } else {
            const osc = audioCtx.createOscillator();
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            
            if (type === 'chime') {
                osc.type = 'sine';
                osc.frequency.setValueAtTime(800, audioCtx.currentTime);
                osc.frequency.exponentialRampToValueAtTime(1200, audioCtx.currentTime + 0.1);
                gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.5);
                osc.start(); osc.stop(audioCtx.currentTime + 0.5);
            } else {
                osc.type = 'sine';
                osc.frequency.setValueAtTime(600, audioCtx.currentTime);
                osc.frequency.exponentialRampToValueAtTime(300, audioCtx.currentTime + 0.1);
                gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.1);
                osc.start(); osc.stop(audioCtx.currentTime + 0.1);
            }
        }
    }

    // --- STANDARD FUNCTIONS ---
    function openProfileManager() {
        const list = document.getElementById('profile-list'); list.innerHTML="";
        DB.profiles.forEach((p,i) => {
            list.innerHTML += `<div style="padding:10px; border-bottom:1px solid #eee; display:flex; justify-content:space-between;"><div><b>${p.realName}</b></div><button class="btn-main" style="width:auto;padding:5px;" onclick="swap(${i})">Switch</button></div>`;
        });
        document.getElementById('modal-profiles').style.display='flex';
    }
    
    function flipFortune() {
        const t = new Date().toDateString();
        if(DB.fortune && DB.fortune.date === t) return;
        const res = FORTUNES[Math.floor(Math.random()*FORTUNES.length)];
        DB.fortune = { date: t, i: res.i, t: res.t, d: res.d };
        addXP(50); DB.credits += 50;
        document.getElementById('fortune-icon').innerText = res.i;
        document.getElementById('fortune-title').innerText = res.t;
        document.getElementById('fortune-desc').innerText = res.d;
        document.getElementById('fortune-card').classList.add('flipped');
        save();
    }

    function rotateAvatar() {
        playSnd('bloop');
        const u = DB.profiles[DB.activeIdx];
        const maxIndex = Math.min(DB.lvl, AVATARS.length - 1);
        let nextAv = (u.av || 0) + 1;
        if(nextAv > maxIndex) nextAv = 0; 
        u.av = nextAv;
        save(); refreshUI();
    }

    function postBBS() {
        const txt = document.getElementById('bbs-input').value;
        if(!txt) return;
        const u = DB.profiles[DB.activeIdx];
        DB.bbs.push({ sender: u.realName, color: u.color, text: txt, time: new Date().toLocaleTimeString() });
        document.getElementById('bbs-input').value=""; save(); refreshUI();
    }

    function postDiary() {
        const v = document.getElementById('diary-in').value; 
        if(v){ DB.diary.unshift({t:v, m:mood, d: new Date().toLocaleString()}); document.getElementById('diary-in').value=""; addXP(15); }
    }
    
    function addTask() { const v=document.getElementById('task-in').value; if(v){DB.pet.tasks.push(v); document.getElementById('task-in').value=""; save(); refreshUI();} }
    function doTask(i) { DB.pet.tasks.splice(i,1); addXP(10); save(); refreshUI(); }

    function openBackpack() { document.getElementById('modal-backpack').style.display='flex'; refreshUI(); }
    function openPortal() { document.getElementById('modal-portal').style.display='flex'; }
    function openWishModal() { document.getElementById('modal-wish').style.display='flex'; }
    function closeModals() { document.querySelectorAll('.modal-overlay').forEach(m=>m.style.display='none'); }
    function go(id, btn) {
        document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
        document.getElementById('tab-'+(id==='home'?'dash':id)).classList.add('active');
        document.querySelectorAll('.nav-btn').forEach(b=>b.classList.remove('active'));
        btn.classList.add('active');
        playSnd('bloop');
    }
    function setMood(m,b) { mood=m; document.querySelectorAll('.mood-btn').forEach(x=>x.classList.remove('selected')); b.classList.add('selected'); }
    function submitWish() {
        const n = document.getElementById('w-name').value;
        const i = document.getElementById('w-img').value || "https://cdn-icons-png.flaticon.com/512/3209/3209955.png";
        if(n) { DB.wish.push({name:n, img:i}); save(); closeModals(); refreshUI(); }
    }
    function delWish(i) { if(confirm("Delete?")) { DB.wish.splice(i,1); save(); refreshUI(); } }
    function exportData() { navigator.clipboard.writeText(JSON.stringify(DB)).then(()=>alert("Copied!")); }
    function importData() { const d=prompt("Paste Data:"); if(d){try{DB=JSON.parse(d); save(); location.reload();}catch(e){alert("Error");}} }
</script>
</body>
</html>
