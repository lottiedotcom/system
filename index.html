<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#ff69b4">
    <title>Seiren OS: Care Edition</title>
    
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/2919/2919573.png">
    <link rel="icon" type="image/png" href="https://cdn-icons-png.flaticon.com/512/2919/2919573.png">

    <style>
        :root {
            --main: #ff69b4; 
            --bg-overlay: rgba(255,255,255,0.85);
            --font-main: 'Verdana', sans-serif;
            --font-receipt: 'Courier New', monospace;
        }

        /* --- CORE LAYOUT --- */
        body {
            font-family: var(--font-main);
            background-color: #ffe4e1; 
            background-size: cover; background-position: center; transition: background 0.5s;
            margin: 0; display: flex; justify-content: center; height: 100vh; overflow: hidden;
            color: #444; user-select: none; -webkit-user-select: none;
        }

        /* --- VISUAL FX --- */
        .scanlines {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: linear-gradient(to bottom, rgba(255,255,255,0) 50%, rgba(0,0,0,0.05) 50%);
            background-size: 100% 4px; pointer-events: none; z-index: 9999;
        }
        .vignette {
            position: fixed; top:0; left:0; width:100%; height:100%;
            background: radial-gradient(circle, transparent 60%, rgba(255,182,193,0.4) 100%);
            pointer-events: none; z-index: 9998;
        }

        /* --- APP CONTAINER --- */
        .app-shell {
            width: 100%; max-width: 480px; 
            background: var(--bg-overlay);
            backdrop-filter: blur(5px);
            display: none; flex-direction: column; position: relative; height: 100%;
            box-shadow: 0 0 50px rgba(0,0,0,0.2); z-index: 10;
        }

        /* --- LOCK SCREEN --- */
        #lock-screen {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: #ff69b4; z-index: 20000;
            display: none; flex-direction: column; align-items: center; justify-content: center;
            color: white; transition: transform 0.3s ease-in-out;
        }
        .pin-pad { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-top: 30px; }
        .pin-btn {
            width: 70px; height: 70px; border-radius: 50%; border: 2px solid white;
            background: rgba(255,255,255,0.1); color: white; font-size: 1.5rem;
            display: flex; align-items: center; justify-content: center; cursor: pointer;
        }
        .pin-btn:active { background: white; color: var(--main); }

        /* --- CONTENT ZONES --- */
        .content { flex: 1; overflow-y: auto; padding: 20px; padding-bottom: 100px; scroll-behavior: smooth; }
        .page { display: none; animation: fadeIn 0.3s; }
        .page.active { display: block; }
        @keyframes fadeIn { from {opacity:0; transform:translateY(5px);} to {opacity:1; transform:translateY(0);} }

        /* --- DASHBOARD --- */
        .dash-card {
            background: white; border-radius: 20px; padding: 20px; text-align: center;
            border: 2px solid var(--main); box-shadow: 4px 4px 0 rgba(0,0,0,0.05);
            margin-bottom: 20px; position: relative; overflow: hidden;
        }
        .dash-avatar {
            width: 100px; height: 100px; border-radius: 50%; border: 4px solid var(--main);
            margin: 0 auto 10px; background-size: cover; background-position: center; background-color: #eee;
        }
        
        .dash-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .dash-btn {
            background: white; border: 2px solid #eee; border-radius: 15px; padding: 15px;
            text-align: center; font-weight: bold; font-size: 0.9rem; cursor: pointer;
        }
        .dash-btn:active { transform: scale(0.98); background: #f9f9f9; }

        /* --- PHARMACY (RECEIPT SYSTEM) --- */
        .pharmacy-container {
            display: flex; flex-direction: column; gap: 15px;
        }
        .receipt-paper {
            background: #fff; border: 1px solid #ccc; padding: 15px;
            font-family: var(--font-receipt); font-size: 0.75rem;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            position: relative;
        }
        .receipt-paper::before {
            content: ''; position: absolute; top: -5px; left: 0; width: 100%; height: 10px;
            background: radial-gradient(circle, transparent, transparent 50%, #fff 50%, #fff 100%) -7px -8px / 16px 16px repeat-x;
        }
        .receipt-list { max-height: 150px; overflow-y: auto; border-bottom: 2px dashed #000; margin-bottom: 10px; padding-bottom: 10px; }
        .receipt-entry { display: flex; justify-content: space-between; margin-bottom: 4px; }
        
        .mood-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; }
        .mood-btn {
            background: white; border: 1px solid #ccc; border-radius: 8px; height: 40px;
            font-size: 1.4rem; cursor: pointer; transition: 0.1s;
        }
        .mood-btn:active { background: var(--main); border-color: var(--main); }

        .prescription-btn {
            background: #4db6ac; color: white; border: none; padding: 15px; border-radius: 10px;
            font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px;
            box-shadow: 0 4px 0 #00897b; margin-top: 10px;
        }
        .prescription-btn:active { transform: translateY(4px); box-shadow: none; }

        /* --- PET --- */
        .pet-stage {
            height: 300px; position: relative; border: 3px solid var(--main); border-radius: 20px;
            background: rgba(255,255,255,0.5); overflow: hidden;
            display: flex; align-items: center; justify-content: center;
        }
        .ebi-img { width: 150px; pointer-events: none; z-index: 5; margin-top: 50px; }
        .sticker {
            position: absolute; font-size: 2.5rem; cursor: grab; z-index: 10;
            filter: drop-shadow(2px 2px 0 rgba(0,0,0,0.1));
        }
        .sticker:active { cursor: grabbing; transform: scale(1.1); z-index: 20; }

        /* --- DISCORD CHAT --- */
        .chat-shell { display: flex; height: 100%; border: 2px solid var(--main); border-radius: 15px; background: white; overflow: hidden; }
        .channel-list { width: 60px; background: #f0f0f0; border-right: 1px solid #eee; padding-top: 10px; display: flex; flex-direction: column; align-items: center; gap: 10px; }
        .chan-btn { width: 40px; height: 40px; border-radius: 50%; background: #ddd; display: flex; align-items: center; justify-content: center; font-weight: bold; color: #666; cursor: pointer; }
        .chan-btn.active { background: var(--main); color: white; border-radius: 12px; }
        
        .chat-view { flex: 1; display: flex; flex-direction: column; }
        .chat-feed { flex: 1; overflow-y: auto; padding: 10px; display: flex; flex-direction: column; gap: 10px; }
        
        .pk-msg { display: flex; gap: 10px; align-items: flex-start; }
        .pk-av { width: 35px; height: 35px; border-radius: 50%; object-fit: cover; flex-shrink: 0; }
        .pk-name { font-size: 0.8rem; font-weight: bold; margin-bottom: 2px; }
        .pk-txt { font-size: 0.85rem; color: #444; line-height: 1.3; }

        /* --- NAV --- */
        .dock {
            position: fixed; bottom: 20px; left: 20px; right: 20px;
            background: white; border-radius: 20px; padding: 10px 20px;
            display: flex; justify-content: space-between;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1); border: 2px solid var(--main);
        }
        .dock-btn { background: none; border: none; font-size: 1.5rem; cursor: pointer; opacity: 0.5; transition: 0.2s; }
        .dock-btn.active { opacity: 1; transform: translateY(-5px); }

        /* --- MODALS --- */
        .modal {
            position: fixed; top:0; left:0; width:100%; height:100%;
            background: rgba(0,0,0,0.5); z-index: 2000;
            display: none; align-items: center; justify-content: center;
        }
        .modal-card {
            background: white; width: 85%; max-width: 350px;
            border-radius: 20px; padding: 20px;
            border: 4px solid var(--main); max-height: 80vh; overflow-y: auto;
        }
        .file-upload-btn {
            background: #eee; padding: 10px; border-radius: 10px; width: 100%;
            text-align: center; margin-bottom: 10px; cursor: pointer; border: 2px dashed #ccc;
        }

        .btn-action {
            background: var(--main); color: white; padding: 10px; width: 100%; border: none; border-radius: 10px; font-weight: bold; cursor: pointer;
        }

    </style>
</head>
<body>

<div class="scanlines"></div>
<div class="vignette"></div>

<div id="lock-screen">
    <div style="font-size:3rem; margin-bottom:20px;">üîí</div>
    <div id="pin-dots" style="font-size:2rem; letter-spacing:10px; height:40px;"></div>
    <div class="pin-pad">
        <div class="pin-btn" onclick="enterPin(1)">1</div>
        <div class="pin-btn" onclick="enterPin(2)">2</div>
        <div class="pin-btn" onclick="enterPin(3)">3</div>
        <div class="pin-btn" onclick="enterPin(4)">4</div>
        <div class="pin-btn" onclick="enterPin(5)">5</div>
        <div class="pin-btn" onclick="enterPin(6)">6</div>
        <div class="pin-btn" onclick="enterPin(7)">7</div>
        <div class="pin-btn" onclick="enterPin(8)">8</div>
        <div class="pin-btn" onclick="enterPin(9)">9</div>
        <div class="pin-btn" style="opacity:0"></div>
        <div class="pin-btn" onclick="enterPin(0)">0</div>
        <div class="pin-btn" style="background:rgba(255,0,0,0.3)" onclick="clearPin()">C</div>
    </div>
</div>

<div class="app-shell" id="app">
    
    <div id="page-dash" class="page active" style="padding-top:40px;">
        <div class="dash-card">
            <div id="dash-av" class="dash-avatar"></div>
            <h2 id="dash-name" style="margin:0; color:var(--main);">User</h2>
            <small id="dash-id" style="color:#999;">ID: ???</small>
            <div style="margin-top:15px; background:#f9f9f9; padding:10px; border-radius:10px;">
                <b>Care Points:</b> <span id="cp-display">0</span> üíä
            </div>
        </div>

        <div class="dash-grid">
            <div class="dash-btn" onclick="openProfileModal()">
                üë•<br>Switch
            </div>
            <div class="dash-btn" onclick="openLockModal()">
                üîí<br>Security
            </div>
            <div class="dash-btn" onclick="openBackpack()">
                üéí<br>Meds/Decor
            </div>
            <div class="dash-btn" onclick="nav('pharmacy')">
                üè•<br>Pharmacy
            </div>
        </div>
    </div>

    <div id="page-pharmacy" class="page">
        <h2 style="color:var(--main); text-align:center;">Seiren Care Center</h2>
        
        <div class="pharmacy-container">
            <div class="receipt-paper">
                <div style="text-align:center; border-bottom:1px dashed #000; padding-bottom:5px; margin-bottom:5px;">
                    SEIREN HEALTH<br>
                    SYMPTOM LOG
                </div>
                <div id="receipt-list" class="receipt-list"></div>
                <div style="display:flex; justify-content:space-between; font-weight:bold;">
                    <span>PENDING:</span>
                    <span>+<span id="pending-pts">0</span> CP</span>
                </div>
            </div>

            <div style="text-align:center; font-size:0.8rem; color:#666;">LOG SYMPTOMS TO PRINT:</div>
            <div class="mood-grid">
                <button class="mood-btn" onclick="logMood('üòä', 5)">üòä</button>
                <button class="mood-btn" onclick="logMood('üò¢', 10)">üò¢</button>
                <button class="mood-btn" onclick="logMood('üò°', 10)">üò°</button>
                <button class="mood-btn" onclick="logMood('üåÄ', 15)">üåÄ</button>
                <button class="mood-btn" onclick="logMood('üí§', 5)">üí§</button>
                <button class="mood-btn" onclick="logMood('‚ú®', 5)">‚ú®</button>
                <button class="mood-btn" onclick="logMood('üíÄ', 15)">üíÄ</button>
                <button class="mood-btn" onclick="logMood('üíñ', 5)">üíñ</button>
            </div>

            <button class="btn-action" style="background:#888;" onclick="printReceipt()">üñ®Ô∏è PROCESS RECEIPT</button>

            <hr style="border:1px dashed #ccc; width:100%;">

            <div style="background:white; padding:15px; border-radius:15px; border:2px solid #4db6ac;">
                <div style="text-align:center; font-weight:bold; color:#00695c;">PHARMACY COUNTER</div>
                <p style="text-align:center; font-size:0.8rem; margin:5px 0;">Cost: 50 Care Points</p>
                <button class="prescription-btn" onclick="fillPrescription()">
                    üíä FILL PRESCRIPTION
                </button>
            </div>
        </div>
    </div>

    <div id="page-pet" class="page">
        <h2 style="color:var(--main); text-align:center;">Patient Room</h2>
        <div class="pet-stage" id="pet-stage">
            <div id="decor-layer"></div>
            <img src="https://i.postimg.cc/13FQckct/Untitled-Artwork-20260110072840-20260110074706.png" class="ebi-img">
        </div>
        <p style="text-align:center; font-size:0.8rem; color:#666;">Drag prescribed stickers from your backpack!</p>
    </div>

    <div id="page-chat" class="page" style="height:100%; padding-bottom:80px;">
        <div class="chat-shell">
            <div class="channel-list" id="chan-list">
                </div>
            <div class="chat-view">
                <div style="padding:10px; border-bottom:1px solid #eee; font-weight:bold; color:var(--main);" id="chan-title">#general</div>
                <div class="chat-feed" id="chat-feed"></div>
                <div style="padding:10px; border-top:1px solid #eee;">
                    <input type="text" id="msg-in" style="width:100%; padding:10px; border:1px solid #ccc; border-radius:5px;" placeholder="Message...">
                    <button onclick="sendMsg()" style="margin-top:5px; width:100%; padding:8px; background:var(--main); color:white; border:none; border-radius:5px;">Send</button>
                </div>
            </div>
        </div>
    </div>

    <div class="dock">
        <button class="dock-btn active" onclick="nav('dash')">üè†</button>
        <button class="dock-btn" onclick="nav('pharmacy')">üè•</button>
        <button class="dock-btn" onclick="nav('pet')">üç§</button>
        <button class="dock-btn" onclick="nav('chat')">üí¨</button>
    </div>

</div>

<div id="modal-profile" class="modal">
    <div class="modal-card">
        <h3>Identity Card</h3>
        <div id="prof-list" style="margin-bottom:15px; max-height:150px; overflow-y:auto;"></div>
        <hr>
        <h4>New ID</h4>
        <input type="text" id="new-name" placeholder="Name" style="width:100%; margin-bottom:5px; padding:8px;">
        
        <label class="file-upload-btn">
            üìÇ Upload Avatar
            <input type="file" id="av-upload" accept="image/*" style="display:none;" onchange="handleFile(this, 'av-preview')">
        </label>
        <div id="av-preview" style="width:50px; height:50px; background:#ccc; margin:0 auto; border-radius:50%; background-size:cover;"></div>
        
        <p style="font-size:0.8rem; margin-top:5px;">Theme Color:</p>
        <input type="color" id="new-color" value="#ff69b4" style="width:100%; border:none; height:30px;">
        
        <button class="btn-action" style="margin-top:10px;" onclick="createProfile()">Print ID</button>
        <button class="btn-action" style="margin-top:5px; background:#ccc;" onclick="closeModals()">Close</button>
    </div>
</div>

<div id="modal-backpack" class="modal">
    <div class="modal-card">
        <h3>Medicine Cabinet</h3>
        <div id="inventory-grid" style="display:flex; flex-wrap:wrap; gap:5px; justify-content:center;"></div>
        <button class="btn-action" style="margin-top:10px; background:#ff6b6b;" onclick="clearDecor()">Clear Room</button>
        <button class="btn-action" style="margin-top:5px; background:#ccc;" onclick="closeModals()">Close</button>
    </div>
</div>

<div id="modal-security" class="modal">
    <div class="modal-card">
        <h3>System Lock</h3>
        <input type="number" id="pin-set" placeholder="Enter 4 digits" maxlength="4" style="width:100%; padding:10px; font-size:1.2rem; text-align:center;">
        <button class="btn-action" style="margin-top:10px;" onclick="setLock()">Enable Lock</button>
        <button class="btn-action" style="margin-top:5px; background:#ccc;" onclick="closeModals()">Close</button>
    </div>
</div>

<script>
    // --- STATE ---
    let DB = {
        profiles: [],
        active: 0,
        cp: 0, // Care Points
        inventory: [],
        decor: [],
        lock: null,
        channels: { 'gen': {name:'general', msgs:[]} },
        curChan: 'gen'
    };
    
    let pendingCP = 0;
    let tempPin = "";
    let uploadedAv = ""; // Temp holder for base64

    const PRESCRIPTIONS = [
        "ü©π", "üíä", "üíâ", "ü©∫", "üß∏", "üéÄ", "üßÉ", "üç´", "üçµ", "üå∏", "üçÑ", "‚≠ê", "üí§", "üßº", "üß¥"
    ];

    // --- INIT ---
    window.onload = () => {
        const saved = localStorage.getItem('seiren_care_v2');
        if(saved) DB = JSON.parse(saved);

        if(DB.profiles.length === 0) {
            DB.profiles.push({
                name: "Host", 
                av: "", // Default gray
                color: "#ff69b4",
                id: "001"
            });
        }

        if(DB.lock) {
            document.getElementById('lock-screen').style.display = 'flex';
        } else {
            document.querySelector('.app-shell').style.display = 'flex';
            loadUI();
        }
    };

    function save() { localStorage.setItem('seiren_care_v2', JSON.stringify(DB)); }

    // --- NAVIGATION & UI ---
    function nav(id) {
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        document.getElementById('page-'+id).classList.add('active');
        document.querySelectorAll('.dock-btn').forEach(b => b.classList.remove('active'));
        // Find button logic later, simple toggle for now
        
        if(id === 'pet') renderDecor();
        if(id === 'chat') renderChat();
    }
    
    function loadUI() {
        const p = DB.profiles[DB.active];
        
        // Theme
        document.documentElement.style.setProperty('--main', p.color);
        document.body.style.backgroundColor = p.color; // Changes background of body
        
        // Dash
        document.getElementById('dash-name').innerText = p.name;
        document.getElementById('dash-id').innerText = "ID: " + p.id;
        document.getElementById('dash-av').style.backgroundImage = p.av ? `url(${p.av})` : 'none';
        document.getElementById('cp-display').innerText = DB.cp;
    }

    // --- LOCK SCREEN ---
    function enterPin(n) {
        tempPin += n;
        document.getElementById('pin-dots').innerText = "*".repeat(tempPin.length);
        if(tempPin.length === 4) {
            if(tempPin === DB.lock) {
                document.getElementById('lock-screen').style.transform = "translateY(-100%)";
                setTimeout(()=> {
                    document.getElementById('lock-screen').style.display = 'none';
                    document.querySelector('.app-shell').style.display = 'flex';
                    loadUI();
                }, 300);
            } else {
                tempPin = "";
                document.getElementById('pin-dots').innerText = "ERROR";
                setTimeout(()=>document.getElementById('pin-dots').innerText="", 500);
            }
        }
    }
    function clearPin() { tempPin=""; document.getElementById('pin-dots').innerText=""; }
    function openLockModal() { document.getElementById('modal-security').style.display='flex'; }
    function setLock() {
        const p = document.getElementById('pin-set').value;
        if(p.length===4) { DB.lock = p; save(); closeModals(); alert("System Locked Next Boot"); }
    }

    // --- PHARMACY (RECEIPT) ---
    function logMood(icon, pts) {
        const list = document.getElementById('receipt-list');
        const div = document.createElement('div');
        div.className = 'receipt-entry';
        div.innerHTML = `<span>${icon} SYMPTOM</span> <span>${pts} CP</span>`;
        list.appendChild(div);
        list.scrollTop = list.scrollHeight;
        pendingCP += pts;
        document.getElementById('pending-pts').innerText = pendingCP;
    }
    
    function printReceipt() {
        if(pendingCP > 0) {
            DB.cp += pendingCP;
            alert(`Processed! +${pendingCP} Care Points added to account.`);
            pendingCP = 0;
            document.getElementById('receipt-list').innerHTML = "";
            document.getElementById('pending-pts').innerText = "0";
            save(); loadUI();
        }
    }

    function fillPrescription() {
        if(DB.cp >= 50) {
            DB.cp -= 50;
            const item = PRESCRIPTIONS[Math.floor(Math.random()*PRESCRIPTIONS.length)];
            DB.inventory.push(item);
            alert(`Prescription Filled: Received ${item}`);
            save(); loadUI();
        } else {
            alert("Insufficient Care Points. Log symptoms to earn more.");
        }
    }

    // --- IMAGE COMPRESSOR (FILE UPLOAD) ---
    function handleFile(input, previewId) {
        const file = input.files[0];
        if(!file) return;

        const reader = new FileReader();
        reader.onload = (e) => {
            const img = new Image();
            img.src = e.target.result;
            img.onload = () => {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                // Resize to max 150px to save localstorage space
                const max = 150;
                let w = img.width; let h = img.height;
                if(w>h) { if(w>max){h*=max/w; w=max;} } else { if(h>max){w*=max/h; h=max;} }
                
                canvas.width = w; canvas.height = h;
                ctx.drawImage(img, 0, 0, w, h);
                uploadedAv = canvas.toDataURL('image/jpeg', 0.7); // Compress
                document.getElementById(previewId).style.backgroundImage = `url(${uploadedAv})`;
            };
        };
        reader.readAsDataURL(file);
    }

    // --- PROFILES ---
    function openProfileModal() {
        document.getElementById('modal-profile').style.display='flex';
        const list = document.getElementById('prof-list');
        list.innerHTML = "";
        DB.profiles.forEach((p,i) => {
            list.innerHTML += `
            <div style="display:flex; justify-content:space-between; padding:5px; border-bottom:1px solid #eee;">
                <span>${p.name}</span>
                <button onclick="switchProf(${i})">Switch</button>
            </div>`;
        });
    }
    
    function createProfile() {
        const name = document.getElementById('new-name').value;
        const color = document.getElementById('new-color').value;
        if(name) {
            DB.profiles.push({
                name: name,
                color: color,
                av: uploadedAv,
                id: Math.floor(Math.random()*9000)+1000
            });
            save(); closeModals();
        }
    }

    function switchProf(i) {
        DB.active = i;
        save(); loadUI(); closeModals();
    }

    // --- DRAGGABLE DECOR (PET) ---
    function openBackpack() {
        document.getElementById('modal-backpack').style.display='flex';
        const g = document.getElementById('inventory-grid');
        g.innerHTML = "";
        DB.inventory.forEach(item => {
            const b = document.createElement('div');
            b.style.fontSize = "2rem"; b.style.cursor="pointer"; b.innerText = item;
            b.onclick = () => spawnDecor(item);
            g.appendChild(b);
        });
    }

    function spawnDecor(item) {
        DB.decor.push({i:item, x:50, y:50});
        save(); closeModals(); nav('pet');
    }

    function renderDecor() {
        const layer = document.getElementById('decor-layer');
        layer.innerHTML = "";
        DB.decor.forEach(d => {
            const el = document.createElement('div');
            el.className = 'sticker';
            el.innerText = d.i;
            el.style.left = d.x + "%";
            el.style.top = d.y + "%";
            
            // Touch Drag Logic
            let isDrag = false;
            const move = (e) => {
                if(!isDrag) return;
                const box = document.getElementById('pet-stage').getBoundingClientRect();
                const cx = e.touches ? e.touches[0].clientX : e.clientX;
                const cy = e.touches ? e.touches[0].clientY : e.clientY;
                d.x = ((cx - box.left)/box.width)*100;
                d.y = ((cy - box.top)/box.height)*100;
                el.style.left = d.x + "%"; el.style.top = d.y + "%";
            };
            const end = () => { if(isDrag) { isDrag=false; save(); } };
            
            el.addEventListener('mousedown', ()=>{isDrag=true});
            el.addEventListener('touchstart', ()=>{isDrag=true});
            window.addEventListener('mousemove', move);
            window.addEventListener('touchmove', move);
            window.addEventListener('mouseup', end);
            window.addEventListener('touchend', end);
            
            layer.appendChild(el);
        });
    }
    
    function clearDecor() { DB.decor=[]; save(); nav('pet'); closeModals(); }

    // --- CHAT (PK) ---
    function renderChat() {
        const list = document.getElementById('chan-list');
        list.innerHTML = "";
        Object.keys(DB.channels).forEach(k => {
            const b = document.createElement('div');
            b.className = `chan-btn ${DB.curChan===k?'active':''}`;
            b.innerText = DB.channels[k].name.substring(0,2).toUpperCase();
            b.onclick = () => { DB.curChan=k; renderChat(); };
            list.appendChild(b);
        });
        
        // Feed
        const c = DB.channels[DB.curChan];
        document.getElementById('chan-title').innerText = "#" + c.name;
        const feed = document.getElementById('chat-feed');
        feed.innerHTML = "";
        c.msgs.forEach(m => {
            feed.innerHTML += `
            <div class="pk-msg">
                <img src="${m.av}" class="pk-av" style="background:${m.color}">
                <div>
                    <div class="pk-name" style="color:${m.color}">${m.name}</div>
                    <div class="pk-txt">${m.txt}</div>
                </div>
            </div>`;
        });
        feed.scrollTop = feed.scrollHeight;
    }

    function sendMsg() {
        const inp = document.getElementById('msg-in');
        if(inp.value.trim() === "") return;
        const p = DB.profiles[DB.active];
        DB.channels[DB.curChan].msgs.push({
            name: p.name,
            av: p.av || "", // If empty, css makes it gray
            color: p.color,
            txt: inp.value
        });
        inp.value = "";
        save(); renderChat();
    }

    function closeModals() { document.querySelectorAll('.modal').forEach(m=>m.style.display='none'); }

</script>
</body>
</html>
