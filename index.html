<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#ff69b4">
    
    <title>Seiren OS</title>
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/2919/2919573.png">
    <link rel="icon" type="image/png" href="https://cdn-icons-png.flaticon.com/512/2919/2919573.png">

    <style>
        /* --- CORE AESTHETICS --- */
        :root {
            --pink: #ff69b4;
            --pastel-pink: #ffe4e1;
            --deep-pink: #d12e87;
            --blue: #4fc3f7;
            --text: #555;
            --glass: rgba(255, 255, 255, 0.95);
        }

        body {
            font-family: 'Verdana', sans-serif;
            background-color: var(--pastel-pink);
            background-image: 
                radial-gradient(var(--pink) 15%, transparent 16%),
                radial-gradient(var(--pink) 15%, transparent 16%);
            background-size: 20px 20px;
            background-position: 0 0, 10px 10px;
            margin: 0;
            display: flex;
            justify-content: center;
            height: 100vh;
            overflow: hidden;
            color: var(--text);
            overscroll-behavior: none;
        }

        /* 1. WELCOME SCREEN (STARTUP) */
        #welcome-screen {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: linear-gradient(135deg, #ffc0cb, #e6e6fa);
            z-index: 9999; 
            display: flex; /* Flex by default */
            flex-direction: column;
            align-items: center; justify-content: center;
            transition: opacity 0.5s ease;
        }
        .welcome-box {
            background: rgba(255,255,255,0.9); padding: 40px; border-radius: 30px;
            border: 5px solid white; box-shadow: 0 0 40px rgba(255, 105, 180, 0.6);
            text-align: center; backdrop-filter: blur(5px);
            animation: float 3s ease-in-out infinite;
        }
        @keyframes float { 0% {transform: translateY(0px);} 50% {transform: translateY(-10px);} 100% {transform: translateY(0px);} }
        
        .enter-btn {
            background: linear-gradient(90deg, var(--pink), var(--blue));
            color: white; border: none; padding: 15px 50px; border-radius: 50px;
            font-size: 1.2rem; font-weight: bold; cursor: pointer; margin-top: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2); 
            transition: transform 0.2s;
        }
        .enter-btn:active { transform: scale(0.95); }

        /* 2. MAIN APP SHELL (HIDDEN AT START) */
        .app-shell {
            width: 100%; max-width: 480px;
            background: var(--glass);
            display: none; /* HIDDEN INITIALLY */
            flex-direction: column;
            position: relative; height: 100%;
            box-shadow: 0 0 30px rgba(255, 105, 180, 0.4);
            z-index: 10; opacity: 0; transition: opacity 0.5s;
        }

        /* GLOBAL STYLES */
        .scanlines {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.03) 50%);
            background-size: 100% 3px; pointer-events: none; z-index: 998;
        }

        .marquee-container {
            background: linear-gradient(90deg, var(--pink), var(--deep-pink));
            color: white; padding: 8px 0;
            white-space: nowrap; overflow: hidden; border-bottom: 3px solid #fff;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1); flex-shrink: 0;
        }
        .marquee-text {
            display: inline-block; padding-left: 100%;
            animation: marquee 15s linear infinite; font-weight: bold; font-size: 0.8rem;
            text-transform: uppercase; letter-spacing: 1px;
        }
        @keyframes marquee { 0% { transform: translate(0, 0); } 100% { transform: translate(-100%, 0); } }

        .content {
            flex: 1; overflow-y: auto; overflow-x: hidden;
            padding: 20px; padding-bottom: 150px; scroll-behavior: smooth;
        }
        .page { display: none; animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .page.active { display: block; }
        @keyframes popIn { from {opacity:0; transform:scale(0.95);} to {opacity:1; transform:scale(1);} }

        /* ID CARD */
        .id-card-wrap {
            background: #fff; border: 4px solid var(--pink); border-radius: 20px;
            padding: 5px; box-shadow: 5px 5px 0 rgba(255, 182, 193, 0.5);
            margin-bottom: 20px; position: relative; overflow: hidden;
        }
        .id-inner {
            background-color: #fff0f5;
            background-image: repeating-linear-gradient(45deg, transparent, transparent 10px, rgba(255,255,255,0.7) 10px, rgba(255,255,255,0.7) 20px);
            border: 2px dashed var(--deep-pink); border-radius: 15px; padding: 15px; position: relative;
        }
        .deco-bow { position: absolute; top: -5px; right: -5px; font-size: 2rem; transform: rotate(15deg); z-index: 5; }
        .id-top { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid var(--pink); padding-bottom: 5px; margin-bottom: 10px; }
        .id-body { display: flex; gap: 15px; align-items: center; }
        .id-photo { 
            width: 80px; height: 80px; border-radius: 50%; border: 4px solid white; 
            outline: 3px solid var(--blue); object-fit: cover; background: white;
        }
        .id-data { flex: 1; }
        .id-main-name { font-size: 1.4rem; font-weight: bold; color: var(--deep-pink); line-height: 1; }
        .id-sub-name { font-size: 0.7rem; color: #888; font-style: italic; margin-bottom: 8px; }
        .id-stats-grid {
            display: grid; grid-template-columns: 1fr 1fr; gap: 5px; font-size: 0.7rem;
            background: rgba(255,255,255,0.6); padding: 5px; border-radius: 5px;
        }
        .stat-label { color: var(--blue); font-weight: bold; }
        .signature {
            font-family: 'Brush Script MT', cursive; font-size: 1.2rem; color: var(--blue);
            transform: rotate(-5deg); display: inline-block; margin-right: 10px;
        }

        /* PROFILE MODAL */
        .modal-overlay {
            position: fixed; top:0; left:0; right:0; bottom:0; background: rgba(0,0,0,0.6); z-index: 50;
            display: none; align-items: center; justify-content: center; backdrop-filter: blur(2px);
        }
        .modal-box {
            background: white; width: 85%; max-width: 400px; border-radius: 20px; border: 4px solid var(--pink);
            padding: 20px; max-height: 80vh; overflow-y: auto; animation: popIn 0.3s;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        .slot-card {
            background: #fff0f5; border: 2px solid #ffb7b2; border-radius: 10px; padding: 10px; margin-bottom: 10px;
            display: flex; align-items: center; justify-content: space-between;
        }
        .slot-card.active-slot { border-color: var(--blue); background: #e0f7fa; }
        .slot-btn { padding: 5px 10px; font-size: 0.7rem; border-radius: 10px; border: 1px solid #ccc; cursor: pointer; }
        .btn-switch { background: var(--blue); color: white; border-color: var(--blue); }
        .btn-del { background: #ffcccb; color: red; border-color: red; }

        /* BUTTONS */
        .btn-main {
            background: linear-gradient(180deg, var(--pink), #d12e87); color: white;
            border: none; padding: 12px; width: 100%; border-radius: 25px;
            font-weight: bold; box-shadow: 0 4px 0 #9e1b61; cursor: pointer; margin-top: 10px;
        }
        .btn-main:active { transform: translateY(4px); box-shadow: none; }
        
        .icon-btn { 
            background: linear-gradient(180deg, #fff, #fff0f5); 
            border: 2px solid var(--pink); border-radius: 15px; 
            padding: 10px 20px; font-weight: bold; color: var(--deep-pink);
            font-size: 0.9rem; display: flex; align-items: center; gap: 5px;
            box-shadow: 0 4px 0 #ffb7b2; transition: 0.1s; cursor: pointer;
        }
        .icon-btn:active { transform: translateY(4px); box-shadow: none; }
        
        /* REGISTRY */
        .registry-btn-row { display: flex; gap: 15px; margin-bottom: 20px; justify-content: center; }
        .reg-item { border-bottom: 1px dashed #ccc; padding: 10px 0; display: flex; justify-content: space-between; align-items: center; }
        .reg-del { color: red; font-weight: bold; cursor: pointer; padding: 5px; font-size: 1.2rem; }

        /* FORTUNE */
        .fortune-stage { perspective: 1000px; width: 160px; height: 220px; margin: 0 auto; cursor: pointer; }
        .card-wrapper {
            width: 100%; height: 100%; position: relative;
            transform-style: preserve-3d; transition: transform 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .card-wrapper.flipped { transform: rotateY(180deg); }
        .card-face {
            position: absolute; width: 100%; height: 100%; backface-visibility: hidden; border-radius: 12px;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.15); border: 4px solid white;
        }
        .card-front { background: repeating-linear-gradient(45deg, var(--pink), var(--pink) 10px, #ff9eb5 10px, #ff9eb5 20px); }
        .card-back { background: white; transform: rotateY(180deg); padding: 10px; text-align: center; border-color: var(--pink); }
        .new-day-btn {
            background: #4fc3f7; color: white; border: none; padding: 8px 15px;
            border-radius: 20px; font-size: 0.8rem; margin-top: 15px; cursor: pointer;
            box-shadow: 0 3px 0 #29b6f6; font-weight: bold;
        }

        /* WISHLIST */
        .corkboard {
            background: #e6d7c3; border: 5px solid #8b5a2b; border-radius: 10px; padding: 15px;
            box-shadow: inset 0 0 20px rgba(0,0,0,0.1); min-height: 500px; position: relative;
        }
        .wish-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .polaroid {
            background: white; padding: 6px 6px 20px 6px; box-shadow: 2px 2px 5px rgba(0,0,0,0.2);
            text-align: center; transform: rotate(-2deg); transition: 0.2s; position: relative;
        }
        .polaroid:nth-child(even) { transform: rotate(2deg); }
        .polaroid:hover { transform: scale(1.05) rotate(0deg); z-index: 10; }
        .polaroid img { width: 100%; aspect-ratio: 1/1; object-fit: cover; background: #eee; border: 1px solid #ccc; }
        .polaroid-link { text-decoration: none; color: inherit; display: block; }
        .delete-wish-btn {
            position: absolute; top: -8px; right: -8px; width: 22px; height: 22px;
            background: #ff4d4d; color: white; border: 2px solid white; border-radius: 50%;
            font-size: 14px; font-weight: bold; cursor: pointer; display: flex; 
            align-items: center; justify-content: center; z-index: 20; box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        
        .fab-btn {
            position: absolute; bottom: 20px; right: 20px; width: 60px; height: 60px;
            background: var(--pink); color: white; border-radius: 50%; border: 3px solid white;
            font-size: 2rem; font-weight: bold; display: flex; align-items: center; justify-content: center;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3); cursor: pointer; z-index: 100;
        }
        .wish-panel {
            position: absolute; bottom: 90px; right: 20px; left: 20px;
            background: white; border: 3px solid var(--blue); border-radius: 15px;
            padding: 15px; display: none; box-shadow: 0 10px 30px rgba(0,0,0,0.2); z-index: 99; animation: slideUp 0.3s;
        }
        @keyframes slideUp { from {transform: translateY(20px); opacity:0;} to {transform: translateY(0); opacity:1;} }

        .pet-box { background: white; border: 3px solid var(--pink); border-radius: 20px; padding: 20px; text-align: center; margin-bottom: 20px; }
        .ebi-img { width: 120px; animation: bounce 2s infinite; filter: drop-shadow(0 5px 0 rgba(0,0,0,0.1)); }
        @keyframes bounce { 0%, 100% {transform:translateY(0);} 50% {transform:translateY(-5px);} }
        .task-item { background: white; padding: 12px; margin-bottom: 8px; border-radius: 10px; display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #eee; }
        .task-item.completed { text-decoration: line-through; color: #aaa; opacity: 0; transform: translateX(50px); transition: all 0.4s; }

        .diary-box { background: white; border-radius: 15px; padding: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .mood-bar { display: flex; justify-content: space-between; margin-bottom: 10px; }
        .mood-btn { font-size: 1.5rem; background: #f0f0f0; border-radius: 50%; width: 40px; height: 40px; border: 2px solid transparent; cursor: pointer; }
        .mood-btn.selected { background: var(--pastel-pink); border-color: var(--pink); transform: scale(1.1); }

        /* UI HELPER */
        input { width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 10px; box-sizing: border-box; font-family:inherit; margin-bottom: 5px; }
        input:focus { outline: none; border-color: var(--pink); background: #fff0f5; }
        .xp-box { background: white; padding: 10px; border-radius: 12px; margin-bottom: 20px; border: 2px solid var(--blue); text-align: center; }
        .xp-track { height: 8px; background: #eee; border-radius: 4px; margin-top: 5px; overflow: hidden; }
        .xp-fill { height: 100%; background: linear-gradient(90deg, var(--blue), #00bfff); width: 0%; transition: width 0.5s; }
        .toast {
            position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
            background: rgba(255, 105, 180, 0.9); color: white; padding: 10px 20px;
            border-radius: 20px; font-size: 0.9rem; pointer-events: none;
            opacity: 0; transition: 0.3s; z-index: 9999; font-weight: bold;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }
        .toast.show { opacity: 1; top: 30px; }

        nav {
            position: fixed; bottom: 0; left: 0; right: 0;
            background: white; border-top: 3px solid var(--pink);
            display: flex; justify-content: space-around; padding: 12px 0;
            padding-bottom: max(12px, env(safe-area-inset-bottom)); z-index: 100;
        }
        .nav-btn { background: none; border: none; color: #ccc; display: flex; flex-direction: column; align-items: center; font-size: 0.7rem; }
        .nav-btn span { font-size: 1.4rem; margin-bottom: 2px; }
        .nav-btn.active { color: var(--pink); transform: scale(1.1); font-weight: bold; }

    </style>
</head>
<body>

<div class="scanlines"></div>
<div id="toast" class="toast">üíæ Saved!</div>

<div id="welcome-screen">
    <div class="welcome-box">
        <div style="font-size:2rem; color:#d12e87; font-weight:bold; text-transform:uppercase; letter-spacing:2px;">SEIREN OS</div>
        <div style="font-size:4rem; margin:20px 0;">üéÄ</div>
        <button class="enter-btn" onclick="enterApp()">ENTER SYSTEM</button>
        <div style="margin-top:15px; font-size:0.8rem; color:#888;">System Ready...</div>
    </div>
</div>

<div class="app-shell" id="app-shell">
    <div class="marquee-container">
        <div class="marquee-text">
            ‚òÖ SEIREN OS v21.0 ‚òÖ OFFICIAL CITIZEN SYSTEM ‚òÖ EBI IS HUNGRY ‚òÖ MAKE A WISH ‚òÖ GIRLS BRAVO FOREVER ‚òÖ
        </div>
    </div>

    <div class="content">

        <div id="tab-home" class="page active">
            
            <div id="setup-screen" style="text-align:center; padding:20px; display:none;">
                <h2 style="color:var(--pink);">New Citizen?</h2>
                <p style="font-size:0.8rem; color:#666; margin-bottom:10px;">Create your first profile.</p>
                <input type="text" id="setup-name" placeholder="Name">
                <input type="number" id="setup-age" placeholder="Age">
                <button class="btn-main" onclick="createProfile()">Create ID</button>
            </div>

            <div id="id-display" style="display:none;">
                
                <div class="xp-box">
                    <div style="display:flex; justify-content:space-between; font-size:0.8rem; font-weight:bold; color:var(--blue);">
                        <span>Level <span id="lvl-num">1</span></span>
                        <span><span id="xp-val">0</span> / 100 XP</span>
                    </div>
                    <div class="xp-track"><div id="xp-bar" class="xp-fill"></div></div>
                </div>

                <div class="id-card-wrap">
                    <div class="id-inner">
                        <div class="deco-bow">üéÄ</div>
                        <div class="id-top">
                            <div class="id-logo">SEIREN GOV.</div>
                            <div style="font-size:0.6rem; color:#aaa; font-weight:bold;">ID CARD</div>
                        </div>
                        <div class="id-body">
                            <div class="id-photo-zone">
                                <img id="my-avatar" class="id-photo" src="" onclick="changeAvatar()">
                            </div>
                            <div class="id-data">
                                <div>
                                    <div id="my-name" class="id-main-name">User</div>
                                    <div id="my-realname" class="id-sub-name">aka ???</div>
                                </div>
                                <div class="id-stats-grid">
                                    <span><span class="stat-label">ID#:</span> <span id="my-id">0000</span></span>
                                    <span><span class="stat-label">Sign:</span> <span id="my-sign">?</span></span>
                                    <span><span class="stat-label">Eyes:</span> <span id="my-eyes">?</span></span>
                                    <span><span class="stat-label">Hair:</span> <span id="my-hair">?</span></span>
                                    <span><span class="stat-label">Hgt:</span> <span id="my-hgt">?</span></span>
                                    <span><span class="stat-label">Wgt:</span> <span id="my-wgt">?</span></span>
                                </div>
                            </div>
                        </div>
                        <div class="id-footer">
                            AUTHORIZED SIGNATURE: <span class="signature" id="my-sig">User</span>
                        </div>
                    </div>
                </div>

                <div style="text-align:center; margin-bottom:20px;">
                    <button class="icon-btn" onclick="openProfileManager()" style="margin:0 auto;">
                        üë• Profiles (Switch ID)
                    </button>
                </div>

                <div class="registry-btn-row">
                    <button class="icon-btn" onclick="saveToRegistry()">üíæ Save ID</button>
                    <button class="icon-btn" onclick="openRegistry()">üìñ Registry</button>
                </div>

                <div style="text-align:center;">
                    <h3 style="color:var(--pink); margin-bottom:5px;">Daily Fortune</h3>
                    <div class="fortune-stage" onclick="flipFortune()">
                        <div class="card-wrapper" id="fortune-card">
                            <div class="card-face card-front">
                                <span style="font-size:3rem; color:white; font-weight:bold;">?</span>
                            </div>
                            <div class="card-face card-back">
                                <div id="fortune-icon" style="font-size:3rem; margin-bottom:10px;">‚≠ê</div>
                                <strong id="fortune-title" style="color:var(--pink); font-size:1rem;"></strong>
                                <p id="fortune-desc" style="font-size:0.8rem; color:#666; margin-top:5px; line-height:1.3;"></p>
                            </div>
                        </div>
                    </div>
                    <button class="new-day-btn" onclick="resetFortune()">‚Üª New Day</button>
                </div>
            </div>
        </div>

        <div id="tab-wish" class="page">
            <h2 style="color:var(--blue);">My Wishlist</h2>
            <div class="corkboard">
                <div id="wish-grid" class="wish-grid"></div>
                <button class="fab-btn" onclick="toggleWishPanel()">+</button>
                <div class="wish-panel" id="wish-panel">
                    <strong style="color:var(--pink);">New Wish</strong>
                    <input type="text" id="wish-name" placeholder="Item Name">
                    <input type="text" id="wish-img" placeholder="Image Link (Optional)">
                    <input type="text" id="wish-link" placeholder="Link to Buy (Optional)">
                    <button class="btn-main" onclick="addWish()">Pin It!</button>
                </div>
            </div>
        </div>

        <div id="tab-pet" class="page">
            <div class="pet-box">
                <img src="https://cdn-icons-png.flaticon.com/512/3069/3069172.png" class="ebi-img">
                <h3 style="color:var(--pink); margin:10px 0;">Ebi</h3>
                <div style="background:#eee; height:12px; border-radius:10px; overflow:hidden;">
                    <div id="hunger-bar" style="width:50%; height:100%; background:linear-gradient(90deg, #ff9a9e, #ff69b4); transition:width 0.3s;"></div>
                </div>
                <p id="pet-msg" style="font-size:0.8rem; color:#888; margin-top:5px;">Feed me snacks!</p>
            </div>
            <h3>My Tasks</h3>
            <div style="display:flex; gap:10px; margin-bottom:15px;">
                <input type="text" id="task-input" placeholder="New Task...">
                <button class="btn-main btn-sm" onclick="addTask()">Add</button>
            </div>
            <div id="task-list"></div>
        </div>

        <div id="tab-diary" class="page">
            <h2 style="color:var(--pink);">Secret Diary</h2>
            <div class="diary-box">
                <div class="mood-bar">
                    <button class="mood-btn selected" onclick="setMood('üòä', this)">üòä</button>
                    <button class="mood-btn" onclick="setMood('üò¢', this)">üò¢</button>
                    <button class="mood-btn" onclick="setMood('üò°', this)">üò°</button>
                    <button class="mood-btn" onclick="setMood('üíñ', this)">üíñ</button>
                </div>
                <textarea id="diary-text" style="width:100%; height:80px; padding:10px; border:2px solid #eee; border-radius:10px; resize:none; font-family:inherit;" placeholder="Dear Diary..."></textarea>
                <button class="btn-main" onclick="saveDiary()">Save Entry</button>
            </div>
            <div id="diary-history"></div>
        </div>

    </div>

    <div class="modal-overlay" id="profile-modal" onclick="closeProfileManager(event)">
        <div class="modal-box">
            <h2 style="color:var(--pink); margin-top:0;">üë• Select Profile</h2>
            <div id="profile-slots"></div>
            <div id="modal-create-form" style="display:none; margin-top:20px; border-top:2px dashed #ddd; padding-top:10px;">
                <h3 style="margin:0 0 10px 0; color:var(--blue);">New Profile</h3>
                <input type="text" id="new-slot-name" placeholder="Name">
                <input type="number" id="new-slot-age" placeholder="Age">
                <button class="btn-main" onclick="confirmCreateProfile()">Create</button>
            </div>
            <button class="btn-main" style="background:#888; margin-top:10px;" onclick="document.getElementById('profile-modal').style.display='none'">Close</button>
        </div>
    </div>

    <div class="modal-overlay" id="registry-modal" onclick="closeRegistry(event)">
        <div class="modal-box">
            <h2 style="color:var(--pink); margin-top:0;">üìñ Registry Book</h2>
            <div class="reg-input-group" style="background:#f0f8ff; padding:10px; border-radius:10px; margin-bottom:15px;">
                <div style="font-size:0.7rem; font-weight:bold; color:var(--blue); margin-bottom:5px;">ADD NEW ENTRY</div>
                <div style="display:flex; gap:5px;">
                    <input type="text" id="reg-new-name" placeholder="Name" style="margin:0;">
                    <input type="text" id="reg-new-age" placeholder="Age" style="margin:0; width:60px;">
                </div>
                <button class="btn-main" style="margin-top:5px; padding:8px;" onclick="addNewToRegistry()">Register New</button>
            </div>
            <div id="registry-list"></div>
            <button class="btn-main" onclick="document.getElementById('registry-modal').style.display='none'">Close</button>
        </div>
    </div>

    <nav>
        <button class="nav-btn active" onclick="nav('home', this)"><span>üè†</span>Home</button>
        <button class="nav-btn" onclick="nav('wish', this)"><span>üìå</span>Wishes</button>
        <button class="nav-btn" onclick="nav('pet', this)"><span>üç§</span>Ebi</button>
        <button class="nav-btn" onclick="nav('diary', this)"><span>üìì</span>Diary</button>
    </nav>
</div>

<script>
    // === AVATAR LINKS ===
    const AVATARS = [
        "https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcRzYjS4GrT6U0nmcao3A-UnuzLyeh-2UR3jloaiM4z7_A&s=10",
        "https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcT-z6WQN33PPEubdeVEbA1tGIvqoi3-J8-8wReOIZikgQ&s=10",
        "https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcRJVhcDbDaFqB74aaGolFdS64y-mZ-MFhlhYcurhWdC_g&s=10",
        "https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcTklVuzM99qRKzhmBO5tNcbgRNsRyEVv7a4xjoHGC-ttshIszV1lN-VRNw&s=10",
        "https://upload.wikimedia.org/wikipedia/commons/4/43/Chara04.png",
        "https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcTDNRg8thRPLTkTTKHsN1GxIk8WWQuawgwJcJalTTxhbNf339y17tzoxbmI&s=10",
        "https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcTt4mFfq8-QLLwjpTjWrloE8-LH67ZIuDDv_5pqzFDKeC5CbaNQn60p9j8&s=10",
        "https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcRrlK8lLQ6EYZMbc8lqQ5ZCX_kThxUo6XFKizYzXR91YNT5feH1etfRF-s&s=10",
        "https://static.wikia.nocookie.net/aesthetics/images/0/04/Luckystarmoe.png/revision/latest?cb=20230827221913"
    ];
    const WISH_ICONS = ["https://cdn-icons-png.flaticon.com/512/3209/3209955.png", "https://cdn-icons-png.flaticon.com/512/2855/2855734.png", "https://cdn-icons-png.flaticon.com/512/2763/2763268.png", "https://cdn-icons-png.flaticon.com/512/2763/2763444.png", "https://cdn-icons-png.flaticon.com/512/2965/2965228.png"];

    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    function playSnd(type) {
        if(audioCtx.state === 'suspended') audioCtx.resume();
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.type = type === 'bloop' ? 'sine' : 'triangle';
        const freq = type === 'bloop' ? 800 : 1200;
        osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
        osc.frequency.exponentialRampToValueAtTime(freq/2, audioCtx.currentTime + 0.1);
        gain.gain.setValueAtTime(0.2, audioCtx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.1);
        osc.connect(gain); gain.connect(audioCtx.destination);
        osc.start(); osc.stop(audioCtx.currentTime + 0.1);
    }

    const DB = {
        profiles: JSON.parse(localStorage.getItem('v20_profiles')) || [null, null, null, null, null],
        activeSlot: parseInt(localStorage.getItem('v20_activeSlot')) || 0,
        wish: JSON.parse(localStorage.getItem('v20_wish')) || [],
        pet: JSON.parse(localStorage.getItem('v20_pet')) || { hunger: 50, tasks: ['Drink Water'] },
        diary: JSON.parse(localStorage.getItem('v20_diary')) || [],
        fortune: JSON.parse(localStorage.getItem('v20_fortune')) || { date: '', icon: '', title: '', desc: '' },
        registry: JSON.parse(localStorage.getItem('v20_registry')) || [],
        xp: parseInt(localStorage.getItem('v20_xp')) || 0,
        lvl: parseInt(localStorage.getItem('v20_lvl')) || 1
    };
    let mood = 'üòä';
    let creatingSlot = -1;

    function showSaveToast() {
        const t = document.getElementById('toast');
        t.classList.add('show');
        setTimeout(() => t.classList.remove('show'), 1000);
    }

    function init() {
        // MIGRATION FROM V19
        const oldP = JSON.parse(localStorage.getItem('v19_profiles'));
        if(oldP && !DB.profiles[0]) {
            DB.profiles = oldP;
            DB.activeSlot = parseInt(localStorage.getItem('v19_activeSlot')) || 0;
            localStorage.setItem('v20_profiles', JSON.stringify(DB.profiles));
        }

        // Logic handled in enterApp() mainly, init just sets up data
        // If user already exists, they wait at welcome screen.
        // If NO user exists at all, we can skip welcome or just show setup inside app.
    }

    // MAIN ENTRY POINT
    function enterApp() {
        playSnd('spark');
        // Hide Welcome
        document.getElementById('welcome-screen').style.opacity = '0';
        setTimeout(() => {
            document.getElementById('welcome-screen').style.display = 'none';
            document.getElementById('app-shell').style.display = 'flex';
            // Trigger reflow for transition
            setTimeout(() => {
                document.getElementById('app-shell').style.opacity = '1';
                
                // Check if we need setup
                const hasUser = DB.profiles.some(p => p !== null);
                if(hasUser) {
                    document.getElementById('id-display').style.display = 'block';
                    renderID(); checkFortune(); updateXP(); 
                    renderWish(); renderPet(); renderDiary();
                } else {
                    document.getElementById('setup-screen').style.display = 'block';
                }
            }, 50);
        }, 500);
    }

    // === GENERATOR ===
    function generateStats(name, age) {
        const seed = name.length + parseInt(age || 0);
        const pres = ["Mi", "Lu", "Fa", "Ko", "Ri", "Yu", "Se"];
        const sufs = ["-chan", "-pyon", "ren", "la", "na", "ka"];
        const sName = pres[seed % pres.length] + sufs[(seed*3) % sufs.length];
        
        return {
            name: sName, realName: name, age: age || "?",
            type: ["Tsundere", "Dojikko", "Alien", "Idol", "Ghost"][seed % 5],
            id: Math.floor(Math.random()*9000)+1000,
            eyes: ["Pink", "Blue", "Red", "Gold", "Purple"][seed%5],
            hair: ["Twin-tails", "Long", "Bob", "Drills", "Messy"][seed%5],
            wgt: ["3 Apples", "5 Mochis", "40kg", "Feather"][seed%4],
            hgt: (140 + (seed%30)) + "cm",
            sign: ["Aries", "Leo", "Libra", "Pisces", "Gemini"][seed%5],
            avatarIdx: seed % AVATARS.length
        };
    }

    // === PROFILES ===
    function createProfile() {
        const name = document.getElementById('setup-name').value;
        const age = document.getElementById('setup-age').value;
        if(!name) return;
        playSnd('bloop');
        
        DB.profiles[0] = generateStats(name, age);
        DB.activeSlot = 0;
        saveProfiles();
        
        document.getElementById('setup-screen').style.display='none';
        document.getElementById('id-display').style.display='block';
        renderID(); renderWish(); renderPet(); renderDiary();
    }

    function createNewProfile(slotIndex) {
        creatingSlot = slotIndex;
        document.getElementById('modal-create-form').style.display = 'block';
        document.getElementById('new-slot-name').focus();
    }

    function confirmCreateProfile() {
        const name = document.getElementById('new-slot-name').value;
        const age = document.getElementById('new-slot-age').value;
        if(!name || creatingSlot === -1) return;
        playSnd('spark');

        DB.profiles[creatingSlot] = generateStats(name, age);
        DB.activeSlot = creatingSlot;
        saveProfiles();
        
        document.getElementById('new-slot-name').value = "";
        document.getElementById('new-slot-age').value = "";
        document.getElementById('modal-create-form').style.display = 'none';
        document.getElementById('profile-modal').style.display = 'none';
        renderID();
        showSaveToast();
    }

    function switchProfile(index) {
        playSnd('bloop');
        DB.activeSlot = index;
        localStorage.setItem('v20_activeSlot', DB.activeSlot);
        document.getElementById('profile-modal').style.display = 'none';
        renderID();
        showSaveToast();
    }

    function deleteProfile(index) {
        if(confirm("Delete this profile?")) {
            DB.profiles[index] = null;
            if(index === DB.activeSlot) {
                const next = DB.profiles.findIndex(p => p !== null);
                if(next !== -1) DB.activeSlot = next;
                else location.reload();
            }
            saveProfiles();
            openProfileManager();
        }
    }

    function saveProfiles() {
        localStorage.setItem('v20_profiles', JSON.stringify(DB.profiles));
        localStorage.setItem('v20_activeSlot', DB.activeSlot);
    }

    function openProfileManager() {
        playSnd('bloop');
        const list = document.getElementById('profile-slots');
        list.innerHTML = "";
        document.getElementById('modal-create-form').style.display = 'none';

        DB.profiles.forEach((p, idx) => {
            if(p) {
                const isActive = idx === DB.activeSlot ? 'active-slot' : '';
                list.innerHTML += `<div class="slot-card ${isActive}"><div class="slot-info"><div class="slot-name">Slot ${idx+1}: ${p.name}</div><div>${p.realName}</div></div><div class="slot-actions">${idx !== DB.activeSlot ? `<button class="slot-btn btn-switch" onclick="switchProfile(${idx})">Switch</button>` : ''}<button class="slot-btn btn-del" onclick="deleteProfile(${idx})">x</button></div></div>`;
            } else {
                list.innerHTML += `<div class="slot-card" style="border-style:dashed;justify-content:center;"><button class="slot-btn" onclick="createNewProfile(${idx})">+ New Profile</button></div>`;
            }
        });
        document.getElementById('profile-modal').style.display = 'flex';
    }
    function closeProfileManager(e) { if(e.target.id === 'profile-modal') e.target.style.display = 'none'; }

    // RENDER ID
    function renderID() {
        const user = DB.profiles[DB.activeSlot];
        if(!user) return; 

        document.getElementById('my-name').innerText = user.name;
        document.getElementById('my-realname').innerText = "aka " + user.realName;
        document.getElementById('my-sig').innerText = user.name;
        document.getElementById('my-id').innerText = user.id;
        document.getElementById('my-eyes').innerText = user.eyes;
        document.getElementById('my-hair').innerText = user.hair;
        document.getElementById('my-sign').innerText = user.sign;
        document.getElementById('my-hgt').innerText = user.hgt;
        document.getElementById('my-wgt').innerText = user.wgt;
        document.getElementById('my-avatar').src = AVATARS[user.avatarIdx % AVATARS.length];
        updateXP();
    }
    function changeAvatar() {
        playSnd('bloop');
        if(DB.lvl < 2) return alert("Level up to unlock avatars!");
        const user = DB.profiles[DB.activeSlot];
        const limit = Math.min(DB.lvl + 1, AVATARS.length);
        user.avatarIdx = (user.avatarIdx + 1) % limit;
        saveProfiles(); renderID();
    }

    // REGISTRY
    function saveToRegistry() {
        playSnd('bloop');
        const current = DB.profiles[DB.activeSlot];
        DB.registry.unshift({...current});
        localStorage.setItem('v20_registry', JSON.stringify(DB.registry));
        showSaveToast();
        alert("Saved to Registry!");
    }
    function addNewToRegistry() {
        const name = document.getElementById('reg-new-name').value;
        const age = document.getElementById('reg-new-age').value;
        if(!name) return;
        playSnd('spark');
        DB.registry.unshift(generateStats(name, age));
        localStorage.setItem('v20_registry', JSON.stringify(DB.registry));
        document.getElementById('reg-new-name').value=""; document.getElementById('reg-new-age').value="";
        openRegistry(); showSaveToast();
    }
    function removeRegistryItem(index) {
        if(confirm("Delete this entry?")) {
            DB.registry.splice(index, 1);
            localStorage.setItem('v20_registry', JSON.stringify(DB.registry));
            openRegistry();
        }
    }
    function openRegistry() {
        playSnd('bloop');
        const list = document.getElementById('registry-list');
        list.innerHTML = "";
        if(DB.registry.length === 0) list.innerHTML = "<p style='text-align:center;color:#aaa;'>Empty.</p>";
        DB.registry.forEach((entry, idx) => {
            list.innerHTML += `<div class="reg-item"><div><div style="font-weight:bold;color:var(--pink);">${entry.name}</div><div style="font-size:0.7rem;">${entry.realName} (${entry.age})</div></div><div style="display:flex;align-items:center;gap:5px;"><div style="background:var(--blue);color:white;padding:2px 6px;border-radius:10px;font-size:0.6rem;">${entry.type}</div><span class="reg-del" onclick="removeRegistryItem(${idx})">x</span></div></div>`;
        });
        document.getElementById('registry-modal').style.display = 'flex';
    }
    function closeRegistry(e) { if(e.target.id === 'registry-modal') e.target.style.display = 'none'; }

    // XP
    function addXP(n) {
        DB.xp += n;
        if(DB.xp >= 100) { DB.xp -= 100; DB.lvl++; playSnd('spark'); alert("LEVEL UP!"); }
        localStorage.setItem('v20_xp', DB.xp); localStorage.setItem('v20_lvl', DB.lvl);
        updateXP();
    }
    function updateXP() {
        document.getElementById('lvl-num').innerText = DB.lvl;
        document.getElementById('xp-val').innerText = DB.xp;
        document.getElementById('xp-bar').style.width = DB.xp + "%";
    }

    // FORTUNE
    function checkFortune() {
        const today = new Date().toDateString();
        const card = document.getElementById('fortune-card');
        if(DB.fortune.date === today) {
            renderFData(DB.fortune);
            card.classList.add('flipped');
            card.style.transition = 'none';
        } else { card.classList.remove('flipped'); }
    }
    function flipFortune() {
        const today = new Date().toDateString();
        if(DB.fortune.date === today) return;
        playSnd('spark');
        const opts = [{i:"üçû",t:"Toast Dash",d:"You will be late!"},{i:"üõÅ",t:"Bath Portal",d:"Teleport risk high."},{i:"üëΩ",t:"Alien Signal",d:"Check your phone."},{i:"üíñ",t:"Doki Doki",d:"Love is in the air!"}];
        const res = opts[Math.floor(Math.random()*opts.length)];
        DB.fortune = { date: today, icon: res.i, title: res.t, desc: res.d };
        localStorage.setItem('v20_fortune', JSON.stringify(DB.fortune));
        addXP(20);
        renderFData(DB.fortune);
        const card = document.getElementById('fortune-card');
        card.style.transition = 'transform 0.8s'; void card.offsetWidth; card.classList.add('flipped');
        showSaveToast();
    }
    function resetFortune() {
        if(confirm("Start a new day?")) {
            DB.fortune.date = ""; localStorage.setItem('v20_fortune', JSON.stringify(DB.fortune));
            const card = document.getElementById('fortune-card');
            card.style.transition = 'none'; card.classList.remove('flipped');
        }
    }
    function renderFData(d) {
        document.getElementById('fortune-icon').innerText = d.icon;
        document.getElementById('fortune-title').innerText = d.title;
        document.getElementById('fortune-desc').innerText = d.desc;
    }

    // WISHLIST
    function toggleWishPanel() { const p = document.getElementById('wish-panel'); p.style.display = p.style.display === 'block' ? 'none' : 'block'; }
    function addWish() {
        const n = document.getElementById('wish-name').value;
        const i = document.getElementById('wish-img').value;
        const l = document.getElementById('wish-link').value;
        if(!n) return;
        playSnd('bloop');
        let defaultImg = WISH_ICONS[Math.floor(Math.random()*WISH_ICONS.length)];
        DB.wish.push({name:n, img: i || defaultImg, link: l || "#"});
        localStorage.setItem('v20_wish', JSON.stringify(DB.wish));
        document.getElementById('wish-name').value=""; document.getElementById('wish-img').value=""; document.getElementById('wish-link').value="";
        toggleWishPanel(); renderWish(); showSaveToast();
    }
    function deleteWish(index) {
        playSnd('bloop');
        if(confirm("Remove?")) {
            DB.wish.splice(index, 1);
            localStorage.setItem('v20_wish', JSON.stringify(DB.wish));
            renderWish(); showSaveToast();
        }
    }
    function renderWish() {
        const g = document.getElementById('wish-grid'); g.innerHTML="";
        const backupIcon = "https://cdn-icons-png.flaticon.com/512/3209/3209955.png";
        DB.wish.forEach((w, idx)=>{
            let content = `<div class="polaroid"><button class="delete-wish-btn" onclick="event.preventDefault(); deleteWish(${idx})">x</button><div class="pin"></div><img src="${w.img}" onerror="this.src='${backupIcon}'"><div style="font-size:0.7rem;margin-top:5px;">${w.name}</div></div>`;
            if(w.link && w.link !== "#") { content = `<a href="${w.link}" target="_blank" class="polaroid-link">${content}</a>`; }
            g.innerHTML += content;
        });
    }

    // PET & TASKS
    function renderPet() {
        document.getElementById('hunger-bar').style.width = DB.pet.hunger+"%";
        document.getElementById('pet-msg').innerText = DB.pet.hunger>50 ? "Ebi is happy!" : "Hungry...";
        const l = document.getElementById('task-list'); l.innerHTML="";
        DB.pet.tasks.forEach((t, index)=>{
            l.innerHTML+=`<div class="task-item" id="task-${index}"><span>${t}</span><input type="checkbox" onclick="finishTask(${index}, this)"></div>`;
        });
    }
    function finishTask(index, checkbox) {
        checkbox.disabled = true; playSnd('bloop'); DB.pet.hunger = Math.min(100, DB.pet.hunger + 15); addXP(10);
        document.getElementById(`task-${index}`).classList.add('completed');
        setTimeout(() => {
            DB.pet.tasks.splice(index, 1); localStorage.setItem('v20_pet', JSON.stringify(DB.pet)); renderPet(); showSaveToast();
        }, 500); 
    }
    function addTask() {
        const v = document.getElementById('task-input').value;
        if(v) { DB.pet.tasks.push(v); localStorage.setItem('v20_pet', JSON.stringify(DB.pet)); document.getElementById('task-input').value=""; renderPet(); showSaveToast(); }
    }

    // DIARY
    function setMood(m,b) { playSnd('bloop'); mood=m; document.querySelectorAll('.mood-btn').forEach(btn=>btn.classList.remove('selected')); b.classList.add('selected'); }
    function saveDiary() {
        const t = document.getElementById('diary-text').value; if(!t) return;
        playSnd('spark');
        DB.diary.unshift({d: new Date().toLocaleDateString(), m: mood, t: t});
        addXP(10); localStorage.setItem('v20_diary', JSON.stringify(DB.diary));
        document.getElementById('diary-text').value=""; renderDiary(); showSaveToast();
    }
    function renderDiary() {
        const h = document.getElementById('diary-history'); h.innerHTML="";
        DB.diary.forEach(e=>h.innerHTML+=`<div style="background:white;padding:10px;margin-bottom:10px;border-radius:10px;border-bottom:2px solid #eee;">${e.m} <span style="font-size:0.7rem;color:#aaa;">${e.d}</span><br>${e.t}</div>`);
    }

    function nav(id, btn) {
        playSnd('bloop');
        document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
        document.getElementById('tab-'+id).classList.add('active');
        document.querySelectorAll('.nav-btn').forEach(b=>b.classList.remove('active'));
        btn.classList.add('active');
    }

    // LOAD
    init();
    if('serviceWorker' in navigator) window.addEventListener('load', ()=>navigator.serviceWorker.register('./sw.js'));
</script>
</body>
</html>
