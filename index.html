<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#ff69b4">
    <title>Seiren OS + PK</title>
    
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/2919/2919573.png">
    <link rel="icon" type="image/png" href="https://cdn-icons-png.flaticon.com/512/2919/2919573.png">

    <style>
        :root {
            --main: #ff69b4;
            --bg-light: #ffe4e1;
            --bg-dark: #ffb7b2;
            --dark: #d12e87;
            --glass: rgba(255, 255, 255, 0.95);
            --text: #555;
            --blue: #4fc3f7;
        }

        /* --- GLOBAL & LAYOUT --- */
        body {
            font-family: 'Verdana', 'Tahoma', sans-serif;
            background-color: var(--bg-light);
            background-image: 
                radial-gradient(var(--bg-dark) 15%, transparent 16%),
                radial-gradient(var(--bg-dark) 15%, transparent 16%);
            background-size: 20px 20px;
            background-position: 0 0, 10px 10px;
            margin: 0; display: flex; justify-content: center; height: 100vh; overflow: hidden;
            color: var(--text); user-select: none; -webkit-user-select: none;
        }

        .app-shell {
            width: 100%; max-width: 480px; background: var(--glass);
            display: none; flex-direction: column; position: relative; height: 100%;
            box-shadow: 0 0 50px rgba(0,0,0,0.1); z-index: 10;
        }

        /* --- LOCK SCREEN --- */
        #lock-screen {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: var(--main); z-index: 20000;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            color: white; transition: transform 0.3s ease-in-out;
        }
        .pin-pad { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-top: 20px; }
        .pin-btn {
            width: 60px; height: 60px; border-radius: 50%; border: 2px solid white;
            background: rgba(255,255,255,0.2); color: white; font-size: 1.5rem;
            display: flex; align-items: center; justify-content: center; cursor: pointer;
        }
        .pin-btn:active { background: white; color: var(--main); }
        .pin-display { 
            width: 200px; height: 40px; background: rgba(0,0,0,0.2); 
            border-radius: 10px; margin-bottom: 20px; display: flex; 
            align-items: center; justify-content: center; letter-spacing: 10px; font-size: 2rem;
        }

        /* --- DISCORD-STYLE CHAT LAYOUT --- */
        .discord-layout {
            display: flex; height: 100%; overflow: hidden;
            background: #fff; border: 2px ridge var(--main); border-radius: 15px;
        }
        .channel-sidebar {
            width: 80px; background: #f0f0f0; border-right: 1px solid #ddd;
            display: flex; flex-direction: column; align-items: center; padding-top: 10px;
            overflow-y: auto;
        }
        .channel-bubble {
            width: 50px; height: 50px; border-radius: 50%; background: #ddd;
            margin-bottom: 10px; display: flex; align-items: center; justify-content: center;
            font-size: 1.2rem; cursor: pointer; border: 2px solid transparent;
            transition: 0.2s; position: relative; color: #555;
        }
        .channel-bubble.active-chan { border-color: var(--main); background: white; color: var(--main); border-radius: 15px; }
        .channel-bubble:hover { border-radius: 15px; background: #e0e0e0; }
        
        .chat-area { flex: 1; display: flex; flex-direction: column; background: white; min-width: 0; }
        .chat-header {
            padding: 10px; border-bottom: 1px solid #eee; font-weight: bold; color: var(--dark);
            display: flex; justify-content: space-between; align-items: center;
        }
        .chat-feed {
            flex: 1; overflow-y: auto; padding: 15px; 
            display: flex; flex-direction: column; gap: 15px;
            background-image: radial-gradient(#eee 1px, transparent 1px); background-size: 20px 20px;
        }
        
        /* PLURALKIT STYLE MESSAGES */
        .pk-msg { display: flex; gap: 10px; align-items: flex-start; animation: popIn 0.2s; }
        .pk-avatar { 
            width: 40px; height: 40px; border-radius: 50%; object-fit: cover; 
            border: 2px solid transparent; flex-shrink: 0;
        }
        .pk-content { min-width: 0; }
        .pk-header { display: flex; align-items: baseline; gap: 5px; margin-bottom: 2px; }
        .pk-name { font-weight: bold; font-size: 0.8rem; cursor: pointer; }
        .pk-tag { font-size: 0.6rem; background: #7289da; color: white; padding: 1px 4px; border-radius: 4px; }
        .pk-time { font-size: 0.6rem; color: #999; }
        .pk-text { font-size: 0.85rem; color: #333; word-wrap: break-word; line-height: 1.4; }

        /* --- STANDARD UI ELEMENTS --- */
        .status-bar { display: flex; justify-content: space-between; padding: 10px 15px; font-size: 0.7rem; font-weight: bold; color: var(--dark); background: rgba(255,255,255,0.8); }
        .content { flex: 1; overflow-y: auto; padding: 20px; padding-bottom: 120px; }
        .page { display: none; animation: popIn 0.3s; }
        .page.active { display: block; }
        @keyframes popIn { from {opacity:0; transform:scale(0.98);} to {opacity:1; transform:scale(1);} }

        .btn-main { background: var(--main); color: white; border: 2px outset #ff9eb5; padding: 12px; width: 100%; border-radius: 25px; font-weight: bold; cursor: pointer; }
        .btn-main:active { transform: translateY(2px); border-style: inset; }
        input, textarea { width: 100%; padding: 12px; border: 2px inset #ddd; border-radius: 15px; box-sizing: border-box; font-family:inherit; outline:none; background: #fffdfd; }
        
        /* NAV */
        nav { position: fixed; bottom: 35px; left: 20px; right: 20px; background: rgba(255,255,255,0.95); border-radius: 40px; display: flex; justify-content: space-around; padding: 15px 0; box-shadow: 0 5px 20px rgba(0,0,0,0.1); z-index: 100; border: 2px solid white; }
        .nav-btn { background: none; border: none; color: #ccc; font-size: 1.4rem; transition: 0.2s; display: flex; flex-direction:column; align-items: center; }
        .nav-btn.active { color: var(--main); transform: scale(1.1); }
        .nav-label { font-size: 0.55rem; font-weight:bold; margin-top: 2px; }

        /* MODALS */
        .modal-overlay { position: fixed; top:0; left:0; right:0; bottom:0; background: rgba(0,0,0,0.6); z-index: 2000; display: none; align-items: center; justify-content: center; backdrop-filter: blur(2px); }
        .modal-box { background: white; width: 85%; max-width: 400px; border-radius: 25px; border: 4px ridge var(--main); padding: 20px; max-height: 80vh; overflow-y: auto; }

        /* DASHBOARD WIDGETS */
        .xp-box { background: white; padding: 10px; border-radius: 12px; margin-bottom: 15px; border: 2px inset var(--blue); text-align: center; }
        .dash-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px; }
        .dash-btn { background: white; border-radius: 15px; padding: 15px; text-align: center; box-shadow: 2px 2px 5px rgba(0,0,0,0.05); cursor: pointer; border: 2px outset #eee; }

    </style>
</head>
<body>

<div id="lock-screen" style="display:none;">
    <div style="font-size:3rem; margin-bottom:10px;">üîí</div>
    <h3>SYSTEM LOCKED</h3>
    <div class="pin-display" id="pin-dots"></div>
    <div class="pin-pad">
        <div class="pin-btn" onclick="enterPin(1)">1</div>
        <div class="pin-btn" onclick="enterPin(2)">2</div>
        <div class="pin-btn" onclick="enterPin(3)">3</div>
        <div class="pin-btn" onclick="enterPin(4)">4</div>
        <div class="pin-btn" onclick="enterPin(5)">5</div>
        <div class="pin-btn" onclick="enterPin(6)">6</div>
        <div class="pin-btn" onclick="enterPin(7)">7</div>
        <div class="pin-btn" onclick="enterPin(8)">8</div>
        <div class="pin-btn" onclick="enterPin(9)">9</div>
        <div class="pin-btn" style="background:none; border:none;"></div>
        <div class="pin-btn" onclick="enterPin(0)">0</div>
        <div class="pin-btn" style="color:#ff69b4; border-color:#ff69b4;" onclick="clearPin()">C</div>
    </div>
</div>

<div class="app-shell" id="main-app">
    <div class="status-bar">
        <span id="clock">12:00</span>
        <span id="active-fronter-display">Loading...</span>
    </div>

    <div class="content">

        <div id="tab-dash" class="page active">
            <h2 style="text-align:center; color:var(--main);">System Dashboard</h2>
            
            <div class="xp-box">
                <b>Current Fronter</b><br>
                <div id="dash-avatar" style="width:80px; height:80px; border-radius:50%; background:#ccc; margin:10px auto; background-size:cover; background-position:center; border:3px solid var(--main);"></div>
                <h3 id="dash-name" style="margin:0;">Loading...</h3>
                <div style="font-size:0.8rem; color:#888; margin-top:5px;">ID: <span id="dash-id">000</span></div>
            </div>

            <div class="dash-grid">
                <div class="dash-btn" onclick="openProfileManager()">
                    <span style="font-size:2rem;">üë•</span><br><b>Switch</b>
                </div>
                <div class="dash-btn" onclick="toggleLockSetup()">
                    <span style="font-size:2rem;">üõ°Ô∏è</span><br><b>Security</b>
                </div>
            </div>
        </div>

        <div id="tab-bbs" class="page" style="height: 100%; display:none; flex-direction:column;">
            <div class="discord-layout" style="flex:1;">
                <div class="channel-sidebar" id="channel-list">
                    <div class="channel-bubble" onclick="addChannel()">+</div>
                </div>

                <div class="chat-area">
                    <div class="chat-header">
                        <span id="chan-title">#general</span>
                        <span style="font-size:0.7rem; color:red; cursor:pointer;" onclick="deleteChannel()">üóëÔ∏è</span>
                    </div>
                    <div class="chat-feed" id="chat-feed"></div>
                    <div style="padding:10px; border-top:1px solid #eee; display:flex; gap:5px;">
                        <input type="text" id="chat-input" placeholder="Proxy message..." style="margin:0;">
                        <button class="btn-main" style="width:auto;" onclick="sendMsg()">Send</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="tab-diary" class="page">
            <h2 style="color:var(--main);">System Diary</h2>
            <div style="margin-bottom:15px;">
                <textarea id="diary-in" style="height:100px; resize:none;" placeholder="Log a memory or diary entry..."></textarea>
                <button class="btn-main" onclick="postDiary()">Log Entry</button>
            </div>
            <div id="diary-feed"></div>
        </div>

    </div>

    <nav>
        <button class="nav-btn active" onclick="go('dash', this)"><span>üè†</span><span class="nav-label">Dash</span></button>
        <button class="nav-btn" onclick="go('bbs', this)"><span>üí¨</span><span class="nav-label">Chats</span></button>
        <button class="nav-btn" onclick="go('diary', this)"><span>üìì</span><span class="nav-label">Diary</span></button>
    </nav>

    <div id="modal-profiles" class="modal-overlay">
        <div class="modal-box">
            <h3>Switch Fronter</h3>
            <div id="profile-list" style="max-height:200px; overflow-y:auto; margin-bottom:15px;"></div>
            <hr>
            <h4>New Alter/Member</h4>
            <input type="text" id="new-name" placeholder="Name">
            <input type="text" id="new-avatar" placeholder="Image URL (Imgur/Discord link)">
            <input type="color" id="new-color" value="#ff69b4" style="width:100%; height:40px; border:none;">
            <button class="btn-main" onclick="createProfile()" style="margin-top:10px;">Register</button>
            <button class="btn-main" style="background:#ccc; margin-top:10px;" onclick="closeModals()">Close</button>
        </div>
    </div>

    <div id="modal-security" class="modal-overlay">
        <div class="modal-box">
            <h3>üõ°Ô∏è Security Settings</h3>
            <p>Set a 4-digit PIN to lock the system.</p>
            <input type="number" id="set-pin" placeholder="Enter 4 digits" maxlength="4">
            <button class="btn-main" onclick="savePin()">Set PIN</button>
            <button class="btn-main" style="background:#ff4444; margin-top:10px;" onclick="removePin()">Remove Lock</button>
            <button class="btn-main" style="background:#ccc; margin-top:10px;" onclick="closeModals()">Close</button>
        </div>
    </div>

</div>

<script>
    // --- DATABASE STRUCTURE ---
    // We update the DB to support channels and PK-style message preservation
    let DB = {
        profiles: [], 
        activeIdx: 0,
        channels: { 
            'general': { name: 'general', msgs: [] },
            'fronting': { name: 'fronting', msgs: [] }
        },
        currentChan: 'general',
        diary: [],
        pin: null // Security PIN
    };

    // --- INIT ---
    let tempPin = "";
    
    window.onload = () => {
        const saved = localStorage.getItem('seiren_pk_v1');
        if(saved) DB = JSON.parse(saved);

        // First Time Setup Logic
        if(DB.profiles.length === 0) {
            DB.profiles.push({
                name: "Host", 
                avatar: "https://cdn-icons-png.flaticon.com/512/3233/3233508.png", 
                color: "#ff69b4",
                id: "001"
            });
        }

        // Security Check
        if(DB.pin) {
            document.getElementById('lock-screen').style.display = 'flex';
        } else {
            enterApp();
        }

        setInterval(() => {
            document.getElementById('clock').innerText = new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
        }, 1000);
    };

    function save() {
        localStorage.setItem('seiren_pk_v1', JSON.stringify(DB));
    }

    // --- SECURITY LOGIC ---
    function enterPin(n) {
        if(tempPin.length < 4) {
            tempPin += n;
            updatePinDots();
        }
        if(tempPin.length === 4) {
            if(tempPin === DB.pin) {
                // UNLOCK
                document.getElementById('lock-screen').style.transform = "translateY(-100%)";
                setTimeout(()=> {
                    document.getElementById('lock-screen').style.display = 'none';
                    enterApp();
                }, 300);
            } else {
                // FAIL
                document.getElementById('pin-dots').style.background = "rgba(255,0,0,0.5)";
                setTimeout(()=> {
                    tempPin = "";
                    updatePinDots();
                    document.getElementById('pin-dots').style.background = "rgba(0,0,0,0.2)";
                }, 500);
            }
        }
    }
    function clearPin() { tempPin = ""; updatePinDots(); }
    function updatePinDots() {
        document.getElementById('pin-dots').innerText = "*".repeat(tempPin.length);
    }
    
    function toggleLockSetup() {
        document.getElementById('modal-security').style.display = 'flex';
    }
    function savePin() {
        const p = document.getElementById('set-pin').value;
        if(p.length === 4) {
            DB.pin = p; save(); alert("System Locked! üîí"); closeModals();
        } else { alert("Pin must be 4 digits"); }
    }
    function removePin() {
        if(confirm("Remove security lock?")) { DB.pin = null; save(); closeModals(); }
    }

    // --- APP LOGIC ---
    function enterApp() {
        document.getElementById('main-app').style.display = 'flex';
        renderDash();
        renderChannels();
    }

    // --- PROFILES & SWITCHING ---
    function renderDash() {
        const u = DB.profiles[DB.activeIdx];
        document.getElementById('active-fronter-display').innerText = u.name;
        document.getElementById('dash-name').innerText = u.name;
        document.getElementById('dash-id').innerText = u.id;
        document.getElementById('dash-avatar').style.backgroundImage = `url('${u.avatar}')`;
        document.getElementById('dash-avatar').style.borderColor = u.color;
        
        // Apply theme color
        document.documentElement.style.setProperty('--main', u.color);
    }

    function openProfileManager() {
        const list = document.getElementById('profile-list');
        list.innerHTML = "";
        DB.profiles.forEach((p, i) => {
            list.innerHTML += `
                <div style="display:flex; justify-content:space-between; align-items:center; padding:10px; border-bottom:1px solid #eee;">
                    <div style="display:flex; align-items:center; gap:10px;">
                        <img src="${p.avatar}" style="width:30px; height:30px; border-radius:50%;">
                        <b>${p.name}</b>
                    </div>
                    <div>
                        ${i === DB.activeIdx ? '<small>Active</small>' : `<button onclick="switchProfile(${i})">Front</button>`}
                        ${i !== 0 ? `<button onclick="deleteProfile(${i})" style="color:red;border:none;background:none;">x</button>` : ''}
                    </div>
                </div>`;
        });
        document.getElementById('modal-profiles').style.display = 'flex';
    }

    function createProfile() {
        const name = document.getElementById('new-name').value;
        const av = document.getElementById('new-avatar').value || "https://cdn-icons-png.flaticon.com/512/3233/3233508.png";
        const col = document.getElementById('new-color').value;
        
        if(name) {
            DB.profiles.push({
                name: name, avatar: av, color: col, id: Math.floor(Math.random()*9000)+1000
            });
            save(); openProfileManager();
            document.getElementById('new-name').value = "";
        }
    }

    function switchProfile(i) {
        DB.activeIdx = i;
        save();
        renderDash();
        closeModals();
    }
    
    function deleteProfile(i) {
        if(confirm("Delete member?")) {
            DB.profiles.splice(i,1);
            if(DB.activeIdx >= i) DB.activeIdx = 0;
            save(); openProfileManager();
        }
    }

    // --- CHANNELS & PLURALKIT MESSAGING ---
    function renderChannels() {
        const sidebar = document.getElementById('channel-list');
        // Clear all except the '+' button
        sidebar.innerHTML = '';
        
        Object.keys(DB.channels).forEach(key => {
            const chan = DB.channels[key];
            const div = document.createElement('div');
            div.className = `channel-bubble ${DB.currentChan === key ? 'active-chan' : ''}`;
            div.innerText = chan.name.substring(0,2).toUpperCase();
            div.onclick = () => switchChannel(key);
            sidebar.appendChild(div);
        });

        // Add Button
        const addBtn = document.createElement('div');
        addBtn.className = 'channel-bubble';
        addBtn.innerText = '+';
        addBtn.onclick = addChannel;
        sidebar.appendChild(addBtn);

        renderChat();
    }

    function switchChannel(key) {
        DB.currentChan = key;
        renderChannels(); // re-render sidebar for active state
        renderChat();
    }

    function addChannel() {
        const name = prompt("New Channel Name (e.g. 'venting'):");
        if(name) {
            const id = name.toLowerCase().replace(/\s/g, '-');
            if(!DB.channels[id]) {
                DB.channels[id] = { name: name, msgs: [] };
                save(); renderChannels();
            }
        }
    }
    
    function deleteChannel() {
        if(DB.currentChan === 'general') { alert("Cannot delete #general"); return; }
        if(confirm(`Delete #${DB.currentChan}?`)) {
            delete DB.channels[DB.currentChan];
            DB.currentChan = 'general';
            save(); renderChannels();
        }
    }

    function renderChat() {
        const chan = DB.channels[DB.currentChan];
        document.getElementById('chan-title').innerText = "#" + chan.name;
        const feed = document.getElementById('chat-feed');
        feed.innerHTML = "";

        chan.msgs.forEach(msg => {
            feed.innerHTML += `
                <div class="pk-msg">
                    <img src="${msg.avatar}" class="pk-avatar" style="border-color:${msg.color}">
                    <div class="pk-content">
                        <div class="pk-header">
                            <span class="pk-name" style="color:${msg.color}">${msg.name}</span>
                            <span class="pk-tag">BOT</span>
                            <span class="pk-time">${msg.time}</span>
                        </div>
                        <div class="pk-text">${msg.text}</div>
                    </div>
                </div>
            `;
        });
        feed.scrollTop = feed.scrollHeight;
    }

    function sendMsg() {
        const txt = document.getElementById('chat-input').value;
        if(!txt) return;

        const u = DB.profiles[DB.activeIdx];
        
        // PLURALKIT LOGIC: We capture the data NOW and freeze it
        const msgData = {
            name: u.name,
            avatar: u.avatar,
            color: u.color,
            text: txt,
            time: new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})
        };

        DB.channels[DB.currentChan].msgs.push(msgData);
        document.getElementById('chat-input').value = "";
        save();
        renderChat();
    }

    // --- DIARY LOGIC ---
    function postDiary() {
        const txt = document.getElementById('diary-in').value;
        if(!txt) return;

        const u = DB.profiles[DB.activeIdx];
        DB.diary.unshift({
            name: u.name,
            text: txt,
            date: new Date().toLocaleString()
        });
        document.getElementById('diary-in').value = "";
        save(); renderDiary();
    }

    function renderDiary() {
        const div = document.getElementById('diary-feed');
        div.innerHTML = "";
        DB.diary.forEach(entry => {
            div.innerHTML += `
                <div style="background:white; padding:15px; border-radius:10px; margin-bottom:10px; border-left:4px solid var(--main); box-shadow:0 2px 5px rgba(0,0,0,0.05);">
                    <div style="font-size:0.7rem; color:#999; display:flex; justify-content:space-between;">
                        <b>${entry.name}</b>
                        <span>${entry.date}</span>
                    </div>
                    <div style="margin-top:5px; white-space:pre-wrap;">${entry.text}</div>
                </div>
            `;
        });
    }

    // --- NAVIGATION & MODALS ---
    function go(page, btn) {
        document.querySelectorAll('.page').forEach(el => el.style.display = 'none');
        document.querySelectorAll('.nav-btn').forEach(el => el.classList.remove('active'));
        
        if(page === 'bbs') {
            document.getElementById('tab-bbs').style.display = 'flex'; // Flex for sidebar layout
        } else {
            document.getElementById('tab-' + page).style.display = 'block';
        }
        
        btn.classList.add('active');
        if(page === 'diary') renderDiary();
    }

    function closeModals() {
        document.querySelectorAll('.modal-overlay').forEach(el => el.style.display = 'none');
    }

</script>

</body>
</html>
