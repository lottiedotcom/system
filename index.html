<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#ff69b4">
    <title>Seiren OS</title>
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/2919/2919573.png">
    <link rel="icon" type="image/png" href="https://cdn-icons-png.flaticon.com/512/2919/2919573.png">

    <style>
        :root { --main: #ff69b4; --bg-light: #ffe4e1; --bg-dark: #ffb7b2; --dark: #d12e87; --glass: rgba(255, 255, 255, 0.95); --text: #555; --blue: #4fc3f7; }
        ::-webkit-scrollbar { width: 12px; }
        ::-webkit-scrollbar-track { background: #e0e0e0; border-left: 1px solid #ccc; }
        ::-webkit-scrollbar-thumb { background: #ff69b4; border: 2px outset #ff9eb5; }
        
        body {
            font-family: 'Verdana', 'Tahoma', sans-serif;
            background-color: var(--bg-light);
            background-image: radial-gradient(var(--bg-dark) 15%, transparent 16%), radial-gradient(var(--bg-dark) 15%, transparent 16%);
            background-size: 20px 20px; background-position: 0 0, 10px 10px;
            margin: 0; display: flex; justify-content: center; height: 100vh; overflow: hidden;
            color: var(--text); overscroll-behavior: none;
        }

        .dream-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 9998;
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.65' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)' opacity='0.05'/%3E%3C/svg%3E");
            opacity: 0.5; mix-blend-mode: overlay;
        }

        #welcome-layer {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: linear-gradient(135deg, var(--bg-light) 0%, #ffffff 100%);
            z-index: 20000; display: flex; flex-direction: column; align-items: center; justify-content: center;
            transition: opacity 0.5s ease-out;
        }
        .welcome-card {
            background: rgba(255,255,255,0.9); padding: 40px; border-radius: 40px;
            box-shadow: 0 10px 40px rgba(255, 105, 180, 0.3); text-align: center;
            width: 80%; max-width: 320px; border: 4px ridge white;
        }
        .enter-btn {
            background: #ff69b4; color: white; border: 3px outset #ffb7b2; padding: 15px 0; width: 100%;
            border-radius: 50px; font-size: 1.2rem; font-weight: bold; cursor: pointer; 
            box-shadow: 2px 2px 5px rgba(0,0,0,0.1); 
        }
        .enter-btn:active { transform: scale(0.98); border-style: inset; }

        .app-shell { width: 100%; max-width: 480px; background: var(--glass); display: none; flex-direction: column; position: relative; height: 100%; z-index: 10; }
        .status-bar { display: flex; justify-content: space-between; padding: 10px 15px; font-size: 0.7rem; font-weight: bold; color: var(--dark); background: rgba(255,255,255,0.8); border-bottom: 2px solid white; }
        .lvl-badge { position: fixed; top: 50px; left: 10px; z-index: 50; background: white; border: 2px outset #ff69b4; border-radius: 50%; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; box-shadow: 2px 2px 5px rgba(0,0,0,0.1); }
        .marquee-container { background: var(--main); color: white; padding: 6px 0; white-space: nowrap; overflow: hidden; border-bottom: 2px solid white; border-top: 2px solid white; }
        .marquee-text { display: inline-block; padding-left: 100%; animation: marquee 15s linear infinite; font-size: 0.7rem; font-weight:bold; }
        @keyframes marquee { 0% { transform: translate(0, 0); } 100% { transform: translate(-100%, 0); } }

        .content { flex: 1; overflow-y: auto; overflow-x: hidden; padding: 20px; padding-bottom: 120px; }
        .page { display: none; animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .page.active { display: block; }
        @keyframes popIn { from {opacity:0; transform:scale(0.98);} to {opacity:1; transform:scale(1);} }

        /* UI ELEMENTS */
        .dash-header { text-align: center; margin-bottom: 20px; }
        .xp-box { background: white; padding: 10px; border-radius: 12px; margin-bottom: 15px; border: 2px inset var(--blue); text-align: center; }
        .xp-track { height: 8px; background: #eee; border-radius: 4px; margin-top: 5px; overflow: hidden; border: 1px inset #ccc; }
        .xp-fill { height: 100%; background: repeating-linear-gradient(45deg, var(--blue), var(--blue) 5px, #87cefa 5px, #87cefa 10px); width: 0%; transition: width 0.5s; }
        
        .id-card-wrap { background: white; border: 4px ridge var(--main); border-radius: 20px; padding: 5px; box-shadow: 3px 3px 0 #ffb7b2; margin-bottom: 20px; position: relative; overflow: hidden; }
        .id-inner { background: var(--bg-light); background-image: radial-gradient(var(--bg-dark) 2px, transparent 2px); background-size: 15px 15px; border: 2px dashed var(--dark); border-radius: 15px; padding: 15px; }
        .id-top { display: flex; justify-content: space-between; border-bottom: 2px solid var(--main); padding-bottom: 5px; margin-bottom: 10px; }
        .id-body { display: flex; gap: 10px; align-items: center; }
        .id-photo { width: 80px; height: 80px; border-radius: 50%; border: 3px outset white; outline: 3px solid var(--main); object-fit: cover; background: white; }
        .id-data { flex: 1; }
        .id-stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 4px; font-size: 0.65rem; background: rgba(255,255,255,0.8); padding: 5px; border-radius: 5px; margin-top:5px; border: 1px inset white; }
        .signature { font-family: 'Brush Script MT', cursive; font-size: 1.2rem; color: var(--blue); transform: rotate(-5deg); display: inline-block; margin-right: 10px; }

        .dash-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-bottom: 20px; }
        .dash-btn { background: white; border-radius: 15px; padding: 10px 5px; text-align: center; box-shadow: 2px 2px 5px rgba(0,0,0,0.05); border: 2px outset #eee; }
        .dash-btn:active { transform: scale(0.95); border-style: inset; }
        .dash-icon { font-size: 1.5rem; display: block; margin-bottom: 3px; }
        .dash-label { font-size: 0.7rem; font-weight: bold; color: var(--text); }

        .fortune-stage { perspective: 1000px; width: 140px; height: 200px; margin: 0 auto; cursor: pointer; }
        .card-wrapper { width: 100%; height: 100%; position: relative; transform-style: preserve-3d; transition: transform 0.8s; }
        .card-wrapper.flipped { transform: rotateY(180deg); }
        .card-face { position: absolute; width: 100%; height: 100%; backface-visibility: hidden; border-radius: 12px; display: flex; flex-direction: column; align-items: center; justify-content: center; box-shadow: 0 5px 15px rgba(0,0,0,0.15); border: 4px solid white; }
        .card-front { background: repeating-linear-gradient(45deg, var(--main), var(--main) 10px, #ffb7b2 10px, #ffb7b2 20px); }
        .card-back { background: white; transform: rotateY(180deg); padding: 10px; text-align: center; border: 2px solid var(--main); }
        .new-day-btn { background: #4fc3f7; color: white; border: 2px outset #81d4fa; padding: 8px 15px; border-radius: 20px; font-size: 0.8rem; margin-top: 15px; }

        .pet-box { background: white; border: 3px ridge var(--main); border-radius: 20px; padding: 20px; text-align: center; margin-bottom: 20px; position:relative; }
        .pet-hat { position: absolute; top: 55px; left: 50%; transform: translateX(-50%); font-size: 4rem; z-index: 10; pointer-events: none; }
        .acc-head { top: 35px; } .acc-mask { top: 60px; } .acc-side { top: unset; bottom: 20px; right: 20px; left: unset; }
        .ebi-img { width: 140px; margin-top:10px; }
        
        .gacha-btn { background: #f8f8f8; border: 2px outset #ddd; padding: 10px; border-radius: 10px; width: 30%; }
        .inventory-grid { display: flex; flex-wrap: wrap; gap: 5px; justify-content: center; margin-top: 10px; background: #f0f0f0; padding: 10px; border: 2px inset #ccc; border-radius: 10px; }
        .inv-item { font-size: 1.5rem; padding: 8px; border: 1px solid #ddd; background: white; border-radius: 5px; }

        .diary-box { background: white; border-radius: 15px; padding: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        .mood-bar { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-bottom: 15px; }
        .mood-btn { font-size: 1.5rem; background: #f0f0f0; border-radius: 15px; height: 40px; border: 2px outset #eee; display:flex; align-items:center; justify-content:center; }
        .mood-btn.selected { border-color: var(--main); background: var(--bg-light); border-style: inset; }
        
        .quick-mood-board { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin-top: 10px; }
        .qm-btn { background: white; border: 2px solid var(--main); border-radius: 10px; padding: 10px; font-size: 1.2rem; }
        .receipt-log { font-family: 'Courier New', monospace; font-size: 0.7rem; background: #fff; padding: 10px; border: 1px dashed #ccc; margin-top: 10px; min-height: 50px; }

        .modal-overlay { position: fixed; top:0; left:0; right:0; bottom:0; background: rgba(0,0,0,0.6); z-index: 2000; display: none; align-items: center; justify-content: center; backdrop-filter: blur(2px); }
        .modal-box { background: white; width: 85%; max-width: 400px; border-radius: 25px; border: 4px ridge var(--main); padding: 20px; max-height: 80vh; overflow-y: auto; animation: popIn 0.3s; }
        .slot-card { background: #fdf2f8; border: 2px outset #eee; border-radius: 12px; padding: 10px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center; }
        
        nav { position: fixed; bottom: 35px; left: 20px; right: 20px; background: rgba(255,255,255,0.95); border-radius: 40px; display: flex; justify-content: space-around; padding: 15px 0; box-shadow: 0 5px 20px rgba(0,0,0,0.1); z-index: 100; border: 2px solid white; }
        .nav-btn { background: none; border: none; color: #ccc; font-size: 1.4rem; display: flex; flex-direction:column; align-items: center; }
        .nav-btn.active { color: var(--main); transform: scale(1.1); }
        .save-ribbon { position: fixed; bottom: 0; left: 0; right: 0; height: 25px; background: #d12e87; color: white; font-size: 0.7rem; display: flex; align-items: center; justify-content: center; z-index: 200; border-top: 2px solid white; font-weight: bold; }
        
        /* WALLPAPER CLASSES */
        .bg-hearts { background-color: #ffe4e1 !important; background-image: radial-gradient(#ff69b4 2px, transparent 2px), radial-gradient(#ff69b4 2px, transparent 2px) !important; background-size: 20px 20px !important; background-position: 0 0, 10px 10px !important; }
        .bg-dots-blue { background-color: #e0f7fa !important; background-image: radial-gradient(#4fc3f7 2px, transparent 2px) !important; background-size: 15px 15px !important; }
        .bg-check-green { background-color: #f1f8e9 !important; background-image: repeating-linear-gradient(45deg, #c5e1a5 25%, transparent 25%, transparent 75%, #c5e1a5 75%, #c5e1a5), repeating-linear-gradient(45deg, #c5e1a5 25%, #f1f8e9 25%, #f1f8e9 75%, #c5e1a5 75%, #c5e1a5) !important; background-size: 20px 20px !important; }
        .bg-clouds { background-color: #e3f2fd !important; background-image: radial-gradient(white 8px, transparent 9px), radial-gradient(white 8px, transparent 9px) !important; background-size: 40px 40px !important; background-position: 0 0, 20px 20px !important; }
        
        .toast { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background: rgba(255, 105, 180, 0.9); color: white; padding: 10px 20px; border-radius: 20px; font-size: 0.8rem; opacity: 0; transition: 0.3s; z-index: 20001; font-weight:bold; pointer-events: none; }
        .toast.show { opacity: 1; top: 30px; }
        
        input { width: 100%; padding: 10px; margin-bottom: 5px; border: 2px inset #ccc; border-radius: 10px; }
        .btn-main { background: var(--main); color: white; padding: 10px; border: 2px outset #ff9eb5; border-radius: 20px; width: 100%; font-weight: bold; }
    </style>
</head>
<body>

<div class="dream-overlay"></div>
<div id="toast" class="toast">üíæ Saved!</div>

<div id="welcome-layer">
    <div class="welcome-card">
        <div style="font-size:4rem; margin-bottom:10px;">üéÄ</div>
        <h1 style="color:#d12e87; margin-bottom:20px;">SEIREN</h1>
        <button class="enter-btn" onclick="startApp()">ENTER WORLD<br>‚ô°</button>
    </div>
</div>

<div class="app-shell" id="main-app">
    <div id="lvl-badge" class="lvl-badge">üå±</div>
    <div class="status-bar"><span id="clock">12:00</span><span>üîã 100%</span></div>
    <div class="marquee-container"><div class="marquee-text">‚òÖ SYSTEM ONLINE ‚òÖ WELCOME HOME ‚òÖ EBI IS HUNGRY ‚òÖ MAKE A WISH ‚òÖ GIRLS BRAVO FOREVER ‚òÖ</div></div>

    <div class="content">
        <div id="tab-dash" class="page active">
            <div id="setup-view" style="text-align:center; padding:30px; display:none;">
                <h2 style="color:var(--main);">New System?</h2>
                <input type="text" id="setup-name" placeholder="Name">
                <input type="number" id="setup-age" placeholder="Age">
                <button class="btn-main" onclick="initFirstProfile()">Create ID</button>
            </div>
            <div id="dash-view" style="display:none;">
                <div class="dash-header">
                    <h2 style="margin:0; color:var(--dark);" id="dash-greet">Hello!</h2>
                    <span style="font-size:0.8rem; color:#888;">System Dashboard</span>
                </div>
                <div class="xp-box">
                    <div style="display:flex; justify-content:space-between; font-size:0.8rem; font-weight:bold; color:var(--blue);">
                        <span>Level <span id="lvl-num">1</span></span><span><span id="xp-val">0</span>/100 XP</span>
                    </div>
                    <div class="xp-track"><div id="xp-bar" class="xp-fill"></div></div>
                    <div style="margin-top:5px; font-size:0.7rem; color:var(--dark);">Credits: ‚Çµ<span id="credit-val">0</span></div>
                </div>
                <div class="id-card-wrap">
                    <div class="id-inner">
                        <div class="deco-bow">üéÄ</div>
                        <div class="id-top"><span style="font-size:0.7rem; font-weight:bold; color:var(--dark);">SEIREN GOV</span></div>
                        <div class="id-body">
                            <img id="id-pic" class="id-photo" src="" onclick="rotateAvatar()">
                            <div class="id-data">
                                <div id="id-name" style="font-size:1.3rem; font-weight:bold; color:var(--dark);">User</div>
                                <div id="id-real" style="font-size:0.7rem; font-style:italic; color:#888;">aka ???</div>
                                <div class="id-stats-grid">
                                    <span><b>ID:</b> <span id="id-num">000</span></span>
                                    <span><b>Sign:</b> <span id="id-sign">?</span></span>
                                    <span><b>Hgt:</b> <span id="id-hgt">?</span></span>
                                    <span><b>Wgt:</b> <span id="id-wgt">?</span></span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="dash-grid">
                    <div class="dash-btn" onclick="openProfileManager()"><span class="dash-icon">üë•</span><span>Switch</span></div>
                    <div class="dash-btn" onclick="openPortal()"><span class="dash-icon">üåÄ</span><span>Portal</span></div>
                    <div class="dash-btn" onclick="openBackpack()"><span class="dash-icon">üéí</span><span>Backpack</span></div>
                </div>
                <div style="text-align:center;">
                    <div class="fortune-stage" onclick="flipFortune()">
                        <div class="card-wrapper" id="fortune-card">
                            <div class="card-face card-front"><span style="font-size:3rem; color:white;">?</span></div>
                            <div class="card-face card-back"><div id="fortune-icon" style="font-size:3rem;">‚≠ê</div><strong id="fortune-title"></strong><p id="fortune-desc"></p></div>
                        </div>
                    </div>
                    <button class="new-day-btn" onclick="resetFortune()">‚Üª New Day</button>
                </div>
            </div>
        </div>

        <div id="tab-bbs" class="page">
            <h2 style="color:var(--main);">System Chat</h2>
            <div class="bbs-container">
                <div class="bbs-messages" id="bbs-feed"></div>
                <div class="bbs-input-area">
                    <input type="text" id="bbs-input" placeholder="Message...">
                    <button class="btn-main" style="width:auto;" onclick="postBBS()">Send</button>
                </div>
            </div>
        </div>

        <div id="tab-wish" class="page">
            <h2 style="color:var(--blue);">Wishlist</h2>
            <div class="corkboard"><div id="wish-list" class="wish-grid"></div></div>
            <button class="fab-btn" onclick="openWishModal()">+</button>
        </div>

        <div id="tab-pet" class="page">
            <div class="pet-box" id="pet-container">
                <div class="pet-acc-container"><div id="ebi-hat" class="pet-hat"></div></div>
                <img id="ebi-pet" src="https://cdn-icons-png.flaticon.com/512/3069/3069172.png" class="ebi-img">
                <h3 style="color:var(--main);">Ebi</h3>
                <div style="background:#eee; height:12px; border-radius:10px; overflow:hidden; margin:10px 0;">
                    <div id="pet-bar" style="width:50%; height:100%; background:var(--main); transition:width 0.5s;"></div>
                </div>
                <div id="ebi-msg" style="font-size:0.7rem; color:#888;">Do tasks to feed me!</div>
            </div>
            <strong>To Do List</strong>
            <div style="display:flex; gap:5px; margin-bottom:10px;">
                <input type="text" id="task-in" placeholder="Task...">
                <button class="btn-main" style="width:auto;" onclick="addTask()">+</button>
            </div>
            <div id="task-list"></div>
            
            <div style="margin-top:20px; border-top:2px dashed #ccc; padding-top:10px;">
                <strong>Quick Mood Check</strong>
                <div class="quick-mood-board">
                    <button class="qm-btn" onclick="logMoodQuick('üòä')">üòä</button>
                    <button class="qm-btn" onclick="logMoodQuick('üò¢')">üò¢</button>
                    <button class="qm-btn" onclick="logMoodQuick('üò°')">üò°</button>
                    <button class="qm-btn" onclick="logMoodQuick('üíñ')">üíñ</button>
                    <button class="qm-btn" onclick="logMoodQuick('üí§')">üí§</button>
                    <button class="qm-btn" onclick="logMoodQuick('üåÄ')">üåÄ</button>
                    <button class="qm-btn" onclick="logMoodQuick('üíÄ')">üíÄ</button>
                    <button class="qm-btn" onclick="logMoodQuick('‚ú®')">‚ú®</button>
                </div>
                <div id="receipt-log" class="receipt-log">*** RECEIPT ***</div>
            </div>
        </div>

        <div id="tab-diary" class="page">
            <h2 style="color:var(--main);">Secret Diary</h2>
            <div class="diary-box">
                <textarea id="diary-in" style="width:100%; height:80px; padding:10px;" placeholder="Write something..."></textarea>
                <button class="btn-main" onclick="postDiary()">Save Entry</button>
            </div>
            <div id="diary-feed" style="margin-top:20px;"></div>
        </div>
    </div>

    <div class="save-ribbon">‚ô° REMEMBER TO SAVE BEFORE LEAVING ‚ô°</div>

    <div id="modal-profiles" class="modal-overlay">
        <div class="modal-box">
            <h3>Select Fronter</h3>
            <div id="profile-list"></div>
            <div style="border-top:2px dashed #eee; padding-top:10px; margin-top:10px;">
                <input type="text" id="new-p-name" placeholder="Name">
                <input type="number" id="new-p-age" placeholder="Age">
                <input type="color" id="new-p-color" value="#ff69b4" style="width:100%;">
                <button class="btn-main" onclick="addProfile()">Create</button>
            </div>
            <button class="btn-main" style="background:#ccc; margin-top:10px;" onclick="closeModals()">Close</button>
        </div>
    </div>

    <div id="modal-backpack" class="modal-overlay">
        <div class="modal-box">
            <h3>üéí Backpack</h3>
            <div style="background:#f9f9f9; padding:10px; border-radius:10px; margin-bottom:10px;">
                <div style="font-weight:bold;">Gacha (50 ‚Çµ)</div>
                <div class="gacha-btn-group">
                    <button class="gacha-btn" onclick="playGacha('cute')">üéÄ</button>
                    <button class="gacha-btn" onclick="playGacha('dark')">üï∏Ô∏è</button>
                    <button class="gacha-btn" onclick="playGacha('nature')">üçÑ</button>
                    <button class="gacha-btn" onclick="playGacha('decor')">üñºÔ∏è</button>
                </div>
            </div>
            <div id="inv-grid" class="inventory-grid"><span class="inv-item" onclick="setHat('')">‚ùå</span></div>
            <button class="btn-main" style="background:#ccc; margin-top:10px;" onclick="closeModals()">Close</button>
        </div>
    </div>

    <div id="modal-portal" class="modal-overlay">
        <div class="modal-box">
            <h3>üåÄ Portal</h3>
            <div id="link-list"></div>
            <a href="https://www.quotev.com/quiz/17122879/who-am-I-pt-2" target="_blank" class="btn-main" style="display:block; text-align:center; text-decoration:none; margin-bottom:10px;">‚ú® QUIZ</a>
            <input type="text" id="link-name" placeholder="Title">
            <input type="text" id="link-url" placeholder="URL">
            <button class="btn-main" onclick="addLink()">Add Link</button>
            <button class="btn-main" style="background:#555; margin-top:10px;" onclick="exportData()">üíæ Copy Save</button>
            <button class="btn-main" style="background:#999; margin-top:5px;" onclick="importData()">üìÇ Import Save</button>
            <button class="btn-main" style="background:#ccc; margin-top:10px;" onclick="closeModals()">Close</button>
        </div>
    </div>

    <div id="modal-wish" class="modal-overlay">
        <div class="modal-box">
            <h3>New Wish</h3>
            <input type="text" id="w-name" placeholder="Item Name">
            <input type="text" id="w-img" placeholder="Image Link">
            <button class="btn-main" onclick="submitWish()">Pin It</button>
            <button class="btn-main" style="background:#ccc; margin-top:10px;" onclick="closeModals()">Close</button>
        </div>
    </div>

    <nav>
        <button class="nav-btn active" onclick="go('home', this)"><span>üè†</span><span>Home</span></button>
        <button class="nav-btn" onclick="go('bbs', this)"><span>üí¨</span><span>Chat</span></button>
        <button class="nav-btn" onclick="go('wish', this)"><span>üìå</span><span>Wish</span></button>
        <button class="nav-btn" onclick="go('pet', this)"><span>üç§</span><span>Tools</span></button>
        <button class="nav-btn" onclick="go('diary', this)"><span>üìì</span><span>Diary</span></button>
    </nav>
</div>

<script>
    // --- STABLE AVATARS (PROVIDED) ---
    const AVATARS = [
        "https://i.postimg.cc/Wb1dxKCd/Images_D2FB0W0F.webp",
        "https://i.postimg.cc/QxdFvPwK/girlsbravo_tomoka_manga.jpg",
        "https://i.postimg.cc/bNwZ4MWn/girlsbravo_maharu_manga.jpg",
        "https://i.postimg.cc/28S1gJMq/girlsbravo_koyomi_manga.jpg",
        "https://i.postimg.cc/YqCvTVZR/Girls_Bravo_Koyomi_Hare_Nanaka.webp",
        "https://i.postimg.cc/5N2XDGTw/Girls_Bravo_Kosame.webp",
        "https://i.postimg.cc/J7qy6m6H/ee755c95_ea8f_4a26_bdfd_fbaff3669802.jpg",
        "https://i.postimg.cc/wTj1nPZQ/Cd480afa91.webp",
        "https://i.postimg.cc/rFwD7b39/Cc8a9456a3.webp",
        "https://i.postimg.cc/X7YrthmQ/Ac83513f62.webp",
        "https://i.postimg.cc/5N2XDGTP/9180_710547588.jpg"
    ];

    const BADGES = ["üå±","üê£","üéÄ","‚≠ê","üå∏","üçÑ","üíé","üëë","üßö‚Äç‚ôÄÔ∏è","üè∞","ü™ê"];
    const GACHA = {
        cute: ["üéÄ","üëë","ü©∞","üßÅ","üß∏","üíñ","üçì","üç≠"],
        dark: ["üï∏Ô∏è","üï∑Ô∏è","üíÄ","ü•Ä","üñ§","ü¶á","üó°Ô∏è","‚õìÔ∏è"],
        nature: ["üçÑ","üå±","üåµ","üå∏","üåª","üê∏","üçÉ","ü™µ"],
        decor: ["bg-hearts", "bg-dots-blue", "bg-check-green", "bg-clouds"] 
    };
    const FORTUNES = [
        {i:"üçû",t:"Toast Dash",d:"Running late!"},{i:"üåü",t:"Super Star",d:"Main character energy."},{i:"üíñ",t:"Doki Doki",d:"Love is in the air."},{i:"üéÆ",t:"Gamer",d:"High score incoming."},{i:"üõÅ",t:"Bath Portal",d:"Bring a towel."},{i:"ü§ß",t:"Sneeze",d:"Someone is talking about you."},{i:"üçõ",t:"Curry",d:"Spicy power."},{i:"ü©∏",t:"Nosebleed",d:"Too cute."},{i:"üíª",t:"Blue Screen",d:"Crash imminent."},{i:"üìß",t:"Mail",d:"Check inbox."}
    ];

    let DB = { profiles: [], activeIdx: 0, xp: 0, credits: 0, lvl: 1, wish: [], pet: {hunger:50, tasks:[], lastTask: Date.now()}, inventory: [], bbs: [], frontLog: [], diary: [], links: [], fortune: {date:'',i:'',t:'',d:''}, wallpaper: "" };
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

    // --- MAIN APP ENTRY ---
    function startApp() {
        // Resume Audio
        if(audioCtx.state === 'suspended') audioCtx.resume();
        
        // Hide Welcome / Show App
        document.getElementById('welcome-layer').style.opacity = '0';
        setTimeout(() => {
            document.getElementById('welcome-layer').style.display = 'none';
            document.getElementById('main-app').style.display = 'flex';
            setTimeout(() => {
                document.getElementById('main-app').style.opacity = '1';
                loadData();
            }, 50);
        }, 500);
    }

    function loadData() {
        const saved = localStorage.getItem('seiren_v50');
        if(saved) DB = JSON.parse(saved);
        // Migration check
        if(DB.profiles.length === 0) {
            const old = JSON.parse(localStorage.getItem('seiren_v49') || localStorage.getItem('seiren_v48'));
            if(old) { DB = old; save(); }
        }
        
        // Render Correct View
        if(DB.profiles.length > 0) {
            applyTheme(DB.profiles[DB.activeIdx]);
            document.getElementById('dash-view').style.display = 'block';
            refreshUI(); checkFortune();
        } else {
            document.getElementById('setup-view').style.display = 'block';
        }
    }

    function save() {
        localStorage.setItem('seiren_v50', JSON.stringify(DB));
        const t = document.getElementById('toast');
        t.classList.add('show');
        setTimeout(() => t.classList.remove('show'), 1000);
    }

    // --- GENERATOR & PROFILES ---
    function genID(name, age, color) {
        return {
            name: name + "-chan", realName: name, age: age, color: color,
            id: Math.floor(Math.random()*9000)+1000,
            sign: ["Alien","Maid","Neko","Usagi","Ghost"][Math.floor(Math.random()*5)],
            wgt: "3 Peaches", hgt: "Tiny",
            av: Math.min(DB.lvl, AVATARS.length-1), hat: ""
        };
    }

    function initFirstProfile() {
        const n = document.getElementById('setup-name').value;
        const a = document.getElementById('setup-age').value;
        if(!n) return;
        DB.profiles.push(genID(n, a, "#ff69b4"));
        DB.activeIdx = 0;
        save();
        document.getElementById('setup-view').style.display='none';
        document.getElementById('dash-view').style.display='block';
        refreshUI();
    }

    function refreshUI() {
        const u = DB.profiles[DB.activeIdx];
        if(u) {
            document.getElementById('dash-greet').innerText = `Hello, ${u.realName}`;
            document.getElementById('id-name').innerText = u.name;
            document.getElementById('id-real').innerText = `aka ${u.realName}`;
            document.getElementById('id-num').innerText = u.id;
            document.getElementById('id-sign').innerText = u.sign;
            document.getElementById('id-hgt').innerText = u.hgt;
            document.getElementById('id-wgt').innerText = u.wgt;
            document.getElementById('id-pic').src = AVATARS[(u.av||0) % AVATARS.length];
            
            // SMART HAT LOGIC
            const el = document.getElementById('ebi-hat');
            el.innerText = u.hat || "";
            el.className = getAccType(u.hat || "");
        }
        
        document.getElementById('pet-container').className = `pet-box ${DB.wallpaper || ''}`;
        document.getElementById('lvl-badge').innerText = BADGES[Math.min(DB.lvl-1, BADGES.length-1)];
        document.getElementById('lvl-num').innerText = DB.lvl;
        document.getElementById('xp-val').innerText = DB.xp;
        document.getElementById('xp-bar').style.width = DB.xp + "%";
        document.getElementById('credit-val').innerText = DB.credits;

        // INVENTORY
        const invGrid = document.getElementById('inv-grid');
        while(invGrid.children.length > 1) { invGrid.removeChild(invGrid.lastChild); }
        DB.inventory.forEach(item => {
            const span = document.createElement('span');
            span.className = 'inv-item';
            span.innerText = item.startsWith('bg-') ? 'üñºÔ∏è' : item;
            span.onclick = () => { item.startsWith('bg-') ? setWallpaper(item) : setHat(item); };
            invGrid.appendChild(span);
        });

        // TASKS
        const tList = document.getElementById('task-list'); tList.innerHTML="";
        DB.pet.tasks.forEach((t,i)=> tList.innerHTML+=`<div class="task-item"><span>${t}</span><input type="checkbox" onclick="doTask(${i})"></div>`);
        
        // DIARY
        const df = document.getElementById('diary-feed'); df.innerHTML="";
        DB.diary.forEach(e => df.innerHTML+=`<div style="background:white;padding:10px;margin-bottom:5px;border-bottom:1px solid #eee;">${e.t}</div>`);
    }

    // --- GAMEPLAY ---
    function addXP(n) {
        DB.xp += n; DB.credits += n;
        if(DB.xp >= 100) { DB.xp -= 100; DB.lvl++; playSnd('chime'); alert("LEVEL UP!"); }
        save(); refreshUI();
    }

    function doTask(i) {
        DB.pet.tasks.splice(i,1);
        DB.pet.lastTask = Date.now();
        triggerFeedReward();
        addXP(10);
    }

    function triggerFeedReward() {
        if(DB.pet.hunger < 100) {
            DB.pet.hunger += 10;
            document.getElementById('ebi-msg').innerText = "Yummy! üç§";
            const pet = document.getElementById('ebi-pet');
            pet.classList.remove('bounce'); void pet.offsetWidth; pet.classList.add('bounce');
            playSnd('chime');
        }
        save(); refreshUI();
    }

    function logMoodQuick(m) {
        playSnd('print');
        addXP(10);
        const receipt = document.getElementById('receipt-log');
        const line = document.createElement('div');
        line.innerText = `${m}.............1.....+10‚Çµ`;
        receipt.appendChild(line);
        receipt.scrollTop = receipt.scrollHeight;
    }

    function playGacha(type) {
        if(DB.credits < 50) { alert("Need 50 Credits!"); return; }
        DB.credits -= 50; playSnd('chime');
        const pool = GACHA[type];
        const item = pool[Math.floor(Math.random()*pool.length)];
        if(!DB.inventory.includes(item)) { DB.inventory.push(item); alert(`Got: ${item}!`); }
        else { DB.credits += 10; alert(`Duplicate ${item}. +10‚Çµ returned.`); }
        save(); refreshUI();
    }

    function setHat(h) { DB.profiles[DB.activeIdx].hat = h; playSnd('bloop'); save(); refreshUI(); }
    function setWallpaper(w) { DB.wallpaper = w; playSnd('bloop'); save(); refreshUI(); }
    
    function getAccType(item) {
        const heads = ["üéÄ","üëë","üß¢","üå∏","üå±","üçÉ","üï∏Ô∏è","üé©","ü•Ä"];
        const masks = ["üê∏","üï∂Ô∏è","üëì","üë∫","ü§°"];
        if(heads.includes(item)) return "pet-hat acc-head";
        if(masks.includes(item)) return "pet-hat acc-mask";
        return "pet-hat acc-side";
    }

    // --- STANDARD FUNCTIONS ---
    function addTask() { const v=document.getElementById('task-in').value; if(v){DB.pet.tasks.push(v); document.getElementById('task-in').value=""; save(); refreshUI();} }
    function postDiary() { const v=document.getElementById('diary-in').value; if(v){DB.diary.unshift({t:v}); document.getElementById('diary-in').value=""; addXP(15); triggerFeedReward();} }
    
    function rotateAvatar() {
        const u = DB.profiles[DB.activeIdx];
        if(u.av + 1 > Math.min(DB.lvl, AVATARS.length-1)) u.av = 0; else u.av++;
        save(); refreshUI();
    }

    function openProfileManager() { 
        const list = document.getElementById('profile-list'); list.innerHTML="";
        DB.profiles.forEach((p,i) => {
            list.innerHTML += `<div class="slot-card" onclick="swap(${i})">${p.name} (Switch)</div>`;
        });
        document.getElementById('modal-profiles').style.display='flex'; 
    }
    function swap(i) { DB.activeIdx = i; applyTheme(DB.profiles[i]); closeModals(); refreshUI(); addXP(10); }
    function applyTheme(u) { document.documentElement.style.setProperty('--main', u.color || '#ff69b4'); }

    // --- SOUND ENGINE ---
    function playSnd(type) {
        if(audioCtx.state === 'suspended') audioCtx.resume();
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.connect(gain); gain.connect(audioCtx.destination);

        if(type === 'print') {
            // White Noise for Receipt
            const bufferSize = audioCtx.sampleRate * 0.1;
            const buffer = audioCtx.createBuffer(1, bufferSize, audioCtx.sampleRate);
            const data = buffer.getChannelData(0);
            for(let i=0; i<bufferSize; i++) data[i] = Math.random()*2-1;
            const noise = audioCtx.createBufferSource();
            noise.buffer = buffer; noise.connect(gain);
            gain.gain.setValueAtTime(0.5, audioCtx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime+0.1);
            noise.start();
        } else {
            // Tones
            osc.type = type==='chime'?'sine':'triangle';
            osc.frequency.setValueAtTime(type==='chime'?1200:400, audioCtx.currentTime);
            gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime+0.2);
            osc.start(); osc.stop(audioCtx.currentTime+0.2);
        }
    }

    // --- NAV & UTILS ---
    function go(id, btn) {
        playSnd('bloop');
        document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
        document.getElementById('tab-'+(id==='home'?'dash':id)).classList.add('active');
        document.querySelectorAll('.nav-btn').forEach(b=>b.classList.remove('active'));
        btn.classList.add('active');
    }
    
    function closeModals() { document.querySelectorAll('.modal-overlay').forEach(m=>m.style.display='none'); }
    function openBackpack() { document.getElementById('modal-backpack').style.display='flex'; refreshUI(); }
    function openPortal() { document.getElementById('modal-portal').style.display='flex'; }
    function openWishModal() { document.getElementById('modal-wish').style.display='flex'; }
    
    // --- FORTUNE ---
    function checkFortune() {
        if(DB.fortune.date === new Date().toDateString()) document.getElementById('fortune-card').classList.add('flipped');
        renderFortune(DB.fortune);
    }
    function flipFortune() {
        if(DB.fortune.date === new Date().toDateString()) return;
        const f = FORTUNES[Math.floor(Math.random()*FORTUNES.length)];
        DB.fortune = {date:new Date().toDateString(), ...f};
        save(); renderFortune(DB.fortune);
        document.getElementById('fortune-card').classList.add('flipped');
        addXP(50);
    }
    function renderFortune(f) {
        if(!f.i) return;
        document.getElementById('fortune-icon').innerText = f.i;
        document.getElementById('fortune-title').innerText = f.t;
        document.getElementById('fortune-desc').innerText = f.d;
    }
    function resetFortune() { if(confirm("Reset?")) { DB.fortune={date:''}; save(); document.getElementById('fortune-card').classList.remove('flipped'); } }

    if('serviceWorker' in navigator) navigator.serviceWorker.register('./sw.js');
</script>
</body>
</html>
