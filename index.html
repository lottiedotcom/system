<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#ff69b4">
    <title>OS</title>
    
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/2919/2919573.png">
    <link rel="icon" type="image/png" href="https://cdn-icons-png.flaticon.com/512/2919/2919573.png">

    <style>
        /* --- THEME VARIABLES --- */
        :root {
            --main: #ff69b4;
            --bg-light: #ffe4e1;
            --bg-dark: #ffb7b2;
            --dark: #d12e87;
            --glass: rgba(255, 255, 255, 0.95);
            --text: #555;
            --blue: #4fc3f7;
        }

        /* 2004 SCROLLBAR */
        ::-webkit-scrollbar { width: 12px; }
        ::-webkit-scrollbar-track { background: #e0e0e0; border-left: 1px solid #ccc; }
        ::-webkit-scrollbar-thumb { background: #ff69b4; border: 2px outset #ff9eb5; }

        body {
            font-family: 'Verdana', 'Tahoma', sans-serif;
            background-color: var(--bg-light);
            background-image: 
                radial-gradient(var(--bg-dark) 15%, transparent 16%),
                radial-gradient(var(--bg-dark) 15%, transparent 16%);
            background-size: 20px 20px;
            background-position: 0 0, 10px 10px;
            margin: 0; display: flex; justify-content: center; height: 100vh; overflow: hidden;
            color: var(--text); overscroll-behavior: none;
            user-select: none; -webkit-user-select: none;
        }

        /* --- VISUAL EFFECTS --- */
        .dream-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; z-index: 9998;
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.65' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)' opacity='0.05'/%3E%3C/svg%3E");
            opacity: 0.5; backdrop-filter: blur(0.5px); mix-blend-mode: overlay;
        }
        .scanlines {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: linear-gradient(to bottom, rgba(255,255,255,0) 50%, rgba(0,0,0,0.1) 50%);
            background-size: 100% 4px; pointer-events: none; z-index: 9999;
            opacity: 0.6; animation: scanMove 60s linear infinite;
        }
        @keyframes scanMove { 0% { background-position: 0 0; } 100% { background-position: 0 100%; } }

        /* --- LAYERS --- */
        #welcome-layer {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: linear-gradient(135deg, var(--bg-light) 0%, #ffffff 100%);
            z-index: 10002; display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            transition: opacity 0.5s ease-out;
        }
        #lock-screen {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: var(--main); z-index: 10001;
            display: none; flex-direction: column; align-items: center; justify-content: center;
            color: white; transition: transform 0.3s ease-in-out;
        }
        .app-shell {
            width: 100%; max-width: 480px; background: var(--glass);
            display: none; flex-direction: column; position: relative; height: 100%;
            box-shadow: 0 0 50px rgba(0,0,0,0.1); z-index: 10;
        }

        /* --- WELCOME CARD --- */
        .welcome-card {
            background: rgba(255,255,255,0.9); padding: 40px; border-radius: 40px;
            box-shadow: 0 10px 40px rgba(255, 105, 180, 0.3); text-align: center; 
            backdrop-filter: blur(5px); width: 80%; max-width: 320px; border: 4px ridge white;
        }
        .enter-btn {
            background: #ff69b4; color: white; border: 3px outset #ffb7b2; padding: 15px 0; width: 100%;
            border-radius: 50px; font-size: 1.2rem; font-weight: bold; cursor: pointer; 
            box-shadow: 2px 2px 5px rgba(0,0,0,0.1); transition: transform 0.1s; letter-spacing: 1px;
        }
        .enter-btn:active { transform: scale(0.98); border-style: inset; }

        /* --- PIN PAD --- */
        .pin-pad { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-top: 20px; }
        .pin-btn {
            width: 60px; height: 60px; border-radius: 50%; border: 2px solid white;
            background: rgba(255,255,255,0.2); color: white; font-size: 1.5rem;
            display: flex; align-items: center; justify-content: center; cursor: pointer;
        }
        .pin-btn:active { background: white; color: var(--main); }
        .pin-display { 
            width: 200px; height: 40px; background: rgba(0,0,0,0.2); 
            border-radius: 10px; margin-bottom: 20px; display: flex; 
            align-items: center; justify-content: center; letter-spacing: 10px; font-size: 2rem;
        }

        /* --- MAIN UI --- */
        .status-bar { display: flex; justify-content: space-between; padding: 10px 15px; font-size: 0.7rem; font-weight: bold; color: var(--dark); background: rgba(255,255,255,0.8); border-bottom: 2px solid white; }
        
        .content { flex: 1; overflow-y: auto; overflow-x: hidden; padding: 20px; padding-bottom: 120px; scroll-behavior: smooth; }
        .page { display: none; animation: popIn 0.3s; }
        .page.active { display: block; }
        @keyframes popIn { from {opacity:0; transform:scale(0.98);} to {opacity:1; transform:scale(1);} }

        /* DASHBOARD */
        .xp-box { background: white; padding: 10px; border-radius: 12px; margin-bottom: 15px; border: 2px inset var(--blue); text-align: center; }
        .xp-track { height: 8px; background: #eee; border-radius: 4px; margin-top: 5px; overflow: hidden; border: 1px inset #ccc; }
        .xp-fill { height: 100%; background: repeating-linear-gradient(45deg, var(--blue), var(--blue) 5px, #87cefa 5px, #87cefa 10px); width: 0%; transition: width 0.5s; }
        
        .dash-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-bottom: 20px; }
        .dash-btn { background: white; border-radius: 15px; padding: 10px 5px; text-align: center; box-shadow: 2px 2px 5px rgba(0,0,0,0.05); cursor: pointer; border: 2px outset #eee; }
        .dash-icon { font-size: 1.5rem; display: block; margin-bottom: 3px; }
        .dash-label { font-size: 0.7rem; font-weight: bold; color: var(--text); }

        /* CHANNELS (PK STYLE) */
        .discord-layout { display: flex; height: 100%; background: #fff; border: 2px ridge var(--main); border-radius: 15px; overflow: hidden; min-height: 400px; }
        .channel-sidebar { width: 60px; background: #f0f0f0; border-right: 1px solid #ddd; display: flex; flex-direction: column; align-items: center; padding-top: 10px; overflow-y: auto; }
        .channel-bubble { width: 40px; height: 40px; border-radius: 50%; background: #ddd; margin-bottom: 10px; display: flex; align-items: center; justify-content: center; font-size: 0.9rem; cursor: pointer; border: 2px solid transparent; color: #555; font-weight: bold; }
        .channel-bubble.active-chan { border-color: var(--main); background: white; color: var(--main); border-radius: 12px; }
        
        .chat-area { flex: 1; display: flex; flex-direction: column; background: white; min-width: 0; }
        .chat-header { padding: 10px; border-bottom: 1px solid #eee; font-weight: bold; color: var(--dark); display: flex; justify-content: space-between; }
        .chat-feed { flex: 1; overflow-y: auto; padding: 10px; display: flex; flex-direction: column; gap: 10px; background-image: radial-gradient(#eee 1px, transparent 1px); background-size: 20px 20px; }
        
        .pk-msg { display: flex; gap: 10px; align-items: flex-start; }
        .pk-avatar { width: 35px; height: 35px; border-radius: 50%; object-fit: cover; border: 2px solid transparent; flex-shrink: 0; }
        .pk-header { display: flex; align-items: baseline; gap: 5px; margin-bottom: 2px; }
        .pk-name { font-weight: bold; font-size: 0.8rem; }
        .pk-text { font-size: 0.8rem; color: #333; word-wrap: break-word; line-height: 1.3; }

        /* PET & GACHA */
        .pet-box { background: white; border: 3px ridge var(--main); border-radius: 20px; padding: 20px; text-align: center; margin-bottom: 20px; position:relative; min-height: 250px; overflow: hidden; touch-action: none; transition: background 0.3s; }
        .pet-sticker { position: absolute; font-size: 3rem; cursor: grab; user-select: none; z-index: 5; transition: transform 0.1s; }
        .pet-sticker:active { cursor: grabbing; transform: scale(1.1); z-index: 15; }
        .pet-sticker.wear { z-index: 20; } 
        .pet-sticker.decor { z-index: 1; }
        .ebi-img { width: 140px; margin-top:40px; position:relative; z-index:2; pointer-events: none; }
        
        .gacha-btn-group { display: flex; gap: 5px; justify-content: center; flex-wrap: wrap; margin-top: 5px; }
        .gacha-btn { background: #f8f8f8; border: 2px outset #ddd; padding: 8px; border-radius: 10px; font-size: 0.7rem; cursor: pointer; width: 45%; }
        .inventory-grid { display: flex; flex-wrap: wrap; gap: 5px; justify-content: center; margin-top: 5px; background: #f0f0f0; padding: 10px; border: 2px inset #ccc; border-radius: 10px; max-height: 120px; overflow-y: auto; }
        .inv-item { font-size: 1.5rem; cursor: pointer; padding: 5px; border: 1px solid #ddd; background: white; border-radius: 5px; }

        /* UI ELEMENTS */
        .btn-main { background: var(--main); color: white; border: 2px outset #ff9eb5; padding: 12px; width: 100%; border-radius: 25px; font-weight: bold; cursor: pointer; box-shadow: 2px 2px 0 rgba(0,0,0,0.1); }
        .btn-main:active { transform: translateY(2px); border-style: inset; box-shadow: none; }
        input, textarea { width: 100%; padding: 10px; border: 2px inset #ddd; border-radius: 15px; box-sizing: border-box; font-family:inherit; outline:none; background: #fffdfd; margin-bottom:5px; }

        /* MODALS */
        .modal-overlay { position: fixed; top:0; left:0; right:0; bottom:0; background: rgba(0,0,0,0.6); z-index: 2000; display: none; align-items: center; justify-content: center; backdrop-filter: blur(2px); }
        .modal-box { background: white; width: 85%; max-width: 400px; border-radius: 25px; border: 4px ridge var(--main); padding: 20px; max-height: 85vh; overflow-y: auto; border: 4px ridge var(--main); box-shadow: 0 10px 40px rgba(0,0,0,0.3); }

        /* NAV */
        nav { position: fixed; bottom: 35px; left: 20px; right: 20px; background: rgba(255,255,255,0.95); border-radius: 40px; display: flex; justify-content: space-around; padding: 15px 0; box-shadow: 0 5px 20px rgba(0,0,0,0.1); z-index: 100; border: 2px solid white; }
        .nav-btn { background: none; border: none; color: #ccc; font-size: 1.4rem; transition: 0.2s; display: flex; flex-direction:column; align-items: center; }
        .nav-btn.active { color: var(--main); transform: scale(1.1); }
        .nav-label { font-size: 0.55rem; margin-top:2px; font-weight:bold; }

        .toast { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background: rgba(255, 105, 180, 0.9); color: white; padding: 10px 20px; border-radius: 20px; font-size: 0.8rem; opacity: 0; transition: 0.3s; z-index: 20001; font-weight:bold; }
        .toast.show { opacity: 1; top: 30px; }
        
        .receipt-log { font-family: 'Courier New', monospace; font-size: 0.7rem; background: #fff; padding: 10px; border: 1px dashed #ccc; margin-top: 10px; min-height: 60px; white-space: pre-wrap; max-height: 150px; overflow-y: scroll; }

        /* WALLPAPERS */
        .bg-hearts { background-color: #ffe4e1 !important; background-image: radial-gradient(#ff69b4 2px, transparent 2px), radial-gradient(#ff69b4 2px, transparent 2px) !important; background-size: 20px 20px !important; background-position: 0 0, 10px 10px !important; }
        .bg-clouds { background-color: #e3f2fd !important; background-image: radial-gradient(white 8px, transparent 9px), radial-gradient(white 8px, transparent 9px) !important; background-size: 40px 40px !important; background-position: 0 0, 20px 20px !important; }
    </style>
</head>
<body>

<div class="dream-overlay"></div>
<div class="scanlines"></div>
<div id="toast" class="toast">üíæ Saved!</div>

<div id="welcome-layer">
    <div class="welcome-card">
        <div style="font-size:4rem; margin-bottom:10px;">üéÄ</div>
        <h1 style="color:var(--main); margin-bottom:20px;">SEIREN OS</h1>
        <button class="enter-btn" onclick="startSystem()">ENTER SYSTEM</button>
    </div>
</div>

<div id="lock-screen">
    <div style="font-size:3rem; margin-bottom:10px;">üîí</div>
    <h3>SYSTEM LOCKED</h3>
    <div class="pin-display" id="pin-dots"></div>
    <div class="pin-pad">
        <div class="pin-btn" onclick="enterPin(1)">1</div>
        <div class="pin-btn" onclick="enterPin(2)">2</div>
        <div class="pin-btn" onclick="enterPin(3)">3</div>
        <div class="pin-btn" onclick="enterPin(4)">4</div>
        <div class="pin-btn" onclick="enterPin(5)">5</div>
        <div class="pin-btn" onclick="enterPin(6)">6</div>
        <div class="pin-btn" onclick="enterPin(7)">7</div>
        <div class="pin-btn" onclick="enterPin(8)">8</div>
        <div class="pin-btn" onclick="enterPin(9)">9</div>
        <div class="pin-btn" style="border:none; background:none;"></div>
        <div class="pin-btn" onclick="enterPin(0)">0</div>
        <div class="pin-btn" style="color:#ff69b4; border-color:#ff69b4;" onclick="clearPin()">C</div>
    </div>
</div>

<div class="app-shell" id="main-app">
    
    <div class="status-bar">
        <span id="clock">12:00</span>
        <span id="active-fronter-display">Loading...</span>
    </div>

    <div class="content">

        <div id="tab-dash" class="page active">
            <h2 style="text-align:center; color:var(--main);">Dashboard</h2>
            
            <div class="xp-box">
                <div style="display:flex; justify-content:space-between; font-size:0.8rem; font-weight:bold; color:var(--blue);">
                    <span>Level <span id="lvl-num">1</span></span>
                    <span><span id="xp-val">0</span>/<span id="xp-req">100</span> XP</span>
                </div>
                <div class="xp-track"><div id="xp-bar" class="xp-fill"></div></div>
                <div style="margin-top:5px; font-size:0.8rem; font-weight:bold;">Bananas: üçå<span id="credit-val">0</span></div>
            </div>

            <div style="background:white; border:4px ridge var(--main); border-radius:20px; padding:15px; margin-bottom:20px; text-align:center;">
                <div id="dash-avatar" style="width:80px; height:80px; border-radius:50%; margin:0 auto; background-size:cover; background-position:center; border:3px solid var(--main); box-shadow:2px 2px 5px rgba(0,0,0,0.1);"></div>
                <h3 id="dash-name" style="margin:10px 0 5px 0; color:var(--dark);">User</h3>
                <div style="font-size:0.7rem; color:#888;">ID: <span id="dash-id">000</span></div>
            </div>

            <div class="dash-grid">
                <div class="dash-btn" onclick="openProfileManager()">
                    <span class="dash-icon">üë•</span><span class="dash-label">Switch</span>
                </div>
                <div class="dash-btn" onclick="openBackpack()">
                    <span class="dash-icon">üéí</span><span class="dash-label">Backpack</span>
                </div>
                <div class="dash-btn" onclick="toggleLockSetup()">
                    <span class="dash-icon">üõ°Ô∏è</span><span class="dash-label">Security</span>
                </div>
            </div>
        </div>

        <div id="tab-bbs" class="page" style="height:100%; flex-direction:column;">
            <div class="discord-layout" style="flex:1;">
                <div class="channel-sidebar" id="channel-list"></div>
                <div class="chat-area">
                    <div class="chat-header">
                        <span id="chan-title">#general</span>
                        <span style="font-size:0.7rem; color:red; cursor:pointer;" onclick="deleteChannel()">üóëÔ∏è</span>
                    </div>
                    <div class="chat-feed" id="chat-feed"></div>
                    <div style="padding:10px; border-top:1px solid #eee; display:flex; gap:5px;">
                        <input type="text" id="chat-input" placeholder="Proxy message..." style="margin:0;">
                        <button class="btn-main" style="width:auto; padding:10px;" onclick="sendMsg()">Send</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="tab-pet" class="page">
            <div class="pet-box" id="pet-container">
                <div id="room-decor-layer"></div>
                <img id="ebi-pet" src="https://cdn-icons-png.flaticon.com/512/3069/3069172.png" class="ebi-img">
                <h3 style="color:var(--main); position:relative; z-index:2;">Ebi</h3>
                <div style="background:#eee; height:12px; border-radius:10px; overflow:hidden; margin:10px 0; position:relative; z-index:2;">
                    <div id="pet-bar" style="width:50%; height:100%; background:var(--main); transition:width 0.5s;"></div>
                </div>
            </div>

            <div style="margin-top:20px; border-top:2px dashed #ccc; padding-top:10px;">
                <strong style="color:var(--dark);">Quick Mood Receipt</strong>
                <div style="display:flex; justify-content:space-between; margin:10px 0;">
                    <button class="btn-main" style="width:auto; padding:10px;" onclick="logMoodQuick('üòä')">üòä</button>
                    <button class="btn-main" style="width:auto; padding:10px;" onclick="logMoodQuick('üò¢')">üò¢</button>
                    <button class="btn-main" style="width:auto; padding:10px;" onclick="logMoodQuick('üò°')">üò°</button>
                    <button class="btn-main" style="width:auto; padding:10px;" onclick="logMoodQuick('üíñ')">üíñ</button>
                </div>
                <div id="receipt-log" class="receipt-log">
‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
‚ïë  SEIREN MOOD SYSTEM  ‚ïë
‚ï†‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï£
<div id="receipt-entries"></div>
‚ï†‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï£
‚ïë PENDING XP: +<span id="pending-xp">0</span>      ‚ïë
‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
                </div>
                <button class="btn-main" style="margin-top:5px; background:#ccc; color:#333;" onclick="cashOutReceipt()">üñ®Ô∏è PRINT & COLLECT</button>
            </div>
        </div>

        <div id="tab-diary" class="page">
            <h2 style="color:var(--main);">System Diary</h2>
            <div class="diary-box">
                <textarea id="diary-in" style="height:80px; resize:none;" placeholder="Log a memory..."></textarea>
                <button class="btn-main" onclick="postDiary()">Log Entry</button>
            </div>
            <div id="diary-feed" style="margin-top:20px;"></div>
        </div>

    </div>

    <nav>
        <button class="nav-btn active" onclick="go('dash', this)"><span>üè†</span><span class="nav-label">Dash</span></button>
        <button class="nav-btn" onclick="go('bbs', this)"><span>üí¨</span><span class="nav-label">Chats</span></button>
        <button class="nav-btn" onclick="go('pet', this)"><span>üç§</span><span class="nav-label">Ebi</span></button>
        <button class="nav-btn" onclick="go('diary', this)"><span>üìì</span><span class="nav-label">Diary</span></button>
    </nav>

    <div id="modal-profiles" class="modal-overlay">
        <div class="modal-box">
            <h3>System Members</h3>
            <div id="profile-list" style="max-height:200px; overflow-y:auto; margin-bottom:15px;"></div>
            <hr>
            <h4>New Member</h4>
            <input type="text" id="new-name" placeholder="Name">
            <input type="text" id="new-avatar" placeholder="Image URL">
            <input type="color" id="new-color" value="#ff69b4" style="width:100%; height:40px; border:none;">
            <button class="btn-main" onclick="createProfile()" style="margin-top:10px;">Register</button>
            <button class="btn-main" style="background:#ccc; margin-top:10px;" onclick="closeModals()">Close</button>
        </div>
    </div>

    <div id="modal-backpack" class="modal-overlay">
        <div class="modal-box">
            <h3>üéí Backpack</h3>
            <div style="background:#f9f9f9; padding:10px; border-radius:10px; margin-bottom:15px; border:2px inset #eee;">
                <b>Gacha Shop (50 üçå)</b>
                <div class="gacha-btn-group">
                    <button class="gacha-btn" onclick="playGacha('cute')">üéÄ Cute</button>
                    <button class="gacha-btn" onclick="playGacha('dark')">üï∏Ô∏è Dark</button>
                    <button class="gacha-btn" onclick="playGacha('seiren')">üëô Seiren</button>
                    <button class="gacha-btn" onclick="playGacha('fun')">üê∏ Fun</button>
                </div>
            </div>
            
            <small>WEARABLES (Drag onto Ebi)</small>
            <div class="inventory-grid" id="inv-wear"></div>
            
            <small>DECOR (Drag into Room)</small>
            <div class="inventory-grid" id="inv-decor"></div>

            <small>WALLPAPERS (Click)</small>
            <div class="inventory-grid" id="inv-wall"></div>
            
            <button class="btn-main" style="background:#ff8a80; margin-top:15px;" onclick="clearRoomDecor()">üóëÔ∏è Clear Room</button>
            <button class="btn-main" style="background:#ccc; margin-top:5px;" onclick="closeModals()">Close</button>
        </div>
    </div>

    <div id="modal-security" class="modal-overlay">
        <div class="modal-box">
            <h3>üõ°Ô∏è Security</h3>
            <p>Set a 4-digit PIN to lock the system.</p>
            <input type="number" id="set-pin" placeholder="Enter 4 digits" maxlength="4">
            <button class="btn-main" onclick="savePin()">Set PIN</button>
            <button class="btn-main" style="background:#ff4444; margin-top:10px;" onclick="removePin()">Remove Lock</button>
            <button class="btn-main" style="background:#ccc; margin-top:10px;" onclick="closeModals()">Close</button>
        </div>
    </div>

</div>

<script>
    // --- GACHA DATA ---
    const GACHA = {
        cute: ["üéÄ","üëë","ü©∞","üßÅ","üß∏","üíñ"],
        dark: ["üï∏Ô∏è","üï∑Ô∏è","üíÄ","ü•Ä","üñ§","ü¶á"],
        seiren: ["üëô","üï∂Ô∏è","üß¢","üëí","üíç"],
        fun: ["üê∏","üçÑ","üêõ","üêå","üåª","üåà"],
        walls: ["bg-hearts", "bg-clouds"]
    };

    // --- DB & STATE ---
    let DB = {
        profiles: [], activeIdx: 0,
        channels: { 'general': { name: 'general', msgs: [] } },
        currentChan: 'general',
        xp: 0, credits: 0, lvl: 1,
        pet: { hunger: 50, decor: [], inventory: [] },
        diary: [],
        pin: null,
        wallpaper: ""
    };
    let pendingXP = 0;
    let tempPin = "";

    // --- INIT ---
    window.onload = () => {
        const saved = localStorage.getItem('seiren_fixed_v1');
        if(saved) DB = JSON.parse(saved);

        // First Run
        if(DB.profiles.length === 0) {
            DB.profiles.push({
                name: "Host", 
                avatar: "https://cdn-icons-png.flaticon.com/512/3233/3233508.png", 
                color: "#ff69b4", id: "001"
            });
            DB.pet.inventory = ["üéÄ", "bg-hearts"];
        }

        setInterval(() => {
            document.getElementById('clock').innerText = new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
        }, 1000);
    };

    function startSystem() {
        document.getElementById('welcome-layer').style.opacity = '0';
        setTimeout(() => {
            document.getElementById('welcome-layer').style.display = 'none';
            if(DB.pin) {
                document.getElementById('lock-screen').style.display = 'flex';
            } else {
                enterApp();
            }
        }, 500);
    }

    function save() {
        localStorage.setItem('seiren_fixed_v1', JSON.stringify(DB));
        const t = document.getElementById('toast');
        t.classList.add('show');
        setTimeout(()=>t.classList.remove('show'), 1000);
    }

    // --- SECURITY ---
    function enterPin(n) {
        if(tempPin.length < 4) { tempPin += n; updatePinDots(); }
        if(tempPin.length === 4) {
            if(tempPin === DB.pin) {
                document.getElementById('lock-screen').style.transform = "translateY(-100%)";
                setTimeout(()=>{ document.getElementById('lock-screen').style.display = 'none'; enterApp(); }, 300);
            } else {
                document.getElementById('pin-dots').style.background = "rgba(255,0,0,0.5)";
                setTimeout(()=>{ tempPin=""; updatePinDots(); document.getElementById('pin-dots').style.background="rgba(0,0,0,0.2)"; }, 500);
            }
        }
    }
    function updatePinDots() { document.getElementById('pin-dots').innerText = "*".repeat(tempPin.length); }
    function clearPin() { tempPin=""; updatePinDots(); }
    function toggleLockSetup() { document.getElementById('modal-security').style.display='flex'; }
    function savePin() { const p=document.getElementById('set-pin').value; if(p.length===4){ DB.pin=p; save(); alert("Locked!"); closeModals(); } }
    function removePin() { if(confirm("Remove lock?")){ DB.pin=null; save(); closeModals(); } }

    // --- MAIN APP ---
    function enterApp() {
        document.getElementById('main-app').style.display = 'flex';
        setTimeout(() => document.getElementById('main-app').style.opacity = '1', 50);
        refreshUI();
    }

    function refreshUI() {
        const u = DB.profiles[DB.activeIdx];
        
        // Theme
        document.documentElement.style.setProperty('--main', u.color);
        document.getElementById('active-fronter-display').innerText = u.name;
        document.getElementById('dash-name').innerText = u.name;
        document.getElementById('dash-id').innerText = u.id;
        document.getElementById('dash-avatar').style.backgroundImage = `url('${u.avatar}')`;
        document.getElementById('dash-avatar').style.borderColor = u.color;

        // Stats
        const req = 100 + (DB.lvl * 20);
        document.getElementById('lvl-num').innerText = DB.lvl;
        document.getElementById('xp-req').innerText = req;
        document.getElementById('xp-val').innerText = DB.xp;
        document.getElementById('xp-bar').style.width = (DB.xp/req)*100 + "%";
        document.getElementById('credit-val').innerText = DB.credits;

        // Pet
        document.getElementById('pet-bar').style.width = DB.pet.hunger + "%";
        if(DB.wallpaper) document.getElementById('pet-container').className = "pet-box " + DB.wallpaper;

        renderRoomDecor();
    }

    // --- PROFILES ---
    function openProfileManager() {
        const list = document.getElementById('profile-list'); list.innerHTML="";
        DB.profiles.forEach((p,i)=>{
            list.innerHTML += `
            <div style="display:flex; justify-content:space-between; align-items:center; padding:10px; border-bottom:1px solid #eee;">
                <div style="display:flex; align-items:center; gap:10px;">
                    <img src="${p.avatar}" style="width:30px; height:30px; border-radius:50%; object-fit:cover;">
                    <b>${p.name}</b>
                </div>
                <div>
                    ${i===DB.activeIdx ? '<small>Active</small>' : `<button onclick="switchProfile(${i})">Front</button>`}
                    ${i!==0 ? `<button onclick="delProfile(${i})" style="color:red;border:none;background:none;">x</button>` : ''}
                </div>
            </div>`;
        });
        document.getElementById('modal-profiles').style.display='flex';
    }
    function createProfile() {
        const n = document.getElementById('new-name').value;
        const a = document.getElementById('new-avatar').value || "https://cdn-icons-png.flaticon.com/512/3233/3233508.png";
        const c = document.getElementById('new-color').value;
        if(n) {
            DB.profiles.push({ name:n, avatar:a, color:c, id: Math.floor(Math.random()*9000)+1000 });
            save(); openProfileManager();
        }
    }
    function switchProfile(i) { DB.activeIdx = i; save(); refreshUI(); closeModals(); }
    function delProfile(i) { if(confirm("Delete?")){ DB.profiles.splice(i,1); DB.activeIdx=0; save(); openProfileManager(); } }

    // --- CHANNELS ---
    function renderChannels() {
        const sb = document.getElementById('channel-list'); sb.innerHTML="";
        Object.keys(DB.channels).forEach(k => {
            const div = document.createElement('div');
            div.className = `channel-bubble ${DB.currentChan===k?'active-chan':''}`;
            div.innerText = DB.channels[k].name.substring(0,2).toUpperCase();
            div.onclick = () => { DB.currentChan=k; renderChannels(); renderChat(); };
            sb.appendChild(div);
        });
        const add = document.createElement('div'); add.className='channel-bubble'; add.innerText='+';
        add.onclick = () => { const n=prompt("Name:"); if(n) { const id=n.toLowerCase(); DB.channels[id]={name:n,msgs:[]}; save(); renderChannels(); }};
        sb.appendChild(add);
    }
    function renderChat() {
        document.getElementById('chan-title').innerText = "#"+DB.channels[DB.currentChan].name;
        const feed = document.getElementById('chat-feed'); feed.innerHTML="";
        DB.channels[DB.currentChan].msgs.forEach(m => {
            feed.innerHTML += `
            <div class="pk-msg">
                <img src="${m.avatar}" class="pk-avatar" style="border-color:${m.color}">
                <div>
                    <div class="pk-header"><span class="pk-name" style="color:${m.color}">${m.name}</span></div>
                    <div class="pk-text">${m.text}</div>
                </div>
            </div>`;
        });
        feed.scrollTop = feed.scrollHeight;
    }
    function sendMsg() {
        const t = document.getElementById('chat-input').value; if(!t)return;
        const u = DB.profiles[DB.activeIdx];
        DB.channels[DB.currentChan].msgs.push({ name:u.name, avatar:u.avatar, color:u.color, text:t });
        document.getElementById('chat-input').value=""; save(); renderChat();
    }
    function deleteChannel() {
        if(DB.currentChan==='general') return;
        if(confirm("Delete channel?")) { delete DB.channels[DB.currentChan]; DB.currentChan='general'; save(); renderChannels(); renderChat(); }
    }

    // --- BACKPACK ---
    function openBackpack() {
        renderInventory();
        document.getElementById('modal-backpack').style.display='flex';
    }

    function playGacha(type) {
        if(DB.credits < 50) { alert("Need 50 Bananas! (Level up/Receipts to earn)"); return; }
        DB.credits -= 50;
        const pool = GACHA[type] || GACHA.cute;
        const item = pool[Math.floor(Math.random()*pool.length)];
        DB.pet.inventory.push(item);
        alert(`You got: ${item}`);
        save(); refreshUI(); renderInventory();
    }

    function renderInventory() {
        const w = document.getElementById('inv-wear'); w.innerHTML="";
        const d = document.getElementById('inv-decor'); d.innerHTML="";
        const bg = document.getElementById('inv-wall'); bg.innerHTML="";

        DB.pet.inventory.forEach(item => {
            const el = document.createElement('div'); el.className='inv-item'; el.innerText=item;
            if(item.startsWith('bg-')) {
                bg.appendChild(el); el.onclick = () => { DB.wallpaper=item; save(); refreshUI(); };
            } else if (["üéÄ","üëë","üß¢","üëí","üëì","üï∂Ô∏è","üëô"].includes(item)) {
                w.appendChild(el); el.onclick = () => spawnDecor(item, 'wear');
            } else {
                d.appendChild(el); el.onclick = () => spawnDecor(item, 'decor');
            }
        });
    }

    function spawnDecor(item, type) {
        DB.pet.decor.push({item:item, type:type, x:50, y:50});
        save(); renderRoomDecor(); closeModals();
    }

    function renderRoomDecor() {
        const layer = document.getElementById('room-decor-layer'); layer.innerHTML="";
        DB.pet.decor.forEach((d, i) => {
            const el = document.createElement('div'); 
            el.className = `pet-sticker ${d.type}`; 
            el.innerText = d.item;
            el.style.left = d.x + "%"; el.style.top = d.y + "%";
            
            let isDragging = false;
            const start = (e) => { isDragging=true; e.preventDefault(); };
            const move = (e) => {
                if(!isDragging) return;
                const box = document.getElementById('pet-container').getBoundingClientRect();
                const cx = e.touches?e.touches[0].clientX:e.clientX;
                const cy = e.touches?e.touches[0].clientY:e.clientY;
                d.x = ((cx - box.left)/box.width)*100;
                d.y = ((cy - box.top)/box.height)*100;
                el.style.left=d.x+"%"; el.style.top=d.y+"%";
            };
            const end = () => { if(isDragging){isDragging=false; save();} };
            
            el.addEventListener('mousedown', start); el.addEventListener('touchstart', start);
            window.addEventListener('mousemove', move); window.addEventListener('touchmove', move);
            window.addEventListener('mouseup', end); window.addEventListener('touchend', end);
            layer.appendChild(el);
        });
    }
    function clearRoomDecor() { if(confirm("Clear room?")){ DB.pet.decor=[]; save(); renderRoomDecor(); } }

    // --- RECEIPT ---
    function logMoodQuick(m) {
        pendingXP += 5;
        const div = document.createElement('div'); div.innerText = `${m} ... +5XP`;
        document.getElementById('receipt-entries').appendChild(div);
        document.getElementById('pending-xp').innerText = pendingXP;
    }
    function cashOutReceipt() {
        if(pendingXP > 0) {
            DB.credits += pendingXP;
            DB.xp += pendingXP;
            const req = 100 + (DB.lvl * 20);
            if(DB.xp >= req) { DB.xp -= req; DB.lvl++; alert("Level Up!"); }
            pendingXP = 0; document.getElementById('receipt-entries').innerHTML="";
            document.getElementById('pending-xp').innerText="0";
            save(); refreshUI();
        }
    }

    // --- DIARY ---
    function postDiary() {
        const t = document.getElementById('diary-in').value; if(!t)return;
        const u = DB.profiles[DB.activeIdx];
        DB.diary.unshift({name:u.name, text:t, date:new Date().toLocaleString()});
        document.getElementById('diary-in').value=""; save(); renderDiary();
    }
    function renderDiary() {
        const f = document.getElementById('diary-feed'); f.innerHTML="";
        DB.diary.forEach(e=>{
            f.innerHTML+=`<div style="background:white;padding:10px;margin-bottom:10px;border-radius:10px;border-left:4px solid var(--main);"><div style="font-size:0.7rem;color:#999;display:flex;justify-content:space-between;"><b>${e.name}</b><span>${e.date}</span></div><div>${e.text}</div></div>`;
        });
    }

    // --- NAV ---
    function go(page, btn) {
        document.querySelectorAll('.page').forEach(e=>e.style.display='none');
        document.querySelectorAll('.nav-btn').forEach(e=>e.classList.remove('active'));
        if(page==='bbs') { document.getElementById('tab-bbs').style.display='flex'; renderChannels(); renderChat(); }
        else document.getElementById('tab-'+page).style.display='block';
        if(page==='pet') refreshUI();
        if(page==='diary') renderDiary();
        btn.classList.add('active');
    }
    function closeModals() { document.querySelectorAll('.modal-overlay').forEach(e=>e.style.display='none'); }

</script>
</body>
</html>
