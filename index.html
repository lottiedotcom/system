<!DOCTYPE html>  
<html lang="en">  
<head>  
    <meta charset="UTF-8">  
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">  
    <meta name="apple-mobile-web-app-capable" content="yes">  
    <meta name="theme-color" content="#ff69b4">  
    <title>Seiren OS</title>  
    <link rel="manifest" href="manifest.json">  
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/2919/2919573.png">  
    <link rel="icon" type="image/png" href="https://cdn-icons-png.flaticon.com/512/2919/2919573.png">  

<style>  
    /* --- CORE VARIABLES --- */  
    :root {  
        --main: #ff69b4;   
        --font-main: 'Verdana', sans-serif;  
        --font-mono: 'Courier New', monospace;  
    }  

    * { box-sizing: border-box; user-select: none; -webkit-tap-highlight-color: transparent; }  

    body {  
        font-family: var(--font-main);  
        background-color: #ffe4e1;   
        background-image: radial-gradient(#ffb7b2 15%, transparent 16%), radial-gradient(#ffb7b2 15%, transparent 16%);  
        background-size: 20px 20px; background-position: 0 0, 10px 10px;  
        background-repeat: repeat;  
        background-attachment: fixed; 
        transition: background-image 0.5s ease;  
        margin: 0; display: flex; justify-content: center; height: 100vh; overflow: hidden;  
        color: #444;   
    }  

    /* --- EXPANDED BACKGROUND LIBRARY --- */
    .bg-polka { background-color: #fff0f5 !important; background-image: radial-gradient(#ff1493 20%, transparent 20%) !important; background-size: 30px 30px !important; background-attachment: fixed !important; }
    .bg-lines { background-color: #fff0f5 !important; background-image: repeating-linear-gradient(45deg, transparent, transparent 10px, rgba(255, 20, 147, 0.4) 10px, rgba(255, 20, 147, 0.4) 20px) !important; background-attachment: fixed !important; }
    .bg-grid { background-color: #fff !important; background-image: linear-gradient(rgba(255, 105, 180, 0.5) 1px, transparent 1px), linear-gradient(90deg, rgba(255, 105, 180, 0.5) 1px, transparent 1px) !important; background-size: 20px 20px !important; background-attachment: fixed !important; }
    .bg-checkers { background-color: #fff !important; background-image: repeating-linear-gradient(45deg, rgba(255,105,180,0.25) 25%, transparent 25%, transparent 75%, rgba(255,105,180,0.25) 75%, rgba(255,105,180,0.25)), repeating-linear-gradient(45deg, rgba(255,105,180,0.25) 25%, #fff 25%, #fff 75%, rgba(255,105,180,0.25) 75%, rgba(255,105,180,0.25)) !important; background-size: 20px 20px !important; background-attachment: fixed !important; }
    .bg-clouds { background-color: #81d4fa !important; background-image: radial-gradient(white 8px, transparent 9px), radial-gradient(white 8px, transparent 9px) !important; background-size: 40px 40px !important; background-attachment: fixed !important; }  
    .bg-night { background-color: #1a237e !important; background-image: radial-gradient(white 1px, transparent 1px) !important; background-size: 30px 30px !important; background-attachment: fixed !important; color: white; }
    .bg-sunset { background: linear-gradient(180deg, #ff9a9e 0%, #fecfef 99%, #fecfef 100%) !important; background-attachment: fixed !important; }
    .bg-mint { background-color: #e0f2f1 !important; background-image: radial-gradient(#00695c 1px, transparent 1px) !important; background-size: 15px 15px !important; background-attachment: fixed !important; }
    .bg-rainbow { background: repeating-linear-gradient(90deg, #ffcdd2, #ffcdd2 20px, #f8bbd0 20px, #f8bbd0 40px, #e1bee7 40px, #e1bee7 60px, #d1c4e9 60px, #d1c4e9 80px, #c5cae9 80px, #c5cae9 100px, #b3e5fc 100px, #b3e5fc 120px) !important; background-attachment: fixed !important; }
    .bg-blueprint { background-color: #283593 !important; background-image: linear-gradient(rgba(255,255,255,0.3) 1px, transparent 1px), linear-gradient(90deg, rgba(255,255,255,0.3) 1px, transparent 1px) !important; background-size: 20px 20px !important; background-attachment: fixed !important; color: white; }
    .bg-argyle { background-color: #ffe4e1 !important; background-image: repeating-linear-gradient(120deg, rgba(255,255,255,.5), rgba(255,255,255,.5) 1px, transparent 1px, transparent 60px), repeating-linear-gradient(60deg, rgba(255,255,255,.5), rgba(255,255,255,.5) 1px, transparent 1px, transparent 60px), linear-gradient(60deg, rgba(0,0,0,.1) 25%, transparent 25%, transparent 75%, rgba(0,0,0,.1) 75%, rgba(0,0,0,.1)), linear-gradient(120deg, rgba(0,0,0,.1) 25%, transparent 25%, transparent 75%, rgba(0,0,0,.1) 75%, rgba(0,0,0,.1)) !important; background-size: 70px 120px !important; background-attachment: fixed !important; }
    .bg-lemon { background-color: #fff9c4 !important; background-image: repeating-linear-gradient(45deg, #fff176 25%, transparent 25%, transparent 75%, #fff176 75%, #fff176), repeating-linear-gradient(45deg, #fff176 25%, #fff9c4 25%, #fff9c4 75%, #fff176 75%, #fff176) !important; background-size: 20px 20px !important; background-attachment: fixed !important; }
    .bg-pixels { background-color: #e1bee7; background-image: linear-gradient(45deg, #ce93d8 25%, transparent 25%, transparent 75%, #ce93d8 75%, #ce93d8), linear-gradient(45deg, #ce93d8 25%, transparent 25%, transparent 75%, #ce93d8 75%, #ce93d8) !important; background-size: 10px 10px !important; background-position: 0 0, 5px 5px !important; background-attachment: fixed !important; }
    
    /* --- VISUAL FX --- */  
    .scanlines {  
        position: fixed; top: 0; left: 0; right: 0; bottom: 0; pointer-events: none; z-index: 9999; display: none;  
        background: linear-gradient(to bottom, rgba(255,255,255,0) 50%, rgba(0,0,0,0.1) 50%); background-size: 100% 4px;  
        animation: scan 60s linear infinite; opacity: 0.6;  
    }  
    .dream-overlay {  
        position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 9998; display: none;  
        background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.65' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)' opacity='0.05'/%3E%3C/svg%3E");  
        opacity: 0.5; mix-blend-mode: overlay;  
    }  
    body.fx-active .scanlines, body.fx-active .dream-overlay { display: block; }  
    @keyframes scan { 0% { background-position: 0 0; } 100% { background-position: 0 100%; } }  

    /* --- APP SHELL --- */  
    .app-shell {  
        width: 100%; max-width: 480px; 
        background: transparent; 
        backdrop-filter: blur(10px); 
        -webkit-backdrop-filter: blur(10px);
        display: none; flex-direction: column; position: relative; height: 100%;  
        z-index: 10; 
    }  
    .content { flex: 1; overflow-y: auto; padding: 20px; padding-bottom: 100px; scroll-behavior: smooth; }  
    .page { display: none; animation: popIn 0.3s; }  
    .page.active { display: block; }  
    @keyframes popIn { from {opacity:0; transform:scale(0.98);} to {opacity:1; transform:scale(1);} }  

    /* --- FIXED GLIMMER ID CARD --- */  
    .id-card-wrap {  
        background: #fff; border-radius: 15px; padding: 0;  
        box-shadow: 0 10px 20px rgba(0,0,0,0.15); margin-bottom: 20px;   
        position: relative; overflow: hidden; border: 1px solid #ccc;  
        min-height: 270px;
        transform: translate3d(0,0,0); 
    }  
    .id-card-wrap::before {  
        content: ""; position: absolute; top: -50%; left: -50%; width: 200%; height: 200%;  
        background: linear-gradient(115deg, transparent 40%, rgba(255,0,150,0.2) 45%, rgba(0,255,255,0.3) 50%, rgba(255,255,0,0.2) 55%, transparent 60%);  
        mix-blend-mode: multiply; pointer-events: none; z-index: 10;  
        animation: foil 5s linear infinite; opacity: 0.6;  
        will-change: transform;
    }  
    @keyframes foil { 
        0% { transform: translate3d(0,0,0); } 
        100% { transform: translate3d(50%,50%,0); } 
    }  

    .id-inner { padding: 15px; height: 100%; display: flex; flex-direction: column; position: relative; z-index: 2; }  
    .id-header { border-bottom: 2px solid var(--main); padding-bottom: 5px; margin-bottom: 10px; display: flex; justify-content: space-between; font-weight: 900; letter-spacing: 1px; font-size: 0.7rem; color: #555; }  
    .id-main { display: flex; gap: 15px; margin-bottom: 10px; }  
    .id-photo { width: 90px; height: 110px; background: #eee; border: 1px solid #999; object-fit: cover; display: block; box-shadow: 2px 2px 5px rgba(0,0,0,0.1); }  
    .id-details { flex: 1; display: flex; flex-direction: column; justify-content: flex-start; gap: 5px; font-size: 0.7rem; }  
    .id-label { color: var(--main); font-weight: bold; font-size: 0.6rem; text-transform: uppercase; display:block; }  
    .id-val { color: #222; font-weight: bold; display: block; border-bottom: 1px dotted #ccc; width: 100%; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }  
    .bio-section { background: rgba(255,255,255,0.8); border: 1px solid #ddd; border-radius: 8px; padding: 8px; font-size: 0.75rem; color: #333; flex: 1; overflow-y: auto; max-height: 80px; margin-top: 5px; white-space: pre-wrap; }  

    /* --- DASHBOARD --- */  
    .dash-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 20px; }  
    .dash-btn { background: white; border: 2px solid #eee; border-radius: 18px; padding: 15px; text-align: center; font-weight: bold; cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }  
    .dash-btn:active { transform: scale(0.96); background: #f9f9f9; border-color: var(--main); }  

    /* --- BIO/ABOUT TAB --- */
    .bio-container { background: white; padding: 20px; border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
    .bio-list-box { 
        border: 2px dashed #eee; padding: 10px; border-radius: 10px; min-height: 60px; 
        display: flex; flex-wrap: wrap; gap: 5px; margin-bottom: 10px;
    }
    .bio-tag { 
        background: var(--main); color: white; padding: 4px 10px; border-radius: 15px; 
        font-size: 0.8rem; font-weight: bold; display: flex; align-items: center; gap: 5px;
    }
    .bio-tag span { cursor: pointer; opacity: 0.7; font-size: 0.7rem; }
    .bio-input-group { display: flex; gap: 5px; margin-bottom: 15px; }

    /* --- FRONT LOG TABLE --- */
    .log-table { width: 100%; border-collapse: collapse; font-size: 0.8rem; }
    .log-table th { text-align: left; border-bottom: 2px solid var(--main); padding: 5px; color: var(--main); }
    .log-table td { border-bottom: 1px solid #eee; padding: 8px 5px; color: #555; }
    .log-table tr:nth-child(even) { background: #f9f9f9; }

    /* --- CHAT --- */  
    .chat-shell { display: flex; height: 100%; border: 2px solid var(--main); border-radius: 15px; background: white; overflow: hidden; position:relative; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }  
    .channel-sidebar { width: 75px; background: #f0f0f0; border-right: 1px solid #e0e0e0; padding-top: 40px; display: flex; flex-direction: column; align-items: center; gap: 12px; overflow-y: auto; transition: margin-left 0.3s ease; }  
    .channel-sidebar.hidden { margin-left: -75px; }  
    .sidebar-toggle { position: absolute; top: 10px; left: 10px; z-index: 100; background: var(--main); color: white; border: none; border-radius: 50%; width: 25px; height: 25px; font-weight: bold; cursor: pointer; }  
    .chan-btn { width: 48px; height: 48px; border-radius: 50%; background: #ddd; display: flex; align-items: center; justify-content: center; font-weight: bold; color: #666; cursor: pointer; border: 2px solid white; position: relative; flex-shrink: 0; }  
    .chan-btn.active { background: var(--main); color: white; border-radius: 14px; }  
    .del-chan { position: absolute; top: -5px; right: -5px; background: red; color: white; width: 18px; height: 18px; border-radius: 50%; font-size: 10px; display: none; align-items: center; justify-content: center; }  
    .chan-btn:hover .del-chan { display: flex; }  
    .chat-view { flex: 1; display: flex; flex-direction: column; min-width: 0; }  
    .chat-feed { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 15px; background-image: radial-gradient(#f0f0f0 1px, transparent 1px); background-size: 20px 20px; }  
    .pk-msg { display: flex; gap: 10px; align-items: flex-start; }  
    .pk-av { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; flex-shrink: 0; }  
    .pk-img { max-width: 150px; border-radius: 10px; margin-top: 5px; display: block; border: 2px solid #eee;}  
    .chat-input-area { padding: 10px; border-top: 1px solid #eee; display: flex; gap: 8px; align-items: center; background: #fafafa; }  

    /* --- PET --- */  
    .pet-stage { height: 350px; position: relative; border: 4px ridge var(--main); border-radius: 20px; background: rgba(255,255,255,0.85); box-shadow: 0 5px 15px rgba(0,0,0,0.1); overflow: hidden; display: flex; align-items: center; justify-content: center; }  
    .ebi-img { width: 160px; pointer-events: none; z-index: 5; margin-top: 60px; filter: drop-shadow(0 5px 5px rgba(0,0,0,0.1)); }  
    .sticker { position: absolute; font-size: 3rem; cursor: grab; z-index: 10; user-select: none; }  
    .speech-bubble {  
        position: absolute; top: 40px; left: 50%; transform: translateX(-50%) scale(0);  
        background: white; padding: 10px 15px; border-radius: 20px; border: 2px solid var(--main);  
        font-size: 0.8rem; font-weight: bold; z-index: 20; text-align: center;  
        transition: transform 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);  
        pointer-events: none; white-space: nowrap;  
    }  
    .speech-bubble.show { transform: translateX(-50%) scale(1); }  

    /* --- PHARMACY --- */  
    .receipt-paper { background: #fff; border: 1px solid #ccc; padding: 15px; font-family: var(--font-mono); font-size: 0.8rem; box-shadow: 0 5px 15px rgba(0,0,0,0.05); margin-bottom: 10px; position: relative; }  
    .mood-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 5px; max-height: 200px; overflow-y: auto; padding-right: 5px; }  
    .mood-btn { background: white; border: 1px solid #ccc; border-radius: 8px; height: 40px; font-size: 1.2rem; cursor: pointer; }  
    .mood-btn:active { background: var(--main); }  

    /* --- UI COMPONENTS --- */  
    .btn-action { background: var(--main); color: white; padding: 12px; width: 100%; border: none; border-radius: 12px; font-weight: bold; cursor: pointer; margin-bottom: 5px; box-shadow: 0 4px 0 rgba(0,0,0,0.1); }  
    .btn-action:active { transform: translateY(3px); box-shadow: none; }  
      
    .dock { position: fixed; bottom: 25px; left: 20px; right: 20px; background: rgba(255,255,255,0.95); border-radius: 25px; padding: 12px 25px; display: flex; justify-content: space-between; box-shadow: 0 5px 25px rgba(0,0,0,0.15); z-index: 100; border: 2px solid white; }  
    .dock-btn { background: none; border: none; font-size: 1.6rem; cursor: pointer; opacity: 0.5; transition: 0.2s; }  
    .dock-btn.active { opacity: 1; transform: translateY(-8px); }  

    .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 2000; display: none; align-items: center; justify-content: center; }  
    .modal-card { background: white; width: 90%; max-width: 380px; border-radius: 25px; padding: 25px; border: 4px ridge var(--main); max-height: 85vh; overflow-y: auto; }  
    input, textarea { width: 100%; padding: 10px; margin-bottom: 8px; border: 2px inset #eee; border-radius: 10px; font-family: inherit;}  

    /* --- LOCK SCREEN --- */  
    #lock-screen { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: var(--main); z-index: 20000; display: none; flex-direction: column; align-items: center; justify-content: center; color: white; }  
    .pin-pad { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-top: 30px; }  
    .pin-btn { width: 70px; height: 70px; border-radius: 50%; border: 2px solid white; background: rgba(255,255,255,0.15); color: white; font-size: 1.8rem; display: flex; align-items: center; justify-content: center; cursor: pointer; }  

    /* --- DIARY --- */  
    .diary-entry { background: white; padding: 15px; border-radius: 12px; margin-bottom: 12px; border-left: 5px solid var(--main); position: relative; box-shadow: 2px 2px 5px rgba(0,0,0,0.05); }  
    .del-diary { position: absolute; top: 8px; right: 8px; color: #ff4444; cursor: pointer; font-weight: bold; font-size: 0.9rem; padding: 5px; }  
    
    .file-upload-btn {
        display: block; width: 100%; padding: 10px; text-align: center; background: #eee;
        border-radius: 10px; margin-bottom: 10px; cursor: pointer; font-weight: bold; color: #555;
    }
</style>

</head>  
<body class="fx-active">  
<div class="scanlines"></div>  
<div class="dream-overlay"></div>  

<div id="welcome-screen" style="position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.9); z-index:3000; display:flex; flex-direction:column; align-items:center; justify-content:center;">  
    <div style="font-size:4rem; margin-bottom:10px;">üíæ</div>  
    <h1 style="color:var(--main); margin:0 0 10px 0;">SEIREN OS</h1>  
    <p style="font-size:0.8rem; color:#666; margin-bottom:30px;">Guest Mode Active</p>  
    <button class="btn-action" style="width:220px;" onclick="enterSystem()">Enter System</button>  
    
    <label class="btn-action" style="width:220px; background:#4fc3f7; text-align:center; display:block; cursor:pointer;">  
        üìÇ Load Backup  
        <input type="file" id="backup-input" style="display:none;" onchange="importData(this)">  
    </label>

    <label class="btn-action" style="width:220px; background:#7e57c2; text-align:center; display:block; cursor:pointer; margin-top:10px;">  
        üëæ Import PluralKit  
        <input type="file" id="pk-input" style="display:none;" onchange="importPluralKit(this)">  
    </label>
</div>  

<div id="lock-screen">  
    <div style="font-size:4rem; margin-bottom:10px;">üîí</div>  
    <h3>SYSTEM LOCKED</h3>  
    <div id="pin-dots" style="font-size:3rem; letter-spacing:15px; height:60px; font-family:monospace;"></div>  
    <div class="pin-pad">  
        <div class="pin-btn" onclick="enterPin(1)">1</div><div class="pin-btn" onclick="enterPin(2)">2</div><div class="pin-btn" onclick="enterPin(3)">3</div>  
        <div class="pin-btn" onclick="enterPin(4)">4</div><div class="pin-btn" onclick="enterPin(5)">5</div><div class="pin-btn" onclick="enterPin(6)">6</div>  
        <div class="pin-btn" onclick="enterPin(7)">7</div><div class="pin-btn" onclick="enterPin(8)">8</div><div class="pin-btn" onclick="enterPin(9)">9</div>  
        <div class="pin-btn" style="opacity:0"></div><div class="pin-btn" onclick="enterPin(0)">0</div><div class="pin-btn" style="background:rgba(255,200,200,0.3)" onclick="clearPin()">C</div>  
    </div>  
</div>  

<div class="app-shell" id="app">  
    <div id="page-dash" class="page active" style="padding-top:20px;">  
        <div class="id-card-wrap">  
            <div class="id-inner">  
                <div class="id-header">  
                    <span id="sys-name-display">SEIREN OS</span>  
                    <span>GLIMMER ID</span>  
                </div>  
                <div class="id-main">  
                    <img id="dash-av" class="id-photo" src="">  
                    <div class="id-details">  
                        <div><span class="id-label">NAME</span><span class="id-val" id="dash-name">Guest</span></div>  
                        <div style="display:flex; gap:10px;">  
                            <div style="flex:1;"><span class="id-label">AGE</span><span class="id-val" id="dash-age">--</span></div>  
                            <div style="flex:1;"><span class="id-label">HEIGHT</span><span class="id-val" id="dash-height">--</span></div>  
                        </div>  
                        <div style="display:flex; gap:10px;">  
                            <div style="flex:1;"><span class="id-label">SIGN</span><span class="id-val" id="dash-sign">--</span></div>  
                            <div style="flex:1;"><span class="id-label">SPECIES</span><span class="id-val" id="dash-species">--</span></div>  
                        </div>  
                        <div id="cofront-row" style="display:none; margin-top:5px;">
                            <span class="id-label">CO-CON</span>
                            <span class="id-val" id="dash-co"></span>
                        </div>
                    </div>  
                </div>  
                <span class="id-label">PERSONNEL NOTES</span>  
                <div class="bio-section" id="dash-bio">  
                    Official System Member  
                </div>  
            </div>  
        </div>  

        <div style="background:white; padding:12px; border-radius:15px; text-align:center; margin-bottom:20px; border:2px inset #eee; color:#666;">  
            <b>XP Points:</b> <span id="cp-display" style="color:var(--main); font-weight:bold; font-size:1.2rem;">0</span>  
        </div>  

        <div class="dash-grid">  
            <div class="dash-btn" onclick="openProfileModal()"><span>üë•</span><br>Switch/Edit</div>  
            <div class="dash-btn" onclick="openSettingsModal()"><span>‚öôÔ∏è</span><br>Settings</div>  
            <div class="dash-btn" onclick="openBackpack()"><span>üéí</span><br>Items</div>  
            <div class="dash-btn" onclick="nav('pharmacy')"><span>üè•</span><br>Pharmacy</div>  
        </div>  
          
        <button class="btn-action" style="background:#607d8b; margin-top:25px; width:auto; font-size:0.8rem;" onclick="exportData()">üíæ Save Backup</button>  
    </div>  

    <div id="page-about" class="page" style="padding-top:20px;">
        <h2 style="color:var(--main); text-align:center; background:white; border-radius:10px; display:inline-block; padding:5px 15px; margin:0 auto 15px auto; display:table;">About Me</h2>
        
        <div class="bio-container">
            <h4 style="color:#555; margin:0 0 5px 0;">üíñ Likes</h4>
            <div id="likes-list" class="bio-list-box"></div>
            <div class="bio-input-group">
                <input type="text" id="like-in" placeholder="Add like..." style="margin:0;">
                <button class="btn-action" style="width:auto; margin:0;" onclick="addBioItem('likes')">+</button>
            </div>

            <h4 style="color:#555; margin:15px 0 5px 0;">üö´ Dislikes</h4>
            <div id="dislikes-list" class="bio-list-box"></div>
            <div class="bio-input-group">
                <input type="text" id="dislike-in" placeholder="Add dislike..." style="margin:0;">
                <button class="btn-action" style="width:auto; margin:0;" onclick="addBioItem('dislikes')">+</button>
            </div>

            <h4 style="color:#555; margin:15px 0 5px 0;">üìù Notes / Triggers</h4>
            <textarea id="notes-in" style="height:100px;" placeholder="Extra details here..." onblur="saveBioNotes()"></textarea>
        </div>
    </div>

    <div id="page-chat" class="page" style="height:100%; padding-bottom:80px;">  
        <div class="chat-shell">  
            <button class="sidebar-toggle" onclick="toggleSidebar()">&lt;</button>  
            <div class="channel-sidebar" id="chan-list"></div>  
            <div class="chat-view">  
                <div class="chat-header">  
                    <span id="chan-title">#general</span>  
                </div>  
                <div class="chat-feed" id="chat-feed"></div>  
                <div class="chat-input-area">  
                    <label style="cursor:pointer; font-size:1.5rem; color:#888;">üìé<input type="file" accept="image/*" style="display:none;" onchange="handleChatImage(this)"></label>  
                    <input type="text" id="msg-in" style="width:100%; margin:0;" placeholder="Message...">  
                    <button class="btn-action" style="width:auto; margin:0;" onclick="sendMsg()">Send</button>  
                </div>  
            </div>  
        </div>  
    </div>  

    <div id="page-pharmacy" class="page">  
        <h2 style="color:var(--main); text-align:center; margin-bottom:15px; background:white; border-radius:10px; display:inline-block; padding:5px 15px;">Pharmacy & Care</h2>  
        <div style="background:white; padding:15px; border-radius:15px; border:2px solid var(--main);">  
            <div id="receipt-list" style="max-height:150px; overflow-y:auto; font-family:var(--font-mono); border-bottom:1px dashed #ccc; margin-bottom:10px; min-height:50px;"></div>  
              
            <div style="text-align:center; margin-bottom:5px; font-size:0.7rem; color:#888;">LOG SYMPTOMS:</div>  
            <div class="mood-grid">  
                <button class="mood-btn" onclick="logMood('üòä Happy', 5)">üòä</button>  
                <button class="mood-btn" onclick="logMood('üò¢ Sad', 10)">üò¢</button>  
                <button class="mood-btn" onclick="logMood('üò° Angry', 10)">üò°</button>  
                <button class="mood-btn" onclick="logMood('üåÄ Anxious', 15)">üåÄ</button>  
                <button class="mood-btn" onclick="logMood('üí§ Tired', 5)">üí§</button>  
                <button class="mood-btn" onclick="logMood('‚ú® Hyper', 5)">‚ú®</button>  
                <button class="mood-btn" onclick="logMood('üíÄ Dead', 15)">üíÄ</button>  
                <button class="mood-btn" onclick="logMood('üíñ Loved', 5)">üíñ</button>  
                <button class="mood-btn" onclick="logMood('üò∞ Panic', 15)">üò∞</button>  
                <button class="mood-btn" onclick="logMood('üå´Ô∏è Numb', 10)">üå´Ô∏è</button>  
                <button class="mood-btn" onclick="logMood('‚ö° Manic', 15)">‚ö°</button>  
                <button class="mood-btn" onclick="logMood('ü•Ä Lonely', 10)">ü•Ä</button>  
                <button class="mood-btn" onclick="logMood('üé™ Silly', 5)">üé™</button>  
                <button class="mood-btn" onclick="logMood('ü©π Hurt', 10)">ü©π</button>  
                <button class="mood-btn" onclick="logMood('üéÆ Bored', 5)">üéÆ</button>  
                <button class="mood-btn" onclick="logMood('üß∏ Soft', 5)">üß∏</button>  
                <button class="mood-btn" onclick="logMood('ü§¢ Sick', 15)">ü§¢</button>  
                <button class="mood-btn" onclick="logMood('ü§Ø Overwhelmed', 15)">ü§Ø</button>  
                <button class="mood-btn" onclick="logMood('ü•∫ Sensitive', 10)">ü•∫</button>  
                <button class="mood-btn" onclick="logMood('üò§ Frustrated', 10)">üò§</button>
            </div>  

            <button class="btn-action" style="margin-top:10px; background:#78909c;" onclick="processReceipt()">Print Receipt (+Self Care)</button>  
            <button class="btn-action" style="margin-top:10px; background:#4db6ac;" onclick="fillPrescription()">üíä Fill Rx (50 XP)</button>  
        </div>  
    </div>  

    <div id="page-pet" class="page">  
        <h2 style="color:var(--main); text-align:center; background:white; border-radius:10px; display:inline-block; padding:5px 15px;">Patient Room</h2>  
        <div class="pet-stage" id="pet-stage">  
            <div id="decor-layer"></div>  
            <div id="pet-speech" class="speech-bubble">Hello!</div>  
            <img src="https://i.postimg.cc/13FQckct/Untitled-Artwork-20260110072840-20260110074706.png" class="ebi-img">  
        </div>  
        <p style="text-align:center; font-size:0.7rem; color:#888; margin-top:5px; background:rgba(255,255,255,0.8); border-radius:5px; padding:2px;">Check Backpack for Prescribed Items</p>  
    </div>  

    <div id="page-diary" class="page">  
        <h2 style="color:var(--main); text-align:center; background:white; border-radius:10px; display:inline-block; padding:5px 15px;">Diary</h2>  
        <textarea id="diary-in" style="width:100%; height:100px;" placeholder="Entry..."></textarea>  
        <button class="btn-action" onclick="postDiary()">Save</button>  
        <div id="diary-feed" style="margin-top:20px;"></div>  
    </div>  

    <div class="dock">  
        <button class="dock-btn active" onclick="nav('dash')">üè†</button>  
        <button class="dock-btn" onclick="nav('about')">üë§</button>
        <button class="dock-btn" onclick="nav('pharmacy')">üè•</button>  
        <button class="dock-btn" onclick="nav('pet')">üç§</button>  
        <button class="dock-btn" onclick="nav('chat')">üí¨</button>  
        <button class="dock-btn" onclick="nav('diary')">üìì</button>  
    </div>
</div>  

<div id="modal-settings" class="modal">  
    <div class="modal-card">  
        <h3>Settings</h3>  
        <label>System Name:</label>  
        <input type="text" id="sys-name-input" placeholder="Seiren OS">  
        <button class="btn-action" style="margin-top:5px; margin-bottom:15px;" onclick="saveSystemName()">Update Name</button>  
        
        <label style="display:flex; justify-content:space-between; align-items:center; background:#f9f9f9; padding:10px; border-radius:10px;">  
            <span>üì∫ CRT Effects</span>  
            <input type="checkbox" id="toggle-crt" onchange="toggleCRT()" checked style="width:auto; margin:0;">  
        </label>  
        <hr>  
        <h4>Security</h4>  
        <input type="number" id="pin-set" placeholder="New PIN (4 digits)" maxlength="4" style="text-align:center;">  
        <button class="btn-action" style="margin-top:5px;" onclick="setLock()">Enable Lock</button>  
        <button class="btn-action" style="margin-top:5px; background:#ff4444;" onclick="disableLock()">Disable Lock</button>  
        <button class="btn-action" style="margin-top:15px; background:#ccc;" onclick="closeModals()">Close</button>  
    </div>
</div>  

<div id="modal-profile" class="modal">  
    <div class="modal-card">  
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
            <h3>Identity Card</h3>
            <button class="btn-action" style="width:auto; padding:5px 10px; font-size:0.7rem;" onclick="openLogModal()">üìú History</button>
        </div>
        <div id="prof-list" style="margin-bottom:15px; max-height:150px; overflow-y:auto; border:1px solid #eee;"></div>  
        <hr>  
        <h4>Profile Editor</h4>  
        <p style="font-size:0.7rem; color:#666;">Leave fields blank to keep current data.</p>
        
        <input type="text" id="new-name" placeholder="Name">  
        <div style="display:flex; gap:10px;">  
            <input type="text" id="new-age" placeholder="Age" style="width:30%;">  
            <input type="text" id="new-sign" placeholder="Sign" style="width:70%;">  
        </div>  
        <div style="display:flex; gap:10px;">  
            <input type="text" id="new-species" placeholder="Species" style="width:70%;">  
            <input type="text" id="new-height" placeholder="Height" style="width:30%;">  
        </div>  
        <textarea id="new-bio" placeholder="Profile Info / Notes..." style="height:60px; font-family:inherit;"></textarea>  
        
        <label class="file-upload-btn">  
            üìÇ Upload Photo  
            <input type="file" accept="image/*" style="display:none;" onchange="handleFile(this, 'av-preview')">  
        </label>  
        
        <img id="av-preview" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Crect width='100' height='100' fill='%23eee'/%3E%3Ccircle cx='50' cy='40' r='20' fill='%23ccc'/%3E%3Cpath d='M20,90 Q50,60 80,90' fill='%23ccc'/%3E%3C/svg%3E" style="width:60px; height:60px; margin:0 auto; display:block; object-fit:cover; border-radius:50%; background:#eee;">  
          
        <input type="color" id="new-color" value="#ff69b4" style="width:100%; border:none; height:30px; margin-top:5px;">  
        
        <div style="display:flex; gap:5px; margin-top:10px; flex-wrap:wrap;">
            <button class="btn-action" style="background:#81c784; flex:1;" onclick="updateCurrentProfile()">Save Changes</button>
            <button class="btn-action" style="flex:1;" onclick="createProfile()">Create New</button>
        </div>
        
        <button class="btn-action" style="margin-top:5px; background:#ccc;" onclick="closeModals()">Close</button>  
    </div>
</div>  

<div id="modal-log" class="modal">
    <div class="modal-card">
        <h3>Front Log</h3>
        <div style="max-height:300px; overflow-y:auto; margin-bottom:10px;">
            <table class="log-table">
                <thead><tr><th>Who</th><th>Date</th><th>Start</th><th>Duration</th></tr></thead>
                <tbody id="front-log-body"></tbody>
            </table>
        </div>
        <button class="btn-action" style="background:#ccc;" onclick="closeModals()">Close</button>
    </div>
</div>

<div id="modal-backpack" class="modal">  
    <div class="modal-card">  
        <h3>Inventory</h3>  
        <p style="font-size:0.7rem; color:#666;">Items placed in Room. Backgrounds apply to SYSTEM.</p>  
        <div id="inventory-grid" style="display:flex; flex-wrap:wrap; gap:10px; justify-content:center; padding:10px; background:#f9f9f9; border-radius:10px; margin-bottom:10px;"></div>  
        <div id="empty-msg" style="text-align:center; color:#999; display:none;">Backpack is empty.<br>Visit Pharmacy.</div>
        <button class="btn-action" style="background:#ff6b6b;" onclick="clearDecor()">üóëÔ∏è Clear Room</button>  
        <button class="btn-action" style="margin-top:5px; background:#ccc;" onclick="closeModals()">Close</button>  
    </div>  
</div>  

<script>  
    // --- STATE ---  
    let DB = {  
        sysName: "SEIREN OS",  
        profiles: [], active: 0, xp: 0, 
        inventory: [], 
        decor: [],   
        cofront: [], 
        frontHistory: [], 
        currentFrontStart: 0, 
        lock: null, channels: { 'gen': {name:'general', msgs:[]} }, curChan: 'gen',  
        diary: [], settings: { crt: true }  
    };  
    let pendingXP = 0; let tempPin = ""; let uploadedAv = ""; let chatImg = "";  
  
    // LOOT TABLE
    const LOOT_ITEMS = [
        "ü©π", "üíä", "üíâ", "ü©∫", "üß∏", "üéÄ", "üßÉ", "üç´", "üçµ", "üå∏", "üçÑ", "‚≠ê", "üí§", "üßº", "üß¥",
        "ü•§", "üç∞", "üçô", "üç¨", "üç≠", "üé®", "ü™Å", "‚òÇÔ∏è", "üéµ", "üì∑", "üí°", "üîÆ", "üßπ", "ü™¥",
        "bg-clouds", "bg-night", "bg-polka", "bg-lines", "bg-grid", "bg-checkers", "bg-sunset", "bg-mint",
        "bg-rainbow", "bg-blueprint", "bg-argyle", "bg-lemon", "bg-pixels", "bg-zigzag", "bg-hearts-tiny",
        "bg-matrix", "bg-lavender", "bg-honey"
    ];  
    const EBI_TALK = ["Thank you!", "I feel better!", "Yummy!", "So cozy!", "Yay!", "Take care!"];  
    const SELF_CARE = ["Drink a glass of water", "Stretch for 2 mins", "Fix your posture", "Take a deep breath", "Look away from screen", "Relax your shoulders", "Eat a snack", "Listen to 1 song"];
    const DEFAULT_AV = "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Crect width='100' height='100' fill='%23f0f0f0'/%3E%3Ccircle cx='50' cy='40' r='20' fill='%23ccc'/%3E%3Cpath d='M20,90 Q50,60 80,90' fill='%23ccc'/%3E%3C/svg%3E";  
    
    const BG_ICONS = {
        'bg-clouds': '‚òÅÔ∏è', 'bg-night': 'üåô', 'bg-polka': '‚ö™', 'bg-lines': 'ü•¢', 'bg-grid': '‚ñ¶',
        'bg-checkers': 'üèÅ', 'bg-sunset': 'üåÖ', 'bg-mint': 'üçÉ', 'bg-rainbow': 'üåà', 'bg-blueprint': 'üìê',
        'bg-argyle': 'üí†', 'bg-lemon': 'üçã', 'bg-pixels': 'üëæ', 'bg-zigzag': '„Ä∞Ô∏è', 'bg-hearts-tiny': 'üíó',
        'bg-matrix': 'üíª', 'bg-lavender': 'ü¶Ñ', 'bg-honey': 'üçØ'
    };

    window.onload = () => {  
        const saved = localStorage.getItem('seiren_fixed_v78'); 
        if(saved) { try { DB = JSON.parse(saved); } catch(e) {} }  
          
        if(DB.profiles.length === 0) {  
            DB.profiles.push({  
                name: "Guest", av: DEFAULT_AV, color: "#ff69b4", id: "GUEST",  
                sign: "-", species: "Visitor", age: "-", height: "-", bio: "Guest Access",
                likes: [], dislikes: [], notes: "" 
            });  
        }  
        // Initialize new fields
        if(!DB.cofront) DB.cofront = [];
        if(!DB.frontHistory) DB.frontHistory = [];
        if(!DB.currentFrontStart) DB.currentFrontStart = Date.now();

        DB.profiles.forEach(p => {
            if(!p.likes) p.likes = [];
            if(!p.dislikes) p.dislikes = [];
            if(!p.notes) p.notes = "";
            if(!p.id) p.id = Math.floor(Math.random()*900000);
        });

        document.getElementById('sys-name-input').value = DB.sysName || "SEIREN OS";  
        document.getElementById('toggle-crt').checked = DB.settings.crt;  
        toggleCRT();  
    };  
  
    function enterSystem() {  
        document.getElementById('welcome-screen').style.display = 'none';  
        if(DB.lock) document.getElementById('lock-screen').style.display='flex';  
        else { document.querySelector('.app-shell').style.display='flex'; refreshAll(); }  
    }  
  
    function refreshAll() { loadUI(); renderChat(); renderDecor(); renderDiary(); renderBio(); }  
    function save() { localStorage.setItem('seiren_fixed_v78', JSON.stringify(DB)); }  
  
    // --- SYSTEM NAME ---  
    function saveSystemName() { DB.sysName = document.getElementById('sys-name-input').value; save(); loadUI(); closeModals(); }  
  
    // --- IMAGES ---  
    function handleFile(inpt, id) {   
        const file = inpt.files[0]; if(!file) return;  
        const reader = new FileReader();  
        reader.onload = (e) => {  
            const img = new Image();
            img.onload = () => {
                const canvas = document.createElement('canvas'); const ctx = canvas.getContext('2d');
                const maxSize = 250; let w = img.width; let h = img.height;
                if (w > h) { if (w > maxSize) { h *= maxSize / w; w = maxSize; } } else { if (h > maxSize) { w *= maxSize / h; h = maxSize; } }
                canvas.width = w; canvas.height = h; ctx.drawImage(img, 0, 0, w, h);
                uploadedAv = canvas.toDataURL('image/jpeg', 0.8);
                document.getElementById(id).src = uploadedAv; 
            };
            img.src = e.target.result;
        };  
        reader.readAsDataURL(file);
        inpt.value = ""; // RESET INPUT
    }  
    function handleChatImage(inpt) {   
        const file = inpt.files[0]; if(!file) return;  
        const reader = new FileReader(); reader.onload = (e) => { chatImg = e.target.result; alert("Image attached!"); }; reader.readAsDataURL(file);  
        inpt.value = ""; // RESET INPUT
    }  
  
    // --- UI & PROFILES ---  
    function loadUI() {  
        const p = DB.profiles[DB.active];  
        document.documentElement.style.setProperty('--main', p.color);  
        document.getElementById('sys-name-display').innerText = DB.sysName;  
        document.getElementById('dash-name').innerText = p.name;  
        document.getElementById('dash-sign').innerText = p.sign||"?";  
        document.getElementById('dash-species').innerText = p.species||"?";  
        document.getElementById('dash-age').innerText = p.age||"?";  
        document.getElementById('dash-height').innerText = p.height||"?";  
        document.getElementById('dash-bio').innerText = p.bio || "No info provided.";  
        document.getElementById('dash-av').src = p.av || DEFAULT_AV;  
        document.getElementById('cp-display').innerText = DB.xp;  
        
        // Co-Front Display
        const coDiv = document.getElementById('cofront-row');
        if (DB.cofront && DB.cofront.length > 0) {
            const names = DB.cofront.map(idx => DB.profiles[idx].name).join(", ");
            document.getElementById('dash-co').innerText = names;
            coDiv.style.display = 'block';
        } else {
            coDiv.style.display = 'none';
        }

        let classes = "";
        if(DB.settings.crt) classes += "fx-active ";
        if(p.wallpaper) classes += p.wallpaper;
        document.body.className = classes;
    }  
  
    function createProfile() {  
        const n = document.getElementById('new-name').value;  
        if(n) {  
            if(DB.profiles[0].id === "GUEST") DB.profiles = [];  
            DB.profiles.push({  
                name:n, color:document.getElementById('new-color').value,   
                av: uploadedAv || DEFAULT_AV,  
                sign:document.getElementById('new-sign').value,   
                species:document.getElementById('new-species').value,   
                age:document.getElementById('new-age').value,  
                height:document.getElementById('new-height').value,  
                bio:document.getElementById('new-bio').value,
                likes: [], dislikes: [], notes: "",  
                id: Math.floor(Math.random()*900000)  
            });  
            uploadedAv = ""; DB.active = DB.profiles.length - 1;  
            save(); closeModals(); refreshAll();  
        }  
    }

    function updateCurrentProfile() {
        if(DB.active < 0 || DB.active >= DB.profiles.length) return;
        const p = DB.profiles[DB.active];
        
        const newName = document.getElementById('new-name').value; if(newName) p.name = newName;
        const newAge = document.getElementById('new-age').value; if(newAge) p.age = newAge;
        const newSign = document.getElementById('new-sign').value; if(newSign) p.sign = newSign;
        const newSpec = document.getElementById('new-species').value; if(newSpec) p.species = newSpec;
        const newH = document.getElementById('new-height').value; if(newH) p.height = newH;
        const newBio = document.getElementById('new-bio').value; if(newBio) p.bio = newBio;
        const newColor = document.getElementById('new-color').value; p.color = newColor;
        if(uploadedAv) { p.av = uploadedAv; uploadedAv = ""; }
        
        save(); closeModals(); refreshAll(); alert("ID Updated!");
    }
  
    function openProfileModal() {  
        document.getElementById('modal-profile').style.display='flex';  
        const p = DB.profiles[DB.active];
        
        document.getElementById('new-name').value = ""; document.getElementById('new-name').placeholder = "Name: " + p.name;
        document.getElementById('new-age').value = ""; document.getElementById('new-age').placeholder = "Age: " + p.age;
        document.getElementById('new-sign').value = ""; document.getElementById('new-sign').placeholder = "Sign: " + p.sign;
        document.getElementById('new-species').value = ""; document.getElementById('new-species').placeholder = "Species: " + p.species;
        document.getElementById('new-height').value = ""; document.getElementById('new-height').placeholder = "Height: " + p.height;
        document.getElementById('new-bio').value = ""; document.getElementById('new-bio').placeholder = "Bio: " + p.bio;
        document.getElementById('new-color').value = p.color;
        document.getElementById('av-preview').src = p.av || DEFAULT_AV;

        const list = document.getElementById('prof-list'); list.innerHTML="";  
        DB.profiles.forEach((p,i)=>{  
            list.innerHTML += `<div style="padding:10px; border-bottom:1px solid #eee; display:flex; justify-content:space-between; align-items:center;">  
                <b>${p.name}</b>  
                <div>  
                    <button style="margin-right:5px; font-size:0.8rem;" onclick="addToCofront(${i})">+ Co-Con</button>
                    <button onclick="switchProfile(${i})">Switch</button>  
                    ${i!==0 ? `<button style="color:red; margin-left:5px;" onclick="if(confirm('Delete?')){DB.profiles.splice(${i},1); DB.active=0; save(); openProfileModal();}">x</button>` : ''}  
                </div>  
            </div>`;  
        });  
    }  

    // --- SWITCH, CO-FRONT, AND LOGGING ---
    function switchProfile(index) {
        logSwitch(DB.active); // Log the session ending
        DB.active = index;
        DB.cofront = []; // Clear co-front when switching main
        save(); refreshAll(); closeModals();
    }

    function addToCofront(index) {
        if (!DB.cofront) DB.cofront = [];
        if (index === DB.active) { alert("Already fronting!"); return; }
        if (DB.cofront.includes(index)) { alert("Already co-fronting!"); return; }
        DB.cofront.push(index);
        save(); refreshAll(); 
        alert(DB.profiles[index].name + " added to Co-Con!");
    }

    // --- FRONT LOGIC ---
    function logSwitch(oldIndex) {
        if (!DB.currentFrontStart) { DB.currentFrontStart = Date.now(); return; }
        
        const now = Date.now();
        const diff = now - DB.currentFrontStart;
        
        // Format Duration
        const minutes = Math.floor(diff / 60000);
        const hours = Math.floor(minutes / 60);
        const displayTime = (hours > 0 ? hours + "h " : "") + (minutes % 60) + "m";

        const p = DB.profiles[oldIndex];
        
        // Add to history
        DB.frontHistory.unshift({
            n: p.name,
            d: new Date(DB.currentFrontStart).toLocaleDateString(),
            t: new Date(DB.currentFrontStart).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}),
            dur: displayTime || "<1m"
        });
        
        // Cap history at 50 items
        if (DB.frontHistory.length > 50) DB.frontHistory.pop();

        DB.currentFrontStart = now;
    }

    function openLogModal() {
        document.getElementById('modal-log').style.display = 'flex';
        const tbody = document.getElementById('front-log-body');
        tbody.innerHTML = "";
        DB.frontHistory.forEach(entry => {
            tbody.innerHTML += `<tr><td><b>${entry.n}</b></td><td>${entry.d}</td><td>${entry.t}</td><td>${entry.dur}</td></tr>`;
        });
    }

    // --- BIO TAB LOGIC ---
    function renderBio() {
        const p = DB.profiles[DB.active];
        if(!p.likes) p.likes=[]; if(!p.dislikes) p.dislikes=[]; if(!p.notes) p.notes="";

        const likesList = document.getElementById('likes-list'); likesList.innerHTML = "";
        p.likes.forEach((l, i) => { likesList.innerHTML += `<div class="bio-tag">${l} <span onclick="removeBioItem('likes',${i})">x</span></div>`; });

        const dislikesList = document.getElementById('dislikes-list'); dislikesList.innerHTML = "";
        p.dislikes.forEach((l, i) => { dislikesList.innerHTML += `<div class="bio-tag" style="background:#555;">${l} <span onclick="removeBioItem('dislikes',${i})">x</span></div>`; });

        document.getElementById('notes-in').value = p.notes;
    }
    function addBioItem(type) {
        const inputId = type === 'likes' ? 'like-in' : 'dislike-in';
        const val = document.getElementById(inputId).value;
        if(val) { DB.profiles[DB.active][type].push(val); document.getElementById(inputId).value = ""; save(); renderBio(); }
    }
    function removeBioItem(type, index) { DB.profiles[DB.active][type].splice(index, 1); save(); renderBio(); }
    function saveBioNotes() { DB.profiles[DB.active].notes = document.getElementById('notes-in').value; save(); }
  
    // --- CHAT ---  
    function toggleSidebar() { document.getElementById('chan-list').classList.toggle('hidden'); const btn = document.querySelector('.sidebar-toggle'); btn.innerText = btn.innerText === '<' ? '>' : '<'; }  
    function renderChat() {  
        const list = document.getElementById('chan-list'); list.innerHTML="";  
        Object.keys(DB.channels).forEach(k => {  
            const div = document.createElement('div'); div.className = `chan-btn ${DB.curChan===k?'active':''}`;  
            div.innerText = DB.channels[k].name.substring(0,2).toUpperCase(); div.onclick = () => { DB.curChan=k; renderChat(); };  
            if(k!=='gen') { const del = document.createElement('div'); del.className='del-chan'; del.innerText='x'; div.appendChild(del); del.onclick=(e)=>{e.stopPropagation(); if(confirm("Delete?")){ delete DB.channels[k]; DB.curChan='gen'; save(); renderChat(); }}; }  
            list.appendChild(div);  
        });  
        const add = document.createElement('div'); add.className='chan-btn'; add.style.background='#4fc3f7'; add.style.color='white'; add.innerText='+';  
        add.onclick = () => { const n=prompt("Name:"); if(n){ const id=n.toLowerCase().replace(/\s/g,''); DB.channels[id]={name:n, msgs:[]}; save(); renderChat(); }};  
        list.appendChild(add);  
        const c = DB.channels[DB.curChan]; document.getElementById('chan-title').innerText = "#" + c.name;  
        const feed = document.getElementById('chat-feed'); feed.innerHTML="";  
        c.msgs.forEach(m => { 
            const imgHTML = m.img ? `<img src="${m.img}" class="pk-img">` : ''; 
            feed.innerHTML += `
            <div class="pk-msg">
                <img src="${m.av}" class="pk-av" style="background:${m.color}">
                <div>
                    <div class="pk-name" style="color:${m.color}">${m.name} <span style="color:#aaa; font-size:0.7em;">${m.time||''}</span></div>
                    <div class="pk-txt">${m.txt}${imgHTML}</div>
                </div>
            </div>`; 
        });  
        feed.scrollTop = feed.scrollHeight;  
    }  
    function sendMsg() {  
        const i = document.getElementById('msg-in'); if(!i.value && !chatImg) return;  
        const p = DB.profiles[DB.active];  
        const time = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        DB.channels[DB.curChan].msgs.push({ name:p.name, av:p.av, color:p.color, txt:i.value, img:chatImg, time:time });  
        i.value=""; chatImg=""; save(); renderChat();  
    }  
  
    // --- DECOR ---  
    function renderDecor() {  
        const l = document.getElementById('decor-layer'); l.innerHTML="";   
        DB.decor.forEach(d => {  
            const el = document.createElement('div'); el.className='sticker'; el.innerText=d.i;  
            el.style.left=d.x+"%"; el.style.top=d.y+"%";  
            let isDrag=false;  
            const move = (e) => { if(!isDrag)return; const b=document.getElementById('pet-stage').getBoundingClientRect(); const cx=e.touches?e.touches[0].clientX:e.clientX; const cy=e.touches?e.touches[0].clientY:e.clientY; d.x=((cx-b.left)/b.width)*100; d.y=((cy-b.top)/b.height)*100; el.style.left=d.x+"%"; el.style.top=d.y+"%"; };  
            const end = () => { if(isDrag){isDrag=false; save();} };  
            el.onmousedown=()=>{isDrag=true}; el.ontouchstart=()=>{isDrag=true};  
            window.addEventListener('mousemove', move); window.addEventListener('touchmove', move, {passive:false}); window.addEventListener('mouseup', end); window.addEventListener('touchend', end);  
            l.appendChild(el);  
        });  
    }  
    
    // --- FIXED BACKPACK (STACKING LOGIC) ---
    function openBackpack() {  
        document.getElementById('modal-backpack').style.display='flex';  
        const g = document.getElementById('inventory-grid'); g.innerHTML="";  
        if(DB.inventory.length === 0) document.getElementById('empty-msg').style.display='block'; else document.getElementById('empty-msg').style.display='none';

        // Add "Clear Wallpaper" option
        const clearBtn = document.createElement('div'); 
        clearBtn.style.fontSize="1.5rem"; clearBtn.innerText="üö´"; 
        clearBtn.style.border="2px dashed red"; clearBtn.style.padding="10px"; clearBtn.style.borderRadius="10px"; clearBtn.style.cursor="pointer";
        clearBtn.onclick = () => { DB.profiles[DB.active].wallpaper = ""; save(); refreshAll(); alert("Wallpaper Removed"); };
        g.appendChild(clearBtn);

        // 1. COUNT ITEMS
        const counts = {};
        DB.inventory.forEach(x => { counts[x] = (counts[x] || 0) + 1; });

        // 2. SORT AND DISPLAY UNIQUE ITEMS
        const uniqueItems = Object.keys(counts).sort((a,b) => { 
            const aBg = a.startsWith('bg-'); const bBg = b.startsWith('bg-'); 
            return aBg === bBg ? 0 : aBg ? 1 : -1; 
        });

        uniqueItems.forEach(item => {  
            const b = document.createElement('div'); 
            b.style.fontSize="2.5rem"; 
            b.style.cursor="pointer"; 
            b.style.position="relative"; // For badge positioning
            
            // Display Count Badge if > 1
            let badge = "";
            if(counts[item] > 1 && !item.startsWith('bg-')) {
                badge = `<span style="position:absolute; bottom:0; right:0; background:red; color:white; font-size:0.6rem; padding:2px 5px; border-radius:10px;">x${counts[item]}</span>`;
            }
            
            if(item.startsWith('bg-')) {  
                let icon = BG_ICONS[item] || "üñºÔ∏è"; 
                b.style.fontSize="1.5rem"; b.innerHTML=icon; 
                b.style.border="2px solid pink"; b.style.padding="10px"; b.style.borderRadius="10px";
                b.onclick = () => { DB.profiles[DB.active].wallpaper = item; save(); refreshAll(); alert("Wallpaper Applied!"); };  
            } else {  
                b.innerHTML = item + badge; // Add icon and badge
                b.onclick = () => { 
                    DB.decor.push({i:item, x:50, y:50}); 
                    // Remove ONE instance of this item
                    const realIndex = DB.inventory.indexOf(item); 
                    if(realIndex > -1) DB.inventory.splice(realIndex, 1); 
                    save(); closeModals(); nav('pet'); 
                };  
            }  
            g.appendChild(b);  
        });  
    }  

    // --- FIXED CLEAR DECOR (RETURN TO BACKPACK) ---
    function clearDecor(){ 
        // Iterate through decor and push items back to inventory
        DB.decor.forEach(d => {
            DB.inventory.push(d.i);
        });
        DB.decor=[]; 
        save(); 
        renderDecor(); 
        closeModals(); 
        alert("Items returned to Backpack!");
    }  
  
    // --- PHARMACY ---  
    function logMood(i,p) { document.getElementById('receipt-list').innerHTML += `<div>${i} ... ${p} XP</div>`; pendingXP+=p; }  
    function processReceipt() { if(pendingXP>0){ DB.xp+=pendingXP; const task = SELF_CARE[Math.floor(Math.random()*SELF_CARE.length)]; alert(`‚úÖ Receipt Processed\n\n+${pendingXP} XP\n\n‚ú® Self Care Task:\n"${task}"`); pendingXP=0; document.getElementById('receipt-list').innerHTML=""; save(); loadUI(); } }  
    function fillPrescription() {   
        if(DB.xp>=50){   
            DB.xp-=50; let item = ""; let attempts = 0;
            do { item = LOOT_ITEMS[Math.floor(Math.random()*LOOT_ITEMS.length)]; attempts++; if (item.startsWith('bg-') && DB.inventory.includes(item)) { item = "DUPE"; } } while (item === "DUPE" && attempts < 10);
            if (item === "DUPE") { const consumables = LOOT_ITEMS.filter(i => !i.startsWith('bg-')); item = consumables[Math.floor(Math.random()*consumables.length)]; }
            DB.inventory.push(item);  
            const speech = EBI_TALK[Math.floor(Math.random()*EBI_TALK.length)]; const bub = document.getElementById('pet-speech'); bub.innerText = speech; bub.classList.add('show'); setTimeout(()=>bub.classList.remove('show'), 2000);  
            let msg = `Rx Filled!\n\nReceived: ${item}`; if(item.startsWith('bg-')) { const icon = BG_ICONS[item] || "üñºÔ∏è"; msg += `\n(New System Wallpaper! Look for ${icon})`; } alert(msg); save(); loadUI();   
        } else alert("Need 50 XP");   
    }  
  
    // --- MISC & PRIVATE DIARY ---  
    function toggleCRT() { DB.settings.crt = document.getElementById('toggle-crt').checked; loadUI(); save(); }  
    function enterPin(n) { tempPin+=n; document.getElementById('pin-dots').innerText="*".repeat(tempPin.length); if(tempPin.length===4){ if(tempPin===DB.lock){ document.getElementById('lock-screen').style.display='none'; document.querySelector('.app-shell').style.display='flex'; refreshAll(); } else { tempPin=""; document.getElementById('pin-dots').innerText="ERR"; }}}  
    function clearPin(){ tempPin=""; document.getElementById('pin-dots').innerText=""; }  
    function setLock(){ const p=document.getElementById('pin-set').value; if(p.length===4){ DB.lock=p; save(); alert("Locked!"); closeModals(); }}  
    function disableLock(){ if(confirm("Remove?")){ DB.lock=null; save(); alert("Removed"); closeModals(); }}  
    function exportData() { const a=document.createElement('a'); a.href="data:text/json;charset=utf-8,"+encodeURIComponent(JSON.stringify(DB)); a.download="seiren_bk.json"; document.body.appendChild(a); a.click(); a.remove(); }  
    function importData(input) { const file = input.files[0]; if(!file) return; const reader = new FileReader(); reader.onload=(e)=>{ try { const json = JSON.parse(e.target.result); DB = json; save(); alert("Backup Loaded Successfully!"); location.reload(); } catch(x) { alert("Error: Invalid Backup File."); console.error(x); } }; reader.readAsText(file); input.value=""; }  
    
    function importPluralKit(input) {
        const file = input.files[0]; if(!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                const json = JSON.parse(e.target.result);
                let members = json.members || json; if (!Array.isArray(members)) throw new Error("Invalid PK file");
                let count = 0;
                members.forEach(m => {
                    if (!DB.profiles.some(p => p.name === m.name)) {
                        DB.profiles.push({
                            name: m.name || "Unknown", av: m.avatar_url || DEFAULT_AV, sign: m.pronouns || "?", age: m.birthday || "--", species: "System Member", height: "--", bio: m.description || "Imported from PluralKit", color: m.color ? "#"+m.color : "#ff69b4", id: m.id || Math.floor(Math.random()*900000), likes: [], dislikes: [], notes: ""
                        }); count++;
                    }
                });
                save(); alert(`Successfully imported ${count} members from PluralKit!`); refreshAll();
            } catch(err) { alert("Error importing PK file. Make sure it is a valid system.json export."); console.error(err); }
        };
        reader.readAsText(file);
        input.value="";
    }

    function nav(id) { document.querySelectorAll('.page').forEach(p=>p.classList.remove('active')); document.getElementById('page-'+id).classList.add('active'); document.querySelectorAll('.dock-btn').forEach(b=>b.classList.remove('active')); if(id==='pet')renderDecor(); if(id==='chat')renderChat(); if(id==='diary')renderDiary(); if(id==='about')renderBio(); }  
    
    function postDiary() { const t=document.getElementById('diary-in'); if(t.value){ DB.diary.unshift({d:new Date().toLocaleDateString(), n:DB.profiles[DB.active].name, uid: DB.profiles[DB.active].id, t:t.value}); t.value=""; save(); renderDiary(); } }  
    function renderDiary() { const f=document.getElementById('diary-feed'); f.innerHTML=""; const currentID = DB.profiles[DB.active].id; const myEntries = DB.diary.filter(e => e.uid === currentID || !e.uid); myEntries.forEach((e,i)=>{ f.innerHTML+=`<div class="diary-entry"><div class="del-diary" onclick="if(confirm('Del?')){DB.diary.splice(${DB.diary.indexOf(e)},1);save();renderDiary();}">x</div><small>${e.d} ‚Ä¢ ${e.n}</small><div style="white-space:pre-wrap;">${e.t}</div></div>`; }); }  
    
    function closeModals() { document.querySelectorAll('.modal').forEach(m=>m.style.display='none'); }  
    function openSettingsModal() { document.getElementById('modal-settings').style.display='flex'; }  
  
    // --- FORCE NUKE SW ---
    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.getRegistrations().then(function(registrations) { for(let registration of registrations) { registration.unregister(); } });
    }
</script>  
</body>  
</html>

