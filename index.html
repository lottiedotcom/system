<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#ff69b4">
    <title>Seiren OS</title>
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/2919/2919573.png">
    <link rel="icon" type="image/png" href="https://cdn-icons-png.flaticon.com/512/2919/2919573.png">

    <style>
        /* --- DYNAMIC THEME VARIABLES --- */
        :root {
            /* Default Pink Theme */
            --main: #ff69b4;
            --bg: #ffe4e1;
            --dark: #d12e87;
            --glass: rgba(255, 255, 255, 0.9);
            --text: #555;
        }

        body {
            font-family: 'Verdana', sans-serif;
            background-color: var(--bg);
            /* Dynamic Background Pattern */
            background-image: 
                linear-gradient(45deg, var(--main) 25%, transparent 25%, transparent 75%, var(--main) 75%, var(--main)),
                linear-gradient(45deg, var(--main) 25%, transparent 25%, transparent 75%, var(--main) 75%, var(--main));
            background-position: 0 0, 10px 10px;
            background-size: 20px 20px;
            /* Fade effect when switching themes */
            transition: background-color 0.5s ease;
            margin: 0; display: flex; justify-content: center; height: 100vh; overflow: hidden;
            color: var(--text); overscroll-behavior: none;
        }

        /* --- WELCOME SCREEN --- */
        #welcome-layer {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: linear-gradient(135deg, var(--bg), #fff);
            z-index: 9999; display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            transition: opacity 0.5s ease-out;
        }
        .welcome-card {
            background: rgba(255,255,255,0.9); padding: 40px; border-radius: 40px;
            border: 6px solid white; box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            text-align: center; backdrop-filter: blur(5px);
            animation: float 3s ease-in-out infinite;
        }
        @keyframes float { 0%, 100% {transform: translateY(0);} 50% {transform: translateY(-10px);} }
        
        .enter-btn {
            background: var(--main);
            color: white; border: 4px solid white; padding: 15px 40px; border-radius: 50px;
            font-size: 1.3rem; font-weight: bold; cursor: pointer;
            box-shadow: 0 5px 15px rgba(0,0,0,0.15); 
            transition: transform 0.1s; text-transform: uppercase; letter-spacing: 2px;
            margin-top: 25px; display: inline-block;
        }
        .enter-btn:active { transform: scale(0.95); }

        /* --- APP SHELL --- */
        .app-shell {
            width: 100%; max-width: 480px; background: var(--glass);
            display: none; flex-direction: column; position: relative; height: 100%;
            box-shadow: 0 0 50px rgba(0,0,0,0.1); z-index: 10;
        }

        .scanlines {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.02) 50%);
            background-size: 100% 4px; pointer-events: none; z-index: 998;
        }

        .status-bar {
            display: flex; justify-content: space-between; padding: 12px 20px;
            font-size: 0.8rem; font-weight: bold; color: var(--dark);
            background: rgba(255,255,255,0.6); backdrop-filter: blur(5px);
        }

        .content {
            flex: 1; overflow-y: auto; overflow-x: hidden;
            padding: 20px; padding-bottom: 120px; scroll-behavior: smooth;
        }
        .page { display: none; animation: slideUp 0.3s ease; }
        .page.active { display: block; }
        @keyframes slideUp { from {opacity:0; transform:translateY(15px);} to {opacity:1; transform:translateY(0);} }

        /* DASHBOARD */
        .dash-header { text-align: center; margin-bottom: 20px; }
        .dash-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px; }
        .dash-btn {
            background: white; border-radius: 20px; padding: 15px; text-align: center;
            box-shadow: 0 4px 10px rgba(0,0,0,0.05); cursor: pointer; transition: 0.1s;
            border: 2px solid white;
        }
        .dash-btn:active { transform: scale(0.95); border-color: var(--main); }
        .dash-icon { font-size: 2rem; display: block; margin-bottom: 5px; }

        /* FRONT LOG WIDGET (NEW) */
        .front-log-widget {
            background: white; border: 2px dashed var(--main); border-radius: 15px;
            padding: 10px; margin-bottom: 20px;
        }
        .log-entry-mini {
            display: flex; justify-content: space-between; font-size: 0.75rem; 
            padding: 5px 0; border-bottom: 1px dotted #eee;
        }

        /* ID CARD (INTRICATE) */
        .id-card-wrap {
            background: white; border: 3px solid var(--main); border-radius: 20px;
            padding: 5px; box-shadow: 5px 5px 0 rgba(0,0,0,0.1);
            margin-bottom: 20px; position: relative; overflow: hidden;
        }
        .id-inner {
            background: var(--bg);
            background-image: repeating-linear-gradient(45deg, transparent, transparent 10px, rgba(255,255,255,0.5) 10px, rgba(255,255,255,0.5) 20px);
            border: 2px dashed var(--dark); border-radius: 15px; padding: 15px;
        }
        .id-body { display: flex; gap: 15px; align-items: center; }
        .id-photo { 
            width: 80px; height: 80px; border-radius: 50%; border: 4px solid white; 
            outline: 3px solid var(--main); object-fit: cover; background: white;
        }
        .id-stats-grid {
            display: grid; grid-template-columns: 1fr 1fr; gap: 5px; font-size: 0.7rem;
            background: rgba(255,255,255,0.7); padding: 5px; border-radius: 5px; margin-top:5px;
        }
        .stat-label { color: var(--main); font-weight: bold; }

        /* BBS / CHAT (NEW) */
        .bbs-container {
            background: white; border: 2px solid var(--main); border-radius: 15px;
            height: 400px; display: flex; flex-direction: column; overflow: hidden;
        }
        .bbs-messages { flex: 1; overflow-y: auto; padding: 10px; background: #f9f9f9; }
        .bbs-msg { 
            background: white; padding: 8px 12px; border-radius: 10px; margin-bottom: 8px;
            box-shadow: 1px 1px 3px rgba(0,0,0,0.05); font-size: 0.85rem;
            border-left: 4px solid #ddd;
        }
        .bbs-meta { font-size: 0.65rem; color: #999; margin-bottom: 2px; display: flex; justify-content: space-between; }
        .bbs-input-area { padding: 10px; background: white; border-top: 1px solid #eee; display: flex; gap: 5px; }

        /* GLOBAL UI */
        input, select { width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 15px; box-sizing: border-box; font-family:inherit; margin-bottom: 10px; outline:none; }
        input:focus { border-color: var(--main); background: #fff; }
        
        .btn-main {
            background: var(--main); color: white; border: none; padding: 12px; width: 100%;
            border-radius: 25px; font-weight: bold; cursor: pointer; box-shadow: 0 4px 0 rgba(0,0,0,0.2);
        }
        .btn-main:active { transform: translateY(4px); box-shadow: none; }

        .modal-overlay {
            position: fixed; top:0; left:0; right:0; bottom:0; background: rgba(0,0,0,0.6); z-index: 2000;
            display: none; align-items: center; justify-content: center; backdrop-filter: blur(2px);
        }
        .modal-box {
            background: white; width: 85%; max-width: 400px; border-radius: 25px; 
            border: 4px solid var(--main); padding: 20px; max-height: 80vh; overflow-y: auto;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3); animation: slideUp 0.3s;
        }

        /* SLOT CARD (UNLIMITED) */
        .slot-card {
            background: #fff; border: 2px solid #eee; border-radius: 12px; padding: 10px; 
            margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center;
        }
        .slot-card.active-slot { border-color: var(--main); background: var(--bg); }

        nav {
            position: fixed; bottom: 20px; left: 20px; right: 20px;
            background: rgba(255,255,255,0.95); border-radius: 40px;
            display: flex; justify-content: space-around; padding: 15px 0;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1); z-index: 100; border: 2px solid white;
        }
        .nav-btn { background: none; border: none; color: #ccc; font-size: 1.5rem; transition: 0.2s; }
        .nav-btn.active { color: var(--main); transform: scale(1.2); }

        /* Helper for other tabs */
        .corkboard { background: #e6d7c3; border: 5px solid #8b5a2b; border-radius: 10px; padding: 15px; min-height: 400px; }
        .polaroid { background: white; padding: 6px; text-align: center; margin-bottom:10px; transform: rotate(-1deg); box-shadow: 2px 2px 5px rgba(0,0,0,0.2); }
        .polaroid img { width: 100%; aspect-ratio: 1/1; object-fit: cover; border: 1px solid #ccc; }
        .pet-box { background: white; border: 3px solid var(--main); border-radius: 20px; padding: 20px; text-align: center; }
        .ebi-img { width: 120px; animation: bounce 2s infinite; }
        @keyframes bounce { 0%, 100% {transform:translateY(0);} 50% {transform:translateY(-8px);} }
        .task-item.completed { text-decoration: line-through; color: #aaa; opacity: 0; transform: translateX(50px); }
        .toast { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background: #333; color: white; padding: 10px 20px; border-radius: 20px; font-size: 0.8rem; opacity: 0; transition: 0.3s; z-index: 9999; }
        .toast.show { opacity: 1; top: 30px; }

    </style>
</head>
<body>

<div class="scanlines"></div>
<div id="toast" class="toast">üíæ Saved!</div>

<div id="welcome-layer">
    <div class="welcome-card">
        <div style="font-size:4rem; margin-bottom:10px;">üéÄ</div>
        <h1 style="color:var(--dark); margin:0; letter-spacing:2px;">SEIREN OS</h1>
        <p style="color:#888; font-size:0.8rem; margin-bottom:20px;">System Companion v24.0</p>
        <button class="enter-btn" onclick="enterApp()">Enter World ‚ô°</button>
    </div>
</div>

<div class="app-shell" id="main-app">
    
    <div class="status-bar">
        <span id="clock">12:00</span>
        <span>üîã 100%</span>
    </div>

    <div class="content">

        <div id="tab-dash" class="page active">
            
            <div id="setup-view" style="text-align:center; padding:30px; display:none;">
                <h2 style="color:var(--main);">New System?</h2>
                <p>Register your first member.</p>
                <input type="text" id="setup-name" placeholder="Name">
                <input type="number" id="setup-age" placeholder="Age">
                <button class="btn-main" onclick="initFirstProfile()">Create ID</button>
            </div>

            <div id="dash-view" style="display:none;">
                <div class="dash-header">
                    <h2 style="margin:0; color:var(--dark);" id="dash-greet">Hello!</h2>
                    <span style="font-size:0.8rem; color:#888;">Welcome back to Seiren.</span>
                </div>

                <div class="id-card-wrap">
                    <div class="id-inner">
                        <div class="deco-bow">üéÄ</div>
                        <div class="id-top">
                            <span style="font-size:0.7rem; font-weight:bold; color:var(--dark);">SEIREN GOV</span>
                            <span style="font-size:0.6rem; color:#aaa; font-weight:bold;">ID CARD</span>
                        </div>
                        <div class="id-body">
                            <img id="id-pic" class="id-photo" src="" onclick="rotateAvatar()">
                            <div class="id-data">
                                <div id="id-name" style="font-size:1.3rem; font-weight:bold; color:var(--dark); line-height:1;">User</div>
                                <div id="id-real" style="font-size:0.7rem; font-style:italic; color:#888; margin-bottom:8px;">aka ???</div>
                                <div class="id-stats-grid">
                                    <span><b>ID:</b> <span id="id-num">000</span></span>
                                    <span><b>Sign:</b> <span id="id-sign">?</span></span>
                                    <span><b>Eyes:</b> <span id="id-eyes">?</span></span>
                                    <span><b>Hair:</b> <span id="id-hair">?</span></span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="dash-grid">
                    <div class="dash-btn" onclick="openProfileManager()">
                        <span class="dash-icon">üë•</span>
                        <span>Profiles</span>
                    </div>
                    <div class="dash-btn" onclick="openRegistry()">
                        <span class="dash-icon">üìñ</span>
                        <span>Registry</span>
                    </div>
                </div>

                <div class="front-log-widget">
                    <strong style="color:var(--main); font-size:0.8rem;">Recent Activity</strong>
                    <div id="mini-log"></div>
                </div>

                <div style="text-align:center; background:white; padding:15px; border-radius:20px; box-shadow:0 5px 15px rgba(0,0,0,0.05);">
                    <div style="font-size:2.5rem;" id="fortune-icon">?</div>
                    <strong style="color:var(--main);" id="fortune-title">Daily Fortune</strong>
                    <button class="btn-main" style="width:auto; padding:8px 20px; font-size:0.8rem; margin-top:10px;" onclick="drawFortune()">Draw Card</button>
                </div>
            </div>
        </div>

        <div id="tab-bbs" class="page">
            <h2 style="color:var(--main);">System BBS</h2>
            <div class="bbs-container">
                <div class="bbs-messages" id="bbs-feed"></div>
                <div class="bbs-input-area">
                    <input type="text" id="bbs-input" placeholder="Message..." style="margin:0;">
                    <button class="btn-main" style="width:auto; padding:10px;" onclick="postBBS()">Send</button>
                </div>
            </div>
        </div>

        <div id="tab-tools" class="page">
            <h2 style="color:var(--main);">Tools</h2>
            
            <div class="pet-box" style="margin-bottom:20px;">
                <img src="https://cdn-icons-png.flaticon.com/512/3069/3069172.png" class="ebi-img">
                <h3>Ebi</h3>
                <div style="background:#eee; height:12px; border-radius:10px; overflow:hidden; margin:10px 0;">
                    <div id="pet-bar" style="width:50%; height:100%; background:var(--main);"></div>
                </div>
                <button class="btn-main" style="width:auto; font-size:0.8rem; padding:8px;" onclick="feedPet()">Feed Snack</button>
            </div>

            <div class="corkboard">
                <div id="wish-list"></div>
                <div style="text-align:center; margin-top:20px;">
                    <button class="btn-main" style="width:50px; height:50px; border-radius:50%; font-size:1.5rem;" onclick="openWishModal()">+</button>
                </div>
            </div>
        </div>

    </div>

    <div id="modal-profiles" class="modal-overlay">
        <div class="modal-box">
            <h3 style="margin-top:0; color:var(--main);">Select Fronter</h3>
            <div id="profile-list" style="max-height:200px; overflow-y:auto; margin-bottom:15px;"></div>
            
            <div style="border-top:2px dashed #eee; padding-top:10px;">
                <h4 style="margin:0 0 10px 0;">New Identity</h4>
                <input type="text" id="new-p-name" placeholder="Name">
                <input type="number" id="new-p-age" placeholder="Age">
                <label style="font-size:0.8rem; font-weight:bold;">Theme Color:</label>
                <input type="color" id="new-p-color" value="#ff69b4" style="height:40px; padding:0; border:none; width:100%;">
                <button class="btn-main" onclick="addProfile()">Create</button>
            </div>
            <button class="btn-main" style="background:#ccc; margin-top:10px; box-shadow:none;" onclick="closeModals()">Close</button>
        </div>
    </div>

    <div id="modal-wish" class="modal-overlay">
        <div class="modal-box">
            <h3>New Wish</h3>
            <input type="text" id="w-name" placeholder="Item Name">
            <input type="text" id="w-img" placeholder="Image Link">
            <button class="btn-main" onclick="submitWish()">Pin It</button>
            <button class="btn-main" style="background:#ccc; margin-top:10px;" onclick="closeModals()">Close</button>
        </div>
    </div>

    <nav>
        <button class="nav-btn active" onclick="go('dash', this)">üè†</button>
        <button class="nav-btn" onclick="go('bbs', this)">üí¨</button>
        <button class="nav-btn" onclick="go('tools', this)">üéí</button>
    </nav>

</div>

<script>
    // --- ASSETS ---
    const AVATARS = [
        "https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcRzYjS4GrT6U0nmcao3A-UnuzLyeh-2UR3jloaiM4z7_A&s=10",
        "https://upload.wikimedia.org/wikipedia/commons/4/43/Chara04.png",
        "https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcTDNRg8thRPLTkTTKHsN1GxIk8WWQuawgwJcJalTTxhbNf339y17tzoxbmI&s=10",
        "https://static.wikia.nocookie.net/aesthetics/images/0/04/Luckystarmoe.png/revision/latest?cb=20230827221913"
    ];

    // --- STATE ---
    // Note: profiles is now an array of objects, NO LIMIT
    let DB = {
        profiles: [], // Dynamic array
        activeIdx: 0,
        xp: 0, lvl: 1,
        wish: [], pet: {hunger:50}, 
        bbs: [], // System Chat
        frontLog: [] // History
    };

    // --- INIT ---
    window.addEventListener('load', () => {
        const saved = localStorage.getItem('seiren_v24');
        if(saved) DB = JSON.parse(saved);
        
        // MIGRATION: Convert old null array to empty array if needed
        if(DB.profiles.length === 5 && DB.profiles[0] === null) DB.profiles = [];

        setInterval(() => {
            const d = new Date();
            document.getElementById('clock').innerText = d.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
        }, 1000);
    });

    function enterApp() {
        document.getElementById('welcome-layer').style.opacity = '0';
        setTimeout(() => {
            document.getElementById('welcome-layer').style.display = 'none';
            document.getElementById('main-app').style.display = 'flex';
            setTimeout(() => {
                document.getElementById('main-app').style.opacity = '1';
                if(DB.profiles.length > 0) {
                    applyTheme(DB.profiles[DB.activeIdx]);
                    document.getElementById('dash-view').style.display = 'block';
                    refreshUI();
                } else {
                    document.getElementById('setup-view').style.display = 'block';
                }
            }, 50);
        }, 500);
    }

    function save() {
        localStorage.setItem('seiren_v24', JSON.stringify(DB));
        const t = document.getElementById('toast');
        t.classList.add('show');
        setTimeout(() => t.classList.remove('show'), 1000);
    }

    // --- THEME ENGINE ---
    function applyTheme(user) {
        if(!user) return;
        const color = user.color || "#ff69b4";
        const root = document.documentElement;
        
        root.style.setProperty('--pink', color);
        root.style.setProperty('--main', color);
        root.style.setProperty('--dark', adjustColor(color, -40));
        root.style.setProperty('--pastel-pink', adjustColor(color, 160)); // Very light version
        root.style.setProperty('--bg', adjustColor(color, 160));
    }

    function adjustColor(col, amt) {
        var usePound = false;
        if (col[0] == "#") { col = col.slice(1); usePound = true; }
        var num = parseInt(col,16);
        var r = (num >> 16) + amt;
        if (r > 255) r = 255; else if  (r < 0) r = 0;
        var b = ((num >> 8) & 0x00FF) + amt;
        if (b > 255) b = 255; else if  (b < 0) b = 0;
        var g = (num & 0x0000FF) + amt;
        if (g > 255) g = 255; else if (g < 0) g = 0;
        return (usePound?"#":"") + (g | (b << 8) | (r << 16)).toString(16);
    }

    // --- LOGIC ---
    function genID(name, age, color) {
        const seed = name.length + parseInt(age||0);
        return {
            name: ["Mi","Lu","Fa","Ko"][seed%4] + ["chan","ren","la"][seed%3],
            realName: name, age: age,
            color: color || "#ff69b4",
            id: Math.floor(Math.random()*9000)+1000,
            sign: ["Aries","Leo","Virgo","Pisces"][seed%4],
            eyes: ["Pink","Blue","Gold","Red"][seed%4],
            hair: ["Twin","Long","Bob","Short"][seed%4],
            wgt: ["3 Apples","Feather","45kg"][seed%3],
            hgt: (140+(seed%30))+"cm",
            av: seed % AVATARS.length
        };
    }

    function initFirstProfile() {
        const n = document.getElementById('setup-name').value;
        const a = document.getElementById('setup-age').value;
        if(!n) return;
        DB.profiles.push(genID(n, a, "#ff69b4"));
        DB.activeIdx = 0;
        save();
        document.getElementById('setup-view').style.display='none';
        document.getElementById('dash-view').style.display='block';
        refreshUI();
    }

    function refreshUI() {
        // ID Card
        const u = DB.profiles[DB.activeIdx];
        if(u) {
            document.getElementById('dash-greet').innerText = `Hello, ${u.realName}`;
            document.getElementById('id-name').innerText = u.name;
            document.getElementById('id-real').innerText = `aka ${u.realName}`;
            document.getElementById('id-num').innerText = u.id;
            document.getElementById('id-sign').innerText = u.sign;
            document.getElementById('id-eyes').innerText = u.eyes;
            document.getElementById('id-hair').innerText = u.hair;
            document.getElementById('id-pic').src = AVATARS[u.av % AVATARS.length];
        }
        // XP
        document.getElementById('lvl-num').innerText = DB.lvl;
        document.getElementById('xp-val').innerText = DB.xp;
        document.getElementById('xp-bar').style.width = DB.xp + "%";
        
        // Log
        const mini = document.getElementById('mini-log');
        mini.innerHTML = "";
        DB.frontLog.slice(0, 3).forEach(l => {
            mini.innerHTML += `<div class="log-entry-mini"><span>${l.name}</span><span>${l.time}</span></div>`;
        });

        // Wish
        const wList = document.getElementById('wish-list'); wList.innerHTML="";
        DB.wish.forEach((w,i)=> wList.innerHTML+=`<div class="polaroid"><img src="${w.img}" style="width:100%"><div style="font-size:0.7rem;">${w.name}</div></div>`);
        
        // BBS
        const bbs = document.getElementById('bbs-feed'); bbs.innerHTML="";
        DB.bbs.slice().reverse().forEach(m => {
            bbs.innerHTML += `<div class="bbs-msg" style="border-left-color:${m.color}"><div class="bbs-meta"><span style="color:${m.color};font-weight:bold;">${m.sender}</span><span>${m.time}</span></div>${m.text}</div>`;
        });
    }

    function rotateAvatar() {
        const u = DB.profiles[DB.activeIdx];
        u.av = (u.av + 1) % AVATARS.length;
        save(); refreshUI();
    }

    // --- PROFILES ---
    function openProfileManager() {
        const list = document.getElementById('profile-list'); list.innerHTML="";
        DB.profiles.forEach((p,i) => {
            const active = i===DB.activeIdx ? "active-slot" : "";
            list.innerHTML += `
                <div class="slot-card ${active}">
                    <div><b>${p.realName}</b> (${p.name})</div>
                    <div>
                        ${i!==DB.activeIdx ? `<button class="btn-main" style="width:auto;padding:5px;" onclick="swap(${i})">Switch</button>` : 'Active'}
                        <button style="color:red;border:none;background:none;font-weight:bold;" onclick="delProf(${i})">x</button>
                    </div>
                </div>`;
        });
        document.getElementById('modal-profiles').style.display='flex';
    }
    
    function addProfile() {
        const n = document.getElementById('new-p-name').value;
        const a = document.getElementById('new-p-age').value;
        const c = document.getElementById('new-p-color').value;
        if(!n) return;
        
        DB.profiles.push(genID(n, a, c));
        // Auto switch to new
        swap(DB.profiles.length - 1);
        
        document.getElementById('new-p-name').value="";
        closeModals();
    }

    function swap(i) {
        DB.activeIdx = i;
        const user = DB.profiles[i];
        
        // Log it
        const time = new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
        DB.frontLog.unshift({ name: user.realName, time: time });
        if(DB.frontLog.length > 20) DB.frontLog.pop();
        
        applyTheme(user);
        save();
        closeModals();
        refreshUI();
    }

    function delProf(i) {
        if(confirm("Delete?")) {
            DB.profiles.splice(i, 1);
            if(DB.activeIdx >= i && DB.activeIdx > 0) DB.activeIdx--;
            if(DB.profiles.length === 0) location.reload();
            save(); openProfileManager();
        }
    }

    // --- BBS ---
    function postBBS() {
        const txt = document.getElementById('bbs-input').value;
        if(!txt) return;
        const user = DB.profiles[DB.activeIdx];
        const time = new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
        DB.bbs.push({ sender: user.realName, color: user.color, text: txt, time: time });
        document.getElementById('bbs-input').value="";
        save(); refreshUI();
    }

    // --- TOOLS ---
    function feedPet() { DB.pet.hunger = Math.min(100, DB.pet.hunger + 10); save(); document.getElementById('pet-bar').style.width = DB.pet.hunger+"%"; }
    
    function openWishModal() { document.getElementById('modal-wish').style.display='flex'; }
    function submitWish() {
        const n = document.getElementById('w-name').value;
        const i = document.getElementById('w-img').value || "https://cdn-icons-png.flaticon.com/512/3209/3209955.png";
        if(n) { DB.wish.push({name:n, img:i}); save(); closeModals(); refreshUI(); }
    }

    function drawFortune() {
        const opts = ["Good Luck!", "Stay Hydrated", "Switch Soon?", "Nap Time"];
        document.getElementById('fortune-title').innerText = opts[Math.floor(Math.random()*opts.length)];
    }

    function go(id, btn) {
        document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
        document.getElementById('tab-'+id).classList.add('active');
        document.querySelectorAll('.nav-btn').forEach(b=>b.classList.remove('active'));
        btn.classList.add('active');
    }
    function closeModals() { document.querySelectorAll('.modal-overlay').forEach(m=>m.style.display='none'); }

    // SERVICE WORKER
    if('serviceWorker' in navigator) navigator.serviceWorker.register('./sw.js');
</script>
</body>
</html>
