<!DOCTYPE html>  
<html lang="en">  
<head>  
    <meta charset="UTF-8">  
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">  
    <meta name="apple-mobile-web-app-capable" content="yes">  
    <meta name="theme-color" content="#ff69b4">  
    <title>Seiren OS</title>  
    <link rel="manifest" href="manifest.json">  
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/2919/2919573.png">  
    <link rel="icon" type="image/png" href="https://cdn-icons-png.flaticon.com/512/2919/2919573.png">  

<style>  
    /* --- CORE VARIABLES --- */  
    :root {  
        --main: #ff69b4;   
        --font-main: 'Verdana', sans-serif;  
        --font-mono: 'Courier New', monospace;  
    }  

    * { box-sizing: border-box; user-select: none; -webkit-tap-highlight-color: transparent; }  

    body {  
        font-family: var(--font-main);  
        background-color: #ffe4e1;   
        background-image: radial-gradient(#ffb7b2 15%, transparent 16%), radial-gradient(#ffb7b2 15%, transparent 16%);  
        background-size: 20px 20px; background-position: 0 0, 10px 10px;  
        background-repeat: repeat;  
        background-attachment: fixed; 
        transition: all 0.8s ease;  
        margin: 0; display: flex; justify-content: center; height: 100vh; overflow: hidden;  
        color: #444;   
    }  

    /* --- NIGHT MODE --- */
    body.night-mode { background-color: #1a1a2e !important; background-image: none !important; color: #e6e6fa !important; }
    body.night-mode .modal-card, body.night-mode .id-card-wrap, body.night-mode .app-shell, body.night-mode .dock { background: #16213e; color: #e6e6fa; border-color: #0f3460; }
    body.night-mode .dock-btn { filter: invert(1); }
    body.night-mode .channel-sidebar { background: #0f3460; border-color: #1a1a2e; }
    body.night-mode .chan-btn { background: #1a1a2e; color: #fff; border-color: #0f3460; }

    /* --- APP SHELL --- */  
    .app-shell {  
        width: 100%; max-width: 480px; 
        background: transparent; 
        display: none; flex-direction: column; position: relative; height: 100%;  
        z-index: 10; 
    }  
    
    .content { 
        flex: 1; overflow-y: auto; overflow-x: hidden; 
        padding: 15px; padding-bottom: 100px;
        scroll-behavior: smooth; -webkit-overflow-scrolling: touch; 
    }  
    
    .page { display: none; animation: popIn 0.3s; height: 100%; display: none; flex-direction: column; }  
    .page.active { display: flex; }  
    @keyframes popIn { from {opacity:0; transform:scale(0.98);} to {opacity:1; transform:scale(1);} }  

    /* --- ID CARD --- */  
    .id-card-wrap {  
        background: #fff; border-radius: 15px; padding: 0;  
        box-shadow: 0 10px 20px rgba(0,0,0,0.15); margin-bottom: 20px;   
        position: relative; overflow: hidden; border: 1px solid #ccc;  
        min-height: 270px; flex-shrink: 0;
    }  
    .id-card-wrap::before {  
        content: ""; position: absolute; top: -50%; left: -50%; width: 200%; height: 200%;  
        background: linear-gradient(115deg, transparent 40%, rgba(255,0,150,0.2) 45%, rgba(0,255,255,0.3) 50%, rgba(255,255,0,0.2) 55%, transparent 60%);  
        mix-blend-mode: multiply; pointer-events: none; z-index: 10;  
        animation: foil 5s linear infinite; opacity: 0.6; 
    }  
    @keyframes foil { 0% { transform: translate3d(0,0,0); } 100% { transform: translate3d(50%,50%,0); } }  
    .id-inner { padding: 15px; height: 100%; display: flex; flex-direction: column; position: relative; z-index: 2; }  
    .id-header { border-bottom: 2px solid var(--main); padding-bottom: 5px; margin-bottom: 10px; display: flex; justify-content: space-between; font-weight: 900; letter-spacing: 1px; font-size: 0.7rem; color: #555; }  
    .id-main { display: flex; gap: 15px; margin-bottom: 10px; }  
    .id-photo { width: 90px; height: 110px; background: #eee; border: 1px solid #999; object-fit: cover; display: block; box-shadow: 2px 2px 5px rgba(0,0,0,0.1); }  
    .id-details { flex: 1; display: flex; flex-direction: column; justify-content: flex-start; gap: 5px; font-size: 0.7rem; }  
    .id-label { color: var(--main); font-weight: bold; font-size: 0.6rem; text-transform: uppercase; display:block; }  
    .id-val { color: #222; font-weight: bold; display: block; border-bottom: 1px dotted #ccc; width: 100%; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }  
    .bio-section { background: rgba(255,255,255,0.8); border: 1px solid #ddd; border-radius: 8px; padding: 8px; font-size: 0.75rem; color: #333; flex: 1; overflow-y: auto; max-height: 80px; margin-top: 5px; white-space: pre-wrap; }  

    /* --- DASHBOARD GRID --- */  
    .dash-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 20px; }  
    .dash-btn { background: white; border: 2px solid #eee; border-radius: 18px; padding: 15px; text-align: center; font-weight: bold; cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }  
    .dash-btn:active { transform: scale(0.96); background: #f9f9f9; border-color: var(--main); }  

    /* --- CHAT WITH CHANNELS --- */
    .chat-shell { 
        display: flex; flex-direction: row; /* Horizontal layout for sidebar */
        height: 100%; 
        border: 2px solid var(--main); border-radius: 15px; 
        background: white; overflow: hidden; position:relative; 
        box-shadow: 0 5px 15px rgba(0,0,0,0.1); 
    }
    
    .channel-sidebar {
        width: 70px; background: #f0f0f0; border-right: 1px solid #ddd;
        display: flex; flex-direction: column; align-items: center; gap: 10px;
        padding-top: 15px; overflow-y: auto;
    }
    
    .chan-btn {
        width: 45px; height: 45px; border-radius: 50%; 
        background: white; border: 2px solid #ccc;
        display: flex; align-items: center; justify-content: center;
        font-weight: bold; color: #666; font-size: 0.8rem; cursor: pointer;
        flex-shrink: 0;
    }
    .chan-btn.active { border-color: var(--main); color: var(--main); background: #fff0f5; }
    .chan-btn.add { background: var(--main); color: white; border: none; font-size: 1.2rem; }

    .chat-view { flex: 1; display: flex; flex-direction: column; min-width: 0; }
    .chat-header { padding: 10px; border-bottom: 1px solid #eee; font-weight: bold; color: var(--main); display: flex; justify-content: space-between; align-items: center; }
    .chat-feed { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 15px; background-image: radial-gradient(#f0f0f0 1px, transparent 1px); background-size: 20px 20px; }
    
    .pk-msg { display: flex; gap: 10px; align-items: flex-start; }
    .pk-av { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; flex-shrink: 0; border: 2px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
    .pk-content { background: #fff; padding: 8px 12px; border-radius: 12px; border-top-left-radius: 0; box-shadow: 0 2px 5px rgba(0,0,0,0.05); max-width: 100%; }
    .pk-name { font-weight: bold; font-size: 0.8rem; margin-bottom: 2px; display: flex; justify-content: space-between; gap: 10px; }
    .pk-txt { font-size: 0.9rem; white-space: pre-wrap; word-wrap: break-word; }
    .chat-input-area { padding: 10px; border-top: 1px solid #eee; display: flex; gap: 8px; align-items: center; background: #fafafa; }
    
    /* --- DREAM JOURNAL (FIXED SIZE) --- */
    #page-dream { padding-bottom: 120px; }
    .dream-form {
        background: white; padding: 20px; border-radius: 15px; 
        margin-bottom: 20px; display: flex; flex-direction: column; gap: 10px;
        box-shadow: 0 5px 15px rgba(0,0,0,0.05);
        border: 2px solid #eee;
    }
    .dream-entry { background: rgba(255,255,255,0.9); padding: 15px; border-left: 5px solid var(--main); margin-bottom: 15px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
    .sensory-slider { margin-bottom: 10px; }
    .sensory-range { width: 100%; }

    /* --- PHARMACY --- */  
    .receipt-paper { 
        background: #fff; padding: 15px; 
        font-family: 'Courier New', monospace; font-size: 0.8rem; 
        box-shadow: 0 5px 15px rgba(0,0,0,0.1); margin-bottom: 10px; position: relative; 
        border-top: 5px solid #333;
        background-image: linear-gradient(135deg, transparent 50%, #fff 50%), linear-gradient(45deg, #fff 50%, transparent 50%);
        background-size: 20px 20px; background-repeat: repeat-x; background-position: bottom;
        padding-bottom: 30px; 
    }  
    .mood-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; padding: 10px 0; }  
    .mood-btn { background: white; border: 2px solid #eee; border-radius: 12px; height: 55px; font-size: 1.8rem; cursor: pointer; transition: transform 0.1s; }  
    .mood-btn:active { transform: scale(0.95); background: var(--main); border-color: var(--main); }

    /* --- UI COMPONENTS --- */  
    .btn-action { background: var(--main); color: white; padding: 12px; width: 100%; border: none; border-radius: 12px; font-weight: bold; cursor: pointer; margin-bottom: 5px; box-shadow: 0 4px 0 rgba(0,0,0,0.1); }  
    .btn-action:active { transform: translateY(3px); box-shadow: none; }  
      
    .dock { position: fixed; bottom: 25px; left: 20px; right: 20px; background: rgba(255,255,255,0.95); border-radius: 25px; padding: 12px 25px; display: flex; justify-content: space-between; box-shadow: 0 5px 25px rgba(0,0,0,0.15); z-index: 100; border: 2px solid white; }  
    .dock-btn { background: none; border: none; font-size: 1.6rem; cursor: pointer; opacity: 0.5; transition: 0.2s; }  
    .dock-btn.active { opacity: 1; transform: translateY(-8px); }  

    .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 2000; display: none; align-items: center; justify-content: center; padding: 20px; }  
    .modal-card { 
        background: white; width: 90%; max-width: 380px; border-radius: 25px; padding: 25px; 
        border: 4px ridge var(--main); max-height: 80vh; overflow-y: auto; padding-bottom: 40px; 
    }  
    input, textarea, select { width: 100%; padding: 10px; margin-bottom: 8px; border: 2px inset #eee; border-radius: 10px; font-family: inherit;}  

    /* --- WELCOME SCREEN --- */
    #welcome-screen {
        position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.95); z-index:3000; 
        display:flex; flex-direction:column; align-items:center; justify-content:center;
    }

</style>

</head>  
<body>  

<div id="welcome-screen">  
    <div style="font-size:4rem; margin-bottom:10px;">üíø</div>  
    <h1 style="color:var(--main); margin:0 0 10px 0;">SEIREN OS</h1>  
    <p style="font-size:0.8rem; color:#666; margin-bottom:30px;">System Management Interface</p>  
    
    <label class="btn-action" style="width:220px; background:#7e57c2; text-align:center; display:block; cursor:pointer; margin-bottom:10px;">  
        üëæ Import PluralKit  
        <input type="file" id="pk-input" style="display:none;" onchange="importPluralKit(this)">  
    </label>

    <button class="btn-action" style="width:220px;" onclick="startGuest()">Continue as Guest</button>  
    <button class="btn-action" style="width:220px; background:#ccc; margin-top:10px;" onclick="resetSystem()">Start New System</button>
</div>  

<div class="app-shell" id="app">  
    <div class="content">
        
        <div id="page-dash" class="page active" style="flex-direction:column;">  
            <div class="id-card-wrap">  
                <div class="id-inner">  
                    <div class="id-header">  
                        <span id="sys-name-display">SEIREN OS</span>  
                        <span>GLIMMER ID</span>  
                    </div>  
                    <div class="id-main">  
                        <img id="dash-av" class="id-photo" src="">  
                        <div class="id-details">  
                            <div><span class="id-label">NAME</span><span class="id-val" id="dash-name">Guest</span></div>  
                            <div style="display:flex; gap:10px;">  
                                <div style="flex:1;"><span class="id-label">AGE</span><span class="id-val" id="dash-age">--</span></div>  
                                <div style="flex:1;"><span class="id-label">HEIGHT</span><span class="id-val" id="dash-height">--</span></div>  
                            </div>  
                            <div style="display:flex; gap:10px;">  
                                <div style="flex:1;"><span class="id-label">SIGN</span><span class="id-val" id="dash-sign">--</span></div>  
                                <div style="flex:1;"><span class="id-label">SPECIES</span><span class="id-val" id="dash-species">--</span></div>  
                            </div>  
                        </div>  
                    </div>  
                    <span class="id-label">PERSONNEL NOTES</span>  
                    <div class="bio-section" id="dash-bio">Guest Access</div>  
                </div>  
            </div>  

            <div class="dash-grid">  
                <div class="dash-btn" onclick="openProfileModal()"><span>üë•</span><br>Switch/Edit</div>  
                <div class="dash-btn" onclick="openSettingsModal()"><span>‚öôÔ∏è</span><br>Settings</div>  
                <div class="dash-btn" onclick="nav('pharmacy')"><span>üè•</span><br>Care Log</div>
                <div class="dash-btn" onclick="nav('dream')"><span>üåô</span><br>Dream Log</div>
                <div class="dash-btn" onclick="nav('chat')"><span>üí¨</span><br>Chat</div>
                <div class="dash-btn" onclick="exportData()"><span>üíæ</span><br>Backup</div>  
            </div>  
        </div>  

        <div id="page-pharmacy" class="page" style="flex-direction:column;">  
            <h2 style="color:var(--main); text-align:center; margin-bottom:15px; background:white; border-radius:10px; display:inline-block; padding:5px 15px;">Clinical Log</h2>  
            
            <div style="background:white; padding:15px; border-radius:15px; border:2px solid var(--main);">  
                <div id="receipt-list" class="receipt-paper">
                    <div style="text-align:center; border-bottom:1px dashed #000; margin-bottom:10px;">SEIREN CLINIC</div>
                    <div id="receipt-content"></div>
                </div>  
                
                <div style="text-align:center; margin-bottom:5px; font-size:0.7rem; color:#888;">LOG SYMPTOMS:</div>  
                <div class="mood-grid">  
                    <button class="mood-btn" onclick="logMood('üòä Happy')">üòä</button>  
                    <button class="mood-btn" onclick="logMood('üò¢ Sad')">üò¢</button>  
                    <button class="mood-btn" onclick="logMood('üò° Angry')">üò°</button>  
                    <button class="mood-btn" onclick="logMood('üåÄ Anxious')">üåÄ</button>  
                    <button class="mood-btn" onclick="logMood('üí§ Tired')">üí§</button>  
                    <button class="mood-btn" onclick="logMood('‚ú® Hyper')">‚ú®</button>  
                    <button class="mood-btn" onclick="logMood('üíÄ Dead')">üíÄ</button>  
                    <button class="mood-btn" onclick="logMood('üíñ Loved')">üíñ</button>  
                    <button class="mood-btn" onclick="logMood('üò∞ Panic')">üò∞</button>  
                    <button class="mood-btn" onclick="logMood('üå´Ô∏è Numb')">üå´Ô∏è</button>  
                    <button class="mood-btn" onclick="logMood('‚ö° Manic')">‚ö°</button>  
                    <button class="mood-btn" onclick="logMood('ü•Ä Lonely')">ü•Ä</button>  
                    <button class="mood-btn" onclick="logMood('üé™ Silly')">üé™</button>  
                    <button class="mood-btn" onclick="logMood('ü©π Hurt')">ü©π</button>  
                    <button class="mood-btn" onclick="logMood('ü§¢ Sick')">ü§¢</button>  
                    <button class="mood-btn" onclick="logMood('ü§Ø Overwhelmed')">ü§Ø</button>  
                    <button class="mood-btn" onclick="logMood('ü•∫ Sensitive')">ü•∫</button>  
                    <button class="mood-btn" onclick="logMood('üò§ Frustrated')">üò§</button>
                    <button class="mood-btn" onclick="logMood('üçº Little')">üçº</button>
                    <button class="mood-btn" onclick="logMood('üò∂ Non-verbal')">üò∂</button>
                    <button class="mood-btn" onclick="logMood('üå´Ô∏è Dissociated')">üå´Ô∏è</button>
                    <button class="mood-btn" onclick="logMood('üí• Overstimulated')">üí•</button>
                </div>  

                <button class="btn-action" style="margin-top:10px; background:#78909c;" onclick="clearReceipt()">Clear Log</button>  
            </div>  
        </div> 

        <div id="page-chat" class="page" style="height:100%; padding-bottom:80px;">  
            <div class="chat-shell">  
                <div class="channel-sidebar" id="chan-list"></div>
                
                <div class="chat-view">
                    <div class="chat-header" id="chat-title">#general</div>
                    <div class="chat-feed" id="chat-feed"></div>  
                    <div class="chat-input-area">  
                        <label style="cursor:pointer; font-size:1.5rem; color:#888;">üìé<input type="file" accept="image/*" style="display:none;" onchange="handleChatImage(this)"></label>  
                        <input type="text" id="msg-in" style="width:100%; margin:0;" placeholder="Message...">  
                        <button class="btn-action" style="width:auto; margin:0;" onmousedown="event.preventDefault(); sendMsg()">Send</button>  
                    </div>  
                </div>
            </div>  
        </div>

        <div id="page-dream" class="page" style="flex-direction:column;">
            <h2 style="text-align:center; color:var(--main); background:white; border-radius:10px; padding:5px;">Dream Journal</h2>
            
            <div class="dream-form">
                <input type="text" id="dream-loc" placeholder="Dream Location / Level">
                
                <textarea id="dream-text" style="height:150px; font-size:1rem;" placeholder="Write entry here..."></textarea>
                
                <div class="sensory-slider">
                    <label style="font-size:0.7rem; color:#888;">REALITY LEVEL</label>
                    <input type="range" id="dream-reality" min="0" max="100" class="sensory-range">
                </div>

                <label class="btn-action" style="background:#7e57c2; text-align:center; display:block;">
                    üì∏ Upload Residue
                    <input type="file" accept="image/*" style="display:none;" onchange="handleDreamImage(this)">
                </label>
                <img id="dream-preview" style="width:100%; display:none; margin-top:10px; border-radius:10px;">
                
                <button class="btn-action" style="margin-top:10px;" onclick="saveDream()">Save Entry</button>
            </div>
            
            <div id="dream-feed"></div>
        </div>

    </div> 

    <div class="dock">  
        <button class="dock-btn active" onclick="nav('dash')">üè†</button>  
        <button class="dock-btn" onclick="nav('pharmacy')">üè•</button>  
        <button class="dock-btn" onclick="nav('chat')">üí¨</button>  
        <button class="dock-btn" onclick="nav('dream')">üåô</button>  
    </div>
</div>  

<div id="modal-settings" class="modal">  
    <div class="modal-card">  
        <h3>Settings</h3>  
        <label>System Name:</label>  
        <input type="text" id="sys-name-input" placeholder="Seiren OS">  
        <button class="btn-action" onclick="saveSystemName()">Update Name</button>
        <button class="btn-action" style="margin-top:10px;" onclick="toggleNightMode()">Toggle Night Mode</button>
        <button class="btn-action" style="margin-top:15px; background:#ccc;" onclick="closeModals()">Close</button>  
    </div>
</div>  

<div id="modal-profile" class="modal">  
    <div class="modal-card">  
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
            <h3>System Members</h3>
        </div>
        <div id="prof-list" style="margin-bottom:15px; max-height:150px; overflow-y:auto; border:1px solid #eee;"></div>  
        <hr>  
        <h4>Profile Editor</h4>  
        <input type="text" id="new-name" placeholder="Name">  
        <div style="display:flex; gap:10px;">  
            <input type="text" id="new-age" placeholder="Age" style="width:30%;">  
            <input type="text" id="new-sign" placeholder="Sign/Pronouns" style="width:70%;">  
        </div>  
        <div style="display:flex; gap:10px;">  
            <input type="text" id="new-species" placeholder="Species" style="width:70%;">  
            <input type="text" id="new-height" placeholder="Height" style="width:30%;">  
        </div>  
        <textarea id="new-bio" placeholder="Profile Info / Notes..." style="height:60px; font-family:inherit;"></textarea>  
        <label style="display:block; padding:10px; background:#eee; text-align:center; border-radius:10px; margin-bottom:10px;">  
            üìÇ Upload Photo  
            <input type="file" accept="image/*" style="display:none;" onchange="handleFile(this, 'av-preview')">  
        </label>  
        <img id="av-preview" src="" style="width:60px; height:60px; margin:0 auto; display:block; object-fit:cover; border-radius:50%; background:#eee; margin-bottom:10px;">  
        <input type="color" id="new-color" value="#ff69b4" style="width:100%; border:none; height:30px;">  
        <div style="display:flex; gap:5px; margin-top:10px;">
            <button class="btn-action" style="background:#81c784; flex:1;" onclick="updateCurrentProfile()">Save Changes</button>
            <button class="btn-action" style="flex:1;" onclick="createProfile()">Create New</button>
        </div>
        <button class="btn-action" style="margin-top:5px; background:#ccc;" onclick="closeModals()">Close</button>  
    </div>
</div>  

<script>  
    // --- DATABASE STRUCTURE ---
    let DEFAULT_DB = {  
        sysName: "SEIREN OS",  
        profiles: [{ 
            name: "Guest", 
            av: "https://cdn-icons-png.flaticon.com/512/2919/2919573.png", 
            color: "#ff69b4", 
            id: "GUEST", bio: "Guest Access" 
        }], 
        active: 0,
        channels: { 'gen': {name:'general', msgs:[]} },
        curChan: 'gen',
        dreams: [],
        nightMode: false
    };
    
    let DB = JSON.parse(JSON.stringify(DEFAULT_DB));
    let uploadedAv = ""; 
    let chatImg = "";
    let tempDreamImg = "";

    window.onload = () => {  
        const saved = localStorage.getItem('seiren_sys_v4_spamfix'); 
        if(saved) { 
            const loaded = JSON.parse(saved);
            DB = { ...DEFAULT_DB, ...loaded };
            
            // Channel migration
            if(Array.isArray(loaded.msgs)) {
                DB.channels = { 'gen': {name:'general', msgs: loaded.msgs } };
                delete DB.msgs;
            }
            if(!DB.channels) DB.channels = { 'gen': {name:'general', msgs:[]} };
            
            if(DB.profiles.length > 1 || DB.profiles[0].name !== "Guest") {
                document.getElementById('welcome-screen').style.display = 'none';
                document.querySelector('.app-shell').style.display='flex';
                loadUI();
                if(DB.nightMode) document.body.classList.add('night-mode');
            }
        }
    };  
  
    function startGuest() {
        document.getElementById('welcome-screen').style.display = 'none';
        document.querySelector('.app-shell').style.display='flex';
        loadUI();
    }

    function resetSystem() {
        if(confirm("Erase all data?")) {
            DB = JSON.parse(JSON.stringify(DEFAULT_DB));
            DB.profiles[0].name = "Host";
            save(); location.reload();
        }
    }
    
    function save() { localStorage.setItem('seiren_sys_v4_spamfix', JSON.stringify(DB)); }  
    function saveSystemName() { DB.sysName = document.getElementById('sys-name-input').value; save(); loadUI(); closeModals(); }  
    function toggleNightMode() {
        DB.nightMode = !DB.nightMode;
        if(DB.nightMode) document.body.classList.add('night-mode');
        else document.body.classList.remove('night-mode');
        save();
    }
    
    function handleFile(inpt, id) {   
        const file = inpt.files[0]; if(!file) return;  
        const reader = new FileReader();  
        reader.onload = (e) => {  
            uploadedAv = e.target.result;
            document.getElementById(id).src = uploadedAv; 
        };  
        reader.readAsDataURL(file); 
    }  
  
    function loadUI() {  
        const p = DB.profiles[DB.active] || DB.profiles[0]; 
        document.documentElement.style.setProperty('--main', p.color);  
        document.getElementById('sys-name-display').innerText = DB.sysName;  
        document.getElementById('dash-name').innerText = p.name;  
        document.getElementById('dash-sign').innerText = p.sign||"?";  
        document.getElementById('dash-species').innerText = p.species||"?";  
        document.getElementById('dash-age').innerText = p.age||"?";  
        document.getElementById('dash-height').innerText = p.height||"?";  
        document.getElementById('dash-bio').innerText = p.bio || "No info provided.";  
        document.getElementById('dash-av').src = p.av;  
    }  
  
    function createProfile() {  
        const n = document.getElementById('new-name').value;  
        if(n) {  
            if(DB.profiles.length === 1 && DB.profiles[0].id === "GUEST") DB.profiles = [];

            DB.profiles.push({  
                name:n, color:document.getElementById('new-color').value,   
                av: uploadedAv || "https://cdn-icons-png.flaticon.com/512/2919/2919573.png",  
                sign:document.getElementById('new-sign').value,   
                species:document.getElementById('new-species').value,   
                age:document.getElementById('new-age').value,  
                height:document.getElementById('new-height').value,  
                bio:document.getElementById('new-bio').value,
                id: Math.floor(Math.random()*900000)  
            });  
            uploadedAv = ""; DB.active = DB.profiles.length - 1;  
            save(); closeModals(); loadUI();  
        }  
    }

    function updateCurrentProfile() {
        const p = DB.profiles[DB.active];
        p.name = document.getElementById('new-name').value || p.name;
        p.age = document.getElementById('new-age').value || p.age;
        p.sign = document.getElementById('new-sign').value || p.sign;
        p.species = document.getElementById('new-species').value || p.species;
        p.height = document.getElementById('new-height').value || p.height;
        p.bio = document.getElementById('new-bio').value || p.bio;
        p.color = document.getElementById('new-color').value || p.color;
        if(uploadedAv) { p.av = uploadedAv; uploadedAv = ""; }
        save(); closeModals(); loadUI();
    }
  
    function openProfileModal() {  
        document.getElementById('modal-profile').style.display='flex';  
        const p = DB.profiles[DB.active];
        document.getElementById('new-name').value = p.name;
        document.getElementById('new-age').value = p.age;
        document.getElementById('new-sign').value = p.sign;
        document.getElementById('new-species').value = p.species;
        document.getElementById('new-height').value = p.height;
        document.getElementById('new-bio').value = p.bio;
        document.getElementById('new-color').value = p.color;
        document.getElementById('av-preview').src = p.av;

        const list = document.getElementById('prof-list'); list.innerHTML="";  
        DB.profiles.forEach((p,i)=>{  
            list.innerHTML += `<div style="padding:10px; border-bottom:1px solid #eee; display:flex; justify-content:space-between; align-items:center;">  
                <b>${p.name}</b>  
                <div>  
                    <button onclick="switchProfile(${i})">Switch</button>  
                    ${i!==0 ? `<button style="color:red; margin-left:5px;" onclick="if(confirm('Delete?')){DB.profiles.splice(${i},1); DB.active=0; save(); openProfileModal(); loadUI();}">x</button>` : ''}  
                </div>  
            </div>`;  
        });  
    }  

    function switchProfile(index) { DB.active = index; save(); loadUI(); closeModals(); }

    // --- PHARMACY ---
    function logMood(m) {
        const d = new Date().toLocaleTimeString();
        document.getElementById('receipt-content').innerHTML += `<div>${m} ... ${d}</div>`;
    }
    function clearReceipt() {
        if(confirm("Clear log?")) document.getElementById('receipt-content').innerHTML = "";
    }

    // --- CHAT WITH CHANNELS & SPAM FIX ---
    function handleChatImage(inpt) {   
        const file = inpt.files[0]; if(!file) return;  
        const reader = new FileReader(); reader.onload = (e) => { chatImg = e.target.result; alert("Image attached!"); }; reader.readAsDataURL(file); inpt.value = ""; 
    }  

    function sendMsg() {  
        const i = document.getElementById('msg-in'); 
        if(!i.value && !chatImg) return;  
        const p = DB.profiles[DB.active];  
        const time = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        
        if(!DB.channels) DB.channels = { 'gen': {name:'general', msgs:[]} };
        if(!DB.channels[DB.curChan]) DB.curChan = 'gen';

        DB.channels[DB.curChan].msgs.push({ name:p.name, av:p.av, color:p.color, txt:i.value, img:chatImg, time:time });  
        i.value=""; chatImg=""; save(); renderChat();  
        
        // KEEP FOCUS TO ALLOW SPAM
        setTimeout(() => i.focus(), 10);
    } 

    function renderChat() {
        const list = document.getElementById('chan-list');
        list.innerHTML = "";
        
        if(!DB.channels) DB.channels = { 'gen': {name:'general', msgs:[]} };

        Object.keys(DB.channels).forEach(k => {
            const btn = document.createElement('div');
            btn.className = `chan-btn ${DB.curChan === k ? 'active' : ''}`;
            btn.innerText = DB.channels[k].name.substring(0,2).toUpperCase();
            btn.onclick = () => { DB.curChan = k; renderChat(); };
            list.appendChild(btn);
        });

        const addBtn = document.createElement('div');
        addBtn.className = "chan-btn add";
        addBtn.innerText = "+";
        addBtn.onclick = () => {
            const n = prompt("Channel Name:");
            if(n) {
                const id = n.toLowerCase().replace(/\s/g, '');
                DB.channels[id] = { name: n, msgs: [] };
                save(); renderChat();
            }
        };
        list.appendChild(addBtn);

        const feed = document.getElementById('chat-feed'); 
        feed.innerHTML="";
        document.getElementById('chat-title').innerText = "#" + (DB.channels[DB.curChan]?.name || "general");
        
        const msgs = DB.channels[DB.curChan]?.msgs || [];
        msgs.forEach(m => { 
            const imgHTML = m.img ? `<img src="${m.img}" style="max-width:200px; border-radius:10px; margin-top:5px;">` : ''; 
            feed.innerHTML += `
            <div class="pk-msg">
                <img src="${m.av}" class="pk-av">
                <div class="pk-content">
                    <div class="pk-name" style="color:${m.color}">${m.name} <span style="color:#ccc; font-weight:normal; font-size:0.7em;">${m.time}</span></div>
                    <div class="pk-txt">${m.txt}${imgHTML}</div>
                </div>
            </div>`; 
        });  
        feed.scrollTop = feed.scrollHeight;  
    }

    // --- DREAM JOURNAL ---
    function handleDreamImage(inpt) {
        const file = inpt.files[0]; if(!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
            tempDreamImg = e.target.result;
            const prev = document.getElementById('dream-preview');
            prev.src = tempDreamImg; prev.style.display = 'block';
        };
        reader.readAsDataURL(file);
    }

    function saveDream() {
        const loc = document.getElementById('dream-loc').value;
        const txt = document.getElementById('dream-text').value;
        const reality = document.getElementById('dream-reality').value;
        
        if(txt || loc || tempDreamImg) {
            DB.dreams.unshift({
                d: new Date().toLocaleDateString(),
                loc: loc, reality: reality,
                txt: txt, img: tempDreamImg 
            });
            document.getElementById('dream-loc').value="";
            document.getElementById('dream-text').value="";
            document.getElementById('dream-preview').style.display='none';
            tempDreamImg = "";
            save(); renderDreams();
        }
    }

    function renderDreams() {
        const f = document.getElementById('dream-feed'); f.innerHTML = "";
        DB.dreams.forEach((d, i) => {
            f.innerHTML += `
            <div class="dream-entry">
                <button style="color:red; background:none; border:none; float:right; cursor:pointer;" onclick="if(confirm('Delete?')){DB.dreams.splice(${i},1); save(); renderDreams();}">x</button>
                <small style="opacity:0.7;">${d.d} ‚Ä¢ ${d.loc || 'Unknown'}</small>
                <div style="font-size:0.7rem; color:${d.reality > 50 ? 'red' : 'blue'};">Reality Level: ${d.reality}%</div>
                ${d.img ? `<img src="${d.img}" style="width:100%; border-radius:5px; margin:5px 0; filter:grayscale(100%);">` : ''}
                <p style="margin-top:5px; white-space:pre-wrap;">${d.txt}</p>
            </div>`;
        });
    }

    // --- IMPORT PLURALKIT ---
    function importPluralKit(input) {
        const file = input.files[0];
        if(!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                const json = JSON.parse(e.target.result);
                let members = [];
                if (json.members) members = json.members; 
                else if (json.tuppers) members = json.tuppers; 
                else if (Array.isArray(json)) members = json; 
                else members = [json]; 

                let count = 0;
                if (DB.profiles.length === 1 && DB.profiles[0].id === "GUEST") DB.profiles = [];

                members.forEach(m => {
                    DB.profiles.push({
                        name: m.name || "Unknown",
                        av: m.avatar_url || "https://cdn-icons-png.flaticon.com/512/2919/2919573.png",
                        sign: m.pronouns || "-",
                        age: m.birthday || "-",
                        species: "System Member",
                        height: "-",
                        bio: m.description || "",
                        color: m.color ? "#"+m.color : "#ff69b4",
                        id: m.id || Math.floor(Math.random()*900000)
                    });
                    count++;
                });

                if(DB.profiles.length > 0) DB.active = 0;
                save();
                alert(`Success! Imported ${count} members.`);
                startGuest(); 
            } catch(err) {
                alert("Import Failed: " + err.message);
            }
        };
        reader.readAsText(file);
        input.value = ""; 
    }

    function nav(id) { 
        document.querySelectorAll('.page').forEach(p=>p.classList.remove('active')); 
        document.getElementById('page-'+id).classList.add('active'); 
        document.querySelectorAll('.dock-btn').forEach(b=>b.classList.remove('active')); 
        if(id==='chat') renderChat();
        if(id==='dream') renderDreams();
    }  
    
    function closeModals() { document.querySelectorAll('.modal').forEach(m=>m.style.display='none'); }  
    function openSettingsModal() { document.getElementById('modal-settings').style.display='flex'; }  
    function exportData() { const a=document.createElement('a'); a.href="data:text/json;charset=utf-8,"+encodeURIComponent(JSON.stringify(DB)); a.download="seiren_backup.json"; document.body.appendChild(a); a.click(); a.remove(); }  

</script>  
</body>  
</html>

