<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#ff69b4">
    
    <title>Seiren System</title>
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/2919/2919573.png">
    <link rel="icon" type="image/png" href="https://cdn-icons-png.flaticon.com/512/2919/2919573.png">

    <style>
        /* --- 2004 SYSTEM AESTHETIC --- */
        :root {
            /* These variables update via Javascript based on the Fronter */
            --theme-main: #ff69b4;       /* Main Pink */
            --theme-light: #fff0f5;      /* Light BG */
            --theme-border: #d12e87;     /* Darker Border */
            --theme-text: #555;
            --glass: rgba(255, 255, 255, 0.92);
        }

        * { box-sizing: border-box; }

        body {
            font-family: 'Verdana', 'MS PGothic', sans-serif;
            background-color: var(--theme-light);
            /* Retro Dot Pattern */
            background-image: radial-gradient(var(--theme-main) 15%, transparent 16%), 
                              radial-gradient(var(--theme-main) 15%, transparent 16%);
            background-size: 20px 20px;
            background-position: 0 0, 10px 10px;
            margin: 0; display: flex; justify-content: center; height: 100vh; overflow: hidden;
            color: var(--theme-text);
            transition: background-color 0.5s ease;
        }

        /* Scanlines for CRT effect */
        .scanlines {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.03) 50%);
            background-size: 100% 3px; pointer-events: none; z-index: 999;
        }

        /* --- APP CONTAINER --- */
        .app-shell {
            width: 100%; max-width: 480px;
            background: var(--glass);
            display: none; /* Hidden until loaded */
            flex-direction: column; height: 100%;
            box-shadow: 0 0 40px rgba(0,0,0,0.2);
            z-index: 10;
            transition: all 0.5s ease;
        }

        /* HEADER */
        .system-header {
            background: linear-gradient(90deg, var(--theme-main), var(--theme-border));
            color: white; padding: 10px; display: flex; justify-content: space-between; align-items: center;
            border-bottom: 3px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .sys-title { font-weight: bold; font-size: 0.9rem; letter-spacing: 1px; }
        .sys-clock { font-family: 'Courier New', monospace; font-size: 0.8rem; }

        /* CONTENT AREA */
        .content {
            flex: 1; overflow-y: auto; padding: 15px; padding-bottom: 100px;
            scroll-behavior: smooth;
        }
        
        .page { display: none; animation: fadeUp 0.3s ease; }
        .page.active { display: block; }
        @keyframes fadeUp { from {opacity:0; transform:translateY(5px);} to {opacity:1; transform:translateY(0);} }

        /* --- 1. ID CARD (RPG STYLE) --- */
        .id-card {
            background: white; border: 2px solid var(--theme-main); border-radius: 15px;
            padding: 5px; box-shadow: 4px 4px 0 rgba(0,0,0,0.1); margin-bottom: 15px;
        }
        .id-inner {
            background: var(--theme-light); border: 1px dashed var(--theme-border);
            border-radius: 10px; padding: 15px; display: flex; gap: 15px; position: relative;
        }
        .current-tag {
            position: absolute; top: -10px; right: 10px; background: var(--theme-border);
            color: white; font-size: 0.6rem; padding: 2px 8px; border-radius: 10px; font-weight: bold;
        }
        .id-photo { 
            width: 80px; height: 80px; border-radius: 10px; border: 3px solid white; 
            outline: 2px solid var(--theme-main); object-fit: cover; background: white;
        }
        .id-info h2 { margin: 0; color: var(--theme-border); font-size: 1.2rem; }
        .id-info p { margin: 2px 0; font-size: 0.7rem; }
        .stats-row { display: flex; gap: 5px; margin-top: 5px; flex-wrap: wrap; }
        .stat-badge { 
            background: white; border: 1px solid var(--theme-main); padding: 2px 6px; 
            border-radius: 4px; font-size: 0.6rem; color: var(--theme-border);
        }

        /* --- 2. SYSTEM BBS (CHAT) --- */
        .bbs-container {
            background: white; border: 2px solid var(--theme-main); border-radius: 10px;
            height: 300px; display: flex; flex-direction: column; overflow: hidden;
        }
        .bbs-header {
            background: var(--theme-light); padding: 5px 10px; border-bottom: 1px solid var(--theme-main);
            font-size: 0.7rem; font-weight: bold; color: var(--theme-border);
        }
        .bbs-messages { flex: 1; overflow-y: auto; padding: 10px; display: flex; flex-direction: column; gap: 8px; }
        .msg { font-size: 0.8rem; background: #f9f9f9; padding: 8px; border-radius: 5px; border-left: 3px solid var(--theme-border); }
        .msg-meta { font-size: 0.6rem; color: #999; margin-bottom: 2px; display: flex; justify-content: space-between; }
        .bbs-input-area { padding: 10px; border-top: 1px solid #eee; display: flex; gap: 5px; }

        /* --- 3. MEMBER LIST (UNLIMITED) --- */
        .member-list { display: grid; gap: 10px; }
        .member-row {
            background: white; padding: 10px; border-radius: 10px; display: flex; align-items: center; justify-content: space-between;
            border-bottom: 2px solid var(--theme-light); transition: 0.2s;
        }
        .member-row:hover { transform: translateX(2px); border-color: var(--theme-main); }
        .mem-left { display: flex; align-items: center; gap: 10px; }
        .mem-img { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; border: 1px solid var(--theme-main); }
        .mem-actions button { font-size: 0.7rem; padding: 4px 8px; margin-left: 2px; }

        /* --- 4. FRONT LOG --- */
        .log-entry { font-size: 0.75rem; padding: 8px; border-bottom: 1px dashed #ccc; display: flex; justify-content: space-between; }
        .log-time { color: #888; font-family: 'Courier New', monospace; }

        /* UI ELEMENTS */
        button { cursor: pointer; font-family: inherit; }
        .btn-main {
            background: var(--theme-main); color: white; border: none; padding: 10px;
            border-radius: 20px; width: 100%; font-weight: bold; box-shadow: 0 3px 0 rgba(0,0,0,0.1);
        }
        .btn-main:active { transform: translateY(3px); box-shadow: none; }
        
        .btn-small { background: white; border: 1px solid var(--theme-main); color: var(--theme-main); border-radius: 5px; }
        
        input, select {
            width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 5px;
            font-family: inherit; outline: none;
        }
        input:focus { border-color: var(--theme-main); }

        /* NAVIGATION */
        nav {
            position: fixed; bottom: 0; left: 0; right: 0;
            background: rgba(255,255,255,0.95); border-top: 2px solid var(--theme-main);
            display: flex; justify-content: space-around; padding: 10px 0;
            padding-bottom: max(10px, env(safe-area-inset-bottom)); z-index: 100;
        }
        .nav-btn { background: none; border: none; color: #aaa; display: flex; flex-direction: column; align-items: center; font-size: 0.7rem; }
        .nav-btn span { font-size: 1.4rem; margin-bottom: 2px; }
        .nav-btn.active { color: var(--theme-main); transform: scale(1.1); font-weight: bold; }

        /* WELCOME SCREEN */
        #welcome-screen {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: #fff0f5; z-index: 2000;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            transition: opacity 0.5s;
        }
        .enter-card {
            background: white; padding: 30px; border-radius: 20px; text-align: center;
            border: 4px dashed #ff69b4; box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        /* MODALS */
        .modal { position: fixed; top:0; left:0; right:0; bottom:0; background: rgba(0,0,0,0.5); z-index: 1500; display: none; align-items: center; justify-content: center; }
        .modal-content { background: white; width: 90%; max-width: 400px; padding: 20px; border-radius: 15px; border: 2px solid var(--theme-main); }

    </style>
</head>
<body>

<div class="scanlines"></div>

<div id="welcome-screen">
    <div class="enter-card">
        <h1 style="color:#ff69b4; margin-bottom:5px;">SEIREN SYSTEM</h1>
        <p style="font-size:0.8rem; color:#888;">OS v1.0 // System Companion</p>
        <button class="btn-main" style="margin-top:20px; background:#ff69b4;" onclick="enterApp()">START UP</button>
    </div>
</div>

<div class="app-shell" id="app-shell">
    
    <div class="system-header">
        <span class="sys-title">SYSTEM ONLINE</span>
        <span class="sys-clock" id="clock">00:00</span>
    </div>

    <div class="content">

        <div id="tab-dash" class="page active">
            <div id="fronter-card-area"></div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px;">
                <button class="btn-main" onclick="openModal('switch-modal')">‚Üî Switch</button>
                <button class="btn-main" style="background:#87cefa;" onclick="nav('members')">üë• Members</button>
            </div>

            <fieldset style="border: 2px dashed var(--theme-border); border-radius: 10px; padding: 10px; margin-bottom: 20px;">
                <legend style="color:var(--theme-border); font-weight:bold; font-size:0.8rem; padding: 0 5px;">Recent Activity</legend>
                <div id="mini-log" style="font-size:0.7rem;"></div>
            </fieldset>

            <div style="background:white; padding:10px; border-radius:10px; text-align:center; border:1px solid #ddd;">
                <span style="font-size:0.8rem; font-weight:bold; color:var(--theme-text);">Daily Fortune</span><br>
                <button class="btn-small" style="margin-top:5px;" onclick="flipFortune()">Draw Card</button>
                <div id="fortune-result" style="margin-top:5px; font-size:0.8rem;"></div>
            </div>
        </div>

        <div id="tab-members" class="page">
            <h2 style="color:var(--theme-border);">Member Registry</h2>
            <button class="btn-main" style="margin-bottom:15px;" onclick="openModal('create-modal')">+ Register New</button>
            <div id="member-list" class="member-list"></div>
        </div>

        <div id="tab-bbs" class="page">
            <h2 style="color:var(--theme-border);">System BBS</h2>
            <div class="bbs-container">
                <div class="bbs-header">Topic: General Chat</div>
                <div id="bbs-messages" class="bbs-messages"></div>
                <div class="bbs-input-area">
                    <input type="text" id="bbs-input" placeholder="Leave a note...">
                    <button class="btn-small" onclick="postMessage()">Post</button>
                </div>
            </div>
        </div>

        <div id="tab-tools" class="page">
            <h2 style="color:var(--theme-border);">Tools</h2>
            
            <div style="background:white; padding:15px; border-radius:15px; border:2px solid var(--theme-main); text-align:center; margin-bottom:20px;">
                <div style="font-size:3rem;">ü¶ê</div>
                <strong>Ebi</strong>
                <div style="background:#eee; height:10px; border-radius:5px; margin:5px 0;">
                    <div id="pet-hunger" style="width:50%; height:100%; background:var(--theme-main);"></div>
                </div>
                <button class="btn-small" onclick="feedPet()">Feed Snack</button>
            </div>

            <div style="background:#fffbeb; padding:15px; border:2px dashed #ffd700; border-radius:15px;">
                <strong>Wishlist</strong>
                <div style="display:flex; gap:5px; margin:10px 0;">
                    <input type="text" id="wish-input" placeholder="Item...">
                    <button class="btn-small" onclick="addWish()">Add</button>
                </div>
                <ul id="wish-list" style="padding-left:20px; font-size:0.8rem;"></ul>
            </div>
        </div>

    </div>

    <div id="switch-modal" class="modal">
        <div class="modal-content">
            <h3>Who is fronting?</h3>
            <div id="switch-list" style="max-height:200px; overflow-y:auto; margin-bottom:15px;"></div>
            <button class="btn-main" style="background:#ccc;" onclick="closeModals()">Cancel</button>
        </div>
    </div>

    <div id="create-modal" class="modal">
        <div class="modal-content">
            <h3>New Registration</h3>
            <input type="text" id="new-name" placeholder="Name" style="margin-bottom:10px;">
            <input type="text" id="new-role" placeholder="Role (e.g. Protector)" style="margin-bottom:10px;">
            <label style="font-size:0.8rem;">Theme Color:</label>
            <input type="color" id="new-color" value="#ff69b4" style="height:40px; margin-bottom:10px;">
            <button class="btn-main" onclick="registerMember()">Save ID</button>
            <button class="btn-small" style="width:100%; margin-top:5px; border:none;" onclick="closeModals()">Cancel</button>
        </div>
    </div>

    <nav>
        <button class="nav-btn active" onclick="nav('dash', this)"><span>üè†</span>Home</button>
        <button class="nav-btn" onclick="nav('members', this)"><span>üë•</span>Mem</button>
        <button class="nav-btn" onclick="nav('bbs', this)"><span>üí¨</span>BBS</button>
        <button class="nav-btn" onclick="nav('tools', this)"><span>üéí</span>Tools</button>
    </nav>

</div>

<script>
    // --- AVATAR ASSETS ---
    const AVATARS = [
        "https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcRzYjS4GrT6U0nmcao3A-UnuzLyeh-2UR3jloaiM4z7_A&s=10",
        "https://upload.wikimedia.org/wikipedia/commons/4/43/Chara04.png",
        "https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcTDNRg8thRPLTkTTKHsN1GxIk8WWQuawgwJcJalTTxhbNf339y17tzoxbmI&s=10"
    ];

    // --- DATA STORE ---
    const DB = {
        members: JSON.parse(localStorage.getItem('sys_members')) || [],
        currentFront: JSON.parse(localStorage.getItem('sys_front')) || null, // Stores index
        log: JSON.parse(localStorage.getItem('sys_log')) || [],
        bbs: JSON.parse(localStorage.getItem('sys_bbs')) || [],
        wish: JSON.parse(localStorage.getItem('sys_wish')) || [],
        pet: JSON.parse(localStorage.getItem('sys_pet')) || { hunger: 50 }
    };

    // --- INIT ---
    function init() {
        setInterval(() => {
            const now = new Date();
            document.getElementById('clock').innerText = now.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        }, 1000);

        if (DB.members.length === 0) {
            // First time setup: Create a default member
            DB.members.push({
                name: "Host",
                role: "Core",
                color: "#ff69b4",
                id: "0001",
                avatar: AVATARS[0]
            });
            DB.currentFront = 0;
            saveData();
        }
    }

    function enterApp() {
        document.getElementById('welcome-screen').style.opacity = '0';
        setTimeout(() => {
            document.getElementById('welcome-screen').style.display = 'none';
            document.getElementById('app-shell').style.display = 'flex';
            renderAll();
        }, 500);
    }

    // --- RENDER FUNCTIONS ---
    function renderAll() {
        applyTheme();
        renderFronter();
        renderLog();
        renderMembers();
        renderBBS();
        renderTools();
    }

    function applyTheme() {
        const fronter = DB.members[DB.currentFront];
        const color = fronter ? fronter.color : '#ff69b4';
        
        // CSS Variable Update
        const root = document.documentElement;
        root.style.setProperty('--theme-main', color);
        
        // Calculate darker border
        root.style.setProperty('--theme-border', adjustColor(color, -40));
        root.style.setProperty('--theme-light', adjustColor(color, 150)); // Very light tint
    }

    function renderFronter() {
        const user = DB.members[DB.currentFront];
        const html = `
            <div class="id-card">
                <div class="id-inner">
                    <div class="current-tag">CURRENT FRONTER</div>
                    <img src="${user.avatar}" class="id-photo">
                    <div class="id-info">
                        <h2>${user.name}</h2>
                        <p>${user.role}</p>
                        <p style="font-family:monospace;">ID: ${user.id}</p>
                        <div class="stats-row">
                            <span class="stat-badge">HP: 100</span>
                            <span class="stat-badge">MP: 100</span>
                        </div>
                    </div>
                </div>
            </div>
        `;
        document.getElementById('fronter-card-area').innerHTML = html;
    }

    function renderMembers() {
        const list = document.getElementById('member-list');
        list.innerHTML = "";
        DB.members.forEach((m, idx) => {
            list.innerHTML += `
                <div class="member-row" style="border-left: 4px solid ${m.color}">
                    <div class="mem-left">
                        <img src="${m.avatar}" class="mem-img">
                        <div>
                            <div style="font-weight:bold;">${m.name}</div>
                            <div style="font-size:0.7rem;">${m.role}</div>
                        </div>
                    </div>
                    <div class="mem-actions">
                        ${idx !== DB.currentFront ? `<button class="btn-small" onclick="switchFront(${idx})">Front</button>` : '<span style="font-size:0.7rem; font-weight:bold;">Active</span>'}
                        <button style="color:red; background:none; border:none;" onclick="deleteMember(${idx})">x</button>
                    </div>
                </div>
            `;
        });

        // Also update Switch Modal list
        const switchList = document.getElementById('switch-list');
        switchList.innerHTML = "";
        DB.members.forEach((m, idx) => {
            switchList.innerHTML += `
                <div class="member-row" onclick="switchFront(${idx})" style="cursor:pointer;">
                    <div class="mem-left">
                        <img src="${m.avatar}" class="mem-img">
                        <span style="font-weight:bold;">${m.name}</span>
                    </div>
                </div>
            `;
        });
    }

    // --- LOGIC ---
    function registerMember() {
        const name = document.getElementById('new-name').value;
        const role = document.getElementById('new-role').value;
        const color = document.getElementById('new-color').value;
        
        if(!name) return;

        DB.members.push({
            name: name,
            role: role || "Member",
            color: color,
            id: Math.floor(Math.random()*9000)+1000,
            avatar: AVATARS[Math.floor(Math.random()*AVATARS.length)]
        });
        saveData();
        closeModals();
        renderMembers();
    }

    function switchFront(index) {
        DB.currentFront = index;
        const user = DB.members[index];
        
        // Add to log
        const time = new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
        DB.log.unshift({ text: `${user.name} switched in`, time: time });
        if(DB.log.length > 20) DB.log.pop(); // Keep log short

        saveData();
        closeModals();
        renderAll();
    }

    function deleteMember(index) {
        if(confirm("Delete this member?")) {
            DB.members.splice(index, 1);
            if(DB.currentFront >= index) DB.currentFront = 0; // Fallback
            saveData();
            renderMembers();
        }
    }

    function postMessage() {
        const txt = document.getElementById('bbs-input').value;
        if(!txt) return;
        const user = DB.members[DB.currentFront];
        const time = new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
        
        DB.bbs.push({
            sender: user.name,
            color: user.color,
            text: txt,
            time: time
        });
        saveData();
        document.getElementById('bbs-input').value = "";
        renderBBS();
    }

    function renderBBS() {
        const container = document.getElementById('bbs-messages');
        container.innerHTML = "";
        DB.bbs.slice().reverse().forEach(msg => {
            container.innerHTML += `
                <div class="msg" style="border-left-color:${msg.color}">
                    <div class="msg-meta">
                        <span style="font-weight:bold; color:${msg.color}">${msg.sender}</span>
                        <span>${msg.time}</span>
                    </div>
                    <div>${msg.text}</div>
                </div>
            `;
        });
    }

    function renderLog() {
        const mini = document.getElementById('mini-log');
        mini.innerHTML = "";
        DB.log.slice(0, 3).forEach(l => {
            mini.innerHTML += `<div class="log-entry"><span>${l.text}</span> <span class="log-time">${l.time}</span></div>`;
        });
    }

    // --- LEISURE ---
    function feedPet() {
        DB.pet.hunger = Math.min(100, DB.pet.hunger + 10);
        saveData(); renderTools();
    }
    function addWish() {
        const txt = document.getElementById('wish-input').value;
        if(txt) { DB.wish.push(txt); saveData(); document.getElementById('wish-input').value=""; renderTools(); }
    }
    function renderTools() {
        document.getElementById('pet-hunger').style.width = DB.pet.hunger + "%";
        const wList = document.getElementById('wish-list');
        wList.innerHTML = "";
        DB.wish.forEach(w => wList.innerHTML += `<li>${w}</li>`);
    }
    function flipFortune() {
        const opts = ["Great Luck!", "Caution in Water", "Love is near", "Check your pockets"];
        document.getElementById('fortune-result').innerText = opts[Math.floor(Math.random()*opts.length)];
    }

    // --- UTILS ---
    function saveData() {
        localStorage.setItem('sys_members', JSON.stringify(DB.members));
        localStorage.setItem('sys_front', DB.currentFront);
        localStorage.setItem('sys_log', JSON.stringify(DB.log));
        localStorage.setItem('sys_bbs', JSON.stringify(DB.bbs));
        localStorage.setItem('sys_wish', JSON.stringify(DB.wish));
        localStorage.setItem('sys_pet', JSON.stringify(DB.pet));
    }

    // Color Hex Adjustment Helper
    function adjustColor(col, amt) {
        var usePound = false;
        if (col[0] == "#") { col = col.slice(1); usePound = true; }
        var num = parseInt(col,16);
        var r = (num >> 16) + amt;
        if (r > 255) r = 255; else if  (r < 0) r = 0;
        var b = ((num >> 8) & 0x00FF) + amt;
        if (b > 255) b = 255; else if  (b < 0) b = 0;
        var g = (num & 0x0000FF) + amt;
        if (g > 255) g = 255; else if (g < 0) g = 0;
        return (usePound?"#":"") + (g | (b << 8) | (r << 16)).toString(16);
    }

    // UI
    function nav(id, btn) {
        document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
        document.getElementById('tab-'+id).classList.add('active');
        if(btn) {
            document.querySelectorAll('.nav-btn').forEach(b=>b.classList.remove('active'));
            btn.classList.add('active');
        }
    }
    function openModal(id) { document.getElementById(id).style.display = 'flex'; }
    function closeModals() { document.querySelectorAll('.modal').forEach(m => m.style.display='none'); }

    // BOOT
    init();
    if('serviceWorker' in navigator) navigator.serviceWorker.register('./sw.js');
</script>
</body>
</html>
